// portal/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- CORE MODELS ------------------------------------------------------------

model Clinic {
  id        String   @id @default(cuid())
  name      String
  
  // LOGISTICS
  addressId String?
  address   Address? @relation(fields: [addressId], references: [id])
  phone     String?
  // BILLING & FINANCIALS
  billingCycleDay Int     @default(1) 
  paymentTerms    Int     @default(30) 
  taxId           String?
  priceTier       String  @default("STANDARD") 

  // BANKING REFERENCE
  bankName        String?
  bankLast4       String? 
  routingNumber   String?
  // RELATIONS
  users           User[] // Primary doctors (One-to-Many)
  
  // ✅ FIX: Back-relation for Secondary Clinics
  partTimeDoctors User[] @relation("DoctorSecondaryClinics")

  cases     DentalCase[]
  invoices  Invoice[]
  payments  Payment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  password        String   // Hashed
  name            String?
  phoneNumber     String?  
  preferenceNote  String? 

  role            String   // customer, lab, admin, milling
  
  invitationToken String? @unique 
  defaultDesignPreferences String?
  
  // PRIMARY CLINIC (One-to-Many)
  clinicId        String?
  clinic          Clinic? @relation(fields: [clinicId], references: [id])

  // ✅ SECONDARY CLINICS (Many-to-Many)
  secondaryClinics Clinic[] @relation("DoctorSecondaryClinics")

  // If this User is a Doctor, they might have a Sales Rep
  salesRepId      String?
  salesRep        User?    @relation("DoctorSalesRep", fields: [salesRepId], references: [id])
  // If this User is a Sales Rep, they have many Doctors
  doctors         User[]   @relation("DoctorSalesRep")

  addressId       String?
  address         Address? @relation(fields: [addressId], references: [id])

  doctorCases     DentalCase[] @relation("DoctorCases")
  workingCases    DentalCase[] @relation("WorkingCases")

  commissionedCases DentalCase[] @relation("CaseSalesRep")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --- SUPPORTING MODELS ------------------------------------------------------

model RegistrationRequest {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String?
  clinicName String
  street    String?
  city      String?
  state     String?
  zipCode   String?
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Address {
  id        String   @id @default(cuid())
  street    String?
  city      String?
  state     String?
  zipCode   String?
  country   String?  @default("USA")
  users     User[]
  clinics   Clinic[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DentalCase {
  id             String @id @default(cuid())
  
  // Clinic is mandatory for billing
  clinicId       String
  clinic         Clinic @relation(fields: [clinicId], references: [id])
  
  // Doctor is the user who owns the case
  doctorUserId   String?
  doctorUser     User?    @relation("DoctorCases", fields: [doctorUserId], references: [id])

  salesRepId     String?
  salesRep       User?    @relation("CaseSalesRep", fields: [salesRepId], references: [id])

  // Lab Assignee
  assigneeId     String?
  assigneeUser   User?    @relation("WorkingCases", fields: [assigneeId], references: [id])

  patientAlias   String
  patientFirstName String? 
  patientLastName  String?
  doctorName     String?
  toothCodes     String

  orderDate      DateTime    @default(now())
  product        String      @default("ZIRCONIA") 

  material       String?
  serviceLevel   String?     // IN_HOUSE, STANDARD
  
  // ✅ SHADES (Expanded)
  shade          String?     // Body Shade
  shadeGingival  String?     // NEW
  shadeIncisal   String?     // NEW
  
  designPreferences String?
  
  // Billing
  billingType    String      @default("BILLABLE") 
  units          Int         @default(1)
  cost           Decimal     @default(0.00)
  isRush         Boolean     @default(false) 
  currency       String      @default("USD")
  invoiced       Boolean     @default(false) 
  
  invoiceId      String?
  invoice        Invoice?    @relation(fields: [invoiceId], references: [id])

  // Production
  dueDate        DateTime?
  status         String      @default("IN_DESIGN") 
  stage          String      @default("DESIGN")    
  
  designedAt     DateTime?
  milledAt       DateTime?
  shippedAt      DateTime?
  
  shippingCarrier String?
  trackingNumber  String?
  shippingEta     DateTime?
  shippingCost    Decimal?  @default(0.00) // ✅ NEW: Store actual cost
  shippingBatchId String?
  needsReview        Boolean   @default(false)
  reviewQuestion     String?
  reviewRequestedAt  DateTime?
  reviewDeadline     DateTime?

  files      CaseFile[]
  events     StatusEvent[]
  comments   CaseComment[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([clinicId])
  @@index([doctorUserId])
  @@index([status])
  @@index([createdAt])
  @@index([orderDate])
  @@map("Case")
}

model Invoice {
  id          String        @id @default(cuid())
  clinicId    String
  clinic      Clinic        @relation(fields: [clinicId], references: [id])
  
  amount      Decimal
  status      String        @default("UNPAID")
  dueDate     DateTime      
  
  periodStart DateTime      
  periodEnd   DateTime      
  
  pdfUrl      String?
  cases       DentalCase[]  
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Payment {
  id          String        @id @default(cuid())
  clinicId    String
  clinic      Clinic        @relation(fields: [clinicId], references: [id])
  
  amount      Decimal
  method      String 
       
  referenceId String?
  postedAt    DateTime      @default(now())
}

model CaseFile {
  id        String      @id @default(cuid())
  caseId    String
  case      DentalCase  @relation(fields: [caseId], references: [id])
  
  label     String?
  kind      String      
  url       String
  sizeBytes Int?
  createdAt DateTime    @default(now())

  commentId String?
  comment   CaseComment? @relation(fields: [commentId], references: [id])
}

model StatusEvent {
  id      String      @id @default(cuid())
  caseId  String
  case    DentalCase  @relation(fields: [caseId], references: [id])
  from    String?
  to      String
  note    String?
  at      DateTime    @default(now())
  actorId String?
}

model CaseComment {
  id        String      @id @default(cuid())
  caseId    String
  case      DentalCase  @relation(fields: [caseId], references: [id])
  authorId  String
  body      String
  createdAt DateTime    @default(now())

  attachments CaseFile[]
}