// portal/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- CORE MODELS ------------------------------------------------------------

model Clinic {
  id        String   @id @default(cuid())
  name      String
  
  // LOGISTICS
  street    String?
  city      String?
  state     String?
  zipCode   String?
  phone     String?
  
  // BILLING & FINANCIALS
  billingCycleDay Int     @default(1) 
  paymentTerms    Int     @default(30) 
  taxId           String?
  
  // Enums replaced with String
  priceTier       String  @default("STANDARD") // STANDARD, IN_HOUSE

  // BANKING REFERENCE
  bankName        String?
  bankLast4       String? 
  routingNumber   String?

  // RELATIONS
  users     User[]
  cases     DentalCase[]
  invoices  Invoice[]
  payments  Payment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  password       String   // Hashed (bcrypt)
  name           String?
  phoneNumber    String?  
  preferenceNote String? 

  role           String   // customer, lab, admin
  clinicId       String?
  clinic         Clinic?  @relation(fields: [clinicId], references: [id])

  doctorCases    DentalCase[] @relation("DoctorCases")
  workingCases   DentalCase[] @relation("WorkingCases")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model DentalCase {
  id            String @id @default(cuid())
  clinicId      String
  clinic        Clinic @relation(fields: [clinicId], references: [id])
  
  doctorUserId String?
  doctorUser   User?   @relation("DoctorCases", fields: [doctorUserId], references: [id])

  assigneeId   String?
  assigneeUser User?   @relation("WorkingCases", fields: [assigneeId], references: [id])

  patientAlias String
  doctorName   String?
  toothCodes   String

  orderDate     DateTime    @default(now())
  product       String      @default("ZIRCONIA") // ZIRCONIA, MULTILAYER_ZIRCONIA, EMAX...

  material      String?
  shade         String?

  // FINANCIALS
  billingType   String      @default("BILLABLE") // BILLABLE, WARRANTY
  units         Int         @default(1)
  cost          Decimal     @default(0.00)
  isRush        Boolean     @default(false) 
  currency      String      @default("USD")
  invoiced      Boolean     @default(false) 
  
  invoiceId     String?
  invoice       Invoice?    @relation(fields: [invoiceId], references: [id])

  // LOGISTICS
  dueDate       DateTime?
  status        String      @default("IN_DESIGN") // IN_DESIGN, APPROVED, SHIPPED...
  stage         String      @default("DESIGN")    // DESIGN, MILLING_GLAZING, SHIPPING
  
  designedAt    DateTime?
  milledAt      DateTime?
  shippedAt     DateTime?
  
  shippingCarrier String?
  trackingNumber  String?
  shippingEta     DateTime?

  // REVIEW
  needsReview       Boolean   @default(false)
  reviewQuestion    String?
  reviewRequestedAt DateTime?
  reviewDeadline    DateTime?

  files    CaseFile[]
  events   StatusEvent[]
  comments CaseComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Case")
}

// --- BILLING MODELS ---------------------------------------------------------

model Invoice {
  id          String        @id @default(cuid())
  clinicId    String
  clinic      Clinic        @relation(fields: [clinicId], references: [id])
  
  amount      Decimal
  status      String        @default("UNPAID") // UNPAID, PAID...
  dueDate     DateTime      
  
  periodStart DateTime      
  periodEnd   DateTime      
  
  pdfUrl      String?

  cases       DentalCase[]  
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Payment {
  id          String        @id @default(cuid())
  clinicId    String
  clinic      Clinic        @relation(fields: [clinicId], references: [id])
  
  amount      Decimal
  method      String        // CREDIT_CARD, ACH...
  referenceId String?       
  
  postedAt    DateTime      @default(now())
}

// --- SUPPORTING MODELS ------------------------------------------------------

model CaseFile {
  id        String     @id @default(cuid())
  caseId    String
  case      DentalCase @relation(fields: [caseId], references: [id])
  
  label     String?
  kind      String     // STL, PLY, PHOTO...
  url       String
  sizeBytes Int?
  createdAt DateTime   @default(now())

  commentId String?
  comment   CaseComment? @relation(fields: [commentId], references: [id])
}

model StatusEvent {
  id      String      @id @default(cuid())
  caseId  String
  case    DentalCase  @relation(fields: [caseId], references: [id])
  from    String?
  to      String
  note    String?
  at      DateTime    @default(now())
  actorId String?
}

model CaseComment {
  id        String     @id @default(cuid())
  caseId    String
  case      DentalCase @relation(fields: [caseId], references: [id])
  authorId  String
  body      String
  createdAt DateTime   @default(now())

  attachments CaseFile[]
}