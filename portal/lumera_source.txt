FILE: ./middleware.ts
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function middleware(req: NextRequest) {
  // We can remove the manual regex check because the matcher handles it
  const has = req.cookies.has("lumera_session");
  
  if (!has) {
    // Redirect to login if trying to access portal without session
    const url = req.nextUrl.clone();
    url.pathname = "/login";
    return NextResponse.redirect(url);
  }
  
  return NextResponse.next();
}

// ✅ PERFORMANCE: Only run on /portal routes
export const config = {
  matcher: "/portal/:path*",
};
--- END OF FILE ---

FILE: ./app/sentry-example-page/page.tsx
"use client";

import * as Sentry from "@sentry/nextjs";
import Head from "next/head";
import { useEffect, useState } from "react";

class SentryExampleFrontendError extends Error {
  constructor(message: string | undefined) {
    super(message);
    this.name = "SentryExampleFrontendError";
  }
}

export default function Page() {
  const [hasSentError, setHasSentError] = useState(false);
  const [isConnected, setIsConnected] = useState(true);

  useEffect(() => {
    Sentry.logger.info("Sentry example page loaded");
    async function checkConnectivity() {
      const result = await Sentry.diagnoseSdkConnectivity();
      setIsConnected(result !== "sentry-unreachable");
    }
    checkConnectivity();
  }, []);

  return (
    <div>
      <Head>
        <title>sentry-example-page</title>
        <meta name="description" content="Test Sentry for your Next.js app!" />
      </Head>

      <main>
        <div className="flex-spacer" />
        <svg
          height="40"
          width="40"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          role="img"
          aria-label="Sentry logo"
        >
          <path
            d="M21.85 2.995a3.698 3.698 0 0 1 1.353 1.354l16.303 28.278a3.703 3.703 0 0 1-1.354 5.053 3.694 3.694 0 0 1-1.848.496h-3.828a31.149 31.149 0 0 0 0-3.09h3.815a.61.61 0 0 0 .537-.917L20.523 5.893a.61.61 0 0 0-1.057 0l-3.739 6.494a28.948 28.948 0 0 1 9.63 10.453 28.988 28.988 0 0 1 3.499 13.78v1.542h-9.852v-1.544a19.106 19.106 0 0 0-2.182-8.85 19.08 19.08 0 0 0-6.032-6.829l-1.85 3.208a15.377 15.377 0 0 1 6.382 12.484v1.542H3.696A3.694 3.694 0 0 1 0 34.473c0-.648.17-1.286.494-1.849l2.33-4.074a8.562 8.562 0 0 1 2.689 1.536L3.158 34.17a.611.611 0 0 0 .538.917h8.448a12.481 12.481 0 0 0-6.037-9.09l-1.344-.772 4.908-8.545 1.344.77a22.16 22.16 0 0 1 7.705 7.444 22.193 22.193 0 0 1 3.316 10.193h3.699a25.892 25.892 0 0 0-3.811-12.033 25.856 25.856 0 0 0-9.046-8.796l-1.344-.772 5.269-9.136a3.698 3.698 0 0 1 3.2-1.849c.648 0 1.285.17 1.847.495Z"
            fill="currentcolor"
          />
        </svg>
        <h1>sentry-example-page</h1>

        <p className="description">
          Click the button below, and view the sample error on the Sentry{" "}
          <a
            target="_blank"
            rel="noopener"
            href="https://lumera-lab.sentry.io/issues/?project=4510789486116864"
          >
            Issues Page
          </a>
          . For more details about setting up Sentry,{" "}
          <a
            target="_blank"
            rel="noopener"
            href="https://docs.sentry.io/platforms/javascript/guides/nextjs/"
          >
            read our docs
          </a>
          .
        </p>

        <button
          type="button"
          onClick={async () => {
            Sentry.logger.info("User clicked the button, throwing a sample error");
            await Sentry.startSpan(
              {
                name: "Example Frontend/Backend Span",
                op: "test",
              },
              async () => {
                const res = await fetch("/api/sentry-example-api");
                if (!res.ok) {
                  setHasSentError(true);
                }
              },
            );
            throw new SentryExampleFrontendError(
              "This error is raised on the frontend of the example page.",
            );
          }}
          disabled={!isConnected}
        >
          <span>Throw Sample Error</span>
        </button>

        {hasSentError ? (
          <p className="success">Error sent to Sentry.</p>
        ) : !isConnected ? (
          <div className="connectivity-error">
            <p>
              It looks like network requests to Sentry are being blocked, which
              will prevent errors from being captured. Try disabling your
              ad-blocker to complete the test.
            </p>
          </div>
        ) : (
          <div className="success_placeholder" />
        )}

        <div className="flex-spacer" />
      </main>

      <style>{`
        main {
          display: flex;
          min-height: 100vh;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          gap: 16px;
          padding: 16px;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
        }

        h1 {
          padding: 0px 4px;
          border-radius: 4px;
          background-color: rgba(24, 20, 35, 0.03);
          font-family: monospace;
          font-size: 20px;
          line-height: 1.2;
        }

        p {
          margin: 0;
          font-size: 20px;
        }

        a {
          color: #6341F0;
          text-decoration: underline;
          cursor: pointer;

          @media (prefers-color-scheme: dark) {
            color: #B3A1FF;
          }
        }

        button {
          border-radius: 8px;
          color: white;
          cursor: pointer;
          background-color: #553DB8;
          border: none;
          padding: 0;
          margin-top: 4px;

          & > span {
            display: inline-block;
            padding: 12px 16px;
            border-radius: inherit;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            background-color: #7553FF;
            border: 1px solid #553DB8;
            transform: translateY(-4px);
          }

          &:hover > span {
            transform: translateY(-8px);
          }

          &:active > span {
            transform: translateY(0);
          }

          &:disabled {
	            cursor: not-allowed;
	            opacity: 0.6;

	            & > span {
	              transform: translateY(0);
	              border: none
	            }
	          }
        }

        .description {
          text-align: center;
          color: #6E6C75;
          max-width: 500px;
          line-height: 1.5;
          font-size: 20px;

          @media (prefers-color-scheme: dark) {
            color: #A49FB5;
          }
        }

        .flex-spacer {
          flex: 1;
        }

        .success {
          padding: 12px 16px;
          border-radius: 8px;
          font-size: 20px;
          line-height: 1;
          background-color: #00F261;
          border: 1px solid #00BF4D;
          color: #181423;
        }

        .success_placeholder {
          height: 46px;
        }

        .connectivity-error {
          padding: 12px 16px;
          background-color: #E50045;
          border-radius: 8px;
          width: 500px;
          color: #FFFFFF;
          border: 1px solid #A80033;
          text-align: center;
          margin: 0;
        }

        .connectivity-error a {
          color: #FFFFFF;
          text-decoration: underline;
        }
      `}</style>
    </div>
  );
}

--- END OF FILE ---

FILE: ./app/contact/page.tsx
// portal/app/contact/page.tsx
import PublicNavbar from "@/components/PublicNavbar";
import PublicFooter from "@/components/PublicFooter";

export default function ContactPage() {
  return (
    <main className="min-h-screen flex flex-col bg-background text-foreground transition-colors duration-300">
      <PublicNavbar />
      
      <section className="pt-24 pb-12">
        <div className="container mx-auto px-6">
          <h1 className="text-5xl font-semibold mb-6">Contact & Send a Case</h1>
          <p className="text-xl text-muted max-w-2xl">
            Flat price. Fast turnaround. Made in USA. We promise delivery in 7 business days.
          </p>
        </div>
      </section>

      <section className="container mx-auto px-6 pb-24 grid lg:grid-cols-2 gap-8">
        {/* Main Contact Card */}
        <div className="p-8 md:p-12 rounded-3xl border border-border bg-surface transition-colors">
          <h2 className="text-2xl font-medium mb-4">Send Scans Via Email</h2>
          <p className="text-muted mb-8">
            Attach STL/PLY files, photos, shade, and notes. We’ll reply quickly with design confirmation.
          </p>
          
          <a href="mailto:hello@glo.dental" className="inline-block w-full text-center py-4 rounded-xl bg-foreground text-background font-bold hover:bg-foreground/90 transition-colors mb-8">
            Email hello@glo.dental
          </a>

          <div className="grid grid-cols-2 gap-4">
            <div className="p-4 rounded-xl border border-border bg-surface-highlight transition-colors">
              <div className="text-xs text-muted mb-1">Phone</div>
              <div className="font-medium">+1 (000) 000-0000</div>
            </div>
            <div className="p-4 rounded-xl border border-border bg-surface-highlight transition-colors">
              <div className="text-xs text-muted mb-1">Delivery</div>
              <div className="font-medium">7 business days</div>
            </div>
          </div>
        </div>

        {/* Info Sidebar */}
        <div className="space-y-6">
          <div className="p-8 rounded-3xl border border-border bg-surface transition-colors">
            <h3 className="text-lg font-medium mb-2">Submissions</h3>
            <p className="text-muted text-sm">
              <strong className="text-foreground">Scans only</strong> (no hard impressions). We support common formats (STL/PLY). 
              We ship the finished crown to your office.
            </p>
          </div>
          
          <div className="p-8 rounded-3xl border border-border bg-surface transition-colors">
            <h3 className="text-lg font-medium mb-2">Address</h3>
            <p className="text-muted text-sm">
              Lumera Dental Lab<br/>
              [Your Street]<br/>
              [City, State ZIP]<br/>
              <span className="text-accent mt-2 inline-block">Made in USA</span>
            </p>
          </div>
        </div>
      </section>

      <PublicFooter />
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/financials/FinancialsTable.tsx
// portal/app/portal/admin/financials/FinancialsTable.tsx
"use client";

import { useState, useMemo } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import CopyableId from "@/components/CopyableId";

type SortConfig = {
  key: string | null;
  direction: "asc" | "desc" | null;
};

function formatMoney(amount: number) {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
  }).format(amount);
}

const SortableHeader = ({ 
  label, colKey, sortConfig, onSort, className = "", align = "left"
}: any) => {
  const isActive = sortConfig.key === colKey;
  return (
    <th 
      className={`
        h-12 p-0 font-medium cursor-pointer transition-colors duration-200 select-none group border-b-2 outline-none whitespace-nowrap align-middle
        ${isActive ? "text-accent border-accent" : "text-muted border-transparent hover:text-foreground"}
        ${className}
      `}
      onClick={() => onSort(colKey)}
    >
      <div className={`flex items-center h-full px-4 ${align === "right" ? "justify-end" : align === "center" ? "justify-center" : "justify-start"}`}>
        <span className="truncate">{label}</span>
        {isActive && (
          <span className="text-accent text-[10px] leading-none ml-1">
            {sortConfig.direction === "asc" ? "▲" : "▼"}
          </span>
        )}
      </div>
    </th>
  );
};

export default function FinancialsTable({ rows, totalCount }: { rows: any[], totalCount: number }) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [sortConfig, setSortConfig] = useState<SortConfig>({ key: null, direction: null });
  const [loadingMore, setLoadingMore] = useState(false);

  const sortedRows = useMemo(() => {
    if (!sortConfig.key || !sortConfig.direction) return rows;
    return [...rows].sort((a, b) => {
      let aVal: any = "";
      let bVal: any = "";
      switch (sortConfig.key) {
        case "alias": aVal = a.patientAlias; bVal = b.patientAlias; break;
        case "id": aVal = a.id; bVal = b.id; break;
        case "doctor": aVal = a.doctorName || ""; bVal = b.doctorName || ""; break;
        case "clinic": aVal = a.clinic.name; bVal = b.clinic.name; break;
        case "date": aVal = new Date(a.createdAt).getTime(); bVal = new Date(b.createdAt).getTime(); break;
        case "designer": aVal = a.designerName || ""; bVal = b.designerName || ""; break;
        case "rep": aVal = a.salesRepName || ""; bVal = b.salesRepName || ""; break;
        case "product": aVal = a.product; bVal = b.product; break;
        case "units": aVal = a.units; bVal = b.units; break;
        case "revenue": aVal = Number(a.cost); bVal = Number(b.cost); break;
        case "haus": aVal = a.millingCost; bVal = b.millingCost; break;
        case "design": aVal = a.designCost; bVal = b.designCost; break;
        case "comm": aVal = a.commissionCost; bVal = b.commissionCost; break;
        case "margin": aVal = a.margin; bVal = b.margin; break;
      }
      if (aVal < bVal) return sortConfig.direction === "asc" ? -1 : 1;
      if (aVal > bVal) return sortConfig.direction === "asc" ? 1 : -1;
      return 0;
    });
  }, [rows, sortConfig]);

  const handleSort = (key: string) => {
    setSortConfig((current) => {
      if (current.key !== key) return { key, direction: "asc" };
      if (current.direction === "asc") return { key, direction: "desc" };
      return { key: null, direction: null };
    });
  };

  const handleLoadMore = () => {
    setLoadingMore(true);
    const params = new URLSearchParams(searchParams.toString());
    const currentLimit = parseInt(params.get("limit") || "50");
    const newLimit = currentLimit + 50;
    params.set("limit", newLimit.toString());
    router.replace(`?${params.toString()}`, { scroll: false });
    setTimeout(() => setLoadingMore(false), 2000);
  };

  return (
    <div className="flex-1 min-h-0 rounded-xl border border-border bg-surface overflow-hidden flex flex-col shadow-2xl">
      <div className="flex-1 overflow-auto custom-scrollbar">
        <table className="w-full text-left text-sm min-w-[1800px]">
          <thead className="bg-surface text-muted sticky top-0 backdrop-blur-md z-10 border-b border-border h-12">
            <tr>
                <SortableHeader label="Case Alias" colKey="alias" sortConfig={sortConfig} onSort={handleSort} className="w-[100px]" />
                <SortableHeader label="Case ID" colKey="id" sortConfig={sortConfig} onSort={handleSort} className="w-[100px]" />
                <SortableHeader label="Doctor" colKey="doctor" sortConfig={sortConfig} onSort={handleSort} className="min-w-[140px]" />
                <SortableHeader label="Clinic" colKey="clinic" sortConfig={sortConfig} onSort={handleSort} className="w-[120px]" />
                <SortableHeader label="Date Created" colKey="date" sortConfig={sortConfig} onSort={handleSort} className="w-[100px]" />
                <SortableHeader label="Designer" colKey="designer" sortConfig={sortConfig} onSort={handleSort} className="w-[110px]" />
                <SortableHeader label="Sales Rep" colKey="rep" sortConfig={sortConfig} onSort={handleSort} className="w-[120px]" />
                <SortableHeader label="Product" colKey="product" sortConfig={sortConfig} onSort={handleSort} className="min-w-[120px]" />
                <SortableHeader label="Units" colKey="units" sortConfig={sortConfig} onSort={handleSort} className="w-[50px]" align="center" />
                <SortableHeader label="Revenue" colKey="revenue" sortConfig={sortConfig} onSort={handleSort} className="min-w-[60px] text-emerald-400" align="right" />
                <SortableHeader label="Haus Cost" colKey="haus" sortConfig={sortConfig} onSort={handleSort} className="min-w-[60px] text-blue-400" align="right" />
                <SortableHeader label="Design Fee" colKey="design" sortConfig={sortConfig} onSort={handleSort} className="min-w-[60px] text-purple-400" align="right" />
                <SortableHeader label="Comm." colKey="comm" sortConfig={sortConfig} onSort={handleSort} className="min-w-[60px] text-orange-400" align="right" />
                <SortableHeader label="Margin" colKey="margin" sortConfig={sortConfig} onSort={handleSort} className="min-w-[60px]" align="right" />
            </tr>
          </thead>
          <tbody className="divide-y divide-border">
            {sortedRows.length === 0 && (
                <tr>
                    <td colSpan={14} className="p-12 text-center text-muted">No records found for this period.</td>
                </tr>
            )}
            {sortedRows.map(r => (
                <tr key={r.id} className="hover:bg-[var(--accent-dim)] transition-colors group h-12">
                    <td className="px-4 font-medium text-foreground truncate">{r.patientAlias}</td>
                    <td className="px-4"><CopyableId id={r.id} truncate /></td>
                    <td className="px-4 text-foreground/80 truncate">{r.doctorName || "—"}</td>
                    <td className="px-4 text-muted text-xs truncate">{r.clinic.name}</td>
                    <td className="px-4 text-muted text-xs font-mono">{new Date(r.createdAt).toLocaleDateString()}</td>
                    <td className="px-4 text-muted">
                        {r.designerName ? (
                            <div className="flex items-center gap-2">
                                <div className="w-5 h-5 rounded-full bg-purple-500/10 text-purple-300 text-[10px] font-bold flex items-center justify-center border border-purple-500/20 shrink-0">
                                    {r.designerName.substring(0, 1).toUpperCase()}
                                </div>
                                <span className="text-xs truncate max-w-[120px]" title={r.designerName}>{r.designerName}</span>
                            </div>
                        ) : <span className="text-white/20 italic text-xs">-</span>}
                    </td>
                    <td className="px-4 text-white/70">
                        {r.salesRepName ? (
                            <div className="flex items-center gap-2">
                                <span className="text-xs bg-orange-500/10 text-orange-300 px-2 py-0.5 rounded border border-orange-500/20 truncate max-w-[100px]" title={r.salesRepName}>
                                    {r.salesRepName.split(' ')[0]}
                                </span>
                            </div>
                        ) : <span className="text-white/20 italic text-xs">-</span>}
                    </td>
                    <td className="px-4 text-foreground">
                        <div className="text-xs font-medium truncate">{r.product.replace(/_/g, " ")}</div>
                        {r.material && <div className="text-[10px] text-muted truncate">{r.material}</div>}
                    </td>
                    <td className="px-4 text-center text-muted">{r.units}</td>
                    <td className="px-4 text-right font-medium text-emerald-400/90">{formatMoney(Number(r.cost))}</td>
                    <td className="px-4 text-right text-blue-300/80">{formatMoney(r.millingCost)}</td>
                    <td className="px-4 text-right text-purple-300/80">{formatMoney(r.designCost)}</td>
                    <td className="px-4 text-right text-orange-300/80">{formatMoney(r.commissionCost)}</td>
                    <td className="px-4 text-right font-bold text-foreground">{formatMoney(r.margin)}</td>
                </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* ✅ UNIFIED FOOTER: SAME ROW */}
      <div className="flex-none h-14 p-3 border-t border-border bg-surface flex items-center justify-between">
        <span className="text-xs text-muted pl-2">
          Showing {rows.length} of {totalCount} records
        </span>
        
        {rows.length < totalCount && (
          <button
            onClick={handleLoadMore}
            disabled={loadingMore}
            className="px-4 py-1.5 rounded-lg bg-surface hover:bg-[var(--accent-dim)] text-xs font-bold text-foreground transition-colors flex items-center gap-2 border border-border"
          >
            {loadingMore ? (
              <>
                <div className="w-3 h-3 border-2 border-muted border-t-foreground rounded-full animate-spin" />
                Loading...
              </>
            ) : "Load More"}
          </button>
        )}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/financials/FinancialsFilters.tsx
// portal/app/portal/admin/financials/FinancialsFilters.tsx
"use client";

import { useRouter } from "next/navigation";
import { useState, useEffect, useCallback } from "react";

const MONTHS = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];

type Props = {
  selYear: number;
  selMonth: number | "ALL";
  designerId: string;
  designers: { id: string; name: string | null; email: string }[];
  salesRepId: string;
  salesReps: { id: string; name: string | null; email: string }[];
  doctorFilter: string;
  clinicFilter: string;
};

export default function FinancialsFilters({ 
  selYear, selMonth, 
  designerId, designers, 
  salesRepId, salesReps,
  doctorFilter, clinicFilter
}: Props) {
  const router = useRouter();
  const currentYear = new Date().getFullYear();
  const years = Array.from({ length: 3 }, (_, i) => currentYear - i);

  const [docInput, setDocInput] = useState(doctorFilter);
  const [clinicInput, setClinicInput] = useState(clinicFilter);

  useEffect(() => {
    setDocInput(doctorFilter);
    setClinicInput(clinicFilter);
  }, [doctorFilter, clinicFilter]);

  // ✅ STABILIZE UPDATE FUNCTION
  const update = useCallback((updates: Record<string, string>) => {
    const url = new URL(window.location.href);
    
    // ✅ 1. Reset pagination limit whenever a filter changes
    url.searchParams.delete("limit");

    // ✅ 2. Update Params
    Object.entries(updates).forEach(([key, val]) => {
        // FIX: Removed '&& val !== "ALL"' check.
        // We MUST allow "ALL" to be sent so the server knows to fetch the full year
        // instead of defaulting to the current month.
        if (val) {
            url.searchParams.set(key, val);
        } else {
            url.searchParams.delete(key);
        }
    });
    router.replace(url.toString());
  }, [router]);

  // Debounce text search
  useEffect(() => {
    const timer = setTimeout(() => {
        if (docInput !== doctorFilter || clinicInput !== clinicFilter) {
            update({ doctor: docInput, clinic: clinicInput });
        }
    }, 500);
    return () => clearTimeout(timer);
  }, [docInput, clinicInput, doctorFilter, clinicFilter, update]);

  const hasFilter = designerId || salesRepId || doctorFilter || clinicFilter || selMonth === "ALL" || selYear !== currentYear;

  return (
    <div className="flex flex-wrap items-center gap-3 bg-black/20 p-2 rounded-xl border border-white/5">
      {/* Time Window */}
      <div className="flex items-center gap-2">
        <select 
          value={selYear}
          onChange={(e) => update({ year: e.target.value })}
          className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-blue-500/50 outline-none cursor-pointer hover:bg-white/5 transition-colors"
        >
          {years.map(y => <option key={y} value={y} className="bg-[#1a1a1a]">{y}</option>)}
        </select>

        <select 
          value={selMonth}
          onChange={(e) => update({ month: e.target.value })}
          className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-blue-500/50 outline-none cursor-pointer hover:bg-white/5 transition-colors"
        >
          <option value="ALL" className="bg-[#1a1a1a]">Full Year</option>
          {MONTHS.map((m, i) => (
            <option key={m} value={i + 1} className="bg-[#1a1a1a]">{m}</option>
          ))}
        </select>
      </div>

      <div className="w-px h-6 bg-white/10 mx-1 hidden sm:block" />

      {/* Text Filters */}
      <input 
        placeholder="Doctor Name" 
        value={docInput}
        onChange={(e) => setDocInput(e.target.value)}
        className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white outline-none w-32 lg:w-40 focus:border-blue-500/50 transition-colors placeholder-white/30" 
      />
      <input 
        placeholder="Clinic Name" 
        value={clinicInput}
        onChange={(e) => setClinicInput(e.target.value)}
        className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white outline-none w-32 lg:w-40 focus:border-blue-500/50 transition-colors placeholder-white/30" 
      />

      {/* Designer Filter */}
      <select 
        value={designerId}
        onChange={(e) => update({ designer: e.target.value })}
        className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-blue-500/50 outline-none cursor-pointer min-w-[130px] hover:bg-white/5 transition-colors"
      >
        <option value="" className="bg-[#1a1a1a]">All Designers</option>
        {designers.map(d => (
          <option key={d.id} value={d.id} className="bg-[#1a1a1a]">{d.name || d.email}</option>
        ))}
      </select>

      {/* Sales Rep Filter */}
      <select 
        value={salesRepId}
        onChange={(e) => update({ salesRep: e.target.value })}
        className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-blue-500/50 outline-none cursor-pointer min-w-[130px] hover:bg-white/5 transition-colors"
      >
        <option value="" className="bg-[#1a1a1a]">All Sales Reps</option>
        {salesReps.map(r => (
          <option key={r.id} value={r.id} className="bg-[#1a1a1a]">{r.name || r.email}</option>
        ))}
      </select>

      {/* Reset Button */}
      {hasFilter && (
        <button 
          onClick={() => router.replace("/portal/admin/financials")}
          className="text-xs text-white/40 hover:text-white transition px-2 font-medium"
        >
          Reset
        </button>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/financials/page.tsx
// portal/app/portal/admin/financials/page.tsx

import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { redirect } from "next/navigation";
import { AdminTabs } from "@/components/AdminTabs";
import FinancialsFilters from "./FinancialsFilters";
import FinancialsTable from "./FinancialsTable"; 
import { calculateProductionCosts } from "@/lib/cost-engine";

export const dynamic = "force-dynamic";

function formatMoney(amount: number) {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
  }).format(amount);
}

export default async function FinancialsPage({
  searchParams,
}: {
  searchParams: Promise<{ month?: string; year?: string; designer?: string; salesRep?: string; doctor?: string; clinic?: string; limit?: string }>;
}) {
  const session = await getSession();
  if (!session || session.role !== "admin") redirect("/portal/cases");

  const sp = await searchParams;
  const now = new Date();
  
  const year = Number(sp.year) || now.getFullYear();
  const monthParam = sp.month; 
  const month = monthParam ? (monthParam === "ALL" ? "ALL" : parseInt(monthParam)) : now.getMonth() + 1;
  const limit = parseInt(sp.limit || "50");

  let start: Date, end: Date;
  if (month === "ALL") {
      start = new Date(year, 0, 1);
      end = new Date(year, 11, 31, 23, 59, 59);
  } else {
      const m = month as number;
      start = new Date(year, m - 1, 1);
      end = new Date(year, m, 0, 23, 59, 59);
  }

  const designerId = sp.designer || "";
  const salesRepId = sp.salesRep || "";
  const doctorFilter = sp.doctor || "";
  const clinicFilter = sp.clinic || "";

  // Build Query
  const where: any = {
    orderDate: { gte: start, lte: end },
    status: { not: "CANCELLED" },
  };
  if (designerId) where.assigneeId = designerId;
  if (salesRepId) where.salesRepId = salesRepId;
  if (doctorFilter) where.doctorName = { contains: doctorFilter, mode: 'insensitive' };
  if (clinicFilter) where.clinic = { name: { contains: clinicFilter, mode: 'insensitive' } };

  // 1. Fetch Summary Data (For Scorecards & Total Count)
  // We fetch ALL matching records here (lightweight select) to ensure scorecards represent the full month/year
  const summaryCases = await prisma.dentalCase.findMany({
    where,
    select: {
      cost: true,
      units: true,
      product: true,
      material: true,
      salesRepId: true,
    }
  });

  // 2. Scorecard Calculations
  let totalRevenue = 0;
  let totalOwedHaus = 0;
  let totalOwedDesigners = 0;
  let totalOwedSales = 0;
  
  for (const c of summaryCases) {
    const costs = calculateProductionCosts(c.product, c.material, c.units, !!c.salesRepId);
    totalRevenue += Number(c.cost);
    totalOwedHaus += costs.milling;
    totalOwedDesigners += costs.design;
    totalOwedSales += costs.commission;
  }
  const netProfit = totalRevenue - totalOwedHaus - totalOwedDesigners - totalOwedSales;

  // 3. Fetch Paginated Table Data
  // This fetch is heavy (includes relations) but limited by 'take'
  const [tableCases, designers, salesReps] = await Promise.all([
    prisma.dentalCase.findMany({
      where,
      orderBy: { orderDate: "desc" },
      take: limit, // ✅ PAGINATED
      select: {
        id: true,
        patientAlias: true,
        orderDate: true,
        createdAt: true,
        product: true,
        material: true,
        units: true,
        cost: true,
        status: true,
        salesRepId: true, 
        doctorName: true,
        clinic: { select: { name: true } },
        assigneeUser: { select: { id: true, name: true, email: true } },
        salesRep: { select: { id: true, name: true, email: true } } 
      }
    }),
    prisma.user.findMany({
      where: { role: { in: ["lab", "admin"] } },
      select: { id: true, name: true, email: true },
      orderBy: { name: "asc" }
    }),
    prisma.user.findMany({
      where: { role: "sales" },
      select: { id: true, name: true, email: true },
      orderBy: { name: "asc" }
    })
  ]);

  const rows = tableCases.map((c) => {
    const costs = calculateProductionCosts(c.product, c.material, c.units, !!c.salesRepId);
    const revenue = Number(c.cost);
    return {
      ...c,
      cost: revenue, 
      millingCost: costs.milling,
      designCost: costs.design,
      commissionCost: costs.commission, 
      margin: revenue - costs.total,
      designerName: c.assigneeUser ? (c.assigneeUser.name || c.assigneeUser.email) : null,
      salesRepName: c.salesRep ? (c.salesRep.name || c.salesRep.email) : null
    };
  });

  const designerLabel = designerId 
    ? `Owed to ${designers.find(d => d.id === designerId)?.name?.split(' ')[0] || 'Designer'}`
    : "Owed to Designers";
  const salesLabel = salesRepId
    ? `Owed to ${salesReps.find(r => r.id === salesRepId)?.name?.split(' ')[0] || 'Rep'}`
    : "Sales Comm.";

  return (
    <div className="flex-1 min-h-0 flex flex-col space-y-4">
      {/* Header */}
      <div className="flex-none flex items-center justify-between">
         <div className="flex items-center gap-4">
            <h1 className="text-2xl font-semibold text-white hidden sm:block">Admin</h1>
            <div className="h-6 w-px bg-white/10 hidden sm:block" />
            <AdminTabs />
         </div>
      </div>

      {/* Filters */}
      <div className="flex-none">
        <FinancialsFilters 
          selYear={year} 
          selMonth={month} 
          designerId={designerId} 
          designers={designers}
          salesRepId={salesRepId}
          salesReps={salesReps} 
          doctorFilter={doctorFilter}
          clinicFilter={clinicFilter}
        />
      </div>

      {/* Scorecards */}
      <div className="flex-none grid grid-cols-2 md:grid-cols-5 gap-4">
        <div className="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20">
            <div className="text-[10px] text-emerald-400 uppercase font-bold tracking-wider mb-1">Total Revenue</div>
            <div className="text-2xl font-light text-white">{formatMoney(totalRevenue)}</div>
        </div>
        <div className="p-4 rounded-xl bg-blue-500/10 border border-blue-500/20">
            <div className="text-[10px] text-blue-400 uppercase font-bold tracking-wider mb-1">Owed to Haus</div>
            <div className="text-2xl font-light text-white">{formatMoney(totalOwedHaus)}</div>
        </div>
        <div className="p-4 rounded-xl bg-purple-500/10 border border-purple-500/20">
            <div className="text-[10px] text-purple-400 uppercase font-bold tracking-wider mb-1">{designerLabel}</div>
            <div className="text-2xl font-light text-white">{formatMoney(totalOwedDesigners)}</div>
        </div>
        <div className="p-4 rounded-xl bg-orange-500/10 border border-orange-500/20">
            <div className="text-[10px] text-orange-400 uppercase font-bold tracking-wider mb-1">{salesLabel}</div>
            <div className="text-2xl font-light text-white">{formatMoney(totalOwedSales)}</div>
        </div>
        <div className="p-4 rounded-xl bg-white/5 border border-white/10">
            <div className="text-[10px] text-white/50 uppercase font-bold tracking-wider mb-1">Net Profit</div>
            <div className="text-2xl font-light text-white">{formatMoney(netProfit)}</div>
        </div>
      </div>

      {/* Client Table (Total count passed for footer) */}
      <FinancialsTable rows={rows} totalCount={summaryCases.length} />
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/requests/RequestListClient.tsx
// portal/app/portal/admin/requests/RequestListClient.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { AdminTabs } from "@/components/AdminTabs";

export default function RequestListClient({ requests }: { requests: any[] }) {
  const router = useRouter();
  const [busyId, setBusyId] = useState<string | null>(null);

  async function handleAction(id: string, action: "approve" | "reject") {
    setBusyId(id);
    try {
      const res = await fetch(`/api/admin/requests/${id}/approve`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action })
      });
      if (!res.ok) throw new Error("Failed");
      router.refresh();
    } catch (e: any) {
      alert("Operation failed.");
    } finally {
      setBusyId(null);
    }
  }

  return (
    <div className="flex-1 min-h-0 flex flex-col space-y-4">
      {/* Header */}
      <div className="flex-none flex items-center justify-between">
         <div className="flex items-center gap-4">
            <h1 className="text-2xl font-semibold text-foreground hidden sm:block">Admin</h1>
            <div className="h-6 w-px bg-border hidden sm:block" />
            <AdminTabs />
         </div>
      </div>

      {/* Table Container */}
      <div className="flex-1 min-h-0 rounded-xl border border-border bg-surface overflow-hidden flex flex-col shadow-2xl">
        <div className="flex-1 overflow-auto custom-scrollbar">
          <table className="w-full text-left text-sm min-w-[800px]">
            <thead className="bg-surface text-muted sticky top-0 backdrop-blur-md z-10 border-b border-border">
              <tr>
                <th className="p-4 font-medium">Name</th>
                <th className="p-4 font-medium">Email</th>
                <th className="p-4 font-medium">Clinic Info</th>
                <th className="p-4 font-medium">Date</th>
                <th className="p-4 font-medium text-right">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-border">
              {requests.length === 0 && (
                <tr>
                  <td colSpan={5} className="p-12 text-center text-muted">
                    No pending requests.
                  </td>
                </tr>
              )}
              {requests.map((r) => (
                <tr key={r.id} className="hover:bg-[var(--accent-dim)] transition-colors">
                  <td className="p-4 font-medium text-foreground">{r.name}</td>
                  <td className="p-4 text-muted">{r.email}</td>
                  <td className="p-4 text-muted">
                    <div className="text-foreground font-medium">{r.clinicName}</div>
                    <div className="text-xs opacity-70">{r.city}, {r.state}</div>
                  </td>
                  <td className="p-4 text-muted">{new Date(r.createdAt).toLocaleDateString()}</td>
                  <td className="p-4 text-right">
                    <div className="flex justify-end gap-2">
                      <button 
                        onClick={() => handleAction(r.id, "reject")}
                        disabled={busyId === r.id}
                        className="px-3 py-1.5 rounded-lg border border-red-500/20 text-red-400 hover:bg-red-500/10 text-xs font-bold uppercase tracking-wider disabled:opacity-50 transition-colors"
                      >
                        Reject
                      </button>
                      <button 
                        onClick={() => handleAction(r.id, "approve")}
                        disabled={busyId === r.id}
                        className="px-3 py-1.5 rounded-lg bg-emerald-500 text-black text-xs font-bold uppercase tracking-wider hover:bg-emerald-400 disabled:opacity-50 transition-colors shadow-lg shadow-emerald-900/20"
                      >
                        {busyId === r.id ? "..." : "Approve"}
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/requests/page.tsx
// portal/app/portal/admin/requests/page.tsx
import { prisma } from "@/lib/prisma";
import RequestListClient from "./RequestListClient";

export const dynamic = "force-dynamic";

export default async function RequestsPage() {
  const where = { status: "PENDING" };
  
  // 1. Count Pending
  const totalPending = await prisma.registrationRequest.count({ where });
  
  // 2. Fetch Recent Pending
  const requests = await prisma.registrationRequest.findMany({
    where,
    orderBy: { createdAt: "desc" },
    take: 50
  });

  return (
    <div className="flex flex-col h-full space-y-4">
      {/* Header is now handled inside RequestListClient to match other screens */}
      
      <RequestListClient requests={requests} />

      <div className="flex-none text-center text-xs text-white/30 pt-2 border-t border-white/5">
        {totalPending > requests.length 
            ? `Showing recent ${requests.length} of ${totalPending} pending requests.` 
            : `Showing all ${requests.length} pending requests.`}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/clinics/ClinicListClient.tsx
// portal/app/portal/admin/clinics/ClinicListClient.tsx
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";
import ClinicForm from "@/components/ClinicForm";
import { AdminTabs } from "@/components/AdminTabs";

// eslint-disable-next-line @typescript-eslint/no-explicit-any
export default function ClinicListClient({ clinics }: { clinics: any[] }) {
  const router = useRouter();
  const [editingClinic, setEditingClinic] = useState<any | null>(null);
  const [isCreating, setIsCreating] = useState(false);

  async function handleDelete(id: string) {
    if (!confirm("Delete this clinic? Warning: This will fail if users are linked.")) return;
    const res = await fetch(`/api/clinics/${id}`, { method: "DELETE" });
    if (res.ok) router.refresh();
    else alert("Failed to delete");
  }

  return (
    <div className="flex-1 min-h-0 flex flex-col space-y-4">
      {/* Header */}
      <div className="flex-none flex items-center justify-between">
         <div className="flex items-center gap-4">
            <h1 className="text-2xl font-semibold text-foreground hidden sm:block">Admin</h1>
            <div className="h-6 w-px bg-border hidden sm:block" />
            <AdminTabs />
         </div>
        
        <button 
          onClick={() => setIsCreating(true)} 
          className="px-3 py-1.5 rounded-lg bg-accent text-white text-sm hover:bg-accent/80 transition font-medium"
        >
          + New Clinic
        </button>
      </div>

      {/* Table Container */}
      <div className="flex-1 min-h-0 rounded-xl border border-border bg-surface overflow-hidden flex flex-col shadow-2xl">
        <div className="flex-1 overflow-auto custom-scrollbar">
          <table className="w-full text-left text-sm min-w-[600px]">
            <thead className="bg-surface text-muted sticky top-0 backdrop-blur-md z-10 border-b border-border">
              <tr>
                <th className="p-4 font-medium">Clinic Name</th>
                <th className="p-4 font-medium">City/State</th>
                <th className="p-4 font-medium">Users</th>
                <th className="p-4 font-medium">Cases</th>
                <th className="p-4 font-medium text-right">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-border">
              {clinics.map((c) => (
                <tr key={c.id} className="hover:bg-[var(--accent-dim)] transition-colors group">
                  <td className="p-4 font-medium text-foreground">{c.name}</td>
                  <td className="p-4 text-muted">
                    {c.address ? `${c.address.city || ''} ${c.address.state || ''}` : "—"}
                  </td>
                  <td className="p-4 text-muted">
                    <span className="bg-surface border border-border px-2 py-0.5 rounded text-xs">
                        {c._count.users}
                    </span>
                  </td>
                  <td className="p-4 text-muted">
                    <span className="bg-surface border border-border px-2 py-0.5 rounded text-xs">
                        {c._count.cases}
                    </span>
                  </td>
                  <td className="p-4 text-right">
                    <div className="flex justify-end gap-3 opacity-60 group-hover:opacity-100 transition-opacity">
                      <button onClick={() => setEditingClinic(c)} className="text-accent hover:text-white transition-colors font-medium">Edit</button>
                      <button onClick={() => handleDelete(c.id)} className="text-red-400 hover:text-red-300 transition-colors font-medium">Delete</button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {(isCreating || editingClinic) && (
        <ClinicForm 
          initialData={editingClinic}
          onClose={() => { setEditingClinic(null); setIsCreating(false); }}
        />
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/clinics/page.tsx
// portal/app/portal/admin/clinics/page.tsx
import { prisma } from "@/lib/prisma";
import ClinicListClient from "./ClinicListClient";

export const dynamic = "force-dynamic";

export default async function ClinicsPage() {
  const totalClinics = await prisma.clinic.count();

  const clinics = await prisma.clinic.findMany({ 
    orderBy: { name: "asc" },
    take: 50, // ✅ LIMIT
    include: { 
      address: true,
      _count: { 
        select: { users: true, cases: true } 
      } 
    }
  });

  return (
    <div className="flex flex-col h-full space-y-4">
      <ClinicListClient clinics={clinics} />

      <div className="flex-none text-center text-xs text-white/30 pt-2 border-t border-white/5">
        {totalClinics > clinics.length 
            ? `Showing first ${clinics.length} of ${totalClinics} clinics.` 
            : `Showing all ${clinics.length} clinics.`}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/addresses/AddressListClient.tsx
// portal/app/portal/admin/addresses/AddressListClient.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { AdminTabs } from "@/components/AdminTabs";

export default function AddressListClient({ addresses }: { addresses: any[] }) {
  const router = useRouter();
  const [busyId, setBusyId] = useState<string | null>(null);
  
  async function deleteAddr(id: string, usageCount: number) {
    const confirmMsg = usageCount > 0 
      ? `This address is linked to ${usageCount} users/clinics. Delete anyway?`
      : "Delete this address?";
    if (!confirm(confirmMsg)) return;

    setBusyId(id);
    try {
        const res = await fetch(`/api/addresses/${id}`, { method: "DELETE" });
        if (res.ok) router.refresh();
        else alert("Failed to delete");
    } catch (e: any) {
        alert("Network error: " + e.message);
    } finally {
        setBusyId(null);
    }
  }

  return (
    <div className="flex-1 min-h-0 flex flex-col space-y-4">
      {/* Header */}
      <div className="flex-none flex items-center justify-between">
         <div className="flex items-center gap-4">
            <h1 className="text-2xl font-semibold text-foreground hidden sm:block">Admin</h1>
            <div className="h-6 w-px bg-border hidden sm:block" />
            <AdminTabs />
         </div>
      </div>

      {/* Table Container */}
      <div className="flex-1 min-h-0 rounded-xl border border-border bg-surface overflow-hidden flex flex-col shadow-2xl">
        <div className="flex-1 overflow-auto custom-scrollbar">
          <table className="w-full text-left text-sm min-w-[600px]">
            <thead className="bg-surface text-muted sticky top-0 backdrop-blur-md z-10 border-b border-border">
              <tr>
                <th className="p-4 font-medium">Street</th>
                <th className="p-4 font-medium">City/State</th>
                <th className="p-4 font-medium">Linked To</th>
                <th className="p-4 font-medium text-right">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-border">
              {addresses.map((a) => {
                const usage = a._count.users + a._count.clinics;
                const isBusy = busyId === a.id;
                return (
                  <tr key={a.id} className="hover:bg-[var(--accent-dim)] transition-colors group">
                    <td className="p-4 font-medium text-foreground">{a.street || "—"}</td>
                    <td className="p-4 text-muted">{a.city}, {a.state} {a.zipCode}</td>
                    <td className="p-4 text-muted">
                      {usage > 0 ? (
                          <span className="px-2 py-0.5 rounded bg-blue-500/10 text-blue-400 text-xs border border-blue-500/20 font-medium">
                              {usage} Links
                          </span>
                      ) : (
                          <span className="text-muted/50 italic text-xs">Unused</span>
                      )}
                    </td>
                    <td className="p-4 text-right">
                      <button 
                          onClick={() => deleteAddr(a.id, usage)} 
                          disabled={isBusy}
                          className="text-red-400 hover:text-red-300 transition-colors font-medium opacity-60 group-hover:opacity-100 disabled:opacity-30"
                      >
                          {isBusy ? "..." : "Delete"}
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/addresses/page.tsx
// portal/app/portal/admin/addresses/page.tsx
import { prisma } from "@/lib/prisma";
import AddressListClient from "./AddressListClient";

export const dynamic = "force-dynamic";

export default async function AddressesPage() {
  const total = await prisma.address.count();

  const addresses = await prisma.address.findMany({
    orderBy: { createdAt: "desc" },
    take: 50, // ✅ LIMIT
    include: {
      _count: {
        select: { users: true, clinics: true }
      }
    }
  });

  return (
    <div className="flex flex-col h-full space-y-4">
      <AddressListClient addresses={addresses} />

      <div className="flex-none text-center text-xs text-white/30 pt-2 border-t border-white/5">
        {total > addresses.length 
            ? `Showing recent ${addresses.length} of ${total} addresses.` 
            : `Showing all ${addresses.length} addresses.`}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/layout.tsx
// portal/app/portal/admin/layout.tsx
import { getSession } from "@/lib/auth";
import { redirect } from "next/navigation";

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await getSession();
  if (!session || session.role !== "admin") redirect("/portal/cases");

  return (
    <div className="h-screen flex flex-col p-6 overflow-hidden">
      {/* HEADER REMOVED: Tabs and Title are now merged into the client pages for better alignment */}
      <div className="flex-1 min-h-0 flex flex-col">
        {children}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/users/UserListClient.tsx
// portal/app/portal/admin/users/UserListClient.tsx
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";
import UserForm from "@/components/UserForm";
import { AdminTabs } from "@/components/AdminTabs";

// eslint-disable-next-line @typescript-eslint/no-explicit-any
export default function UserListClient({ users, clinics }: { users: any[], clinics: any[] }) {
  const router = useRouter();
  const [editingUser, setEditingUser] = useState<any | null>(null);
  const [isCreating, setIsCreating] = useState(false);
  const [deletingId, setDeletingId] = useState<string | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  function requestDelete(id: string) { setDeletingId(id); }

  async function confirmDelete() {
    if (!deletingId) return;
    setIsDeleting(true);
    try {
      const res = await fetch(`/api/users/${deletingId}`, { method: "DELETE" });
      if (res.ok) {
        router.refresh();
        setDeletingId(null);
      } else {
        const j = await res.json();
        alert(j.error || "Failed to delete");
      }
    } catch (error) {
      alert("An error occurred while deleting.");
    } finally {
      setIsDeleting(false);
    }
  }

  // ✅ Helper to extract unique Sales Reps for the form
  const salesReps = users
    .filter(u => u.role === "sales")
    .map(u => ({ id: u.id, name: u.name, email: u.email }));

  return (
    <div className="flex-1 min-h-0 flex flex-col space-y-4">
      {/* Header */}
      <div className="flex-none flex items-center justify-between">
         <div className="flex items-center gap-4">
            <h1 className="text-2xl font-semibold text-foreground hidden sm:block">Admin</h1>
            <div className="h-6 w-px bg-border hidden sm:block" />
            <AdminTabs />
         </div>
        
        <button 
          onClick={() => setIsCreating(true)} 
          className="px-3 py-1.5 rounded-lg bg-accent text-white text-sm hover:bg-accent/80 transition font-medium"
        >
          + New User
        </button>
      </div>

      {/* Table Container */}
      <div className="flex-1 min-h-0 rounded-xl border border-border bg-surface overflow-hidden flex flex-col shadow-2xl">
        <div className="flex-1 overflow-auto custom-scrollbar">
          <table className="w-full text-left text-sm min-w-[600px]">
            <thead className="bg-surface text-muted sticky top-0 backdrop-blur-md z-10 border-b border-border">
              <tr>
                <th className="p-4 font-medium">Name</th>
                <th className="p-4 font-medium">Email</th>
                <th className="p-4 font-medium">Role</th>
                <th className="p-4 font-medium">Primary Clinic</th>
                <th className="p-4 font-medium text-right">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-border">
              {users.map((u) => (
                <tr key={u.id} className="hover:bg-[var(--accent-dim)] transition-colors group">
                  <td className="p-4 font-medium text-foreground">{u.name || "—"}</td>
                  <td className="p-4 text-muted">{u.email}</td>
                  <td className="p-4">
                    {/* ✅ UPDATED ROLE COLORS */}
                    <span className={`px-2 py-1 rounded text-xs font-semibold tracking-wide border ${
                      u.role === "admin" ? "bg-red-500/10 text-red-400 border-red-500/20" :
                      u.role === "lab" ? "bg-blue-500/10 text-blue-400 border-blue-500/20" :
                      u.role === "milling" ? "bg-purple-500/10 text-purple-400 border-purple-500/20" :
                      u.role === "sales" ? "bg-orange-500/10 text-orange-400 border-orange-500/20" : // ✅ Orange for Sales
                      "bg-emerald-500/10 text-emerald-400 border-emerald-500/20"
                    }`}>
                      {u.role.toUpperCase()}
                    </span>
                  </td>
                  <td className="p-4 text-muted">
                    {u.clinic?.name || <span className="text-muted/50 italic">None</span>}
                    {u.secondaryClinics && u.secondaryClinics.length > 0 && (
                        <span className="ml-2 text-[10px] text-muted border border-border px-1 rounded">
                            +{u.secondaryClinics.length} more
                        </span>
                    )}
                  </td>
                  <td className="p-4 text-right">
                    <div className="flex justify-end gap-3 opacity-60 group-hover:opacity-100 transition-opacity">
                      <button onClick={() => setEditingUser(u)} className="text-accent hover:text-white transition-colors font-medium">Edit</button>
                      <button onClick={() => requestDelete(u.id)} className="text-red-400 hover:text-red-300 transition-colors font-medium">Delete</button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {(isCreating || editingUser) && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
          <UserForm 
            clinics={clinics}
            salesReps={salesReps} // ✅ Pass Reps to Form
            initialData={editingUser}
            onClose={() => { setEditingUser(null); setIsCreating(false); }}
          />
        </div>
      )}

      {deletingId && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
          <div className="bg-surface border border-border rounded-xl p-6 max-w-sm w-full shadow-2xl">
            <h3 className="text-lg font-semibold text-foreground mb-2 text-red-400">Delete User?</h3>
            <p className="text-muted text-sm mb-6">Action cannot be undone.</p>
            <div className="flex justify-end gap-3">
              <button onClick={() => setDeletingId(null)} disabled={isDeleting} className="px-4 py-2 text-muted hover:text-foreground">Cancel</button>
              <button onClick={confirmDelete} disabled={isDeleting} className="px-4 py-2 bg-red-500 text-white rounded font-bold hover:bg-red-600">Delete</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/users/new/page.tsx
// portal/app/portal/admin/users/new/page.tsx
import { prisma } from "@/lib/prisma";
import NewUserForm from "@/components/UserForm";

export default async function NewUserPage() {
  // 1. Fetch data on the Server
  const clinics = await prisma.clinic.findMany({
    select: { id: true, name: true },
    orderBy: { name: "asc" },
  });

  // 2. Render the Client Component with data passed as props
  return (
    <div className="max-w-4xl mx-auto">
      <h1 className="text-2xl font-light text-white mb-8">Add New User</h1>
      <NewUserForm clinics={clinics} />
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/users/page.tsx
// portal/app/portal/admin/users/page.tsx
import { prisma } from "@/lib/prisma";
import UserListClient from "./UserListClient";
export const dynamic = "force-dynamic";

export default async function UsersPage() {
  // 1. Get Totals
  const totalUsers = await prisma.user.count();
  
  // 2. Fetch Users (Explicitly include salesRepId just in case)
  const users = await prisma.user.findMany({ 
    orderBy: { createdAt: "desc" },
    take: 50, 
    include: { 
      clinic: { select: { id: true, name: true } },
      secondaryClinics: { select: { id: true, name: true } },
      address: true,
      // The field 'salesRepId' is a scalar so it's fetched automatically, 
      // but if you want the NAME of the rep in the list later, you'd include:
      // salesRep: { select: { name: true } }
    }
  });

  // 3. Fetch all clinics
  const clinics = await prisma.clinic.findMany({ 
    select: { id: true, name: true }, 
    orderBy: { name: "asc" } 
  });

  return (
    <div className="flex flex-col h-full space-y-4">
      <UserListClient users={users} clinics={clinics} />
      
      <div className="flex-none text-center text-xs text-white/30 pt-2 border-t border-white/5">
        {totalUsers > users.length 
            ? `Showing recent ${users.length} of ${totalUsers} users.` 
            : `Showing all ${users.length} users.`}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/page.tsx
// portal/app/portal/admin/page.tsx
import { redirect } from "next/navigation";
export default function AdminPage() {
  redirect("/portal/admin/users");
}
--- END OF FILE ---

FILE: ./app/portal/cases/CasesFilterBar.tsx
// app/portal/cases/CasesFilterBar.tsx
"use client";

import { useRouter, useSearchParams } from "next/navigation";
import { useCallback, useEffect, useState } from "react";
import StatusFilter from "@/components/StatusFilter";

interface Props {
  role: string;
  isAdmin: boolean;
  isDoctor: boolean;
  labUsers: { id: string; name: string | null; email: string }[];
}

export default function CasesFilterBar({ role, isAdmin, isDoctor, labUsers }: Props) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [filters, setFilters] = useState({
    clinic: searchParams.get("clinic") || "",
    doctor: searchParams.get("doctor") || "",
    assignee: searchParams.get("assignee") || "",
    caseId: searchParams.get("caseId") || "",
    date: searchParams.get("date") || "",
    search: searchParams.get("search") || "",
    status: searchParams.getAll("status"),
  });
  const [debouncedFilters, setDebouncedFilters] = useState(filters);

  const updateInstant = (key: string, value: string | string[]) => {
    const newFilters = { ...filters, [key]: value };
    setFilters(newFilters);
    setDebouncedFilters(newFilters);
  };

  const updateText = (key: string, value: string) => {
    setFilters(prev => ({ ...prev, [key]: value }));
  };

  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedFilters(filters);
    }, 500);
    return () => clearTimeout(timer);
  }, [filters]);

  useEffect(() => {
    const params = new URLSearchParams();
    if (debouncedFilters.clinic) params.set("clinic", debouncedFilters.clinic);
    if (debouncedFilters.doctor) params.set("doctor", debouncedFilters.doctor);
    if (debouncedFilters.assignee) params.set("assignee", debouncedFilters.assignee);
    if (debouncedFilters.caseId) params.set("caseId", debouncedFilters.caseId);
    if (debouncedFilters.date) params.set("date", debouncedFilters.date);
    if (debouncedFilters.search) params.set("search", debouncedFilters.search);
    debouncedFilters.status.forEach(s => params.append("status", s));
    router.replace(`?${params.toString()}`, { scroll: false });
  }, [debouncedFilters, router]);

  const hasFilters = Object.values(filters).some(v => v && v.length > 0);

  // Common input class for reuse
  const inputClass = "bg-background border border-border rounded-lg px-3 py-1.5 text-sm text-foreground placeholder:text-muted outline-none w-32 lg:w-40 focus:border-accent transition-colors duration-200";

  return (
    <div className="flex flex-wrap gap-2 items-center bg-surface p-2 rounded-xl border border-border transition-colors duration-200">
      
      <StatusFilter 
        selected={filters.status} 
        role={role} 
        onChange={(val) => updateInstant("status", val)} 
      />
      
      <div className="w-px h-8 bg-border mx-1 hidden sm:block" />

      {!isDoctor && (
        <>
          {isAdmin && (
            <select 
                value={filters.assignee}
                onChange={(e) => updateInstant("assignee", e.target.value)}
                className="bg-background border border-border rounded-lg px-3 py-1.5 text-sm text-foreground outline-none w-32 lg:w-40 cursor-pointer focus:border-accent transition-colors duration-200"
            >
                <option value="">All Lab Users</option>
                {labUsers.map(u => (
                    <option key={u.id} value={u.id}>
                        {u.name || u.email}
                    </option>
                ))}
            </select>
          )}

          <input 
            placeholder="Clinic Name" 
            value={filters.clinic}
            onChange={(e) => updateText("clinic", e.target.value)}
            className={inputClass} 
          />
          <input 
            placeholder="Doctor Name" 
            value={filters.doctor}
            onChange={(e) => updateText("doctor", e.target.value)}
            className={inputClass} 
          />
          <input 
            placeholder="Case ID" 
            value={filters.caseId}
            onChange={(e) => updateText("caseId", e.target.value)}
            className={`${inputClass} font-mono`} 
          />
          {/* ✅ FIX: Added max date to UI to discourage invalid years */}
          <input 
            type="date" 
            max="2100-12-31"
            value={filters.date}
            onChange={(e) => updateText("date", e.target.value)}
            className={inputClass} 
          />
        </>
      )}
      
      {isDoctor && (
        <input 
            placeholder="Search patient, alias, or case ID..." 
            value={filters.search}
            onChange={(e) => updateText("search", e.target.value)}
            className={`${inputClass} flex-1 min-w-[200px]`} 
        />
      )}
      
      {hasFilters && (
         <button 
            onClick={() => {
              setFilters({ clinic:"", doctor:"", assignee:"", caseId:"", date:"", search:"", status:[] });
              setDebouncedFilters({ clinic:"", doctor:"", assignee:"", caseId:"", date:"", search:"", status:[] });
            }} 
            className="px-3 py-1.5 text-sm text-muted hover:text-foreground hover:bg-[var(--accent-dim)] rounded-lg transition-colors duration-200 cursor-pointer"
         >
            Clear
         </button>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/milling/MillingDashboard.tsx
// portal/app/portal/cases/milling/MillingDashboard.tsx
"use client";

import { useState, useMemo } from "react";
import { useRouter, useSearchParams } from "next/navigation"; 
import { CaseRow } from "../page";
import MillingHeader from "./MillingHeader";
import MillingFilters from "./MillingFilters";
import MillingTable from "./MillingTable";
import ShippingModal from "./ShippingModal";
import { calculateProductionCosts } from "@/lib/cost-engine";
import { ShippingTarget } from "@/lib/types";

type SortConfig = {
  key: string | null;
  direction: "asc" | "desc" | null;
};

interface MillingDashboardProps {
  cases: CaseRow[];
  totalCount: number;
  uniqueDoctors: string[];
  uniqueZips: string[];
}

export default function MillingDashboard({ cases, totalCount, uniqueDoctors, uniqueZips }: MillingDashboardProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [sortConfig, setSortConfig] = useState<SortConfig>({ key: null, direction: null });

  const [isDownloading, setIsDownloading] = useState(false);
  const [isShipping, setIsShipping] = useState(false);
  const [isSavingShipment, setIsSavingShipment] = useState(false);
  const [loadingMore, setLoadingMore] = useState(false);

  // --- PAGINATION HANDLER ---
  const handleLoadMore = () => {
    setLoadingMore(true);
    const params = new URLSearchParams(searchParams.toString());
    const currentLimit = parseInt(params.get("limit") || "50");
    const newLimit = currentLimit + 50;
    params.set("limit", newLimit.toString());
    
    router.replace(`?${params.toString()}`, { scroll: false });
    setTimeout(() => setLoadingMore(false), 2000);
  };

  // --- SORTING LOGIC ---
  const sortedCases = useMemo(() => {
    if (!sortConfig.key || !sortConfig.direction) return cases;
    return [...cases].sort((a, b) => {
      let aVal: any = "";
      let bVal: any = "";
      switch (sortConfig.key) {
        case "id": aVal = a.id; bVal = b.id; break;
        case "alias": aVal = a.patientAlias; bVal = b.patientAlias; break;
        case "doctor": aVal = a.doctorUser?.name || a.doctorName || ""; bVal = b.doctorUser?.name || b.doctorName || ""; break;
        case "zip": aVal = a.doctorUser?.address?.zipCode || ""; bVal = b.doctorUser?.address?.zipCode || ""; break;
        case "product": aVal = a.product; bVal = b.product; break;
        case "status": aVal = a.status; bVal = b.status; break;
        case "approved": aVal = new Date(a.updatedAt).getTime(); bVal = new Date(b.updatedAt).getTime(); break;
        case "due": aVal = a.dueDate ? new Date(a.dueDate).getTime() : 0; bVal = b.dueDate ? new Date(b.dueDate).getTime() : 0; break;
      }
      if (aVal < bVal) return sortConfig.direction === "asc" ? -1 : 1;
      if (aVal > bVal) return sortConfig.direction === "asc" ? 1 : -1;
      return 0;
    });
  }, [cases, sortConfig]);

  const handleSort = (key: string) => {
    setSortConfig((current) => {
      if (current.key !== key) return { key, direction: "asc" };
      if (current.direction === "asc") return { key, direction: "desc" };
      return { key: null, direction: null };
    });
  };

  const toggleSelectAll = () => {
    if (selectedIds.size === cases.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(cases.map(c => c.id)));
    }
  };

  const toggleSelect = (id: string) => {
    const next = new Set(selectedIds);
    if (next.has(id)) next.delete(id);
    else next.add(id);
    setSelectedIds(next);
  };

  const hasSelection = selectedIds.size > 0;
  const canShip = useMemo(() => {
    if (!hasSelection) return false;
    const selectedCases = cases.filter(c => selectedIds.has(c.id));
    return selectedCases.every(c => c.status === "IN_MILLING");
  }, [selectedIds, cases, hasSelection]);
  
  const canDownload = hasSelection;

  const batchMetrics = useMemo(() => {
    let totalCost = 0;
    const clinics = new Set<string>();
    const doctors = new Set<string>();
    let shipTarget: ShippingTarget | null = null;

    for (const c of cases) {
        if (selectedIds.has(c.id)) {
            const costs = calculateProductionCosts(c.product, c.material, 1, false); 
            totalCost += costs.milling;

            if (c.clinic?.name) clinics.add(c.clinic.name);
            const docName = c.doctorUser?.name || c.doctorName || "Unknown";
            doctors.add(docName);

            if (!shipTarget && c.doctorUser?.address) {
                const phone = c.clinic.phone || c.doctorUser.phoneNumber || "No Phone";
                shipTarget = {
                    name: docName,
                    attn: null,
                    phone: phone,
                    street: c.doctorUser.address.street, 
                    city: c.doctorUser.address.city,
                    state: c.doctorUser.address.state,
                    zip: c.doctorUser.address.zipCode
                };
            }
        }
    }

    if (shipTarget && doctors.size > 1) {
        const clinicName = Array.from(clinics)[0] || "Dental Clinic";
        const docList = Array.from(doctors).join(", ");
        shipTarget.name = clinicName;
        shipTarget.attn = `Attn: ${docList}`;
    }

    return {
        value: totalCost,
        isMixed: clinics.size > 1,
        uniqueClinics: Array.from(clinics),
        destination: shipTarget
    };
  }, [selectedIds, cases]);

  const handleDownload = async () => {
    if (!canDownload) return;
    setIsDownloading(true);
    try {
      const res = await fetch("/api/cases/batch/download", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids: Array.from(selectedIds) })
      });
      if (!res.ok) throw new Error("Download failed");
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `production_batch_${new Date().toISOString().slice(0,10)}.zip`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      window.location.reload();
    } catch {
      alert("Failed to generate batch.");
    } finally {
      setIsDownloading(false);
    }
  };

  const handleShipConfirm = async (carrier: string, tracking: string, shippingCost?: number) => {
    setIsSavingShipment(true);
    try {
      const res = await fetch("/api/cases/batch/ship", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids: Array.from(selectedIds), carrier, tracking, shippingCost })
      });
      if (!res.ok) throw new Error("Failed");
      setIsShipping(false);
      setSelectedIds(new Set());
      window.location.reload();
    } catch {
      alert("Shipping update failed.");
    } finally {
      setIsSavingShipment(false);
    }
  };

  return (
    <section className="flex flex-col h-full w-full p-6 overflow-hidden relative">
      <div className="flex-none space-y-4 mb-4">
        <MillingHeader 
          queueCount={sortedCases.length}
          selectedCount={selectedIds.size}
          isDownloading={isDownloading}
          canDownload={canDownload}
          canShip={canShip}
          onDownload={handleDownload}
          onShip={() => setIsShipping(true)}
        />
        <MillingFilters 
          uniqueDoctors={uniqueDoctors}
          uniqueZips={uniqueZips}
        />
      </div>

      <MillingTable 
        cases={sortedCases}
        selectedIds={selectedIds}
        sortConfig={sortConfig}
        onSort={handleSort}
        onSelect={toggleSelect}
        onSelectAll={toggleSelectAll}
        totalCount={totalCount}
        onLoadMore={handleLoadMore}
        loadingMore={loadingMore}
      />

      <ShippingModal 
        isOpen={isShipping}
        count={selectedIds.size}
        batchValue={batchMetrics.value}
        isMixedBatch={batchMetrics.isMixed}
        uniqueClinics={batchMetrics.uniqueClinics}
        destination={batchMetrics.destination}
        onClose={() => setIsShipping(false)}
        onConfirm={handleShipConfirm}
        isSaving={isSavingShipment}
      />
    </section>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/milling/ShippingModal.tsx
// FILE: app/portal/cases/milling/ShippingModal.tsx

"use client";

import { useState, useMemo } from "react";
import { ShippingTarget } from "@/lib/types"; // ✅ Import Shared Type

interface Props {
  isOpen: boolean;
  count: number;
  batchValue: number;
  isMixedBatch: boolean;
  uniqueClinics: string[];
  destination: ShippingTarget | null; // ✅ Use explicit Type
  onClose: () => void;
  onConfirm: (carrier: string, tracking: string, cost?: number) => void;
  isSaving: boolean;
}

export default function ShippingModal({ 
  isOpen, count, batchValue, 
  isMixedBatch, uniqueClinics, destination,
  onClose, onConfirm, isSaving 
}: Props) {
  const [carrier, setCarrier] = useState("UPS");
  const [otherCarrier, setOtherCarrier] = useState("");
  const [tracking, setTracking] = useState("");
  const [shippingCost, setShippingCost] = useState(""); 

  const tier = useMemo(() => {
    if (batchValue >= 300) return { label: "Free Standard Overnight", color: "text-purple-400", bg: "bg-purple-500/10", free: true };
    if (batchValue >= 200) return { label: "Free 2-Day Shipping", color: "text-blue-400", bg: "bg-blue-500/10", free: true };
    if (batchValue >= 90) return { label: "Free UPS Ground", color: "text-emerald-400", bg: "bg-emerald-500/10", free: true };
    return { label: "Paid Shipping Required", color: "text-orange-400", bg: "bg-orange-500/10", free: false };
  }, [batchValue]);

  const handleSubmit = () => {
    const finalCarrier = carrier === "Other" ? otherCarrier : carrier;
    if (!finalCarrier) return alert("Please specify a carrier.");
    if (!tracking) return alert("Please enter a tracking number.");
    
    if (!tier.free && !shippingCost) {
        return alert("Batch value is under $90. Please enter the shipping cost.");
    }

    onConfirm(finalCarrier, tracking, tier.free ? 0 : Number(shippingCost));
  };

  const formatMoney = (n: number) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);

  if (!isOpen) return null;

  return (
    <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
      <div className="w-full max-w-md bg-surface border border-border rounded-xl p-6 shadow-2xl space-y-5 animate-in fade-in zoom-in-95 duration-200 overflow-hidden">
        
        {/* Header */}
        <div>
            <h3 className="text-lg font-semibold text-foreground">Ship Batch</h3>
            <p className="text-sm text-muted">
            Applying shipment to <span className="text-foreground font-bold">{count}</span> cases.
            </p>
        </div>

        {/* ⚠️ Mixed Batch Warning */}
        {isMixedBatch && (
            <div className="bg-yellow-500/10 border border-yellow-500/30 p-3 rounded-lg flex gap-3 items-start">
                <svg className="w-5 h-5 text-yellow-500 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <div>
                    <h4 className="text-sm font-bold text-yellow-500">Mixed Clinic Batch</h4>
                    <p className="text-xs text-foreground/70 mt-1 leading-relaxed">
                        You selected cases from <strong className="text-foreground">{uniqueClinics.length} different clinics</strong>. 
                        Ensure you are physically shipping these to the same location, or create separate batches.
                    </p>
                    <div className="mt-2 flex flex-wrap gap-1">
                        {uniqueClinics.map(c => (
                            <span key={c} className="text-[10px] px-2 py-0.5 bg-yellow-500/20 text-yellow-200 rounded border border-yellow-500/20 truncate max-w-[150px]">
                                {c}
                            </span>
                        ))}
                    </div>
                </div>
            </div>
        )}

        {/* 📍 Shipping Destination Card */}
        {!isMixedBatch && destination ? (
            <div className="bg-white text-black p-4 rounded-lg shadow-lg border border-white/20 relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500" />
                
                <div className="flex justify-between items-start mb-2">
                    <span className="text-[10px] font-extrabold uppercase tracking-widest text-black/40">Ship To</span>
                    
                    <div className="flex items-center gap-1 bg-black/5 px-2 py-0.5 rounded text-[10px] font-bold text-black/60 border border-black/5">
                        <svg className="w-3 h-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                        {destination.phone || "No Phone"}
                    </div>
                </div>

                <div className="font-mono text-sm leading-tight space-y-1">
                    <div className="font-bold text-lg uppercase tracking-tight">{destination.name}</div>
                    
                    {destination.attn && (
                        <div className="text-xs font-bold text-black/50 uppercase">{destination.attn}</div>
                    )}
                    
                    <div className="border-t border-black/10 my-1 pt-1"></div>
                    
                    <div>{destination.street}</div>
                    <div>{destination.city}, {destination.state} {destination.zip}</div>
                </div>
            </div>
        ) : !isMixedBatch && (
            <div className="p-3 rounded-lg border border-red-500/30 bg-red-500/10 text-red-300 text-xs text-center">
                ⚠️ Missing address information. Please check doctor profile.
            </div>
        )}

        {/* 💰 Batch Value */}
        <div className="bg-surface rounded-lg p-3 border border-border space-y-2">
            <div className="flex justify-between items-center text-sm">
                <span className="text-muted">Batch Value (Haus)</span>
                <span className="font-bold text-foreground">{formatMoney(batchValue)}</span>
            </div>
            
            <div className={`p-2 rounded text-xs font-bold text-center border border-border ${tier.bg} ${tier.color}`}>
                {tier.label}
            </div>
        </div>

        {/* Inputs */}
        <div className="space-y-3">
            <div className="grid grid-cols-2 gap-3">
                <div className="col-span-2 sm:col-span-1">
                    <label className="text-xs font-bold text-muted uppercase block mb-1">Carrier</label>
                    <select
                        className="w-full bg-surface-highlight border border-border rounded-lg p-2 text-foreground outline-none focus:border-accent"
                        value={carrier}
                        onChange={(e) => setCarrier(e.target.value)}
                    >
                        <option value="UPS">UPS</option>
                        <option value="FedEx">FedEx</option>
                        <option value="USPS">USPS</option>
                        <option value="DHL">DHL</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div className="col-span-2 sm:col-span-1">
                    <label className="text-xs font-bold text-muted uppercase block mb-1">Tracking</label>
                    <input
                        className="w-full bg-surface-highlight border border-border rounded-lg p-2 text-foreground outline-none focus:border-accent"
                        placeholder="1ZA..."
                        value={tracking}
                        onChange={(e) => setTracking(e.target.value)}
                    />
                </div>
            </div>

            {carrier === "Other" && (
                <input
                    className="w-full bg-surface-highlight border border-border rounded-lg p-2 text-foreground outline-none focus:border-accent"
                    placeholder="Enter Carrier Name..."
                    value={otherCarrier}
                    onChange={(e) => setOtherCarrier(e.target.value)}
                />
            )}

            {!tier.free && (
                <div className="animate-in fade-in bg-orange-500/5 p-3 rounded-lg border border-orange-500/20">
                    <label className="text-xs font-bold text-orange-400 uppercase block mb-1">Shipping Cost ($)</label>
                    <input
                        type="number"
                        className="w-full bg-surface-highlight border border-orange-500/30 rounded-lg p-2 text-foreground outline-none focus:border-orange-500"
                        placeholder="0.00"
                        value={shippingCost}
                        onChange={(e) => setShippingCost(e.target.value)}
                    />
                </div>
            )}
        </div>

        {/* Actions */}
        <div className="flex justify-end gap-2 pt-2 border-t border-border">
          <button
            onClick={onClose}
            className="px-4 py-2 text-muted hover:text-foreground transition"
            disabled={isSaving}
          >
            Cancel
          </button>
          <button
            onClick={handleSubmit}
            disabled={isSaving || !tracking || (carrier === "Other" && !otherCarrier)}
            className="px-6 py-2 bg-accent text-white font-bold rounded-lg hover:bg-accent/80 transition disabled:opacity-50"
          >
            {isSaving ? "Saving..." : "Confirm Shipment"}
          </button>
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/milling/MillingTable.tsx
// portal/app/portal/cases/milling/MillingTable.tsx
"use client";

import { CaseRow } from "../page";

type SortConfig = {
  key: string | null;
  direction: "asc" | "desc" | null;
};

interface Props {
  cases: CaseRow[];
  selectedIds: Set<string>;
  sortConfig: SortConfig;
  onSort: (key: string) => void;
  onSelect: (id: string) => void;
  onSelectAll: () => void;
  // ✅ Pagination Props
  totalCount: number;
  onLoadMore: () => void;
  loadingMore: boolean;
}

const fmtDate = (d?: Date | string | null) => {
  if (!d) return "—";
  return new Date(d).toLocaleDateString();
};

const SortableHeader = ({ 
  label, 
  colKey, 
  align = "left",
  sortConfig, 
  onSort 
}: { 
  label: string, 
  colKey: string, 
  align?: string,
  sortConfig: SortConfig, 
  onSort: (k: string) => void 
}) => {
  const isActive = sortConfig.key === colKey;
  return (
    <th 
      className={`
        p-4 font-medium cursor-pointer transition-all select-none text-${align} group border-b-2 outline-none
        ${isActive 
          ? "text-accent border-accent" 
          : "text-muted border-transparent hover:text-foreground hover:bg-[var(--accent-dim)]"
        }
      `}
      onClick={() => onSort(colKey)}
    >
      <div className={`flex items-center ${align === "right" ? "justify-end" : ""}`}>
        {label}
        {isActive && (
          <span className="text-accent ml-2 text-xs">
            {sortConfig.direction === "asc" ? "▲" : "▼"}
          </span>
        )}
      </div>
    </th>
  );
};

export default function MillingTable({ 
  cases, 
  selectedIds, 
  sortConfig, 
  onSort, 
  onSelect, 
  onSelectAll,
  totalCount,
  onLoadMore,
  loadingMore
}: Props) {
  const allSelected = cases.length > 0 && selectedIds.size === cases.length;

  return (
    // ✅ FIX: Rounded corners & Overflow handling
    <div className="flex-1 min-h-0 rounded-xl border border-border bg-surface overflow-hidden flex flex-col shadow-2xl">
      <div className="flex-1 overflow-y-auto custom-scrollbar">
        <table className="w-full text-sm text-left border-collapse">
          <thead className="bg-surface sticky top-0 backdrop-blur-md z-10 border-b border-border">
            <tr>
              <th className="p-4 w-10 border-b-2 border-transparent">
                <input
                  type="checkbox"
                  onChange={onSelectAll}
                  checked={allSelected}
                  className="accent-blue-500"
                />
              </th>
              <SortableHeader label="Case ID" colKey="id" sortConfig={sortConfig} onSort={onSort} />
              <SortableHeader label="Alias" colKey="alias" sortConfig={sortConfig} onSort={onSort} />
              <SortableHeader label="Doctor" colKey="doctor" sortConfig={sortConfig} onSort={onSort} />
              <SortableHeader label="Zip Code" colKey="zip" sortConfig={sortConfig} onSort={onSort} />
              <SortableHeader label="Product Details" colKey="product" sortConfig={sortConfig} onSort={onSort} />
              <SortableHeader label="Status" colKey="status" sortConfig={sortConfig} onSort={onSort} />
              <SortableHeader label="Date Approved" colKey="approved" sortConfig={sortConfig} onSort={onSort} />
              <SortableHeader label="Due Date" colKey="due" sortConfig={sortConfig} onSort={onSort} />
            </tr>
          </thead>
          <tbody className="divide-y divide-border">
            {cases.map((c) => (
              <tr
                key={c.id}
                className={`hover:bg-[var(--accent-dim)] transition-colors ${selectedIds.has(c.id) ? "bg-[var(--accent-dim)]" : ""}`}
              >
                <td className="p-4">
                  <input
                    type="checkbox"
                    checked={selectedIds.has(c.id)}
                    onChange={() => onSelect(c.id)}
                    className="accent-blue-500"
                  />
                </td>
                <td className="p-4 font-mono text-blue-400 select-all">#{c.id.slice(-6)}</td>
                <td className="p-4 font-medium text-foreground">{c.patientAlias}</td>
                <td className="p-4 font-medium text-foreground">
                  {c.doctorUser?.name || c.doctorName || <span className="text-muted italic">Unknown</span>}
                </td>
                <td className="p-4 text-muted font-mono">
                  {c.doctorUser?.address?.zipCode || <span className="text-muted">-</span>}
                </td>
                <td className="p-4">
                  <div className="flex flex-col">
                    <span className="text-foreground font-medium">{c.product}</span>
                    <span className="text-xs text-muted">
                      {c.material ? `${c.material} • ` : ""}
                      {c.serviceLevel?.replace(/_/g, " ") || "Standard"}
                    </span>
                  </div>
                </td>
                <td className="p-4">
                  <span
                    className={`px-2 py-1 rounded text-xs font-semibold tracking-wide border
                       ${
                         c.status === "APPROVED"
                           ? "bg-emerald-500/10 text-emerald-400 border-emerald-500/20"
                           : c.status === "IN_MILLING"
                           ? "bg-purple-500/10 text-purple-400 border-purple-500/20"
                           : c.status === "SHIPPED"
                           ? "bg-blue-500/10 text-blue-400 border-blue-500/20"
                           : "bg-white/5 text-white/50 border-white/10"
                       }`}
                  >
                    {c.status.replace(/_/g, " ")}
                  </span>
                </td>
                <td className="p-4 text-muted">{fmtDate(c.updatedAt)}</td>
                <td className="p-4 text-muted">{fmtDate(c.dueDate)}</td>
              </tr>
            ))}
            {cases.length === 0 && (
              <tr>
                <td colSpan={9} className="p-12 text-center text-muted">
                  No cases found.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {/* ✅ UNIFIED FOOTER: Fixed Height h-14 to avoid shrinkage */}
      <div className="flex-none h-14 p-3 border-t border-border bg-surface flex items-center justify-between">
        <span className="text-xs text-muted pl-2">
          Showing {cases.length} of {totalCount} records (Milling Queue)
        </span>
        
        {cases.length < totalCount && (
          <button
            onClick={onLoadMore}
            disabled={loadingMore}
            className="text-xs font-bold text-foreground hover:text-accent px-3 py-1.5 rounded-lg bg-surface hover:bg-[var(--accent-dim)] border border-border transition-colors flex items-center gap-2"
          >
            {loadingMore ? (
              <>
                <div className="w-3 h-3 border-2 border-muted border-t-foreground rounded-full animate-spin" />
                Loading...
              </>
            ) : "Load More"}
          </button>
        )}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/milling/MillingFilters.tsx
// portal/app/portal/cases/milling/MillingFilters.tsx
"use client";

import { useRouter, useSearchParams } from "next/navigation";
import { useCallback } from "react";

interface Props {
  uniqueDoctors: string[];
  uniqueZips: string[];
}

export default function MillingFilters({ uniqueDoctors, uniqueZips }: Props) {
  const router = useRouter();
  const searchParams = useSearchParams();

  // Initialize state from URL
  const currentStatuses = new Set(searchParams.getAll("status"));
  const showShipped = searchParams.get("showShipped") === "true";
  const doctorFilter = searchParams.get("doctor") || "ALL";
  const zipFilter = searchParams.get("zip") || "ALL";

  // If no status in URL, default to APPROVED + IN_MILLING (Initial Load)
  if (currentStatuses.size === 0 && !searchParams.has("status")) {
    currentStatuses.add("APPROVED");
    currentStatuses.add("IN_MILLING");
  }

  // Unified Update Function
  const update = useCallback((updates: { 
    status?: Set<string>, 
    showShipped?: boolean, 
    doctor?: string, 
    zip?: string 
  }) => {
    const params = new URLSearchParams(searchParams.toString());
    
    // 1. Reset Pagination on any filter change
    params.delete("limit");

    // 2. Handle Status
    if (updates.status !== undefined) {
      params.delete("status");
      updates.status.forEach(s => params.append("status", s));
    }

    // 3. Handle Shipped Toggle
    if (updates.showShipped !== undefined) {
        if (updates.showShipped) params.set("showShipped", "true");
        else params.delete("showShipped");
    }

    // 4. Handle Dropdowns
    if (updates.doctor !== undefined) {
        if (updates.doctor !== "ALL") params.set("doctor", updates.doctor);
        else params.delete("doctor");
    }

    if (updates.zip !== undefined) {
        if (updates.zip !== "ALL") params.set("zip", updates.zip);
        else params.delete("zip");
    }

    router.replace(`?${params.toString()}`, { scroll: false });
  }, [searchParams, router]);

  const toggleStatus = (status: string) => {
    const next = new Set(currentStatuses);
    if (next.has(status)) next.delete(status);
    else next.add(status);
    update({ status: next });
  };

  return (
    <div className="flex flex-wrap gap-2 items-center bg-surface p-2 rounded-xl border border-border">
      {/* Status Checkboxes */}
      <div className="flex items-center gap-2 px-3 py-1.5 bg-surface border border-border rounded-lg">
        <label className="flex items-center gap-2 text-sm text-foreground cursor-pointer select-none">
          <input 
            type="checkbox" 
            checked={currentStatuses.has("APPROVED")} 
            onChange={() => toggleStatus("APPROVED")} 
            className="accent-emerald-500" 
          />
          Approved
        </label>
        <div className="w-px h-4 bg-border mx-1" />
        <label className="flex items-center gap-2 text-sm text-foreground cursor-pointer select-none">
          <input 
            type="checkbox" 
            checked={currentStatuses.has("IN_MILLING")} 
            onChange={() => toggleStatus("IN_MILLING")} 
            className="accent-purple-500" 
          />
          In Milling
        </label>
      </div>

      <div className="w-px h-6 bg-border mx-2" />

      {/* Doctor Filter */}
      <select
        className="bg-surface border border-border rounded-lg px-3 py-1.5 text-sm text-foreground outline-none focus:border-accent transition-colors"
        value={doctorFilter}
        onChange={(e) => update({ doctor: e.target.value })}
      >
        <option value="ALL">All Doctors</option>
        {(uniqueDoctors || []).map((d) => (
          <option key={d} value={d}>{d}</option>
        ))}
      </select>

      {/* Zip Filter */}
      <select
        className="bg-surface border border-border rounded-lg px-3 py-1.5 text-sm text-foreground outline-none focus:border-accent transition-colors"
        value={zipFilter}
        onChange={(e) => update({ zip: e.target.value })}
      >
        <option value="ALL">All Zip Codes</option>
        {(uniqueZips || []).map((z) => (
          <option key={z} value={z}>{z}</option>
        ))}
      </select>

      <div className="w-px h-6 bg-border mx-2" />

      {/* Show Shipped Toggle */}
      <label className="flex items-center gap-2 px-3 py-1.5 bg-surface border border-border rounded-lg text-sm text-foreground cursor-pointer select-none hover:bg-[var(--accent-dim)] transition">
        <input 
            type="checkbox" 
            checked={showShipped} 
            onChange={() => update({ showShipped: !showShipped })} 
            className="accent-accent" 
        />
        Show Shipped
      </label>

      {/* Clear Button */}
      {(doctorFilter !== "ALL" || zipFilter !== "ALL") && (
        <button
          onClick={() => update({ doctor: "ALL", zip: "ALL" })}
          className="px-3 py-1.5 text-sm text-muted hover:text-foreground hover:bg-[var(--accent-dim)] rounded-lg transition"
        >
          Clear
        </button>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/milling/finance/MillingFinanceStats.tsx
// portal/app/portal/cases/milling/finance/MillingFinanceStats.tsx
"use client";

import { formatCurrency } from "@/lib/pricing";

interface Props {
  totalDue: number;
  totalUnits: number;
  totalBatches: number;
}

export default function MillingFinanceStats({ totalDue, totalUnits, totalBatches }: Props) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
      {/* Total Due Card */}
      <div className="rounded-xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm shadow-lg flex flex-col items-center justify-center">
        <div className="flex items-center gap-2 mb-1">
          <div className="p-1.5 rounded-md bg-emerald-500/10 text-emerald-400">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <span className="text-sm font-medium text-white/60">Total Due</span>
        </div>
        <div className="text-3xl font-light text-white tracking-tight text-center">
          {formatCurrency(totalDue)}
        </div>
      </div>

      {/* Units Card */}
      <div className="rounded-xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm shadow-lg flex flex-col items-center justify-center">
        <div className="flex items-center gap-2 mb-1">
          <div className="p-1.5 rounded-md bg-blue-500/10 text-blue-400">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
          </div>
          <span className="text-sm font-medium text-white/60">Total Units</span>
        </div>
        <div className="text-3xl font-light text-white tracking-tight text-center">
          {totalUnits}
        </div>
      </div>

      {/* Shipments Card */}
      <div className="rounded-xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm shadow-lg flex flex-col items-center justify-center">
        <div className="flex items-center gap-2 mb-1">
          <div className="p-1.5 rounded-md bg-purple-500/10 text-purple-400">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
          </div>
          <span className="text-sm font-medium text-white/60">Shipments</span>
        </div>
        <div className="text-3xl font-light text-white tracking-tight text-center">
          {totalBatches}
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/milling/finance/MillingFinanceTable.tsx
// portal/app/portal/cases/milling/finance/MillingFinanceTable.tsx
"use client";

import { useState, Fragment } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { ChevronDown, ChevronRight } from "lucide-react";
import { formatCurrency } from "@/lib/pricing";

export default function MillingFinanceTable({ 
  batches, 
  totalCount, 
  currentLimit 
}: { 
  batches: any[], 
  totalCount: number, 
  currentLimit: number 
}) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [expandedBatches, setExpandedBatches] = useState<Set<string>>(new Set());
  const [loadingMore, setLoadingMore] = useState(false);

  const toggleBatch = (id: string) => {
    const next = new Set(expandedBatches);
    if (next.has(id)) next.delete(id);
    else next.add(id);
    setExpandedBatches(next);
  };

  const handleLoadMore = () => {
    setLoadingMore(true);
    const params = new URLSearchParams(searchParams.toString());
    const newLimit = currentLimit + 10;
    params.set("limit", newLimit.toString());
    router.replace(`?${params.toString()}`, { scroll: false });
    setTimeout(() => setLoadingMore(false), 1000);
  };

  if (batches.length === 0) {
    return (
      <div className="flex-1 flex items-center justify-center border border-white/10 rounded-xl bg-black/20">
        <p className="text-white/40">No shipped batches found.</p>
      </div>
    );
  }

  return (
    // ✅ FIX: Rounded corners & Overflow
    <div className="flex-1 flex flex-col min-h-0 rounded-xl border border-white/10 bg-black/20 overflow-hidden shadow-xl">
      <div className="flex-1 overflow-auto custom-scrollbar">
        <table className="w-full text-left text-sm border-collapse">
          <thead className="bg-black/60 text-white/70 sticky top-0 backdrop-blur-md z-10 border-b border-white/10">
            <tr>
              <th className="p-4 w-10"></th>
              <th className="p-4">Ship Date</th>
              <th className="p-4">Tracking / Carrier</th>
              <th className="p-4 text-center">Cases</th>
              <th className="p-4 text-right">Shipping Cost</th>
              <th className="p-4 text-right">Milling Fees</th>
              <th className="p-4 text-right">Total Owed</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-white/5">
            {batches.map((batch) => (
              <Fragment key={batch.id}>
                <tr 
                  onClick={() => toggleBatch(batch.id)}
                  className="hover:bg-white/5 cursor-pointer transition-colors group"
                >
                  <td className="p-4">
                    {expandedBatches.has(batch.id) ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                  </td>
                  <td className="p-4 font-medium">{new Date(batch.shippedAt).toLocaleDateString()}</td>
                  <td className="p-4">
                    <div className="flex flex-col">
                      <span className="text-xs text-white/40 uppercase font-bold">{batch.carrier}</span>
                      <span className="font-mono text-blue-400">{batch.tracking}</span>
                    </div>
                  </td>
                  <td className="p-4 text-center">
                    <span className="bg-white/5 px-2 py-1 rounded border border-white/10 text-xs">
                      {batch.cases.length} Units
                    </span>
                  </td>
                  <td className="p-4 text-right text-orange-400">{formatCurrency(batch.totalShipping)}</td>
                  <td className="p-4 text-right text-purple-400">{formatCurrency(batch.millingTotal)}</td>
                  <td className="p-4 text-right font-bold text-white">
                    {formatCurrency(batch.totalShipping + batch.millingTotal)}
                  </td>
                </tr>
                {expandedBatches.has(batch.id) && (
                  <tr>
                    <td colSpan={7} className="bg-black/40 p-0">
                      <div className="border-l-2 border-accent ml-6 my-2">
                        <table className="w-full text-xs text-white/60">
                          <thead className="text-[10px] uppercase tracking-wider text-white/30">
                            <tr>
                              <th className="px-4 py-2">Case ID</th>
                              <th className="px-4 py-2">Clinic</th>
                              <th className="px-4 py-2">Product</th>
                              <th className="px-4 py-2 text-right">Milling Fee</th>
                            </tr>
                          </thead>
                          <tbody>
                            {batch.cases.map((c: any) => (
                              <tr key={c.id} className="border-t border-white/5">
                                <td className="px-4 py-2 font-mono">#{c.id.slice(-6)}</td>
                                <td className="px-4 py-2">{c.clinic.name}</td>
                                <td className="px-4 py-2">{c.product} ({c.material || 'HT'})</td>
                                <td className="px-4 py-2 text-right">{formatCurrency(c.millingFee)}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </td>
                  </tr>
                )}
              </Fragment>
            ))}
          </tbody>
        </table>
      </div>

      {/* ✅ FIX: Fixed Height Footer (h-14) */}
      <div className="flex-none h-14 p-3 border-t border-white/5 bg-white/[0.02] flex items-center justify-between">
        <span className="text-xs text-white/40 pl-2">
          Showing {batches.length} of {totalCount} shipments
        </span>
        
        {batches.length < totalCount && (
          <button
            onClick={handleLoadMore}
            disabled={loadingMore}
            className="text-xs font-bold text-white/80 hover:text-white px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 transition-colors flex items-center gap-2"
          >
            {loadingMore ? "Loading..." : "Load More"}
          </button>
        )}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/milling/finance/page.tsx
// portal/app/portal/cases/milling/finance/page.tsx

import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { redirect } from "next/navigation";
import MillingFinanceTable from "./MillingFinanceTable";
import MillingFinanceFilters from "./MillingFinanceFilters";
import MillingFinanceStats from "./MillingFinanceStats"; // ✅ New Import
import { calculateProductionCosts } from "@/lib/cost-engine";

export const dynamic = "force-dynamic";

export default async function MillingFinancePage({
  searchParams,
}: {
  searchParams: Promise<{ month?: string; year?: string; q?: string; limit?: string }>;
}) {
  const session = await getSession();
  if (!session || (session.role !== "admin" && session.role !== "milling")) {
    redirect("/portal/cases");
  }

  const sp = await searchParams;
  const year = parseInt(sp.year || new Date().getFullYear().toString());
  const month = sp.month && sp.month !== "ALL" ? parseInt(sp.month) : undefined;
  const query = sp.q?.trim() || "";
  const limit = parseInt(sp.limit || "50");

  // --- 1. Build Base Filter ---
  const where: any = {
    shippingBatchId: { not: null }
  };

  // Date Filter
  if (month) {
    const start = new Date(year, month - 1, 1);
    const end = new Date(year, month, 0, 23, 59, 59);
    where.shippedAt = { gte: start, lte: end };
  } else {
    const start = new Date(year, 0, 1);
    const end = new Date(year, 11, 31, 23, 59, 59);
    where.shippedAt = { gte: start, lte: end };
  }

  // Text Search
  if (query) {
    where.OR = [
      { trackingNumber: { contains: query } },
      { shippingCarrier: { contains: query } },
      { shippingBatchId: { contains: query } },
      { clinic: { name: { contains: query } } }
    ];
  }

  // --- 2. Discovery & Aggregation Phase ---
  // We fetch ALL matching records to calculate the summary totals accurately
  const allMatchingCases = await prisma.dentalCase.findMany({
    where,
    select: {
      shippingBatchId: true,
      shippedAt: true,
      // Fields needed for Cost Calculation
      product: true,
      material: true,
      units: true,
      shippingCost: true,
      salesRepId: true
    },
    orderBy: { shippedAt: "desc" }
  });

  // Calculate Aggregates
  let totalMilling = 0;
  let totalShipping = 0;
  let totalUnits = 0;
  
  // Use a Set to track unique batches for pagination
  // We maintain order by pushing to array only when first seen
  const orderedUniqueBatchIds: string[] = [];
  const seenBatches = new Set<string>();

  for (const c of allMatchingCases) {
    // 1. Pagination List Builder
    if (c.shippingBatchId && !seenBatches.has(c.shippingBatchId)) {
        seenBatches.add(c.shippingBatchId);
        orderedUniqueBatchIds.push(c.shippingBatchId);
    }

    // 2. Financial Totals (Sum ALL matching cases)
    const costs = calculateProductionCosts(c.product, c.material, c.units, !!c.salesRepId);
    totalMilling += costs.milling;
    totalShipping += Number(c.shippingCost || 0);
    totalUnits += c.units;
  }

  const totalDue = totalMilling + totalShipping;
  const totalBatchCount = orderedUniqueBatchIds.length;

  // --- 3. Pagination Slice ---
  const targetBatchIds = orderedUniqueBatchIds.slice(0, limit);

  // --- 4. Data Phase: Fetch Full Data for Target Batches ---
  const cases = await prisma.dentalCase.findMany({
    where: {
      shippingBatchId: { in: targetBatchIds }
    },
    include: { clinic: true },
    orderBy: { shippedAt: "desc" }
  });

  // --- 5. Grouping & Serialization ---
  const batchMap: Record<string, any> = {};

  for (const c of cases) {
    const bid = c.shippingBatchId!;
    if (!batchMap[bid]) {
      batchMap[bid] = {
        id: bid,
        shippedAt: c.shippedAt,
        carrier: c.shippingCarrier,
        tracking: c.trackingNumber,
        totalShipping: 0,
        millingTotal: 0,
        cases: []
      };
    }

    const costs = calculateProductionCosts(c.product, c.material, c.units, !!c.salesRepId);
    
    batchMap[bid].cases.push({
      ...c,
      cost: Number(c.cost), 
      shippingCost: c.shippingCost ? Number(c.shippingCost) : 0,
      millingFee: costs.milling
    });

    batchMap[bid].totalShipping += Number(c.shippingCost || 0);
    batchMap[bid].millingTotal += costs.milling;
  }

  // Preserve Sort Order from the ID list
  const sortedBatches = targetBatchIds
    .map(id => batchMap[id])
    .filter(Boolean);

  return (
    <div className="flex flex-col h-full space-y-6 p-6 overflow-hidden">
      <header className="flex flex-col gap-4">
        <div>
          <h1 className="text-2xl font-semibold text-white">Haus Finance</h1>
          <p className="text-sm text-white/40">Track milling costs and shipping batch totals.</p>
        </div>
        
        <MillingFinanceFilters />
      </header>

      {/* ✅ Insert Summary Stats */}
      <MillingFinanceStats 
        totalDue={totalDue}
        totalUnits={totalUnits}
        totalBatches={totalBatchCount}
      />
      
      <MillingFinanceTable 
        batches={sortedBatches} 
        totalCount={totalBatchCount} 
        currentLimit={limit}
      />
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/milling/finance/MillingFinanceFilters.tsx
// portal/app/portal/cases/milling/finance/MillingFinanceFilters.tsx
"use client";

import { useRouter, useSearchParams } from "next/navigation";
import { useState, useEffect } from "react";

const MONTHS = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];

export default function MillingFinanceFilters() {
  const router = useRouter();
  const searchParams = useSearchParams();

  // Initialize from URL or defaults
  const [year, setYear] = useState(searchParams.get("year") || new Date().getFullYear().toString());
  const [month, setMonth] = useState(searchParams.get("month") || (new Date().getMonth() + 1).toString());
  const [query, setQuery] = useState(searchParams.get("q") || "");

  const years = Array.from({ length: 3 }, (_, i) => new Date().getFullYear() - i);

  // Debounce Search & Auto-Submit
  useEffect(() => {
    const timer = setTimeout(() => {
      const params = new URLSearchParams();
      if (year) params.set("year", year);
      if (month && month !== "ALL") params.set("month", month);
      if (query.trim()) params.set("q", query.trim());
      
      router.replace(`?${params.toString()}`, { scroll: false });
    }, 400);

    return () => clearTimeout(timer);
  }, [year, month, query, router]);

  return (
    <div className="flex flex-wrap items-center gap-3 bg-surface p-2 rounded-xl border border-border">
      
      {/* Year */}
      <select 
        value={year}
        onChange={(e) => setYear(e.target.value)}
        className="bg-surface-highlight border border-border rounded-lg px-3 py-1.5 text-sm text-foreground outline-none focus:border-accent/50 cursor-pointer hover:bg-[var(--accent-dim)] transition"
      >
        {years.map(y => <option key={y} value={y} className="bg-surface">{y}</option>)}
      </select>

      {/* Month */}
      <select 
        value={month}
        onChange={(e) => setMonth(e.target.value)}
        className="bg-surface-highlight border border-border rounded-lg px-3 py-1.5 text-sm text-foreground outline-none focus:border-accent/50 cursor-pointer hover:bg-[var(--accent-dim)] transition"
      >
        <option value="ALL" className="bg-surface">All Months</option>
        {MONTHS.map((m, i) => (
          <option key={m} value={i + 1} className="bg-surface">{m}</option>
        ))}
      </select>

      <div className="w-px h-6 bg-border mx-1 hidden sm:block" />

      {/* Search Input */}
      <div className="relative flex-1 min-w-[200px]">
        <input 
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="Search Tracking, Clinic, or Batch ID..."
          className="w-full bg-surface-highlight border border-border rounded-lg pl-9 pr-3 py-1.5 text-sm text-foreground outline-none focus:border-accent/50 placeholder-muted transition-all" 
        />
        <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>

      {/* Reset Button */}
      {(query || month !== "ALL") && (
        <button 
          onClick={() => { setQuery(""); setMonth("ALL"); }}
          className="text-xs text-muted hover:text-foreground px-2 transition-colors"
        >
          Reset
        </button>
      )}
    </div>
  );
}

--- END OF FILE ---

FILE: ./app/portal/cases/milling/MillingHeader.tsx
// portal/app/portal/cases/milling/MillingHeader.tsx
"use client";

interface Props {
  queueCount: number;
  selectedCount: number;
  isDownloading: boolean;
  canDownload: boolean;
  canShip: boolean;
  onDownload: () => void;
  onShip: () => void;
}

export default function MillingHeader({
  queueCount,
  selectedCount,
  isDownloading,
  canDownload,
  canShip,
  onDownload,
  onShip
}: Props) {
  return (
    <header className="flex items-center justify-between h-10">
      <div className="flex items-baseline gap-3">
        <h1 className="text-2xl font-semibold text-foreground">Milling Dashboard</h1>
        <span className="text-sm text-muted">Queue: {queueCount}</span>
      </div>

      <div className="flex items-center gap-2">
        <button
          onClick={onDownload}
          disabled={!canDownload || isDownloading}
          className={`
            px-4 py-2 bg-accent text-white font-bold rounded-lg transition flex items-center gap-2
            ${(!canDownload || isDownloading) ? "opacity-30 cursor-not-allowed" : "hover:bg-accent/80"}
          `}
        >
          {isDownloading ? "Zipping..." : `Download Batch (${selectedCount})`}
        </button>

        <button
          onClick={onShip}
          disabled={!canShip}
          className={`
            px-4 py-2 bg-accent text-white font-bold rounded-lg transition flex items-center gap-2
            ${!canShip ? "opacity-30 cursor-not-allowed" : "hover:bg-accent/80 shadow-lg"}
          `}
        >
          Ship Batch
        </button>
      </div>
    </header>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/CaseListClient.tsx
// app/portal/cases/CaseListClient.tsx
"use client";

import { useState, useMemo } from "react";
import { useRouter } from "next/navigation"; 
import CaseListRow from "@/components/CaseListRow";
import { CaseRow } from "./page";

type SortConfig = {
  key: string | null;
  direction: "asc" | "desc" | null;
};

interface Props {
  cases: CaseRow[];
  role: string;
  totalCount: number;
}

const SortableHeader = ({ 
  label, 
  colKey, 
  sortConfig, 
  onSort 
}: { 
  label: string, 
  colKey: string, 
  sortConfig: SortConfig, 
  onSort: (k: string) => void 
}) => {
  const isActive = sortConfig.key === colKey;

  return (
    <th 
      className={`
        p-4 font-medium cursor-pointer transition-colors duration-200 select-none group border-b outline-none whitespace-nowrap
        ${isActive 
          ? "text-accent border-accent" 
          : "border-transparent text-muted hover:text-foreground"
        }
      `}
      onClick={() => onSort(colKey)}
    >
      <div className={`flex items-center gap-1 ${colKey === "status" ? "justify-center" : ""}`}>
        {label}
        {isActive && (
          <span className="text-accent text-[10px] leading-none">
            {sortConfig.direction === "asc" ? "▲" : "▼"}
          </span>
        )}
      </div>
    </th>
  );
};

export default function CaseListClient({ cases, role, totalCount }: Props) {
  const router = useRouter();
  const isDoctor = role === "customer";
  
  const [sortConfig, setSortConfig] = useState<SortConfig>({ key: null, direction: null });
  const [loadingMore, setLoadingMore] = useState(false);

  const sortedCases = useMemo(() => {
    if (!sortConfig.key || !sortConfig.direction) return cases;
    
    return [...cases].sort((a, b) => {
      let aVal: any = "";
      let bVal: any = "";
      switch (sortConfig.key) {
        case "id": aVal = a.id; bVal = b.id; break;
        case "alias": aVal = a.patientAlias; bVal = b.patientAlias; break;
        case "clinic": aVal = a.clinic.name; bVal = b.clinic.name; break;
        case "doctor": aVal = a.doctorName || ""; bVal = b.doctorName || ""; break;
        case "patient": aVal = a.patientLastName || ""; bVal = b.patientLastName || ""; break;
        case "designer": aVal = a.assigneeUser?.name || ""; bVal = b.assigneeUser?.name || ""; break;
        case "tooth": aVal = a.toothCodes; bVal = b.toothCodes; break;
        case "status": aVal = a.status; bVal = b.status; break;
        case "due": aVal = a.dueDate ? new Date(a.dueDate).getTime() : 0; bVal = b.dueDate ? new Date(b.dueDate).getTime() : 0; break;
        case "created": aVal = new Date(a.createdAt).getTime(); bVal = new Date(b.createdAt).getTime(); break;
      }
      if (aVal < bVal) return sortConfig.direction === "asc" ? -1 : 1;
      if (aVal > bVal) return sortConfig.direction === "asc" ? 1 : -1;
      return 0;
    });
  }, [cases, sortConfig]);

  const handleSort = (key: string) => {
    setSortConfig((current) => {
      if (current.key !== key) return { key, direction: "asc" };
      if (current.direction === "asc") return { key, direction: "desc" };
      return { key: null, direction: null };
    });
  };

  const handleLoadMore = () => {
    setLoadingMore(true);
    const params = new URLSearchParams(window.location.search);
    const currentLimit = parseInt(params.get("limit") || "50");
    const newLimit = currentLimit + 50;
    params.set("limit", newLimit.toString());
    router.replace(`?${params.toString()}`, { scroll: false });
    setTimeout(() => setLoadingMore(false), 1500);
  };

  return (
    <div className="flex-1 min-h-0 flex flex-col rounded-xl border border-border bg-surface shadow-2xl overflow-hidden">
      <div className="flex-1 overflow-y-auto custom-scrollbar">
        <table className="w-full text-sm text-left border-collapse min-w-[1000px]">
          <thead className="bg-surface/90 sticky top-0 backdrop-blur-md z-10 border-b border-border">
            <tr>
              <SortableHeader label="Case ID" colKey="id" sortConfig={sortConfig} onSort={handleSort} />
              <SortableHeader label="Alias" colKey="alias" sortConfig={sortConfig} onSort={handleSort} />
              {isDoctor ? (
                <>
                    <SortableHeader label="Patient Name" colKey="patient" sortConfig={sortConfig} onSort={handleSort} />
                    <SortableHeader label="Clinic" colKey="clinic" sortConfig={sortConfig} onSort={handleSort} />
                </>
              ) : (
                <>
                    <SortableHeader label="Doctor" colKey="doctor" sortConfig={sortConfig} onSort={handleSort} />
                    <SortableHeader label="Clinic" colKey="clinic" sortConfig={sortConfig} onSort={handleSort} />
                </>
              )}
              {!isDoctor && (
                <SortableHeader label="Designer" colKey="designer" sortConfig={sortConfig} onSort={handleSort} />
              )}
              <SortableHeader label="Tooth" colKey="tooth" sortConfig={sortConfig} onSort={handleSort} />
              <SortableHeader label="Status" colKey="status" sortConfig={sortConfig} onSort={handleSort} />
              <SortableHeader label="Due Date" colKey="due" sortConfig={sortConfig} onSort={handleSort} />
              <SortableHeader label="Created" colKey="created" sortConfig={sortConfig} onSort={handleSort} />
            </tr>
          </thead>
          <tbody className="divide-y divide-border">
            {sortedCases.map((c) => (
              <CaseListRow key={c.id} data={c} role={role} />
            ))}
            {sortedCases.length === 0 && (
               <tr><td className="p-12 text-center text-muted" colSpan={isDoctor ? 8 : 9}>No cases found.</td></tr>
            )}
          </tbody>
        </table>
      </div>
      
      <div className="flex-none h-14 p-2 border-t border-border bg-surface/50 flex items-center justify-between">
          <span className="text-xs text-muted pl-2">
            Showing {cases.length} of {totalCount} cases
          </span>

          {cases.length < totalCount && (
            <button
              onClick={handleLoadMore}
              disabled={loadingMore}
              className="px-4 py-1.5 rounded-lg border border-border bg-surface hover:bg-[var(--accent-dim)] text-xs font-bold text-foreground transition-colors flex items-center gap-2 cursor-pointer"
            >
              {loadingMore ? (
                <>
                  <span className="w-3 h-3 border-2 border-muted border-t-foreground rounded-full animate-spin" />
                  Loading...
                </>
              ) : "Load More"}
            </button>
          )}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/new/page.tsx
// portal/app/portal/cases/new/page.tsx
import { getSession } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import Link from "next/link";
import { redirect } from "next/navigation";
import NewCaseForm from "@/components/NewCaseForm";
import type { DoctorRow } from "@/components/new-case/types";

export const dynamic = "force-dynamic";

export default async function NewCasePage() {
  const session = await getSession();
  if (!session) return redirect("/login");

  const role = session.role;
  // ✅ FIX: Only Lab and Admin can create cases
  const canCreate = role === "lab" || role === "admin";
  
  if (!canCreate) {
    return (
      <div className="p-8 text-center text-white/60">
        You do not have permission to create cases.
      </div>
    );
  }

  let doctors: DoctorRow[] = [];

  if (role === "admin" || role === "lab") {
    const rawDoctors = await prisma.user.findMany({
      where: { role: "customer" },
      select: { 
        id: true, 
        name: true, 
        email: true, 
        preferenceNote: true,
        defaultDesignPreferences: true,
        clinic: { 
            select: { 
                id: true, 
                name: true, 
                priceTier: true 
            } 
        },
        secondaryClinics: { 
            select: { 
                id: true, 
                name: true,
                priceTier: true 
            } 
        }
      },
      orderBy: { name: "asc" }
    });
    
    doctors = rawDoctors;
  }

  // (Current User Data fetch is redundant now since Customers can't access this)
  let currentUserData = null;

  return (
    <div className="h-full flex flex-col overflow-hidden bg-background">
      
      <div className="flex-none h-16 border-b border-border flex items-center justify-between px-6 bg-surface">
        <div className="flex items-center gap-4">
          <Link 
            href="/portal/cases" 
            className="flex items-center gap-2 text-muted hover:text-foreground transition-colors text-sm font-medium"
          >
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Cases
          </Link>
          <div className="h-6 w-px bg-border" />
          <h1 className="text-lg font-semibold text-foreground">Create New Case</h1>
        </div>
      </div>

      <div className="flex-1 overflow-y-auto custom-scrollbar p-6">
        <div className="max-w-5xl mx-auto pb-12">
          <NewCaseForm 
            doctors={doctors}
            // @ts-expect-error Server Component serialization
            currentDoctor={currentUserData} 
          />
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/[id]/page.tsx
// portal/app/portal/cases/[id]/page.tsx
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { notFound } from "next/navigation";
import Link from "next/link";
import CaseProcessBar from "@/components/CaseProcessBar";
import CaseViewerTabs from "@/components/CaseViewerTabs";
import { CaseFile } from "@prisma/client";
import CopyableId from "@/components/CopyableId";
import CaseDetailSidebar from "@/components/CaseDetailSidebar";
import AutoRefresh from "@/components/AutoRefresh";
import { getSignedFileUrl } from "@/lib/storage"; 

export const dynamic = "force-dynamic";

type ProductionStage = "DESIGN" | "MILLING_GLAZING" | "SHIPPING" | "COMPLETED";
type Params = Promise<{ id: string }>;

function normalizeSlot(label: string | null): "scan" | "design_with_model" | "design_only" | null {
  const lower = String(label ?? "").toLowerCase();
  if (lower === "scan") return "scan";
  if (lower === "design_with_model" || lower === "model_plus_design") return "design_with_model";
  if (lower === "design_only") return "design_only";
  return null;
}

function is3DUrl(url: string | null | undefined): boolean {
  if (!url) return false;
  const clean = url.split("?")[0].toLowerCase(); 
  return clean.endsWith(".stl") || clean.endsWith(".ply") || clean.endsWith(".obj");
}

export default async function CaseDetailPage({ params }: { params: Params }) {
  const { id } = await params;
  const session = await getSession();
  if (!session) return notFound();

  const item = await prisma.dentalCase.findUnique({
    where: { id },
    include: {
      clinic: true,
      files: { orderBy: { createdAt: "asc" } },
      events: { orderBy: { at: "asc" } },
      comments: { 
        include: { attachments: true },
        orderBy: { createdAt: "desc" } 
      },
      assigneeUser: { select: { id: true, name: true, email: true } }
    },
  });

  if (!item) return notFound();

  // ✅ FIXED AUTHORIZATION
  if (session.role === "customer") {
    // Access granted if:
    // 1. You are the Doctor who created the case (Owner)
    // 2. OR the case belongs to your Primary Clinic (Colleague)
    const isOwner = item.doctorUserId === session.userId;
    const isPrimaryClinic = session.clinicId === item.clinicId;

    if (!isOwner && !isPrimaryClinic) {
        return notFound();
    }
  }

  // HYDRATE FILES: Generate Signed URLs
  const hydratedFiles = await Promise.all(item.files.map(async (f) => {
    if (f.url.startsWith("/") || f.url.startsWith("http")) return f;
    try {
        const signed = await getSignedFileUrl(f.url);
        return { ...f, url: signed };
    } catch (e) {
        console.error(`Failed to sign URL for ${f.url}`, e);
        return f; 
    }
  }));
  item.files = hydratedFiles as any;

  // HYDRATE COMMENT ATTACHMENTS
  const hydratedComments = await Promise.all(item.comments.map(async (c) => {
      const attachments = await Promise.all(c.attachments.map(async (a) => {
          if (a.url.startsWith("/") || a.url.startsWith("http")) return a;
          try {
              const signed = await getSignedFileUrl(a.url);
              return { ...a, url: signed };
          } catch (e) {
              return a;
          }
      }));
      return { ...c, attachments };
  }));

  const authorIds = Array.from(new Set(item.comments.map(c => c.authorId)));
  const authors = await prisma.user.findMany({
    where: { id: { in: authorIds } },
    select: { id: true, name: true, role: true, email: true }
  });
  const authorMap = new Map(authors.map(u => [u.id, u]));

  const currentUser = await prisma.user.findUnique({
    where: { id: session.userId },
    select: { name: true, email: true }
  });
  const currentUserName = currentUser?.name || currentUser?.email || "Unknown";

  const uiComments = hydratedComments.map(c => {
    const author = authorMap.get(c.authorId);
    return {
      id: c.id,
      body: c.body,
      at: c.createdAt,
      author: author?.name || author?.email || "Unknown",
      role: author?.role || "user",
      attachments: c.attachments.map(a => ({
        id: a.id,
        url: a.url,
        kind: a.kind
      }))
    };
  });

  const isLabOrAdmin = session.role === "lab" || session.role === "admin";
  let designers: { id: string; name: string | null; email: string }[] = [];
  
  if (session.role === "admin") {
    designers = await prisma.user.findMany({
      where: { role: { in: ["lab", "admin"] } },
      select: { id: true, name: true, email: true },
      orderBy: { name: "asc" }
    });
  }

  let scanFile: CaseFile | null = null;
  let designWithModelFile: CaseFile | null = null;
  let designOnlyFile: CaseFile | null = null;
  let scanHtmlFile: CaseFile | null = null;
  let designHtmlFile: CaseFile | null = null;

  for (const f of item.files) {
    const lbl = String(f.label ?? "").toLowerCase();
    const slot = normalizeSlot(lbl);
    if (slot === "scan") { scanFile = f; continue; }
    if (slot === "design_with_model") { designWithModelFile = f; continue; }
    if (slot === "design_only") { designOnlyFile = f; continue; }
    if (lbl === "scan_html") { scanHtmlFile = f; continue; }
    if (lbl === "design_with_model_html") { designHtmlFile = f; continue; }
  }

  const scan3DUrl = is3DUrl(scanFile?.url) ? scanFile!.url : null;
  const designWithModel3DUrl = is3DUrl(designWithModelFile?.url) ? designWithModelFile!.url : null;
  const designOnly3DUrl = is3DUrl(designOnlyFile?.url) ? designOnlyFile!.url : null;
  const scanHtmlUrl = scanHtmlFile?.url ?? null;
  const designHtmlUrl = designHtmlFile?.url ?? null;

  const statusColor = 
    item.status === "CHANGES_REQUESTED" ? "text-red-400" :
    item.status === "COMPLETED" || item.status === "DELIVERED" ? "text-emerald-400" :
    "text-foreground";

  return (
    <section className="h-full w-full flex flex-col p-4 overflow-hidden">
      <AutoRefresh intervalMs={60000} />

      <div className="flex-none space-y-3 mb-2">
        <CaseProcessBar
          caseId={item.id}
          stage={item.stage as ProductionStage}
          status={item.status}
          role={session.role}
          carrier={item.shippingCarrier}
          tracking={item.trackingNumber}
        />
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-xl font-semibold">{item.patientAlias}</h1>
            <div className="text-muted text-xs mt-1 flex flex-wrap items-center gap-x-3">
              <span>Clinic: <span className="text-foreground">{item.clinic.name}</span></span>
              <span>•</span>
              
              {isLabOrAdmin && item.doctorName && (
                <><span>Doctor: <span className="text-foreground">{item.doctorName}</span></span><span>•</span></>
              )}

              {isLabOrAdmin && item.assigneeUser && (
                <>
                  <span>Designer: <span className="text-foreground">{item.assigneeUser.name || item.assigneeUser.email}</span></span>
                  <span>•</span>
                </>
              )}

              <span>Teeth: <span className="text-foreground">{item.toothCodes}</span></span>
              <span>•</span>
              <span>Status: <span className={`${statusColor} font-medium`}>{item.status.replace(/_/g, " ")}</span></span>
              <span>•</span>
              <div className="flex items-center gap-1.5">
                 <span>ID:</span><CopyableId id={item.id} />
              </div>
            </div>
          </div>
          
          <Link href="/portal/cases" className="px-3 py-1.5 rounded-lg bg-surface border border-border hover:bg-[var(--accent-dim)] transition text-xs font-medium text-muted">
            ← Cases
          </Link>
        </div>
      </div>

      <div className="flex-1 min-h-0 flex flex-col lg:flex-row gap-4">
        <div className="flex-none w-full lg:w-[350px] xl:w-[400px] h-full min-h-0">
          <CaseDetailSidebar 
            caseId={item.id}
            role={session.role}
            files={item.files}
            comments={uiComments}
            events={item.events}
            currentUserName={currentUserName}
            designPreferences={item.designPreferences}
            assigneeId={item.assigneeId}
            designers={designers}
          />
        </div>

        <div className="flex-1 h-full min-h-0">
          <CaseViewerTabs
            caseId={item.id}
            role={session.role}
            status={item.status}
            scan3DUrl={scan3DUrl}
            designWithModel3DUrl={designWithModel3DUrl}
            designOnly3DUrl={designOnly3DUrl}
            scanHtmlUrl={scanHtmlUrl}
            designHtmlUrl={designHtmlUrl}
          />
        </div>
      </div>
    </section>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/page.tsx
// app/portal/cases/page.tsx
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import Link from "next/link";
import { notFound } from "next/navigation";
import MillingDashboard from "./milling/MillingDashboard";
import AutoRefresh from "@/components/AutoRefresh";
import CaseListClient from "./CaseListClient"; 
import CasesFilterBar from "./CasesFilterBar";

export const dynamic = "force-dynamic";

export type CaseRow = {
  id: string;
  patientAlias: string;
  patientFirstName: string | null;
  patientLastName: string | null;
  toothCodes: string;
  status: string;
  dueDate: Date | null;
  updatedAt: Date;
  createdAt: Date;
  doctorName: string | null;
  clinic: { 
    name: string; 
    phone: string | null;
  };
  assigneeUser: { name: string | null; email: string } | null;
  product: string;
  material: string | null;
  serviceLevel: string | null;
  doctorUser: {
    name: string | null;
    phoneNumber: string | null;
    address: {
      street: string | null;
      zipCode: string | null;
      city: string | null;
      state: string | null;
    } | null;
  } | null;
};

export default async function CasesPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | string[] | undefined>>;
}) {
  const session = await getSession();
  if (!session) return notFound();

  const sp = await searchParams;
  const role = session.role;

  // Helpers
  const getParam = (key: string) => {
    const value = sp[key];
    return Array.isArray(value) ? value[0] : value;
  };
  const getParamArray = (key: string) => {
    const value = sp[key];
    return Array.isArray(value) ? value : (typeof value === "string" ? [value] : []);
  };

  const limitParam = getParam("limit");
  const limit = limitParam ? parseInt(limitParam) : 50;

  // --- MILLING VIEW ---
  if (role === "milling") {
    // ... (Milling logic preserved)
    const statusParams = getParamArray("status");
    const showShipped = getParam("showShipped") === "true";
    const doctorParam = getParam("doctor");
    const zipParam = getParam("zip");

    const whereMilling: any = {
        stage: { in: ["DESIGN", "MILLING_GLAZING", "SHIPPING", "COMPLETED", "DELIVERED"] }
    };

    let targetStatuses: string[] = [];
    if (statusParams.length > 0) {
        targetStatuses = [...statusParams];
    } else {
        targetStatuses = ["APPROVED", "IN_MILLING"];
    }

    if (showShipped && !targetStatuses.includes("SHIPPED")) {
        targetStatuses.push("SHIPPED");
    }

    whereMilling.status = { in: targetStatuses };

    if (doctorParam && doctorParam !== "ALL") {
        whereMilling.OR = [
            { doctorName: doctorParam },
            { doctorUser: { name: doctorParam } }
        ];
    }

    if (zipParam && zipParam !== "ALL") {
        whereMilling.doctorUser = { address: { zipCode: zipParam } };
    }

    const [totalMillingCount, millingCases, distinctDoctors, distinctZips] = await Promise.all([
        prisma.dentalCase.count({ where: whereMilling }),
        prisma.dentalCase.findMany({
            where: whereMilling,
            orderBy: { dueDate: "asc" },
            take: limit, 
            select: {
                id: true, patientAlias: true, patientFirstName: true, patientLastName: true, 
                toothCodes: true, status: true, dueDate: true, product: true, shade: true,
                updatedAt: true, createdAt: true, material: true, serviceLevel: true,
                doctorName: true, 
                clinic: { select: { name: true, phone: true } }, 
                assigneeUser: { select: { name: true, email: true } }, 
                doctorUser: { 
                    select: { 
                        name: true, 
                        phoneNumber: true, 
                        address: { select: { street: true, zipCode: true, city: true, state: true } } 
                    } 
                }
            }
        }),
        prisma.dentalCase.findMany({
            where: { stage: { in: ["MILLING_GLAZING", "SHIPPING", "COMPLETED"] } },
            distinct: ['doctorName'],
            select: { doctorName: true, doctorUser: { select: { name: true } } }
        }),
        prisma.dentalCase.findMany({
            where: { stage: { in: ["MILLING_GLAZING", "SHIPPING", "COMPLETED"] } },
            distinct: ['doctorUserId'],
            select: { doctorUser: { select: { address: { select: { zipCode: true } } } } }
        })
    ]);

    const uniqueDoctors = Array.from(new Set(
        distinctDoctors.map(c => c.doctorUser?.name || c.doctorName).filter(Boolean) as string[]
    )).sort();

    const uniqueZips = Array.from(new Set(
        distinctZips.map(c => c.doctorUser?.address?.zipCode).filter(Boolean) as string[]
    )).sort();

    const safeMillingCases = millingCases.map((c: any) => ({ 
        ...c, 
        dueDate: c.dueDate ? c.dueDate : null 
    })) as unknown as any[];

    return (
        <div className="flex flex-col h-full overflow-hidden bg-background text-foreground">
            <AutoRefresh intervalMs={60000} />
            <MillingDashboard 
                cases={safeMillingCases} 
                totalCount={totalMillingCount}
                uniqueDoctors={uniqueDoctors}
                uniqueZips={uniqueZips}
            />
        </div>
    );
  }

  // --- STANDARD VIEW ---
  const isDoctor = role === "customer";
  const isAdmin = role === "admin";
  const currentRole = role as string; 
  const canCreate = currentRole === "lab" || currentRole === "admin";

  const clinicFilter = getParam("clinic");
  const doctorFilter = getParam("doctor");
  const assigneeFilter = getParam("assignee");
  const caseIdFilter = getParam("caseId");
  const dateFilter = getParam("date");
  const aliasFilter = getParam("alias");
  const searchFilter = getParam("search"); // ✅ Added: Capture main search input
  const statusFilter = getParamArray("status");

  const where: any = {};
  if (statusFilter.length > 0) {
    where.status = { in: statusFilter };
  } else {
    if (isDoctor) {
        where.status = { notIn: ["DELIVERED"] };
    } else {
        where.status = { notIn: ["COMPLETED", "DELIVERED"] };
    }
  }

  if (isDoctor) {
    where.OR = [
      { doctorUserId: session.userId },
      { clinicId: session.clinicId ?? "__none__" }
    ];

    // ✅ FIX: Consolidate alias and generic search
    const query = searchFilter || aliasFilter;

    if (query && query.trim()) {
      where.AND = {
        OR: [
            { id: { contains: query.trim() } }, // Added Case ID search
            { patientAlias: { contains: query.trim(), mode: 'insensitive' } },
            { toothCodes: { contains: query.trim(), mode: 'insensitive' } },
            { patientFirstName: { contains: query.trim(), mode: 'insensitive' } },
            { patientLastName: { contains: query.trim(), mode: 'insensitive' } }
        ]
      };
    }
  } else if (currentRole === "sales") {
    where.salesRepId = session.userId;
  } else {
    if (clinicFilter?.trim()) where.clinic = { name: { contains: clinicFilter.trim(), mode: 'insensitive' } };
    if (doctorFilter?.trim()) where.doctorName = { contains: doctorFilter.trim(), mode: 'insensitive' };
    if (caseIdFilter?.trim()) where.id = { contains: caseIdFilter.trim() };
    if (isAdmin && assigneeFilter?.trim()) {
        where.assigneeId = assigneeFilter.trim();
    }

    // ✅ FIX: Generic search for Admins/Lab
    if (searchFilter?.trim()) {
      const term = searchFilter.trim();
      const searchConditions = [
        { id: { contains: term } },
        { patientAlias: { contains: term, mode: 'insensitive' } },
        { patientFirstName: { contains: term, mode: 'insensitive' } },
        { patientLastName: { contains: term, mode: 'insensitive' } },
      ];
      
      // Use array push to combine safely with other filters if needed
      if (!where.AND) {
        where.AND = [{ OR: searchConditions }];
      } else if (Array.isArray(where.AND)) {
        where.AND.push({ OR: searchConditions });
      } else {
        // If where.AND is an object, convert to array
        where.AND = [where.AND, { OR: searchConditions }];
      }
    }

    if (dateFilter?.trim()) {
      const d = new Date(dateFilter);
      // ✅ FIX: Range sanity check to prevent "Year 20000" crashes
      // We only accept years between 2000 and 2100.
      if (!Number.isNaN(d.getTime()) && d.getFullYear() >= 2000 && d.getFullYear() <= 2100) {
        const start = new Date(d); start.setHours(0, 0, 0, 0);
        const end = new Date(start); end.setDate(end.getDate() + 1);
        where.dueDate = { gte: start, lt: end };
      }
    }
  }

  let labUsers: { id: string; name: string | null; email: string }[] = [];
  if (isAdmin) {
    labUsers = await prisma.user.findMany({
        where: { role: { in: ["lab", "admin"] } },
        select: { id: true, name: true, email: true },
        orderBy: { name: "asc" }
    });
  }

  const [totalCount, rows] = await Promise.all([
    prisma.dentalCase.count({ where }),
    prisma.dentalCase.findMany({
        where,
        orderBy: [{ updatedAt: "desc" }],
        take: limit, 
        select: {
            id: true, 
            patientAlias: true,
            patientFirstName: true,
            patientLastName: true, 
            toothCodes: true,
            status: true, 
            dueDate: true, 
            updatedAt: true,
            createdAt: true,
            doctorName: true,
            clinic: { select: { name: true, phone: true } }, 
            assigneeUser: { select: { name: true, email: true } },
            product: true,
            material: true,
            serviceLevel: true,
            doctorUser: {
              select: {
                name: true,
                phoneNumber: true,
                address: { select: { street: true, zipCode: true, city: true, state: true } }
              }
            }
        },
    })
  ]);

  return (
    <section className="flex flex-col h-full w-full p-6 overflow-hidden bg-background text-foreground">
      <AutoRefresh intervalMs={60000} />

      <div className="flex-none space-y-4 mb-4">
        <header className="flex items-center justify-between">
          <div className="flex items-baseline gap-3">
            <h1 className="text-2xl font-semibold text-foreground">Cases</h1>
            <span className="text-sm text-muted">Total: {totalCount}</span>
          </div>
          
          {canCreate && (
            <Link
            href="/portal/cases/new"
            // ✅ FIX: Semantic classes automatically switch:
            className="px-4 py-2 rounded-xl bg-surface text-foreground text-sm font-semibold hover:brightness-110 hover:scale-105 transition-all shadow-md border border-border"
            >
            + New Case
            </Link>
          )}
        </header>

        <CasesFilterBar 
            role={role}
            isAdmin={isAdmin}
            isDoctor={isDoctor}
            labUsers={labUsers}
        />
      </div>

      <CaseListClient 
        cases={rows as CaseRow[]} 
        role={role} 
        totalCount={totalCount}
      />
    </section>
  );
}
--- END OF FILE ---

FILE: ./app/portal/layout.tsx
// portal/app/portal/layout.tsx
import PortalSidebar from "@/components/PortalSidebar";
import { getSession } from "@/lib/auth";
import { redirect } from "next/navigation";

export default async function PortalLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await getSession();
  if (!session) {
    redirect("/login");
  }

  return (
    <div className="flex h-screen w-screen overflow-hidden bg-background text-foreground transition-colors duration-300">
      {/* Sidebar: Fixed width, full height */}
      <PortalSidebar userRole={session.role} />

      {/* Main Content: Fills remaining width/height */}
      <main className="flex-1 flex flex-col min-w-0 h-full relative">
        {children}
      </main>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/billing/page.tsx
// portal/app/portal/billing/page.tsx

import { getSession } from "@/lib/auth";
import { redirect } from "next/navigation";
import { prisma } from "@/lib/prisma";
import { Prisma } from "@prisma/client";
import BillingToolbar from "@/components/BillingToolbar";
import BillingStats from "@/components/BillingStats";
import BillingList from "@/components/BillingList";

export const dynamic = "force-dynamic";

export default async function BillingPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | string[] | undefined>>;
}) {
  const session = await getSession();
  if (!session) redirect("/login");

  const sp = await searchParams;

  const getParam = (key: string) => {
    const val = sp[key];
    if (Array.isArray(val)) return val[0];
    return val;
  };

  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1;

  const selYear = getParam("year") ? parseInt(getParam("year")!) : currentYear;
  const selMonth = getParam("month") ? parseInt(getParam("month")!) : currentMonth;
  const limit = parseInt(getParam("limit") || "50");

  const qFilter = getParam("q") || "";
  const doctorFilter = getParam("doctor") || "";
  const clinicFilter = getParam("clinic") || "";
  const isAdminOrLab = session.role === "admin" || session.role === "lab";

  const where: Prisma.DentalCaseWhereInput = {};
  if (session.role === "customer") {
    if (!session.clinicId) {
      return <div className="p-8 text-muted">No clinic linked. Contact support.</div>;
    }
    where.clinicId = session.clinicId;
  }

  const start = new Date(selYear, selMonth - 1, 1);
  const end = new Date(selYear, selMonth, 0, 23, 59, 59, 999);
  
  where.orderDate = { gte: start, lte: end };
  where.status = { not: "CANCELLED" };

  if (qFilter.trim()) {
    where.OR = [
      { patientAlias: { contains: qFilter.trim(), mode: 'insensitive' } },
      { id: { contains: qFilter.trim() } },
      { patientFirstName: { contains: qFilter.trim(), mode: 'insensitive' } },
      { patientLastName: { contains: qFilter.trim(), mode: 'insensitive' } }
    ];
  }

  if (isAdminOrLab) {
    if (doctorFilter.trim()) where.doctorName = { contains: doctorFilter.trim(), mode: 'insensitive' };
    if (clinicFilter.trim()) where.clinic = { name: { contains: clinicFilter.trim(), mode: 'insensitive' } };
  }

  // --- 2. FETCH DATA ---
  const [stats, rawCases] = await Promise.all([
    // ✅ Use 'aggregate' for counts to populate the footer accurately
    prisma.dentalCase.aggregate({
        where,
        _sum: { cost: true, units: true },
        _count: { id: true }
    }),
    prisma.dentalCase.findMany({
        where,
        orderBy: { orderDate: "desc" },
        take: limit, // ✅ Apply Limit Here
        select: {
            id: true,
            orderDate: true,
            patientAlias: true,
            patientFirstName: true,
            patientLastName: true,
            doctorName: true,
            product: true,
            units: true,
            cost: true,
            billingType: true,
            clinic: { select: { name: true } },
        },
    })
  ]);

  const cases = rawCases.map((c) => ({
    ...c,
    cost: Number(c.cost),
  }));

  const isFiltered = !!qFilter || (isAdminOrLab && (!!doctorFilter || !!clinicFilter)) || selYear !== currentYear || selMonth !== currentMonth;

  return (
    <section className="h-screen w-full flex flex-col p-6 overflow-hidden">
      <BillingToolbar 
        selYear={selYear}
        selMonth={selMonth}
        qFilter={qFilter}
        doctorFilter={doctorFilter}
        clinicFilter={clinicFilter}
        isAdminOrLab={isAdminOrLab}
        isFiltered={isFiltered}
      />

      <BillingStats 
        totalCost={Number(stats._sum.cost || 0)}
        caseCount={stats._count.id}
        totalUnits={stats._sum.units || 0}
      />

      <BillingList 
        cases={cases} 
        isAdminOrLab={isAdminOrLab} 
        totalCount={stats._count.id} // ✅ Pass Total
      />
    </section>
  );
}
--- END OF FILE ---

FILE: ./app/signup/page.tsx
// portal/app/signup/page.tsx
"use client";

import { useState } from "react";
import Link from "next/link";

export default function SignupPage() {
  const [form, setForm] = useState({
    name: "",
    email: "",
    phone: "",
    street: "",
    city: "",
    state: "",
    zipCode: ""
  });
  const [busy, setBusy] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [error, setError] = useState("");

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setBusy(true);
    setError("");

    try {
      const res = await fetch("/api/auth/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(form)
      });
      
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to submit request");
      
      setSubmitted(true);
    } catch (err: any) {
      setError(err.message);
      setBusy(false);
    }
  }

  if (submitted) {
    return (
      <main className="h-screen w-full bg-background flex items-center justify-center p-6 overflow-hidden">
        <div className="max-w-md w-full bg-surface border border-border rounded-2xl p-8 text-center shadow-2xl">
          <div className="w-16 h-16 bg-emerald-500/10 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
          </div>
          <h2 className="text-2xl font-medium text-foreground mb-2">Request Sent</h2>
          <p className="text-muted mb-8 leading-relaxed">
            Thank you, {form.name}. Our team will review your information and send an approval email shortly.
          </p>
          <Link href="/" className="inline-block px-6 py-3 bg-accent text-white font-bold rounded-lg hover:bg-accent/80 transition">
            Return Home
          </Link>
        </div>
      </main>
    );
  }

  return (
    <main className="h-screen w-full bg-background flex items-center justify-center p-6 relative overflow-hidden">
        <div className="absolute inset-0 pointer-events-none">
            <div className="absolute top-0 left-0 w-[800px] h-[800px] bg-accent/5 rounded-full blur-[120px] -translate-y-1/2 -translate-x-1/4" />
        </div>

        <div className="w-full max-w-2xl relative z-10 flex flex-col max-h-full">
            <div className="mb-6 text-center flex-none">
                <Link href="/" className="inline-block text-2xl font-light tracking-wide text-foreground mb-2">Lumera</Link>
                <h1 className="text-2xl font-semibold text-foreground">Request Access</h1>
                <p className="text-muted text-sm mt-1">Enter your details to create an account.</p>
            </div>

            <form onSubmit={onSubmit} className="bg-surface border border-border rounded-2xl p-8 shadow-2xl flex flex-col gap-5 overflow-y-auto custom-scrollbar">
                
                <div className="space-y-4">
                    <h3 className="text-xs font-bold text-accent uppercase tracking-wider border-b border-border pb-2">Account Details</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                        <div className="space-y-1">
                            <label className="text-xs text-muted uppercase">Full Name *</label>
                            <input 
                              required 
                              name="name" 
                              value={form.name} 
                              onChange={handleChange} 
                              className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2.5 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition-colors" 
                              placeholder="Dr. Jane Doe" 
                            />
                        </div>
                        <div className="space-y-1">
                            <label className="text-xs text-muted uppercase">Email Address *</label>
                            <input 
                              required 
                              type="email" 
                              name="email" 
                              value={form.email} 
                              onChange={handleChange} 
                              className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2.5 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition-colors" 
                              placeholder="doctor@clinic.com" 
                            />
                        </div>
                    </div>
                    <div className="space-y-1">
                        <label className="text-xs text-muted uppercase">Phone Number *</label>
                        <input 
                          required 
                          name="phone" 
                          value={form.phone} 
                          onChange={handleChange} 
                          className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2.5 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition-colors" 
                          placeholder="(555) 000-0000" 
                        />
                    </div>
                </div>

                <div className="space-y-4">
                    <h3 className="text-xs font-bold text-accent uppercase tracking-wider border-b border-border pb-2">Address</h3>
                    <div className="space-y-1">
                        <label className="text-xs text-muted uppercase">Street Address *</label>
                        <input 
                          required 
                          name="street" 
                          value={form.street} 
                          onChange={handleChange} 
                          className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2.5 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition-colors" 
                          placeholder="123 Main St" 
                        />
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                        <div className="space-y-1">
                            <label className="text-xs text-muted uppercase">City *</label>
                            <input 
                              required 
                              name="city" 
                              value={form.city} 
                              onChange={handleChange} 
                              className="w-full bg-surface-highlight border border-border rounded-lg px-3 py-2.5 text-foreground placeholder:text-muted outline-none focus:border-accent/50 transition-colors" 
                              placeholder="City" 
                            />
                        </div>
                        <div className="space-y-1">
                            <label className="text-xs text-muted uppercase">State *</label>
                            <input 
                              required 
                              name="state" 
                              value={form.state} 
                              onChange={handleChange} 
                              className="w-full bg-surface-highlight border border-border rounded-lg px-3 py-2.5 text-foreground placeholder:text-muted outline-none focus:border-accent/50 transition-colors" 
                              placeholder="State" 
                            />
                        </div>
                        <div className="space-y-1">
                            <label className="text-xs text-muted uppercase">Zip *</label>
                            <input 
                              required 
                              name="zipCode" 
                              value={form.zipCode} 
                              onChange={handleChange} 
                              className="w-full bg-surface-highlight border border-border rounded-lg px-3 py-2.5 text-foreground placeholder:text-muted outline-none focus:border-accent/50 transition-colors" 
                              placeholder="Zip" 
                            />
                        </div>
                    </div>
                </div>

                {error && <p className="text-red-500 text-sm text-center bg-red-500/10 p-2 rounded">{error}</p>}

                <div className="pt-2 flex items-center justify-between mt-auto">
                    <Link href="/login" className="text-sm text-muted hover:text-foreground transition-colors">← Back to Login</Link>
                    <button 
                      type="submit" 
                      disabled={busy} 
                      className="px-8 py-3 bg-accent text-white font-bold rounded-lg hover:bg-accent/80 transition-colors disabled:opacity-50"
                    >
                        {busy ? "Submitting..." : "Request Access"}
                    </button>
                </div>
            </form>
        </div>
    </main>
  );
}

--- END OF FILE ---

FILE: ./app/setup/page.tsx
// portal/app/setup/page.tsx
"use client";

import { useState, Suspense } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import Link from "next/link";

function SetupForm() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const token = searchParams.get("token");

  const [password, setPassword] = useState("");
  const [confirm, setConfirm] = useState("");
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState("");

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (password !== confirm) return setError("Passwords do not match");
    if (password.length < 6) return setError("Password must be at least 6 characters");
    
    setBusy(true);
    setError("");

    try {
      const res = await fetch("/api/auth/setup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, password })
      });
      
      if (!res.ok) throw new Error((await res.json()).error || "Failed");
      
      // Success -> Redirect to login
      router.push("/login");
    } catch (e: any) {
      setError(e.message);
      setBusy(false);
    }
  }

  if (!token) {
    return (
      <div className="text-center text-muted">
        <p>Invalid or missing invitation token.</p>
        <Link href="/login" className="text-accent hover:underline mt-4 block">Back to Login</Link>
      </div>
    );
  }

  return (
    <div className="w-full max-w-sm">
      <h1 className="text-2xl font-semibold text-foreground mb-2 text-center">Set Your Password</h1>
      <p className="text-muted text-sm text-center mb-8">Finalize your account setup</p>
      
      <form onSubmit={onSubmit} className="bg-surface border border-border rounded-2xl p-8 space-y-4 transition-colors">
        <div>
          <label className="block text-xs font-medium text-muted uppercase mb-2">New Password</label>
          <input 
            type="password" 
            required 
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition-colors"
          />
        </div>
        <div>
          <label className="block text-xs font-medium text-white/60 uppercase mb-2">Confirm Password</label>
          <input 
            type="password" 
            required 
            value={confirm}
            onChange={(e) => setConfirm(e.target.value)}
            className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition-colors"
          />
        </div>

        {error && <div className="text-red-400 text-sm text-center">{error}</div>}

        <button 
          type="submit" 
          disabled={busy}
          className="w-full py-3 bg-accent text-white font-bold rounded-lg hover:bg-accent/80 transition-colors disabled:opacity-50"
        >
          {busy ? "Setting up..." : "Complete Setup"}
        </button>
      </form>
    </div>
  );
}

export default function SetupPage() {
  return (
    <main className="min-h-screen bg-background flex items-center justify-center p-6">
      <Suspense fallback={<div className="text-white/50">Loading...</div>}>
        <SetupForm />
      </Suspense>
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/about/page.tsx
// portal/app/about/page.tsx
import PublicNavbar from "@/components/PublicNavbar";
import PublicFooter from "@/components/PublicFooter";

export default function AboutPage() {
  return (
    <main className="min-h-screen flex flex-col bg-background text-foreground transition-colors duration-300">
      <PublicNavbar />
      
      <section className="pt-24 pb-12">
        <div className="container mx-auto px-6 text-center">
          <h1 className="text-5xl font-semibold mb-6">About Lumera</h1>
          <p className="text-xl text-muted max-w-3xl mx-auto">
            We build one thing exceptionally well: zirconia crowns. When other restorations reach 
            the efficiency and reliability of The Crown, we’ll add them. Never before.
          </p>
        </div>
      </section>

      <section className="container mx-auto px-6 pb-24 max-w-4xl space-y-8">
        {/* Story Card */}
        <div className="p-8 md:p-12 rounded-3xl border border-border bg-surface transition-colors">
          <h2 className="text-2xl font-medium mb-4">Our Story</h2>
          <p className="text-muted leading-relaxed text-lg">
            We started as a <b>boutique lab for personalized restorations</b>, a small team obsessed with detail. 
            As a private lab we served a network of 50+ clinics in the Northeast and refined a single workflow end to end. 
            Today we’re opening to the public with that same craft and focus.
          </p>
        </div>

        {/* Founders Grid */}
        <div className="p-8 md:p-12 rounded-3xl border border-border bg-surface transition-colors">
          <h2 className="text-2xl font-medium mb-8">Founders</h2>
          <div className="grid md:grid-cols-3 gap-6">
            {[
              { role: "Dentist", sub: "Clinical Lead", desc: "Sets standards for margin capture, occlusion, and chairside simplicity." },
              { role: "Group Owner", sub: "Operations", desc: "Ensures submission clarity, communication speed, and predictable delivery." },
              { role: "Engineer", sub: "Biomedical / Software", desc: "Operations, data flow, and reliability across production." }
            ].map((f, i) => (
              <div key={i} className="p-6 rounded-2xl border border-border bg-surface-highlight transition-colors">
                <h3 className="font-semibold text-lg mb-1">{f.role}</h3>
                <div className="text-xs text-accent uppercase tracking-wider font-bold mb-3">{f.sub}</div>
                <p className="text-sm text-muted">{f.desc}</p>
              </div>
            ))}
          </div>
        </div>
      </section>

      <PublicFooter />
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/work/page.tsx
// portal/app/work/page.tsx
import PublicNavbar from "@/components/PublicNavbar";
import PublicFooter from "@/components/PublicFooter";
import Link from "next/link";

export default function WorkPage() {
  const galleryItems = [
    { id: 1, title: "Full Arch Zirconia", category: "Restoration", colSpan: "col-span-1 md:col-span-2 row-span-2" },
    { id: 2, title: "Single Central Incisor", category: "Esthetic", colSpan: "col-span-1" },
    { id: 3, title: "Gold Crown", category: "Classic", colSpan: "col-span-1" },
    { id: 4, title: "Implant Bridge", category: "Complex", colSpan: "col-span-1" },
    { id: 5, title: "Veneer Case", category: "Cosmetic", colSpan: "col-span-1" },
  ];

  return (
    <main className="min-h-screen flex flex-col bg-background text-foreground selection:bg-accent/30 transition-colors duration-300">
      <PublicNavbar />

      <div className="flex-1">
        {/* HERO SECTION */}
        <section className="relative pt-32 pb-20 px-6 overflow-hidden">
          {/* Ambient Background */}
          <div className="absolute top-0 right-0 w-[800px] h-[800px] bg-accent/5 rounded-full blur-[120px] -translate-y-1/2 translate-x-1/3 pointer-events-none" />
          
          <div className="container mx-auto text-center relative z-10">
            <h1 className="text-4xl md:text-6xl font-light mb-6 tracking-tight">
              Our <span className="text-accent">Masterpieces</span>
            </h1>
            <p className="text-lg text-muted max-w-2xl mx-auto leading-relaxed">
              Precision meets artistry. Explore our gallery of complex restorations, 
              aesthetic makeovers, and everyday crown & bridge work.
            </p>
          </div>
        </section>

        {/* GALLERY GRID */}
        {/* FIX: bg-surface (Midnight Blue variant) instead of hardcoded grey */}
        <section className="py-20 px-6 bg-surface/50">
          <div className="container mx-auto">
            <div className="grid grid-cols-1 md:grid-cols-3 auto-rows-[300px] gap-6">
              {galleryItems.map((item) => (
                <div 
                  key={item.id} 
                  className={`group relative rounded-3xl overflow-hidden border border-border bg-surface backdrop-blur-sm hover:border-accent/30 transition-all duration-300 ${item.colSpan}`}
                >
                  {/* Placeholder for Image */}
                  <div className="absolute inset-0 bg-gradient-to-br from-foreground/5 to-transparent flex items-center justify-center group-hover:scale-105 transition-transform duration-700">
                    <svg className="w-12 h-12 text-muted/30 group-hover:text-accent/30 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>

                  {/* Overlay Content */}
                  <div className="absolute inset-0 bg-gradient-to-t from-background via-background/50 to-transparent opacity-60 group-hover:opacity-80 transition-opacity duration-300" />
                  
                  <div className="absolute bottom-0 left-0 p-8 translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                    <span className="text-accent text-xs font-bold tracking-widest uppercase mb-2 block opacity-0 group-hover:opacity-100 transition-opacity delay-100">
                      {item.category}
                    </span>
                    <h3 className="text-xl font-medium text-foreground group-hover:text-accent transition-colors">
                      {item.title}
                    </h3>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* CTA SECTION */}
        <section className="py-32 px-6 relative overflow-hidden">
          <div className="absolute inset-0 bg-accent/5" />
          <div className="container mx-auto text-center relative z-10">
            <h2 className="text-3xl font-light mb-8">Ready to send your first case?</h2>
            <Link 
              href="/signup"
              className="inline-flex items-center justify-center px-8 py-4 text-base font-bold text-white bg-accent rounded-full hover:bg-accent/90 hover:scale-105 transition-all shadow-lg"
            >
              Get Started
            </Link>
          </div>
        </section>
      </div>

      <PublicFooter />
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/layout.tsx
// portal/app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { ThemeProvider } from "@/components/ThemeProvider";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Lumera Dental Portal",
  description: "Next-generation dental lab workflow",
  icons: {
    icon: "/icon.png",
    shortcut: "/icon.png",
    apple: "/icon.png",
  },
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    // suppressHydrationWarning is required because your ThemeProvider modifies the DOM 
    // (adding 'dark' class) before React hydrates.
    <html lang="en" suppressHydrationWarning>
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased bg-[#f5f7fb] dark:bg-[#0a1020] min-h-screen transition-colors duration-300`}
      >
        <ThemeProvider>
          {children}
        </ThemeProvider>
      </body>
    </html>
  );
}
--- END OF FILE ---

FILE: ./app/api/auth/signup/route.ts
// portal/app/api/auth/signup/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function POST(req: Request) {
  try {
    const data = await req.json();
    
    // Validation: Ensure all fields from the new form are present
    if (
      !data.email || 
      !data.name || 
      !data.phone || 
      !data.street || 
      !data.city || 
      !data.state || 
      !data.zipCode
    ) {
      return NextResponse.json({ error: "All fields are required." }, { status: 400 });
    }

    // Check if user already exists
    const existingUser = await prisma.user.findUnique({ where: { email: data.email } });
    if (existingUser) {
      return NextResponse.json({ error: "An account with this email already exists." }, { status: 400 });
    }

    // Check if pending request exists
    const existingReq = await prisma.registrationRequest.findUnique({ where: { email: data.email } });
    if (existingReq) {
      return NextResponse.json({ error: "A request for this email is already pending." }, { status: 400 });
    }

    // Default clinic name since we removed it from the UI to streamline signup
    const clinicName = `${data.name}'s Practice`;

    await prisma.registrationRequest.create({
      data: {
        email: data.email,
        name: data.name,
        phone: data.phone,
        clinicName: clinicName, // Auto-generated
        street: data.street,
        city: data.city,
        state: data.state,
        zipCode: data.zipCode,
        status: "PENDING"
      }
    });

    return NextResponse.json({ ok: true });
  } catch (e) {
    console.error("Signup error:", e);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/auth/setup/route.ts
// portal/app/api/auth/setup/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";

export async function POST(req: Request) {
  try {
    const { token, password } = await req.json();

    if (!token || !password) return NextResponse.json({ error: "Missing fields" }, { status: 400 });

    // Find user with this token
    const user = await prisma.user.findUnique({ where: { invitationToken: token } });
    if (!user) return NextResponse.json({ error: "Invalid or expired token" }, { status: 400 });

    const hash = await bcrypt.hash(password, 10);

    // Update user: Set password, clear token
    await prisma.user.update({
      where: { id: user.id },
      data: {
        password: hash,
        invitationToken: null // One-time use
      }
    });

    return NextResponse.json({ ok: true });
  } catch (e) {
    return NextResponse.json({ error: "Internal Error" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/auth/logout/route.ts
// portal/app/api/auth/logout/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers"; // ✅ Next.js 15 way
import { COOKIE_OPTIONS } from "@/lib/auth";

export async function POST() {
  const jar = await cookies();
  
  // ✅ Force delete by setting maxAge to 0 with matching options
  jar.set({
    name: COOKIE_OPTIONS.name,
    value: "",
    ...COOKIE_OPTIONS.options,
    maxAge: 0,
  });
  
  return NextResponse.json({ ok: true });
}
--- END OF FILE ---

FILE: ./app/api/auth/login/route.ts
// portal/app/api/auth/login/route.ts
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { cookies } from "next/headers";
import bcrypt from "bcryptjs";
import { signToken, COOKIE_OPTIONS } from "@/lib/auth"; // ✅ Import rules

export async function POST(req: Request) {
  try {
    const body = await req.json().catch(() => ({}));
    const email = String(body.email ?? "").toLowerCase();
    const password = String(body.password ?? "");

    if (!email || !password) {
      return NextResponse.json({ error: "Email and password are required" }, { status: 400 });
    }

    const user = await prisma.user.findUnique({ where: { email } });
    if (!user) {
      return NextResponse.json({ error: "Invalid credentials" }, { status: 401 });
    }

    const ok = await bcrypt.compare(password, user.password);
    if (!ok) {
      return NextResponse.json({ error: "Invalid credentials" }, { status: 401 });
    }

    // ✅ Generate Token
    const token = signToken({
      userId: user.id,
      role: user.role,
      clinicId: user.clinicId ?? null,
    });

    // ✅ Set Secure Cookie
    const jar = await cookies();
    jar.set(COOKIE_OPTIONS.name, token, COOKIE_OPTIONS.options);

    return NextResponse.json({ ok: true });
  } catch (e) {
    console.error("Login Error:", e);
    return NextResponse.json({ error: "Login failed" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/admin/requests/[id]/approve/route.ts
// portal/app/api/admin/requests/[id]/approve/route.ts
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { Resend } from "resend";
import crypto from "node:crypto";

const resend = process.env.RESEND_API_KEY ? new Resend(process.env.RESEND_API_KEY) : null;

export async function POST(req: Request, props: { params: Promise<{ id: string }> }) {
  try {
    const session = await getSession();
    if (!session || session.role !== "admin") {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const params = await props.params;
    const { id } = params;
    
    const body = await req.json().catch(() => ({}));
    const action = body.action;

    const request = await prisma.registrationRequest.findUnique({ where: { id } });
    if (!request) {
      return NextResponse.json({ error: "Request not found" }, { status: 404 });
    }

    if (action === "reject") {
      await prisma.registrationRequest.update({ 
        where: { id }, 
        data: { status: "REJECTED" } 
      });
      return NextResponse.json({ ok: true });
    }

    // --- APPROVE ---
    const existingUser = await prisma.user.findUnique({ where: { email: request.email } });
    if (existingUser) {
        await prisma.registrationRequest.update({ 
            where: { id }, 
            data: { status: "PROCESSED" } 
        });
        return NextResponse.json({ ok: true, warning: "User already existed." });
    }

    // 1. Create Address (Linked to USER later, not Clinic)
    const address = await prisma.address.create({
      data: {
        street: request.street,
        city: request.city,
        state: request.state,
        zipCode: request.zipCode,
      }
    });

    // 2. Create Clinic (Name ONLY - No Address)
    // "I dont want the address the new user enters to be a clinic"
    // We assume the user creates a new clinic entity, but keeps their personal address on their user profile.
    const clinic = await prisma.clinic.create({
      data: {
        name: request.clinicName
      }
    });

    // 3. Create User (Linked to Clinic AND Address)
    const token = crypto.randomBytes(16).toString("hex");
    await prisma.user.create({
      data: {
        email: request.email,
        name: request.name,
        phoneNumber: request.phone,
        role: "customer",
        clinicId: clinic.id,
        addressId: address.id, // <--- Address linked here
        password: "PENDING_SETUP", 
        invitationToken: token,
      }
    });

    await prisma.registrationRequest.update({ 
        where: { id }, 
        data: { status: "PROCESSED" } 
    });

    if (resend) {
      try {
        const sender = process.env.EMAIL_FROM || "onboarding@resend.dev";
        const baseUrl = process.env.NEXT_PUBLIC_URL || "https://lumeradental.com";
        const setupUrl = `${baseUrl}/setup?token=${token}`;

        await resend.emails.send({
          from: sender,
          to: request.email,
          subject: "Your Lumera Account is Approved",
          html: `
            <div style="font-family: sans-serif; color: #111; max-width: 600px; padding: 20px;">
              <h2 style="color: #1e1e1e;">Access Granted</h2>
              <p>Hello ${request.name},</p>
              <p>Your request to join the Lumera Dental Portal has been approved.</p>
              <a href="${setupUrl}" style="display: inline-block; background: #000; color: #fff; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: bold;">Set Password</a>
            </div>
          `
        });
      } catch (e) {
        console.error("Email error:", e);
      }
    }

    return NextResponse.json({ ok: true });

  } catch (e: any) {
    console.error("Approval error:", e);
    return NextResponse.json({ error: e.message }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/batch/download/route.ts
// portal/app/api/cases/batch/download/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { getFileStream } from "@/lib/storage";
import archiver from "archiver";
import path from "node:path";
import { Readable } from "stream";

function getFormattedDate() {
  const d = new Date();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  const yyyy = d.getFullYear();
  return `${mm}-${dd}-${yyyy}`;
}

// ✅ Allow dots for shades like "A3.5", allow hyphens, strip others
function sanitize(str: string | null | undefined) {
  if (!str) return "";
  const safe = str.replace(/\//g, "-"); // Replace slashes with hyphens (e.g. A2/A3 -> A2-A3)
  return safe.replace(/[^a-zA-Z0-9.-]/g, ""); 
}

function toCamelCase(str: string | null | undefined): string {
  if (!str) return "";
  return str
    .toLowerCase()
    .split("_")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join("");
}

function getOutputSuffix(dbLabel: string): string {
  const l = dbLabel.toLowerCase();
  if (l === "model_top") return "_ModelTop";
  if (l === "model_bottom") return "_ModelBottom";
  if (l === "rx_pdf") return "_RX";
  if (l === "design_only") return "_Design"; // ✅ Only design_only gets _Design.stl
  if (l === "construction_info") return "_Design"; // Matches suffix but gets .constructionInfo extension below
  return "_File";
}

export async function POST(req: Request) {
  try {
    const session = await getSession();
    if (!session || (session.role !== "milling" && session.role !== "admin")) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { ids } = await req.json();
    if (!ids || !Array.isArray(ids)) return NextResponse.json({ error: "Invalid request" }, { status: 400 });

    const cases = await prisma.dentalCase.findMany({
      where: { id: { in: ids } },
      include: {
        clinic: { include: { address: true } },
        files: true 
      }
    });

    const fileList: { key: string; archivePath: string; isMock?: boolean }[] = [];
    const rootFolder = `Download_${getFormattedDate()}`;

    for (const c of cases) {
      const clinicName = sanitize(c.clinic.name) || "UnknownClinic";
      const zip = sanitize(c.clinic.address?.zipCode) || "NoZip";
      const routingFolder = `${clinicName}_${zip}`;

      const last = sanitize(c.patientLastName);
      const first = sanitize(c.patientFirstName);
      const type = toCamelCase(c.product); 
      let material = toCamelCase(c.material);
      const shade = sanitize(c.shade);

      if (type === "Emax" || type === "InlayOnlay") {
        material = "";
      }
      
      // ✅ FORMAT: DoeJohn_A5-A2-A2_ZirconiaMl
      const caseFolderName = `${last}${first}_${shade}_${type}${material}`;
      
      // ✅ UPDATED: Removed 'design_with_model' and 'scan'
      const relevantLabels = [
        "model_top", 
        "model_bottom", 
        "rx_pdf", 
        "design_only", 
        "construction_info"
      ];

      for (const file of c.files) {
        if (!file.label || !relevantLabels.includes(file.label)) continue;

        const key = file.url;
        const alias = sanitize(c.patientAlias) || "UnknownAlias";
        const suffix = getOutputSuffix(file.label);
        
        let ext = path.extname(key);
        if (!ext && file.kind === "STL") ext = ".stl";
        if (file.label === "construction_info") ext = ".constructionInfo";

        const finalFileName = `${alias}${suffix}${ext}`;
        const archivePath = path.join(rootFolder, routingFolder, caseFolderName, finalFileName);
        
        const isMock = key.startsWith("mock/");
        fileList.push({ key, archivePath, isMock });
      }
    }

    if (fileList.length === 0) {
      return NextResponse.json({ error: "No production files found for selected cases" }, { status: 404 });
    }

    await prisma.dentalCase.updateMany({
      where: { 
        id: { in: ids },
        status: "APPROVED" 
      },
      data: {
        status: "IN_MILLING",
        stage: "MILLING_GLAZING",
        milledAt: new Date()
      }
    });

    const stream = new ReadableStream({
      async start(controller) {
        const archive = archiver("zip", { zlib: { level: 9 } });
        archive.on("data", (chunk) => controller.enqueue(chunk));
        archive.on("end", () => controller.close());
        archive.on("error", (err) => controller.error(err));

        for (const f of fileList) {
          try {
            if (f.isMock) {
               // ✅ Support for mock testing files
               archive.append(`Mock file content for ${f.archivePath}\n(Testing only)`, { name: f.archivePath });
            } else {
               const s3Stream = await getFileStream(f.key);
               archive.append(s3Stream as Readable, { name: f.archivePath });
            }
          } catch (e) {
            console.warn(`[Batch Download] Skipping missing file key: ${f.key}`, e);
            // Insert placeholder error file so the technician knows a file was expected but missing
            archive.append(`Error: File missing from storage.\nKey: ${f.key}`, { name: `${f.archivePath}.ERROR.txt` });
          }
        }
        await archive.finalize();
      },
    });

    return new NextResponse(stream, {
      headers: {
        "Content-Type": "application/zip",
        "Content-Disposition": `attachment; filename="${rootFolder}.zip"`,
        "X-Accel-Buffering": "no",
      },
    });

  } catch (e) {
    console.error("Batch zip error:", e);
    return NextResponse.json({ error: "Failed to generate zip" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/batch/ship/route.ts
// portal/app/api/cases/batch/ship/route.ts

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import crypto from "node:crypto";

export async function POST(req: Request) {
  try {
    const session = await getSession();
    if (!session || (session.role !== "milling" && session.role !== "admin")) {
        return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { ids, tracking, carrier, shippingCost } = await req.json();
    
    if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return NextResponse.json({ error: "No cases selected" }, { status: 400 });
    }

    if (!tracking) {
        return NextResponse.json({ error: "Tracking number is required" }, { status: 400 });
    }

    // ✅ Generate a unique Batch ID for finance tracking
    const batchId = crypto.randomUUID();
    // ✅ Distribute the total shipping cost across selected cases
    const distributedCost = shippingCost ? (Number(shippingCost) / ids.length) : 0;

    await prisma.dentalCase.updateMany({
        where: { id: { in: ids } },
        data: {
            status: "SHIPPED",
            stage: "SHIPPING",
            shippedAt: new Date(),
            trackingNumber: tracking,
            shippingCarrier: carrier || "UPS",
            shippingCost: distributedCost,
            shippingBatchId: batchId
        }
    });

    return NextResponse.json({ ok: true });

  } catch (e) {
    console.error("Batch ship error:", e);
    return NextResponse.json({ error: "Failed to update shipping status" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/new/route.ts
// portal/app/api/cases/new/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { z } from "zod";
import { uploadFile } from "@/lib/storage";

const MAX_FILE_BYTES = 500 * 1024 * 1024; 

// --- ZOD SCHEMA ---
const CreateCaseSchema = z.object({
  patientFirstName: z.string().min(1, "First Name is required"),
  patientLastName: z.string().min(1, "Last Name is required"),
  patientAlias: z.string().min(1, "Patient Alias is required"),
  doctorUserId: z.string().min(1, "Doctor is required"),
  clinicId: z.string().min(1, "Clinic is required"),
  toothCodes: z.string().min(1, "Tooth selection is required"),
  
  orderDate: z.string().refine((d) => !isNaN(Date.parse(d)), "Invalid Order Date"),
  dueDate: z.string().refine((d) => !isNaN(Date.parse(d)), "Invalid Due Date").optional(),

  product: z.string().min(1, "Product is required"),
  material: z.string().optional(),
  shade: z.string().optional(),
  designPreferences: z.string().optional(),
  serviceLevel: z.enum(["IN_HOUSE", "STANDARD"]).default("IN_HOUSE"),
  
  scanHtml: z.instanceof(File, { message: "Scan Viewer HTML is required" }),
  rxPdf: z.instanceof(File, { message: "Rx PDF is required" }),
  
  constructionInfo: z.instanceof(File).optional(),
  modelTop: z.instanceof(File).optional(),
  modelBottom: z.instanceof(File).optional(),
});

function addDays(d: string | Date, n: number) {
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  x.setHours(0, 0, 0, 0);
  return x;
}

// ✅ S3-Aware Save Function
async function saveCaseFile(file: File, caseId: string, label: string) {
  const buf = Buffer.from(await file.arrayBuffer());
  const originalName = file.name || `${label}.bin`;
  const safeName = originalName.replace(/[^a-zA-Z0-9_.-]/g, "_");
  const key = `cases/${caseId}/${label}_${safeName}`;

  await uploadFile(buf, key, file.type);

  let kind = "OTHER";
  const lower = safeName.toLowerCase();
  if (lower.endsWith(".stl")) kind = "STL";
  else if (lower.endsWith(".ply")) kind = "PLY";
  else if (lower.endsWith(".obj")) kind = "OBJ";
  else if (lower.endsWith(".pdf")) kind = "PDF";

  await prisma.caseFile.create({
    data: {
      caseId,
      label,
      kind,
      url: key,
      sizeBytes: buf.length,
    },
  });
}

async function getUniqueAlias(baseAlias: string) {
  const root = baseAlias.slice(0, -2);
  const existing = await prisma.dentalCase.findMany({
    where: { patientAlias: { startsWith: root } },
    select: { patientAlias: true }
  });
  if (existing.length === 0) return baseAlias;

  let maxSuffix = -1;
  existing.forEach((c) => {
    const suffix = parseInt(c.patientAlias.slice(-2), 10);
    if (!isNaN(suffix) && suffix > maxSuffix) {
      maxSuffix = suffix;
    }
  });
  const nextSuffix = (maxSuffix + 1).toString().padStart(2, "0");
  return `${root}${nextSuffix}`;
}

function calculateEstimate(product: string, serviceLevel: string, toothCodes: string) {
  const units = toothCodes.split(",").filter(Boolean).length;
  let basePrice = 0;
  if (product === "ZIRCONIA") basePrice = serviceLevel === "IN_HOUSE" ? 55 : 65;
  else if (product === "EMAX") basePrice = serviceLevel === "IN_HOUSE" ? 110 : 120;
  else if (product === "NIGHTGUARD") basePrice = serviceLevel === "IN_HOUSE" ? 50 : 60;
  else if (product === "INLAY_ONLAY") basePrice = serviceLevel === "IN_HOUSE" ? 65 : 75;
  return basePrice * units;
}

export async function POST(req: Request) {
  try {
    const session = await getSession();
    if (!session) return NextResponse.json({ error: "Please sign in." }, { status: 401 });

    const form = await req.formData();
    const getFile = (key: string) => {
      const f = form.get(key);
      return f instanceof File ? f : undefined;
    };

    const rawData = {
      patientFirstName: form.get("patientFirstName"),
      patientLastName: form.get("patientLastName"),
      patientAlias: form.get("patientAlias"),
      doctorUserId: form.get("doctorUserId"),
      clinicId: form.get("clinicId"),
      toothCodes: form.get("toothCodes"),
      orderDate: form.get("orderDate"),
      dueDate: form.get("dueDate"),
      product: form.get("product"),
      shade: form.get("shade") || undefined,
      material: form.get("material") || undefined,
      designPreferences: form.get("designPreferences") || undefined,
      serviceLevel: form.get("serviceLevel") || "IN_HOUSE",
      
      scanHtml: getFile("scanHtml"),
      rxPdf: getFile("rxPdf"),
      constructionInfo: getFile("constructionInfo"),
      modelTop: getFile("modelTop"),
      modelBottom: getFile("modelBottom"),
    };

    const validation = CreateCaseSchema.safeParse(rawData);
    if (!validation.success) {
      const firstError = validation.error.issues[0];
      return NextResponse.json(
        { error: `${firstError.path.join(".")}: ${firstError.message}` }, 
        { status: 400 }
      );
    }

    const data = validation.data;

    // ✅ Verify Doctor (FETCH SALES REP HERE)
    const doctor = await prisma.user.findUnique({
      where: { id: data.doctorUserId },
      select: { 
        id: true, 
        name: true,
        salesRepId: true // <--- THIS MUST BE HERE, NOT IN CLINIC
      },
    });
    if (!doctor) return NextResponse.json({ error: "Invalid doctor." }, { status: 400 });

    // ✅ Verify Clinic (NO SALES REP HERE)
    const clinic = await prisma.clinic.findUnique({
      where: { id: data.clinicId },
      select: { id: true, priceTier: true },
    });
    if (!clinic) return NextResponse.json({ error: "Invalid clinic." }, { status: 400 });

    const uniqueAlias = await getUniqueAlias(data.patientAlias);
    const cost = calculateEstimate(data.product, data.serviceLevel, data.toothCodes);
    const unitCount = data.toothCodes.split(",").filter(Boolean).length;
    const dueDate = data.dueDate ? new Date(data.dueDate) : addDays(data.orderDate, 8);

    const created = await prisma.dentalCase.create({
      data: {
        clinicId: clinic.id,
        doctorUserId: doctor.id,
        
        // ✅ SNAPSHOT SALES REP
        salesRepId: doctor.salesRepId,

        assigneeId: session.userId, 
        patientFirstName: data.patientFirstName,
        patientLastName: data.patientLastName,
        patientAlias: uniqueAlias,
        doctorName: doctor.name ?? null,
        toothCodes: data.toothCodes,
        orderDate: new Date(data.orderDate),
        dueDate: dueDate, 
        product: data.product,
        material: data.material || null,
        serviceLevel: data.serviceLevel, 
        shade: data.shade || null,
        designPreferences: data.designPreferences || null,
        status: "IN_DESIGN",
        stage: "DESIGN",
        units: unitCount,
        cost,
        billingType: "BILLABLE",
        invoiced: false,
      },
      select: { id: true },
    });

    await saveCaseFile(data.scanHtml, created.id, "scan_html");
    await saveCaseFile(data.rxPdf, created.id, "rx_pdf");
    if (data.constructionInfo) await saveCaseFile(data.constructionInfo, created.id, "construction_info");
    if (data.modelTop) await saveCaseFile(data.modelTop, created.id, "model_top");
    if (data.modelBottom) await saveCaseFile(data.modelBottom, created.id, "model_bottom");

    return NextResponse.json({ ok: true, id: created.id });

  } catch (err: any) { 
    console.error("Create case error:", err);
    return NextResponse.json(
      { error: "Something went wrong creating the case." },
      { status: 500 },
    );
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/comments/route.ts
// portal/app/api/cases/[id]/comments/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { getSignedFileUrl } from "@/lib/storage";

// Helper to sign attachments in a comment list
async function signCommentAttachments(comment: any) {
  if (!comment || !comment.attachments) return comment;
  const signedAttachments = await Promise.all(
    comment.attachments.map(async (att: any) => {
      // If it's already a full URL (legacy), leave it. Otherwise, sign it.
      if (att.url.startsWith("http")) return att;
      try {
        const signed = await getSignedFileUrl(att.url);
        return { ...att, url: signed };
      } catch (e) {
        console.error("Failed to sign URL:", att.url);
        return att;
      }
    })
  );

  return { ...comment, attachments: signedAttachments };
}

export async function POST(
  request: Request,
  props: { params: Promise<{ id: string }> }
) {
  try {
    const session = await getSession();
    if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    const params = await props.params;
    const { id: caseId } = params;
    
    // ✅ SECURITY FIX: verify access rights
    const dentalCase = await prisma.dentalCase.findUnique({
      where: { id: caseId },
      select: { id: true, doctorUserId: true, clinicId: true }
    });

    if (!dentalCase) {
      return NextResponse.json({ error: "Case not found" }, { status: 404 });
    }

    // If user is a Doctor, they MUST own the case or be in the same clinic
    if (session.role === "customer") {
      const isOwner = dentalCase.doctorUserId === session.userId;
      const isSameClinic = session.clinicId && dentalCase.clinicId === session.clinicId;
      
      if (!isOwner && !isSameClinic) {
        return NextResponse.json({ error: "Forbidden" }, { status: 403 });
      }
    }

    const json = await request.json();
    const { body, attachmentFileId } = json;
    
    if (!body && !attachmentFileId) {
      return NextResponse.json({ error: "Body or attachment required" }, { status: 400 });
    }

    // 1. Create the comment
    const newComment = await prisma.caseComment.create({
      data: {
        caseId,
        authorId: session.userId,
        body: body || "",
      },
    });

    // 2. Link the attachment if present
    if (attachmentFileId) {
      await prisma.caseFile.update({
        where: { id: attachmentFileId },
        data: { 
          commentId: newComment.id 
        } as any, 
      });
    }

    // 3. Fetch result with attachments
    const finalComment = await prisma.caseComment.findUnique({
      where: { id: newComment.id },
      include: {
        attachments: true,
      } as any,
    });

    const signedComment = await signCommentAttachments(finalComment);

    return NextResponse.json(signedComment);
  } catch (error) {
    console.error("Comment error:", error);
    return NextResponse.json({ error: "Internal Error" }, { status: 500 });
  }
}

export async function GET(
  request: Request,
  props: { params: Promise<{ id: string }> }
) {
  const session = await getSession();
  if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const params = await props.params;
  const { id } = params;
  
  // ✅ SECURITY FIX: verify access rights
  const dentalCase = await prisma.dentalCase.findUnique({
    where: { id },
    select: { id: true, doctorUserId: true, clinicId: true }
  });

  if (!dentalCase) {
    return NextResponse.json({ error: "Case not found" }, { status: 404 });
  }

  // If user is a Doctor, they MUST own the case or be in the same clinic
  if (session.role === "customer") {
    const isOwner = dentalCase.doctorUserId === session.userId;
    const isSameClinic = session.clinicId && dentalCase.clinicId === session.clinicId;
    
    if (!isOwner && !isSameClinic) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
  }
  
  const comments = await prisma.caseComment.findMany({
    where: { caseId: id },
    orderBy: { createdAt: "asc" },
    include: {
      attachments: true,
    } as any, 
  });

  const signedComments = await Promise.all(comments.map(signCommentAttachments));

  return NextResponse.json({ comments: signedComments });
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/transition/route.ts
// portal/app/api/cases/[id]/transition/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import type { Prisma } from "@prisma/client";
import type { CaseStatus, ProductionStage } from "@/lib/types";

function stageForStatus(to: CaseStatus): ProductionStage {
  switch (to) {
    case "IN_MILLING":
      return "MILLING_GLAZING";
    case "SHIPPED":
      return "SHIPPING";
    case "COMPLETED":
      return "COMPLETED";
    case "DELIVERED": // ✅ Final Stage
      return "DELIVERED";
    case "APPROVED":
    default:
      return "DESIGN";
  }
}

export async function POST(
  req: Request,
  ctx: { params: Promise<{ id: string }> }
) {
  const session = await getSession();
  if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { id } = await ctx.params;
  const body = await req.json().catch(() => ({}));
  const to = body?.to as CaseStatus | undefined;
  const note: string | undefined = body?.note;

  if (!to) return NextResponse.json({ error: "Missing 'to' status" }, { status: 400 });

  const item = await prisma.dentalCase.findUnique({ 
    where: { id },
    include: { files: true }
  });
  if (!item) return NextResponse.json({ error: "Not found" }, { status: 404 });

  // ✅ DOCTOR PERMISSIONS
  if (session.role === "customer") {
    // Doctors can approve designs AND mark Delivered
    const allowedForDoctor: CaseStatus[] = ["APPROVED", "CHANGES_REQUESTED", "DELIVERED"];
    
    if (!allowedForDoctor.includes(to)) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
    
    // Ownership Check
    const isOwner = item.doctorUserId === session.userId;
    const isSameClinic = session.clinicId && item.clinicId === session.clinicId;
    if (!isOwner && !isSameClinic) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }

    // ✅ LOGIC: Can only mark DELIVERED if it is currently COMPLETED (Arrived)
    if (to === "DELIVERED" && item.status !== "COMPLETED") {
        return NextResponse.json({ error: "Case must be marked Completed (Arrived at Clinic) before marking Delivered." }, { status: 400 });
    }
  }

  // (Keep existing Lab/Admin guard logic for APPROVED...)
  if (to === "APPROVED") {
    if (["APPROVED", "IN_MILLING", "SHIPPED", "COMPLETED", "DELIVERED"].includes(item.status)) {
      return NextResponse.json({ error: "Case is already approved/processed." }, { status: 400 });
    }
    const labels = new Set(item.files.map((f) => f.label));
    const missing: string[] = [];
    if (!labels.has("construction_info")) missing.push("Construction Info");
    if (!labels.has("model_top")) missing.push("Model Top");
    if (!labels.has("model_bottom")) missing.push("Model Bottom");
    
    if (missing.length > 0) {
       return NextResponse.json({ 
         error: `Cannot Approve Design. Missing files: ${missing.join(", ")}` 
       }, { status: 400 });
    }
  }

  const newStage = stageForStatus(to);
  const at = new Date();

  await prisma.$transaction(async (tx: Prisma.TransactionClient) => {
    await tx.dentalCase.update({
      where: { id },
      data: {
        status: to,
        stage: newStage,
        designedAt: to === "READY_FOR_REVIEW" ? at : item.designedAt,
        milledAt: to === "IN_MILLING" ? at : item.milledAt,
        shippedAt: to === "SHIPPED" ? at : item.shippedAt,
        // We could add a 'deliveredAt' field to DB later if needed, 
        // for now statusEvent tracks the timestamp.
      },
    });

    await tx.statusEvent.create({
      data: {
        caseId: id,
        from: item.status,
        to,
        note: note ?? null,
        actorId: session.userId ?? undefined,
      },
    });
  });

  return NextResponse.json({ ok: true, status: to, stage: newStage, at });
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/shipping/route.ts
// portal/app/api/cases/[id]/shipping/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function POST(
  request: Request,
  { params }: { params: Promise<{ id: string }> } // <--- FIXED TYPE
) {
  try {
    const session = await getSession();
    if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    const { id } = await params; // <--- AWAIT PARAMS
    const json = await request.json();
    const { carrier, tracking, eta } = json;

    const updatedCase = await prisma.dentalCase.update({
      where: { id },
      data: {
        shippingCarrier: carrier,
        trackingNumber: tracking,
        shippingEta: eta ? new Date(eta) : null,
        shippedAt: new Date(), // Auto-set shipped timestamp
        status: "SHIPPED",     // Auto-update status
        stage: "SHIPPING"      // Auto-update stage
      },
    });

    return NextResponse.json({ 
      ok: true, 
      shipping: { 
        carrier: updatedCase.shippingCarrier, 
        tracking: updatedCase.trackingNumber, 
        eta: updatedCase.shippingEta 
      } 
    });
  } catch (error) {
    console.error("Shipping update error:", error);
    return NextResponse.json({ error: "Failed to update shipping" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/assign/route.ts
// app/api/cases/[id]/assign/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function POST(
  req: Request,
  props: { params: Promise<{ id: string }> }
) {
  try {
    const session = await getSession();
    // CHANGED: Only "admin" can assign. "lab" cannot.
    if (!session || session.role !== "admin") {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { id } = await props.params;
    const body = await req.json();
    const { assigneeId } = body;

    // assigneeId can be null (unassigned) or a valid UUID
    if (assigneeId && typeof assigneeId !== "string") {
      return NextResponse.json({ error: "Invalid assignee ID" }, { status: 400 });
    }

    await prisma.dentalCase.update({
      where: { id },
      data: {
        assigneeId: assigneeId || null
      }
    });

    return NextResponse.json({ ok: true });
  } catch (e) {
    console.error("Assignment error:", e);
    return NextResponse.json({ error: "Failed to update assignment" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/review/route.ts
// app/api/cases/[id]/review/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

type Params = {
  params: Promise<{ id: string }>;
};

export async function POST(req: Request, { params }: Params) {
  const session = await getSession();
  if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { id } = await params;
  const { needsReview, question } = await req.json();
  
  if (typeof needsReview !== "boolean") {
    return NextResponse.json({ error: "needsReview boolean required" }, { status: 400 });
  }

  // DIRECT FIX: Use prisma.dentalCase directly
  const item = await prisma.dentalCase.findUnique({ where: { id } });
  if (!item) return NextResponse.json({ error: "Not found" }, { status: 404 });

  if (session.role === "customer") {
    if (!session.clinicId || session.clinicId !== item.clinicId) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
    // Doctors cannot REQUEST a review (they only answer them)
    if (needsReview === true) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
  }

  const data: any = { needsReview };
  if (needsReview) {
    data.reviewQuestion = (question ?? "").toString().slice(0, 500);
    data.reviewRequestedAt = new Date();
  } else {
    data.reviewQuestion = null;
  }

  await prisma.dentalCase.update({ where: { id }, data });
  return NextResponse.json({ ok: true });
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/files/upload-url/route.ts
import { NextResponse } from "next/server";
import { getSession } from "@/lib/auth";
import { getPresignedUploadUrl } from "@/lib/storage";
import { prisma } from "@/lib/prisma"; // ✅ Import Prisma

export async function POST(
  req: Request,
  props: { params: Promise<{ id: string }> }
) {
  const session = await getSession();
  if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const params = await props.params;
  const { id } = params;

  // ✅ SECURITY CHECK START
  // Prevent doctors from requesting upload URLs for cases they don't own
  if (session.role === "customer") {
    const dentalCase = await prisma.dentalCase.findUnique({
      where: { id },
      select: { doctorUserId: true, clinicId: true }
    });

    if (!dentalCase) {
      return NextResponse.json({ error: "Case not found" }, { status: 404 });
    }

    const isOwner = dentalCase.doctorUserId === session.userId;
    const isSameClinic = session.clinicId && dentalCase.clinicId === session.clinicId;

    if (!isOwner && !isSameClinic) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
  }
  // ✅ SECURITY CHECK END

  const { filename, contentType, label } = await req.json();
  
  // 1. Create a clean file path
  const safeName = (filename || "file").replace(/[^a-zA-Z0-9_.-]/g, "_");
  const key = `cases/${id}/${label}_${Date.now()}_${safeName}`;

  // 2. Generate the URL
  const url = await getPresignedUploadUrl(key, contentType);

  return NextResponse.json({ url, key });
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/files/route.ts
// portal/app/api/cases/[id]/files/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

const FileKind = {
  STL: "STL",
  PLY: "PLY",
  OBJ: "OBJ",
  PDF: "PDF", 
  OTHER: "OTHER"
} as const;

type FileKindType = typeof FileKind[keyof typeof FileKind];

const ProductionStage = {
  DESIGN: "DESIGN",
  MILLING_GLAZING: "MILLING_GLAZING",
  SHIPPING: "SHIPPING"
} as const;

function normalizeSlotLabel(raw: string | null): string {
  const lower = (raw ?? "").toString().trim().toLowerCase();
  if (!lower) return "other";
  if (lower === "scan") return "scan";
  if (lower === "design_with_model" || lower === "model_plus_design") return "design_with_model";
  if (lower === "design_only") return "design_only";
  return lower;
}

export async function POST(
  req: Request,
  props: { params: Promise<{ id: string }> }
) {
  try {
    const session = await getSession();
    if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    const { id } = await props.params;
    const body = await req.json(); 
    const { key, label: rawLabel, size, filename } = body;

    if (!key || !rawLabel) {
      return NextResponse.json({ error: "Missing file metadata" }, { status: 400 });
    }

    const slotLabel = normalizeSlotLabel(rawLabel);

    // Case Existence & Stage Check
    // ✅ ADDED: doctorUserId to the selection
    const dentalCase = await prisma.dentalCase.findUnique({
      where: { id },
      select: { id: true, stage: true, clinicId: true, doctorUserId: true },
    });

    if (!dentalCase) return NextResponse.json({ error: "Case not found." }, { status: 404 });

    // ✅ FIXED: Doctor Ownership Validation
    if (session.role === "customer") {
        const isOwner = dentalCase.doctorUserId === session.userId;
        const isSameClinic = session.clinicId && dentalCase.clinicId === session.clinicId;

        if (!isOwner && !isSameClinic) {
            return NextResponse.json({ error: "Forbidden" }, { status: 403 });
        }
    }

    // Stage Validation (Scan only in DESIGN)
    if (slotLabel === "scan" && dentalCase.stage !== ProductionStage.DESIGN) {
      return NextResponse.json(
        { error: "Scan files can only be uploaded while the case is in the DESIGN stage." },
        { status: 400 },
      );
    }

    // Determine File Kind
    const ext = filename.split('.').pop()?.toLowerCase();
    let kind: FileKindType = FileKind.OTHER;
    if (ext === 'stl') kind = FileKind.STL;
    else if (ext === 'ply') kind = FileKind.PLY;
    else if (ext === 'obj') kind = FileKind.OBJ;
    else if (ext === 'pdf') kind = FileKind.PDF;

    // Replacement Logic (Delete old DB record for this slot)
    const REPLACE_SLOTS = ["scan", "design_with_model", "design_only", "scan_html", "design_with_model_html", "rx_pdf"];
    if (REPLACE_SLOTS.includes(slotLabel)) {
      await prisma.caseFile.deleteMany({
        where: { caseId: id, label: slotLabel },
      });
    }

    // Create the DB record
    const record = await prisma.caseFile.create({
      data: {
        caseId: id,
        label: slotLabel,
        kind: kind, 
        url: key, 
        sizeBytes: size,
      },
    });

    return NextResponse.json({ ok: true, id: record.id });

  } catch (error) {
    console.error("File record error:", error);
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/stage/route.ts
// portal/app/api/cases/[id]/stage/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

type Params = {
  params: Promise<{ id: string }>;
};

type Stage = "DESIGN" | "MILLING_GLAZING" | "SHIPPING" | "COMPLETED";
const STAGE_ORDER: Stage[] = ["DESIGN", "MILLING_GLAZING", "SHIPPING", "COMPLETED"];

export async function POST(req: Request, { params }: Params) {
  const session = await getSession();
  if (!session) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  // Basic role check
  if (session.role !== "admin" && session.role !== "lab") {
    return NextResponse.json(
      { error: "Only lab/admin can update the process." },
      { status: 403 },
    );
  }

  const { id } = await params;

  let body: any;
  try {
    body = await req.json();
  } catch {
    return NextResponse.json(
      { error: "Invalid request body." },
      { status: 400 },
    );
  }

  const targetStage = body?.stage as Stage | undefined;
  if (!targetStage || !STAGE_ORDER.includes(targetStage)) {
    return NextResponse.json(
      { error: "Invalid target stage." },
      { status: 400 },
    );
  }

  // LOGIC CHANGE: Lab cannot manually start milling. It happens via download.
  if (targetStage === "MILLING_GLAZING" && session.role === "lab") {
    return NextResponse.json(
        { error: "Lab users cannot manually start milling. This happens automatically when the Milling Center downloads the files." },
        { status: 403 }
    );
  }

  const existing = await prisma.dentalCase.findUnique({
    where: { id },
  });
  
  if (!existing) {
    return NextResponse.json({ error: "Case not found." }, { status: 404 });
  }

  const currentStage = existing.stage as Stage;
  const currentStatus = existing.status as string;

  const currentIndex = STAGE_ORDER.indexOf(currentStage);
  const targetIndex = STAGE_ORDER.indexOf(targetStage);

  if (targetIndex === -1) {
    return NextResponse.json(
      { error: "Unsupported stage." },
      { status: 400 },
    );
  }

  if (targetIndex === currentIndex) {
    return NextResponse.json({ ok: true, stage: currentStage });
  }

  if (targetIndex < currentIndex) {
    return NextResponse.json(
      { error: "Process cannot move backwards." },
      { status: 400 },
    );
  }

  let nextStatus = currentStatus;
  
  if (currentStage === "DESIGN" && targetStage === "MILLING_GLAZING") {
    if (currentStatus !== "APPROVED") {
      return NextResponse.json(
        {
          error:
            "Case must be APPROVED before moving to Milling & Glazing.",
        },
        { status: 400 },
      );
    }
    nextStatus = "IN_MILLING";
  } 
  else if (
    currentStage === "MILLING_GLAZING" &&
    targetStage === "SHIPPING"
  ) {
    nextStatus = "SHIPPED";
  } 
  else if (
    currentStage === "SHIPPING" &&
    targetStage === "COMPLETED"
  ) {
    nextStatus = "COMPLETED";
  }
  else if (currentStage === "DESIGN" && targetStage === "SHIPPING") {
    return NextResponse.json(
      {
        error:
          "Case must go through Milling & Glazing before Shipping.",
      },
      { status: 400 },
    );
  }

  const [updated] = await prisma.$transaction([
    prisma.dentalCase.update({
      where: { id },
      data: {
        stage: targetStage,
        status: nextStatus as any,
      },
      select: { id: true, stage: true, status: true },
    }),
    prisma.statusEvent.create({
      data: {
        caseId: id,
        from: currentStatus,
        to: nextStatus,
        note: null, 
        actorId: session.userId,
      }
    })
  ]);

  return NextResponse.json({ ok: true, stage: updated.stage, status: updated.status });
}
--- END OF FILE ---

FILE: ./app/api/clinics/route.ts
//portal/app/api/clinics/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function GET() {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  // Include address in list for editing
  const clinics = await prisma.clinic.findMany({ 
    orderBy: { name: "asc" },
    include: { address: true, _count: { select: { users: true, cases: true } } }
  });
  return NextResponse.json(clinics);
}

export async function POST(req: Request) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const data = await req.json();
  if (!data.name) return NextResponse.json({ error: "Name required" }, { status: 400 });

  const addr = data.address || {};
  let addressConfig = undefined;
  if (addr.id) {
    addressConfig = { connect: { id: addr.id } };
  } else if (addr.street) {
    addressConfig = {
      create: {
        street: addr.street,
        city: addr.city,
        state: addr.state,
        zipCode: addr.zipCode
      }
    };
  }

  const clinic = await prisma.clinic.create({
    data: {
      name: data.name,
      phone: data.phone,
      billingCycleDay: Number(data.billingCycleDay) || 1,
      paymentTerms: Number(data.paymentTerms) || 30,
      priceTier: data.priceTier || "STANDARD",
      taxId: data.taxId,
      bankName: data.bankName,
      routingNumber: data.routingNumber,
      bankLast4: data.bankLast4,
      address: addressConfig
    }
  });
  return NextResponse.json(clinic);
}
--- END OF FILE ---

FILE: ./app/api/clinics/[id]/route.ts
//portal/app/api/clinics/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function PUT(req: Request, { params }: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  const { id } = await params;
  const data = await req.json();

  const addr = data.address || {};
  let addressConfig = undefined;
  
  if (addr.id) {
    addressConfig = { connect: { id: addr.id } };
  } else if (addr.street) {
    addressConfig = {
      create: {
        street: addr.street,
        city: addr.city,
        state: addr.state,
        zipCode: addr.zipCode
      }
    };
  }

  const clinic = await prisma.clinic.update({
    where: { id },
    data: {
      name: data.name,
      phone: data.phone,
      billingCycleDay: Number(data.billingCycleDay) || 1,
      paymentTerms: Number(data.paymentTerms) || 30,
      priceTier: data.priceTier || "STANDARD",
      taxId: data.taxId,
      bankName: data.bankName,
      routingNumber: data.routingNumber,
      bankLast4: data.bankLast4,
      address: addressConfig
    }
  });
  return NextResponse.json(clinic);
}

// NEW: Delete Clinic
export async function DELETE(req: Request, { params }: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { id } = await params;

  try {
    await prisma.clinic.delete({ where: { id } });
    return NextResponse.json({ ok: true });
  } catch (e: any) {
    return NextResponse.json({ error: "Cannot delete clinic. It likely has users or cases linked." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/sentry-example-api/route.ts
import * as Sentry from "@sentry/nextjs";
export const dynamic = "force-dynamic";

class SentryExampleAPIError extends Error {
  constructor(message: string | undefined) {
    super(message);
    this.name = "SentryExampleAPIError";
  }
}

// A faulty API route to test Sentry's error monitoring
export function GET() {
  Sentry.logger.info("Sentry example API called");
  throw new SentryExampleAPIError(
    "This error is raised on the backend called by the example page.",
  );
}

--- END OF FILE ---

FILE: ./app/api/addresses/route.ts
// portal/app/api/addresses/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { Prisma } from "@prisma/client";

export async function GET(req: Request) {
  const session = await getSession();
  if (!session) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  // Only admin and lab users can access address search
  if (session.role !== "admin" && session.role !== "lab") {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const url = new URL(req.url);
  const q = url.searchParams.get("q") || "";

  try {
    const where: Prisma.AddressWhereInput = {};
    
    if (q.trim()) {
      where.OR = [
        { street: { contains: q.trim() } },
        { city: { contains: q.trim() } },
        { state: { contains: q.trim() } },
        { zipCode: { contains: q.trim() } },
      ];
    }

    const addresses = await prisma.address.findMany({
      where,
      orderBy: { createdAt: "desc" },
      take: 50,
    });

    return NextResponse.json(addresses);
  } catch {
    return NextResponse.json({ error: "Failed to fetch addresses." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/addresses/[id]/route.ts
// portal/app/api/addresses/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function DELETE(req: Request, props: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const params = await props.params;
  const { id } = params;

  try {
    // 1. Unlink from Users (Wipe address data from user profiles)
    await prisma.user.updateMany({
      where: { addressId: id },
      data: { addressId: null }
    });

    // 2. Unlink from Clinics (Wipe address data from clinic profiles)
    await prisma.clinic.updateMany({
      where: { addressId: id },
      data: { addressId: null }
    });

    // 3. Delete the Address Record
    await prisma.address.delete({ where: { id } });

    return NextResponse.json({ ok: true });
  } catch (e: any) {
    console.error("Address delete error:", e);
    return NextResponse.json({ error: "Failed to delete address." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/users/new/route.ts
// portal/app/api/users/new/route.ts
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import bcrypt from "bcryptjs";
import crypto from "node:crypto";
import { Prisma } from "@prisma/client";
import { Resend } from "resend";
import { CreateUserSchema } from "@/lib/schemas"; 

const resend = process.env.RESEND_API_KEY ? new Resend(process.env.RESEND_API_KEY) : null;

export async function POST(req: Request) {
  try {
    const session = await getSession();
    if (!session || session.role !== "admin") {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const body = await req.json().catch(() => ({}));
    
    // Manual Extraction for fields not in Zod schema yet (secondaryClinicIds)
    const secondaryIds = Array.isArray(body.secondaryClinicIds) ? body.secondaryClinicIds : [];

    // 1. Zod Validation
    const validation = CreateUserSchema.safeParse(body);
    if (!validation.success) {
      const firstError = validation.error.issues[0];
      return NextResponse.json(
        { error: `${firstError.path.join(".")}: ${firstError.message}` }, 
        { status: 400 }
      );
    }
    const data = validation.data;

    // 2. Check Uniqueness
    const existing = await prisma.user.findUnique({ where: { email: data.email } });
    if (existing) {
      return NextResponse.json({ error: "A user with this email already exists." }, { status: 400 });
    }

    // 3. Clinic Resolution
    let resolvedClinicId: string | null = data.clinicId || null;
    if (!resolvedClinicId && data.newClinicName) {
      const createdClinic = await prisma.clinic.create({ data: { name: data.newClinicName } });
      resolvedClinicId = createdClinic.id;
    }

    // 4. Generate Credentials
    const tempPassword = crypto.randomBytes(6).toString("hex");
    const pw = await bcrypt.hash(tempPassword, 10);

    // 5. Address Logic
    let addressConfig = undefined;
    const addr = data.address;
    if (addr?.id) {
        addressConfig = { connect: { id: addr.id } };
    } else if (addr?.street) {
        addressConfig = {
            create: {
                street: addr.street,
                city: addr.city,
                state: addr.state,
                zipCode: addr.zipCode
            }
        };
    }

    // 6. Create User
    const createData: Prisma.UserCreateInput = {
        email: data.email,
        password: pw,
        name: data.name,
        role: data.role,
        clinic: resolvedClinicId ? { connect: { id: resolvedClinicId } } : undefined,
        
        // ✅ NEW: Connect Secondary Clinics
        secondaryClinics: {
           connect: secondaryIds.map((id: string) => ({ id }))
        },

        phoneNumber: data.phoneNumber || null,
        preferenceNote: data.preferenceNote || null,
        address: addressConfig
    };

    const user = await prisma.user.create({
      data: createData,
      select: { id: true, email: true, name: true },
    });

    // 7. Send Email
    if (resend) {
        try {
            await resend.emails.send({
                from: process.env.EMAIL_FROM || "onboarding@resend.dev",
                to: data.email,
                subject: "Welcome to Lumera Dental Portal",
                html: `
                    <div style="font-family: sans-serif; color: #111; padding: 20px;">
                        <h2 style="color: #1e1e1e;">Welcome to Lumera</h2>
                        <p>Hello ${data.name || "Doctor"},</p>
                        <p>Your account has been created.</p>
                        <p><strong>Login:</strong> ${data.email}</p>
                        <p><strong>Password:</strong> ${tempPassword}</p>
                        <p><a href="https://lumeradental.com/login">Log in here</a></p>
                    </div>
                `
            });
        } catch (err) {
            console.error("[Email] Failed to send credentials:", err);
        }
    }

    return NextResponse.json({ ok: true, user });
  } catch (e: any) {
    console.error("Create user error:", e);
    return NextResponse.json({ error: "Internal error while creating user." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/users/[id]/route.ts
// portal/app/api/users/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function PUT(req: Request, props: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  
  const params = await props.params;
  const { id } = params;
  const data = await req.json();

  // Address Logic
  const addr = data.address || {};
  let addressConfig = undefined;
  if (addr.id) {
    addressConfig = { connect: { id: addr.id } };
  } else if (addr.street) {
    addressConfig = {
      create: {
        street: addr.street,
        city: addr.city,
        state: addr.state,
        zipCode: addr.zipCode
      }
    };
  }

  // Primary Clinic Logic
  let clinicConfig = undefined;
  if (data.clinicId) {
    clinicConfig = { connect: { id: data.clinicId } };
  } else if (data.clinicId === null || data.clinicId === "") {
    clinicConfig = { disconnect: true };
  }

  // Secondary Clinics Logic
  const secondaryIds = Array.isArray(data.secondaryClinicIds) ? data.secondaryClinicIds : [];
  const secondaryConfig = {
     set: secondaryIds.map((cid: string) => ({ id: cid }))
  };

  // ✅ FIXED: Sales Rep Logic using Relation Syntax
  // We cannot set 'salesRepId' directly. We must use connect/disconnect.
  let salesRepConfig = undefined;
  if (data.salesRepId) {
    // If an ID is provided, Connect it
    salesRepConfig = { connect: { id: data.salesRepId } };
  } else {
    // If ID is empty/null, Disconnect it
    salesRepConfig = { disconnect: true };
  }

  const updateData: any = {
    name: data.name,
    email: data.email,
    role: data.role,
    clinic: clinicConfig,
    secondaryClinics: secondaryConfig,
    salesRep: salesRepConfig, // ✅ Use the relation object
    phoneNumber: data.phoneNumber || null,
    preferenceNote: data.preferenceNote || null,
    address: addressConfig
  };

  try {
    const user = await prisma.user.update({
      where: { id },
      data: updateData
    });
    return NextResponse.json(user);
  } catch (e: any) {
    console.error("Update User Error:", e);
    return NextResponse.json({ error: "Failed to update user." }, { status: 500 });
  }
}

export async function DELETE(req: Request, props: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  
  const params = await props.params;
  const { id } = params;

  try {
    await prisma.user.delete({ where: { id } });
    return NextResponse.json({ ok: true });
  } catch (e: any) {
    return NextResponse.json({ error: "Failed to delete user. They may have active cases." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/page.tsx
// portal/app/page.tsx
"use client";

import { useEffect, useRef } from "react";
import Link from "next/link";
import Image from "next/image";
import PublicNavbar from "@/components/PublicNavbar";
import PublicFooter from "@/components/PublicFooter";

export default function HomePage() {
  // Reveal Animation Logic
  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            e.target.classList.add("in");
          }
        });
      },
      { threshold: 0.1 }
    );
    document.querySelectorAll(".reveal").forEach((el) => observer.observe(el));
    return () => observer.disconnect();
  }, []);

  // Card Tilt Logic
  const cardRef = useRef<HTMLDivElement>(null);
  const handleMove = (e: React.MouseEvent) => {
    if (!cardRef.current) return;
    const r = cardRef.current.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width - 0.5;
    const y = (e.clientY - r.top) / r.height - 0.5;
    cardRef.current.style.transform = `rotateY(${x * 8}deg) rotateX(${-y * 8}deg)`;
  };
  const handleLeave = () => {
    if (cardRef.current) cardRef.current.style.transform = "rotateY(0) rotateX(0)";
  };

  return (
    <main className="min-h-screen flex flex-col bg-background text-foreground selection:bg-accent selection:text-background transition-colors duration-300">
      <PublicNavbar />

      {/* HERO SECTION */}
      <section className="relative pt-24 pb-20 md:pt-32 md:pb-32 overflow-hidden">
        {/* Background Gradients */}
        <div className="absolute inset-0 pointer-events-none">
          <div className="absolute top-0 right-0 w-[800px] h-[800px] bg-accent/10 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/3" />
          <div className="absolute bottom-0 left-0 w-[600px] h-[600px] bg-blue-500/10 rounded-full blur-[100px] translate-y-1/3 -translate-x-1/4" />
        </div>

        <div className="container mx-auto px-6 relative z-10 grid lg:grid-cols-2 gap-12 items-center">
          {/* Text Content */}
          <div className="space-y-8">
            <h1 className="text-5xl md:text-7xl font-semibold tracking-tight reveal">
              The Crown
            </h1>
            <p className="text-xl md:text-2xl text-muted max-w-lg leading-relaxed reveal">
              One product. $60 all-in. Zirconia perfected — no menus, no upsells, no confusion.
            </p>
            <div className="flex flex-wrap gap-4 reveal">
              <Link
                href="/contact"
                className="px-8 py-4 rounded-full bg-foreground text-background font-bold hover:bg-foreground/90 transition-all shadow-lg"
              >
                Send a Case
              </Link>
              <Link
                href="/work"
                className="px-8 py-4 rounded-full border border-border hover:bg-surface transition-colors font-medium backdrop-blur-md"
              >
                See the Craft
              </Link>
            </div>
            <div className="flex items-center gap-3 text-sm text-muted reveal">
              <div className="w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_10px_rgba(52,211,153,0.6)]" />
              <span>Made in USA • Delivery in 7 business days</span>
            </div>
          </div>

          {/* 3D Card */}
          <div className="perspective-1000 flex justify-center lg:justify-end reveal">
            <div
              ref={cardRef}
              onMouseMove={handleMove}
              onMouseLeave={handleLeave}
              className="relative w-full max-w-md aspect-[4/5] rounded-[32px] border border-border bg-surface backdrop-blur-xl shadow-2xl overflow-hidden transition-all duration-300 ease-out"
              style={{ transformStyle: "preserve-3d" }}
            >
              {/* Card Glow */}
              <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none" />
              
              <div className="relative p-8 h-full flex flex-col justify-between z-10">
                <div className="flex justify-between items-start">
                  <div className="flex flex-wrap gap-2">
                    <span className="px-3 py-1 rounded-full border border-border bg-surface-highlight text-xs font-medium transition-colors">Zirconia</span>
                    <span className="px-3 py-1 rounded-full border border-border bg-surface-highlight text-xs font-medium transition-colors">USA</span>
                  </div>
                  <div className="text-right">
                    <div className="text-3xl font-bold text-foreground">$60</div>
                    <div className="text-xs text-muted">all-in</div>
                  </div>
                </div>

                {/* Animated GIF - REQUIRES Images/CrownLoop.gif in public folder */}
                <div className="flex-1 flex items-center justify-center my-4">
                  <div className="relative w-64 h-64">
                    <Image 
                      src="/Images/CrownLoop.gif" 
                      alt="Crown" 
                      fill
                      className="object-contain drop-shadow-[0_20px_50px_rgba(150,150,226,0.15)]"
                      unoptimized
                    />
                  </div>
                </div>

                {/* Specs */}
                <div className="grid grid-cols-2 gap-3 text-sm">
                  <div className="p-3 rounded-xl border border-border bg-surface-highlight flex justify-between items-center transition-colors">
                    <span className="text-muted">Strength</span>
                    <span className="font-semibold">1200 MPa</span>
                  </div>
                  <div className="p-3 rounded-xl border border-border bg-surface-highlight flex justify-between items-center transition-colors">
                    <span className="text-muted">Translucency</span>
                    <span className="font-semibold">43%</span>
                  </div>
                  <div className="p-3 rounded-xl border border-border bg-surface-highlight flex justify-between items-center transition-colors">
                    <span className="text-muted">Margin</span>
                    <span className="font-semibold">0.2 mm</span>
                  </div>
                  <div className="p-3 rounded-xl border border-border bg-surface-highlight flex justify-between items-center transition-colors">
                    <span className="text-muted">Material</span>
                    <span className="font-semibold">3Y</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* QUALITY SECTION */}
      <section className="py-24 border-t border-white/5 relative">
        <div className="container mx-auto px-6">
          <div className="max-w-2xl mb-16">
            <h2 className="text-4xl font-semibold mb-6 reveal text-foreground">Quality without complexity</h2>
            <p className="text-xl text-muted leading-relaxed reveal">
              We focus on one thing—zirconia crowns—so every step is tuned for excellence. 
              Our globally distributed design team keeps work moving overnight; US manufacturing ensures consistent quality.
            </p>
          </div>

          <div className="grid md:grid-cols-3 gap-6">
            {[
              { title: "Microscopic fit", desc: "Margins verified under magnification; designed for a consistent passive fit to reduce chairside adjustment." },
              { title: "Global design, local quality", desc: "Overnight responsiveness from our global design team; Made in USA production for precision." },
              { title: "Always responsive", desc: "A highly responsive team with clear communication at every step." }
            ].map((card, i) => (
              <div key={i} className="p-8 rounded-3xl border border-border bg-surface hover:bg-surface-highlight transition-colors reveal">
                <h3 className="text-xl font-medium mb-4">{card.title}</h3>
                <p className="text-muted leading-relaxed">{card.desc}</p>
              </div>
            ))}
          </div>
        </div>
      </section>

      <PublicFooter />
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/globals.css
@import "tailwindcss";

:root {
  /* --- DARK MODE (Midnight Hierarchy) --- */
  /* Level 1: Page Background (Deepest) */
  --background: #020617; 
  
  /* Level 2: Sidebar (Mid-Tone) */
  --sidebar-bg: #0f172a; 
  
  /* Level 3: Surface/Tables (Elevated/Lightest) */
  /* ✅ FIX: Updated to Dark Midnight #111b2d as requested */
  --surface: #111b2d;    
  
  /* Inputs */
  --surface-highlight: #1e293b; 
  
  /* Text & Borders */
  --foreground: #f8fafc; /* White-ish */
  --muted: #94a3b8;      
  --border: rgba(255, 255, 255, 0.1); 
  
  /* Brand */
  --accent: #9696e2;
  --accent-dim: rgba(150, 150, 226, 0.15);
  
  /* Glass */
  --glass-bg: rgba(17, 27, 45, 0.7);
  --glass-border: rgba(255, 255, 255, 0.1);
}

.light {
  /* --- LIGHT MODE (High Contrast Hierarchy) --- */
  /* Level 1: Page Background */
  --background: #f1f5f9; 
  
  /* Level 2: Sidebar */
  --sidebar-bg: #f8fafc; 
  
  /* Level 3: Surface/Tables (Pure White) */
  --surface: #ffffff;    
  
  /* Inputs */
  --surface-highlight: #f1f5f9; 
  
  /* Text & Borders */
  --foreground: #0f172a; /* Black-ish */
  --muted: #64748b;      
  --border: #cbd5e1;     /* Visible Slate Border */
  
  /* Brand */
  --accent: #6366f1;     
  --accent-dim: rgba(99, 102, 241, 0.1);
  
  /* Glass */
  --glass-bg: rgba(255, 255, 255, 0.8);
  --glass-border: #cbd5e1;
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
  overflow-x: hidden;
  transition: background 0.3s ease, color 0.3s ease;
}

/* --- UTILITIES --- */
.bg-sidebar { background-color: var(--sidebar-bg); }
.bg-surface { background-color: var(--surface); }
.bg-surface-highlight { background-color: var(--surface-highlight); }
.bg-background { background-color: var(--background); }
.border-border { border-color: var(--border); }
.text-muted { color: var(--muted); }
.text-foreground { color: var(--foreground); }

/* Custom Scrollbar */
.custom-scrollbar::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: var(--muted);
}
--- END OF FILE ---

FILE: ./app/login/page.tsx
// portal/app/login/page.tsx
"use client";
import { FormEvent, useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import Image from "next/image";

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState("admin@test.com");
  const [password, setPassword] = useState("password12");
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  async function onSubmit(e: FormEvent) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    try {
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });
      if (!res.ok) {
        let message = "Invalid credentials";
        try {
          const data = await res.json();
          if (data && typeof data.error === "string") {
            message = data.error;
          }
        } catch { /* ignore */ }
        setError(message);
        setLoading(false);
        return;
      }
      router.push("/portal/cases");
    } catch (err) {
      console.error(err);
      setError("Unable to reach server. Please try again.");
      setLoading(false);
    }
  }

  return (
    <main className="min-h-screen bg-background flex items-center justify-center p-6 relative overflow-hidden">
      <div className="absolute inset-0 pointer-events-none">
        <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-accent/5 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/3" />
        <div className="absolute bottom-0 left-0 w-[500px] h-[500px] bg-accent/5 rounded-full blur-[100px] translate-y-1/3 -translate-x-1/4" />
      </div>

      <div className="w-full max-w-sm relative z-10">
        <div className="flex justify-center mb-8">
          <Link href="/" className="flex items-center gap-3 group">
            <Image 
              src="/Images/Lumera-Lab-White.png" 
              alt="Lumera" 
              width={320} 
              height={80} 
              className="h-16 w-auto"
            />
          </Link>
        </div>

        <form onSubmit={onSubmit} className="w-full space-y-6 border border-border rounded-2xl p-8 bg-surface shadow-2xl">
          <div className="text-center space-y-1">
            <h1 className="text-xl font-medium text-foreground">Welcome back</h1>
            <p className="text-sm text-muted">Enter your credentials</p>
          </div>

          <div className="space-y-4">
            <div>
              <label className="text-xs font-medium text-muted uppercase tracking-wider block mb-2">Email</label>
              <input 
                type="email" 
                required 
                className="w-full rounded-lg px-4 py-3 bg-surface-highlight border border-border text-foreground placeholder-muted focus:outline-none focus:border-accent/50 transition-all" 
                value={email} 
                onChange={(e) => setEmail(e.target.value)} 
              />
            </div>
            <div>
              <label className="text-xs font-medium text-muted uppercase tracking-wider block mb-2">Password</label>
              <input 
                type="password" 
                required 
                className="w-full rounded-lg px-4 py-3 bg-surface-highlight border border-border text-foreground placeholder-muted focus:outline-none focus:border-accent/50 transition-all" 
                value={password} 
                onChange={(e) => setPassword(e.target.value)} 
              />
            </div>
          </div>

          {error && (
            <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-500 text-sm text-center">
              {error}
            </div>
          )}

          <button 
            type="submit" 
            disabled={loading} 
            className="w-full rounded-lg py-3 text-sm font-bold bg-accent text-white hover:bg-accent/80 transition-colors disabled:opacity-50"
          >
            {loading ? "Logging in..." : "Log In"}
          </button>
        </form>

        <div className="mt-8 text-center space-y-4">
          <p className="text-sm text-muted">
            Don&apos;t have an account?{" "}
            <Link href="/signup" className="text-accent hover:text-foreground transition-colors font-medium">
              Request Access
            </Link>
          </p>
          <Link href="/" className="block text-sm text-muted hover:text-foreground transition-colors">
            ← Back to website
          </Link>
        </div>
      </div>
    </main>
  );
}

--- END OF FILE ---

FILE: ./app/global-error.tsx
"use client";

import * as Sentry from "@sentry/nextjs";
import NextError from "next/error";
import { useEffect } from "react";

export default function GlobalError({
  error,
}: {
  error: Error & { digest?: string };
}) {
  useEffect(() => {
    Sentry.captureException(error);
  }, [error]);

  return (
    <html lang="en">
      <body>
        {/* `NextError` is the default Next.js error page component. Its type
        definition requires a `statusCode` prop. However, since the App Router
        does not expose status codes for errors, we simply pass 0 to render a
        generic error message. */}
        <NextError statusCode={0} />
      </body>
    </html>
  );
}

--- END OF FILE ---

FILE: ./prisma/schema.prisma
// portal/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- CORE MODELS ------------------------------------------------------------

model Clinic {
  id        String   @id @default(cuid())
  name      String
  
  // LOGISTICS
  addressId String?
  address   Address? @relation(fields: [addressId], references: [id])
  phone     String?
  
  // BILLING & FINANCIALS
  billingCycleDay Int     @default(1) 
  paymentTerms    Int     @default(30) 
  taxId           String?
  priceTier       String  @default("STANDARD") 

  // BANKING REFERENCE
  bankName        String?
  bankLast4       String? 
  routingNumber   String?
  
  // RELATIONS
  users           User[] // Primary doctors (One-to-Many)
  
  // ✅ FIX: Back-relation for Secondary Clinics
  partTimeDoctors User[] @relation("DoctorSecondaryClinics")

  cases     DentalCase[]
  invoices  Invoice[]
  payments  Payment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  password        String   // Hashed
  name            String?
  phoneNumber     String?  
  preferenceNote  String? 

  role            String   // customer, lab, admin, milling
  
  invitationToken String? @unique 
  defaultDesignPreferences String?
  
  // PRIMARY CLINIC (One-to-Many)
  clinicId        String?
  clinic          Clinic?  @relation(fields: [clinicId], references: [id])

  // ✅ SECONDARY CLINICS (Many-to-Many)
  secondaryClinics Clinic[] @relation("DoctorSecondaryClinics")

  // If this User is a Doctor, they might have a Sales Rep
  salesRepId      String?
  salesRep        User?    @relation("DoctorSalesRep", fields: [salesRepId], references: [id])
  // If this User is a Sales Rep, they have many Doctors
  doctors         User[]   @relation("DoctorSalesRep")

  addressId       String?
  address         Address? @relation(fields: [addressId], references: [id])

  doctorCases     DentalCase[] @relation("DoctorCases")
  workingCases    DentalCase[] @relation("WorkingCases")

  commissionedCases DentalCase[] @relation("CaseSalesRep")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --- SUPPORTING MODELS ------------------------------------------------------

model RegistrationRequest {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String?
  clinicName String
  street    String?
  city      String?
  state     String?
  zipCode   String?
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Address {
  id        String   @id @default(cuid())
  street    String?
  city      String?
  state     String?
  zipCode   String?
  country   String?  @default("USA")
  users     User[]
  clinics   Clinic[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DentalCase {
  id             String @id @default(cuid())
  
  // Clinic is mandatory for billing
  clinicId       String
  clinic         Clinic @relation(fields: [clinicId], references: [id])
  
  // Doctor is the user who owns the case
  doctorUserId   String?
  doctorUser     User?    @relation("DoctorCases", fields: [doctorUserId], references: [id])

  salesRepId     String?
  salesRep       User?    @relation("CaseSalesRep", fields: [salesRepId], references: [id])

  // Lab Assignee
  assigneeId     String?
  assigneeUser   User?    @relation("WorkingCases", fields: [assigneeId], references: [id])

  patientAlias   String
  patientFirstName String? 
  patientLastName  String?
  doctorName     String?
  toothCodes     String

  orderDate      DateTime    @default(now())
  product        String      @default("ZIRCONIA") 

  material       String?
  serviceLevel   String?     // IN_HOUSE, STANDARD
  shade          String?
  designPreferences String?
  
  // Billing
  billingType    String      @default("BILLABLE") 
  units          Int         @default(1)
  cost           Decimal     @default(0.00)
  isRush         Boolean     @default(false) 
  currency       String      @default("USD")
  invoiced       Boolean     @default(false) 
  
  invoiceId      String?
  invoice        Invoice?    @relation(fields: [invoiceId], references: [id])

  // Production
  dueDate        DateTime?
  status         String      @default("IN_DESIGN") 
  stage          String      @default("DESIGN")    
  
  designedAt     DateTime?
  milledAt       DateTime?
  shippedAt      DateTime?
  
  shippingCarrier String?
  trackingNumber  String?
  shippingEta     DateTime?
  shippingCost    Decimal?    @default(0.00) // ✅ NEW: Store actual cost
  shippingBatchId String?

  needsReview        Boolean   @default(false)
  reviewQuestion     String?
  reviewRequestedAt  DateTime?
  reviewDeadline     DateTime?

  files      CaseFile[]
  events     StatusEvent[]
  comments   CaseComment[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([clinicId])
  @@index([doctorUserId])
  @@index([status])
  @@index([createdAt])
  @@index([orderDate])
  @@map("Case")
}

model Invoice {
  id          String        @id @default(cuid())
  clinicId    String
  clinic      Clinic        @relation(fields: [clinicId], references: [id])
  
  amount      Decimal
  status      String        @default("UNPAID")
  dueDate     DateTime      
  
  periodStart DateTime      
  periodEnd   DateTime      
  
  pdfUrl      String?
  cases       DentalCase[]  
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Payment {
  id          String        @id @default(cuid())
  clinicId    String
  clinic      Clinic        @relation(fields: [clinicId], references: [id])
  
  amount      Decimal
  method      String        
  referenceId String?
  postedAt    DateTime      @default(now())
}

model CaseFile {
  id        String      @id @default(cuid())
  caseId    String
  case      DentalCase  @relation(fields: [caseId], references: [id])
  
  label     String?
  kind      String      
  url       String
  sizeBytes Int?
  createdAt DateTime    @default(now())

  commentId String?
  comment   CaseComment? @relation(fields: [commentId], references: [id])
}

model StatusEvent {
  id      String      @id @default(cuid())
  caseId  String
  case    DentalCase  @relation(fields: [caseId], references: [id])
  from    String?
  to      String
  note    String?
  at      DateTime    @default(now())
  actorId String?
}

model CaseComment {
  id        String      @id @default(cuid())
  caseId    String
  case      DentalCase  @relation(fields: [caseId], references: [id])
  authorId  String
  body      String
  createdAt DateTime    @default(now())

  attachments CaseFile[]
}
--- END OF FILE ---

FILE: ./sentry.server.config.ts
// This file configures the initialization of Sentry on the server.
// The config you add here will be used whenever the server handles a request.
// https://docs.sentry.io/platforms/javascript/guides/nextjs/

import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: "https://2f3ab16a8319fa13da4170d7cde35177@o4510789473665024.ingest.us.sentry.io/4510791337377792",

  // Define how likely traces are sampled. Adjust this value in production, or use tracesSampler for greater control.
  tracesSampleRate: 1,

  // Enable logs to be sent to Sentry
  enableLogs: true,

  // Enable sending user PII (Personally Identifiable Information)
  // https://docs.sentry.io/platforms/javascript/guides/nextjs/configuration/options/#sendDefaultPii
  sendDefaultPii: true,
});

--- END OF FILE ---

FILE: ./next-env.d.ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />
/// <reference path="./.next/types/routes.d.ts" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

--- END OF FILE ---

FILE: ./tailwind.config.ts
// tailwind.config.ts
import type { Config } from "tailwindcss";

export default {
  darkMode: "class",
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      colors: {
        background: "var(--background)",
        surface: "var(--surface)",
        "surface-highlight": "var(--surface-highlight)",
        accent: "var(--accent)",
        foreground: "var(--foreground)",
        muted: "var(--muted)",
        border: "var(--glass-border)",
        sidebar: "var(--sidebar-bg)",
        sidebarBorder: "var(--sidebar-border)",
        success: "#34d399",
        warning: "#fbbf24",
        error: "#f87171",
      },
      fontFamily: {
        sans: ["var(--font-geist-sans)", "system-ui", "sans-serif"],
      },
    },
  },
  plugins: [],
} satisfies Config;
--- END OF FILE ---

FILE: ./components/CaseDetailSidebar.tsx
// portal/components/CaseDetailSidebar.tsx
"use client";

import { useState, useMemo, useEffect } from "react";
import HtmlViewerUploader from "@/components/HtmlViewerUploader";
import FileUploader from "@/components/FileUploader";
import CommentsPanel from "@/components/CommentsPanel";
import DesignerPicker from "@/components/DesignerPicker";
import { CaseFile } from "@prisma/client";
import type { Role } from "@/lib/types";

type Props = {
  caseId: string;
  role: Role;
  files: CaseFile[];
  comments: any[];
  events: any[];   
  currentUserName: string;
  designPreferences?: string | null;
  assigneeId?: string | null;
  designers?: { id: string; name: string | null; email: string }[];
};

function fmtDate(d?: Date | string | null) {
  if (!d) return "—";
  return new Date(d).toLocaleString();
}

export default function CaseDetailSidebar({
  caseId,
  role,
  files,
  comments,
  events,
  currentUserName,
  designPreferences,
  assigneeId,
  designers = []
}: Props) {
  const STORAGE_KEY = "lumera.sidebarTab";
  
  const isInternal = role === "lab" || role === "admin" || role === "milling";

  // ✅ Initialize based on role to avoid flash of wrong content
  const [activeTab, setActiveTab] = useState<"files" | "discussion" | "history" | "preferences">(
    isInternal ? "files" : "discussion"
  );

  useEffect(() => {
    if (typeof window !== "undefined") {
      const saved = window.localStorage.getItem(STORAGE_KEY);
      
      // ✅ SAFETY CHECK: If doctor has "files" saved in local storage, force "discussion"
      if (!isInternal && (saved === "files" || saved === "preferences")) {
        setActiveTab("discussion");
        return;
      }

      if (saved && ["files", "discussion", "history", "preferences"].includes(saved)) {
        setActiveTab(saved as any);
      } else {
        // Default fallback if nothing saved
        setActiveTab(isInternal ? "files" : "discussion");
      }
    }
  }, [isInternal]);

  const handleTabChange = (tab: "files" | "discussion" | "history" | "preferences") => {
    setActiveTab(tab);
    if (typeof window !== "undefined") {
      window.localStorage.setItem(STORAGE_KEY, tab);
    }
  };

  const fileStatus = useMemo(() => {
    const labels = new Set(files.map(f => f.label));
    return {
      scanHtml: labels.has("scan_html"),
      designHtml: labels.has("design_with_model_html"),
      designOnly: labels.has("design_only"),
      rx: labels.has("rx_pdf"),
      construction: labels.has("construction_info"),
      modelTop: labels.has("model_top"),
      modelBottom: labels.has("model_bottom"),
    };
  }, [files]);

  // ✅ UPDATED: Matches 3D Viewer Header Height (h-14) & Style
  const InternalNav = () => (
    <div className="h-14 flex items-center px-3 border-b border-border bg-surface shrink-0 gap-3">
      <label className="text-xs font-bold text-accent uppercase tracking-wider shrink-0 hidden sm:block">
        View
      </label>
      <div className="relative flex-1">
        <select
          value={activeTab}
          onChange={(e) => handleTabChange(e.target.value as any)}
          className="w-full bg-surface-highlight border border-border rounded-lg px-3 py-1.5 text-sm text-foreground appearance-none focus:border-accent/50 outline-none cursor-pointer"
        >
          <option value="files">📂 Files & Uploads</option>
          <option value="discussion">💬 Discussion ({comments.length})</option>
          <option value="history">📜 History</option>
          <option value="preferences">⭐ Preferences</option>
        </select>
        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-muted">
          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </div>
    </div>
  );

  // ✅ UPDATED: Matches 3D Viewer Header Height (h-14) & Style
  const CustomerNav = () => (
    <div className="h-14 flex items-center border-b border-border bg-surface shrink-0 px-2">
      <button
        onClick={() => handleTabChange("discussion")}
        className={`flex-1 h-full flex items-center justify-center text-sm font-medium border-b-2 transition-colors ${
          activeTab === "discussion" ? "border-accent text-foreground" : "border-transparent text-muted hover:text-foreground"
        }`}
      >
        Discussion
      </button>
      <button
        onClick={() => handleTabChange("history")}
        className={`flex-1 h-full flex items-center justify-center text-sm font-medium border-b-2 transition-colors ${
          activeTab === "history" ? "border-accent text-foreground" : "border-transparent text-muted hover:text-foreground"
        }`}
      >
        History
      </button>
    </div>
  );

  return (
    <div className="flex flex-col h-full rounded-xl border border-border bg-background overflow-hidden shadow-2xl">
      
      {role === "admin" && (
        <div className="p-3 border-b border-border bg-background">
          <div className="flex items-center justify-between mb-1">
             <div className="text-[10px] font-bold text-muted uppercase tracking-wider">Assigned Designer</div>
          </div>
          <DesignerPicker caseId={caseId} currentAssigneeId={assigneeId || null} designers={designers} />
        </div>
      )}

      {isInternal ? <InternalNav /> : <CustomerNav />}

      <div className="flex-1 flex flex-col min-h-0 overflow-hidden bg-background">
        
        {isInternal && (
          <div className={`flex-1 overflow-y-auto custom-scrollbar p-4 animate-in fade-in duration-200 ${activeTab === "files" ? "block" : "hidden"}`}>
             <div className="space-y-8">
                <div className="space-y-3">
                    <div className="text-[10px] font-bold text-accent uppercase tracking-wider border-b border-border pb-1">Visualization</div>
                    
                    <div className="bg-surface p-3 rounded-lg border border-border">
                        <div className="flex items-center justify-between mb-2">
                             <span className="text-xs font-medium text-foreground/80">Scan HTML</span>
                            {fileStatus.scanHtml && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <HtmlViewerUploader caseId={caseId} role={role} label="scan_html" description="Exocad Web Viewer (Scan)" />
                    </div>

                    <div className="bg-surface p-3 rounded-lg border border-border">
                        <div className="flex items-center justify-between mb-2">
                             <span className="text-xs font-medium text-foreground/80">Design HTML</span>
                            {fileStatus.designHtml && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <HtmlViewerUploader caseId={caseId} role={role} label="design_with_model_html" description="Exocad Web Viewer (Design)" />
                    </div>

                    <div className="bg-surface p-3 rounded-lg border border-border">
                        <div className="flex items-center justify-between mb-2">
                             <span className="text-xs font-medium text-foreground/80">Design STL</span>
                            {fileStatus.designOnly && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <FileUploader caseId={caseId} role={role} label="design_only" description="Final Design STL" />
                    </div>
                </div>

                <div className="space-y-3">
                    <div className="text-[10px] font-bold text-accent uppercase tracking-wider border-b border-border pb-1">Production</div>
                    
                    <div className="bg-surface p-3 rounded-lg border border-border space-y-2">
                        <div className="flex items-center justify-between">
                             <span className="text-xs font-medium text-foreground/80">Rx PDF</span>
                             {fileStatus.rx && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <FileUploader caseId={caseId} role={role} label="rx_pdf" accept=".pdf" description="Prescription PDF" />
                    </div>

                    <div className="bg-surface p-3 rounded-lg border border-border space-y-2">
                        <div className="flex items-center justify-between">
                             <span className="text-xs font-medium text-foreground/80">Construction Info</span>
                             {fileStatus.construction && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <FileUploader caseId={caseId} role={role} label="construction_info" description="Construction/Milling Params" />
                    </div>

                    <div className="bg-surface p-3 rounded-lg border border-border space-y-2">
                        <div className="flex items-center justify-between">
                             <span className="text-xs font-medium text-foreground/80">Model Top</span>
                             {fileStatus.modelTop && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <FileUploader caseId={caseId} role={role} label="model_top" accept=".stl,.ply" description="Upper Model STL" />
                    </div>

                    <div className="bg-surface p-3 rounded-lg border border-border space-y-2">
                        <div className="flex items-center justify-between">
                             <span className="text-xs font-medium text-foreground/80">Model Bottom</span>
                             {fileStatus.modelBottom && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <FileUploader caseId={caseId} role={role} label="model_bottom" accept=".stl,.ply" description="Lower Model STL" />
                    </div>
                </div>
             </div>
          </div>
        )}

        {/* ✅ DISCUSSION TAB (Default for Doctors) */}
        <div className={`flex-1 flex flex-col min-h-0 p-4 animate-in fade-in duration-200 ${activeTab === "discussion" ? "flex" : "hidden"}`}>
             <CommentsPanel caseId={caseId} comments={comments} canPost={true} currentUserName={currentUserName} currentUserRole={role} />
        </div>

        {/* HISTORY TAB */}
        <div className={`flex-1 overflow-y-auto custom-scrollbar p-4 animate-in fade-in duration-200 ${activeTab === "history" ? "block" : "hidden"}`}>
            {events.length === 0 ? <p className="text-muted text-sm">No events yet.</p> : (
              <div className="relative border-l border-border ml-2 space-y-6 pt-2">
                {events.map((ev) => (
                  <div key={ev.id} className="ml-4 relative">
                    <div className="absolute -left-[21px] top-1.5 w-2.5 h-2.5 rounded-full bg-accent border border-background" />
                    <div className="flex flex-col"><span className="text-sm font-medium text-foreground">{ev.to.replace(/_/g, " ")}</span><span className="text-xs text-muted font-mono mt-0.5">{fmtDate(ev.at)}</span></div>
                    {ev.note && <div className="mt-2 text-xs text-foreground/80 bg-surface p-2 rounded border border-border italic">&quot;{ev.note}&quot;</div>}
                  </div>
                ))}
              </div>
            )}
        </div>

        {/* PREFERENCES TAB (Internal Only) */}
        {isInternal && (
          <div className={`flex-1 overflow-y-auto custom-scrollbar p-4 animate-in fade-in duration-200 ${activeTab === "preferences" ? "block" : "hidden"}`}>
            {designPreferences ? (
              <div className="space-y-2">
                <h4 className="text-xs font-bold text-accent uppercase tracking-wider">Doctor Preferences</h4>
                <div className="bg-surface border border-border rounded-lg p-3"><p className="text-sm text-foreground/90 whitespace-pre-wrap leading-relaxed">{designPreferences}</p></div>
              </div>
            ) : (
              <div className="flex flex-col items-center justify-center h-20 text-muted text-sm italic">No preferences set for this case.</div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/StageControls.tsx
// portal/components/StageControls.tsx
"use client";

import { useState } from "react";
import ProgressTracker from "@/components/ProgressTracker";

type Stage = "DESIGN" | "MILLING_GLAZING" | "SHIPPING";
type Role = "customer" | "lab" | "admin";

export default function StageControls({
  caseId,
  stage,
  role,
}: {
  caseId: string;
  stage: Stage;
  role: Role;
}) {
  const [current, setCurrent] = useState<Stage>(stage);
  const canEdit = role === "lab" || role === "admin";

  async function setStage(s: Stage) {
    if (!canEdit) return;
    if (s === current) return;
    const r = await fetch(`/api/cases/${caseId}/stage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ stage: s }),
    });
    if (r.ok) {
      setCurrent(s);
      // refresh server data so timestamps update
      if (typeof window !== "undefined") window.location.reload();
    } else {
      const j = await r.json().catch(() => ({}));
      alert(j.error || "Failed to update stage");
    }
  }

  return (
    <div>
      <ProgressTracker
        stage={current}
        onClickStage={canEdit ? setStage : undefined}
      />
      {!canEdit && (
        <p className="mt-2 text-xs text-muted">
          The lab updates these stages as your case progresses.
        </p>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/StatusFilter.tsx
// portal/components/StatusFilter.tsx
"use client";
import { useState, useRef, useEffect } from "react";

const ALL_STATUSES = [
  "IN_DESIGN",
  "CHANGES_REQUESTED",
  "APPROVED",
  "IN_MILLING",
  "SHIPPED",
  "COMPLETED",
  "DELIVERED"
];

export default function StatusFilter({ 
  selected, 
  role, 
  onChange 
}: { 
  selected: string[], 
  role: string,
  onChange?: (statuses: string[]) => void 
}) {
  const [isOpen, setIsOpen] = useState(false);
  const [selection, setSelection] = useState<Set<string>>(new Set(selected));
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    function onClick(e: MouseEvent) {
      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    }
    document.addEventListener("mousedown", onClick);
    return () => document.removeEventListener("mousedown", onClick);
  }, []);

  useEffect(() => {
    // If explicit NONE is passed, clear selection. 
    // Otherwise sync with props.
    if (selected.includes("NONE")) {
        setSelection(new Set(["NONE"]));
    } else if (selected.length === 0) {
        // If empty coming from parent (and not NONE), it might be initial load -> implies default
        // But if we want local state to track properly, we just set empty.
        setSelection(new Set());
    } else {
        setSelection(new Set(selected));
    }
  }, [selected]);

  // Logic: It is ONLY default if empty AND NOT explicitly "NONE"
  const isDefault = selection.size === 0 && !selection.has("NONE");
  
  const getDefaultSet = () => {
    if (role === "customer") {
        return new Set(ALL_STATUSES.filter(s => s !== "DELIVERED"));
    } else {
        return new Set(ALL_STATUSES.filter(s => s !== "COMPLETED" && s !== "DELIVERED"));
    }
  };
  
  const isAllSelected = selection.size === ALL_STATUSES.length;

  const toggle = (status: string) => {
    let next: Set<string>;

    // If currently in Default Mode, load the default set first
    if (isDefault) {
      next = getDefaultSet();
    } else {
      next = new Set(selection);
      // If we are in "NONE" mode, clear it before adding the new one
      if (next.has("NONE")) next.clear();
    }

    if (next.has(status)) {
        next.delete(status);
    } else {
        next.add(status);
    }

    // ✅ FIX: If set becomes empty, add "NONE" token to prevent snapping back to Default
    if (next.size === 0) {
        next.add("NONE");
    }

    setSelection(next);
    if (onChange) onChange(Array.from(next));
  };

  const selectAll = () => {
    const next = new Set(ALL_STATUSES);
    setSelection(next);
    if (onChange) onChange(Array.from(next));
  };

  const deselectAll = () => {
    // ✅ FIX: Send explicit NONE token
    const next = new Set<string>(["NONE"]);
    setSelection(next);
    if (onChange) onChange(["NONE"]);
  };

  const reset = () => {
    // Empty array triggers Default behavior in parent/server
    const next = new Set<string>();
    setSelection(next);
    if (onChange) onChange([]);
  };

  const label = isDefault 
    ? "Status (Active)" 
    : (selection.has("NONE") ? "Status (None)" : `Status (${selection.size})`);

  const getStatusColor = (s: string) => {
    if (s === "CHANGES_REQUESTED") return "text-red-500";
    if (s === "APPROVED") return "text-lime-600 dark:text-lime-400";
    if (s === "IN_MILLING") return "text-yellow-600 dark:text-yellow-400";
    if (s === "SHIPPED") return "text-blue-600 dark:text-blue-400";
    if (s === "COMPLETED") return "text-emerald-600 dark:text-emerald-400";
    if (s === "DELIVERED") return "text-purple-600 dark:text-purple-400";
    return "text-orange-600 dark:text-orange-400";
  };

  return (
    <div className="relative" ref={containerRef}>
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className={`
          flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm border transition-colors cursor-pointer
          ${isOpen || !isDefault 
            ? "bg-[var(--accent-dim)] border-accent text-accent font-medium" 
            : "bg-surface border-border text-muted hover:border-accent/50 hover:text-foreground"}
        `}
      >
        <span>{label}</span>
        <svg className="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="absolute top-full left-0 mt-2 w-64 bg-surface border border-border rounded-xl shadow-2xl overflow-hidden z-50">
          
          {/* Header */}
          <div className="flex items-center justify-between px-3 py-2 border-b border-border bg-surface-highlight">
            <span className="text-xs font-semibold text-muted uppercase tracking-wider">Filter Status</span>
            <div className="flex items-center gap-1">
              {isAllSelected ? (
                <button
                  type="button"
                  onClick={deselectAll}
                  className="text-xs text-accent hover:text-foreground font-medium px-2 py-1 rounded hover:bg-[var(--accent-dim)] transition-colors cursor-pointer"
                >
                   Deselect All
                </button>
              ) : (
                <button
                  type="button"
                  onClick={selectAll}
                  className="text-xs text-accent hover:text-foreground font-medium px-2 py-1 rounded hover:bg-[var(--accent-dim)] transition-colors cursor-pointer"
                >
                  Select All
                </button>
              )}
            </div>
          </div>

          <div className="max-h-[280px] overflow-y-auto custom-scrollbar p-1">
             {ALL_STATUSES.map((status) => {
              const defaultSet = getDefaultSet();
              const isChecked = isDefault 
                ? defaultSet.has(status)
                : selection.has(status);
              
              const colorClass = getStatusColor(status);

              return (
                <div 
                  key={status} 
                  onClick={() => toggle(status)}
                  className="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[var(--accent-dim)] cursor-pointer transition-colors select-none"
                >
                  {/* CHECKBOX */}
                  <div className={`
                    w-4 h-4 rounded border flex items-center justify-center transition-colors shrink-0
                    ${isChecked ? "bg-accent border-accent" : "border-border bg-surface"}
                  `}>
                    {isChecked && (
                      <svg 
                        className="w-3 h-3 text-[var(--foreground)]" 
                        fill="none" 
                        viewBox="0 0 24 24" 
                        stroke="currentColor"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={4} d="M5 13l4 4L19 7" />
                      </svg>
                    )}
                  </div>
                  <span className={`text-sm font-medium ${colorClass}`}>
                    {status.replace(/_/g, " ")}
                  </span>
                </div>
              );
             })}
          </div>
          
          <div className="border-t border-border mt-1 pt-1 bg-surface-highlight">
            <button
              type="button"
              onClick={reset}
              className="w-full text-left px-3 py-2 text-xs text-muted hover:text-foreground transition-colors cursor-pointer"
            >
              Reset to Active
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/PortalSidebar.tsx
"use client";

import { usePathname } from "next/navigation";
import Link from "next/link";
import { useState, useEffect } from "react";
import Logo from "./Logo";
import ThemeToggle from "./ThemeToggle";
import { 
  LayoutDashboard, FolderOpen, CreditCard, LogOut,
  ChevronRight, ChevronLeft, ShieldCheck, DollarSign
} from "lucide-react";

export default function PortalSidebar({ userRole }: { userRole: string }) {
  const pathname = usePathname();
  const [expanded, setExpanded] = useState(true);
  const [loggingOut, setLoggingOut] = useState(false);

  useEffect(() => {
    const saved = window.localStorage.getItem("lumera_sidebar");
    if (saved !== null) {
      setExpanded(saved === "true");
    }
  }, []);

  const toggleSidebar = () => {
    const next = !expanded;
    setExpanded(next);
    window.localStorage.setItem("lumera_sidebar", String(next));
  };

  const navItems = [
    { label: "Dashboard", href: "/portal/cases", icon: LayoutDashboard, roles: ["customer", "lab", "admin", "milling", "sales"] },
    { label: "New Case", href: "/portal/cases/new", icon: FolderOpen, roles: ["lab", "admin"] },
    { label: "Billing", href: "/portal/billing", icon: CreditCard, roles: ["customer", "admin"] },
    { label: "Milling Finance", href: "/portal/cases/milling/finance", icon: DollarSign, roles: ["milling", "admin"] },
    { label: "Admin", href: "/portal/admin/users", icon: ShieldCheck, roles: ["admin"] },
  ];

  const filteredNav = navItems.filter((item) => item.roles.includes(userRole));

  async function handleLogout() {
    setLoggingOut(true);
    try {
      await fetch("/api/auth/logout", { method: "POST" });
      window.location.href = "/login";
    } catch (e) {
      console.error("Logout failed", e);
      setLoggingOut(false);
    }
  }

  return (
    <aside 
      className={`
        h-full bg-sidebar border-r border-border
        transition-all duration-300 ease-in-out flex flex-col shrink-0 relative
        ${expanded ? "w-64" : "w-20"}
      `}
    >
      <div className="h-24 flex items-center justify-center shrink-0 p-6">
        <div className={`${expanded ? "w-48" : "w-8"} transition-all duration-300 flex justify-center items-center`}>
          <Logo showText={expanded} />
        </div>
      </div>

      <nav className="flex-1 px-3 py-4 space-y-2 overflow-y-auto custom-scrollbar flex flex-col items-center">
        {filteredNav.map((item) => {
          let isActive = false;
          // (Simplified logic for brevity, functional logic remains same)
          if (item.label === "Dashboard") {
             const isFinance = pathname.startsWith("/portal/cases/milling/finance");
             const isNew = pathname.startsWith("/portal/cases/new");
             isActive = pathname.startsWith("/portal/cases") && !isFinance && !isNew;
          } else {
             isActive = pathname.startsWith(item.href);
          }
            
          const Icon = item.icon;

          return (
            <Link
              key={item.href}
              href={item.href}
              className={`
                h-11 flex items-center rounded-lg group relative transition-[background-color] duration-200
                ${expanded ? "w-full px-3 justify-start" : "w-11 justify-center"}
                ${isActive 
                  ? "bg-[var(--accent-dim)] text-accent font-semibold shadow-sm" 
                  : "text-muted hover:bg-[var(--accent-dim)] hover:text-accent"
                }
              `}
              title={!expanded ? item.label : ""}
            >
              <Icon size={20} className={`shrink-0 transition-transform ${isActive ? "" : "group-hover:scale-110"}`} />
              <span className={`ml-3 font-medium whitespace-nowrap overflow-hidden transition-opacity duration-300 ${expanded ? "opacity-100 w-auto" : "opacity-0 w-0 hidden"}`}>
                {item.label}
              </span>
            </Link>
          );
        })}
      </nav>

      <div className="p-4 bg-sidebar border-t border-border flex flex-col items-center space-y-2 transition-colors duration-200">
        <ThemeToggle expanded={expanded} />
        <button 
          onClick={handleLogout}
          disabled={loggingOut}
          className={`
            h-11 flex items-center rounded-lg text-muted hover:text-red-400 hover:bg-red-500/10 transition-[background-color] duration-200 group cursor-pointer
            ${expanded ? "w-full px-3 justify-start" : "w-11 justify-center"}
          `}
          title={!expanded ? "Log Out" : ""}
        >
          <LogOut size={20} className="shrink-0 group-hover:scale-110 transition-transform" />
          <span className={`ml-3 font-medium whitespace-nowrap transition-opacity duration-300 overflow-hidden ${expanded ? "opacity-100 w-auto" : "opacity-0 w-0 hidden"}`}>
            {loggingOut ? "..." : "Log Out"}
          </span>
        </button>
        <button onClick={toggleSidebar} className="w-full flex justify-center py-2 text-muted hover:text-accent transition-colors duration-200 cursor-pointer">
          {expanded ? <ChevronLeft size={20} /> : <ChevronRight size={20} />}
        </button>
      </div>
    </aside>
  );
}
--- END OF FILE ---

FILE: ./components/CaseListRow.tsx
// portal/components/CaseListRow.tsx
"use client";

import { useRouter } from "next/navigation";
import { useState } from "react";
import CopyableId from "@/components/CopyableId";

type CaseRowData = {
  id: string;
  patientAlias: string;
  patientFirstName: string | null;
  patientLastName: string | null;
  toothCodes: string;
  status: string;
  dueDate: Date | null;
  updatedAt: Date;
  createdAt: Date; 
  doctorName: string | null;
  clinic: { name: string };
  assigneeUser: { name: string | null; email: string } | null;
};

// --- HELPER 1: Designer Avatar ---
const DesignerAvatar = ({ name, email }: { name: string | null, email: string }) => {
  const initials = name 
    ? (name.split(" ").length > 1 
        ? (name.split(" ")[0][0] + name.split(" ")[name.split(" ").length - 1][0]) 
        : name.slice(0, 2))
    : email.slice(0, 2);

  return (
    <div className="flex items-center gap-2">
      {/* BACKGROUND: Light Mode = Solid Gray 300. Night Mode = Transparent Blue.
         TEXT: Uses 'text-foreground' which maps to CSS var(--foreground).
         This GUARANTEES Black in Light Mode and White in Night Mode.
      */}
      <div className="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold shadow-sm 
        bg-gray-300 border border-gray-400 text-foreground
        dark:bg-blue-600/30 dark:border-blue-400/50 dark:text-white">
        {initials.toUpperCase()}
      </div>
      <span className="text-muted text-xs truncate max-w-[100px]">
        {name || email.split("@")[0]}
      </span>
    </div>
  );
};

// --- HELPER 2: Status Badge ---
const StatusBadge = ({ status }: { status: string }) => {
  const s = status.toUpperCase();
  // Base classes
  // We use 'text-foreground' here to bind to the global theme text color.
  const baseClasses = "inline-flex items-center px-2.5 py-1 rounded-md text-[10px] font-bold border uppercase tracking-wide shadow-sm transition-colors text-foreground dark:text-white";
  let colorClasses = "";

  switch (s) {
    case "APPROVED":
      // Light: Lime 300 (Solid) | Night: Lime Transparent
      colorClasses = "bg-lime-300 border-lime-400 dark:bg-lime-500/20 dark:border-lime-500/40";
      break;
    case "IN_MILLING":
      // Light: Yellow 300 (Solid) | Night: Yellow Transparent
      colorClasses = "bg-yellow-300 border-yellow-400 dark:bg-yellow-500/20 dark:border-yellow-500/40";
      break;
    case "SHIPPED":
      // Light: Blue 300 (Solid) | Night: Blue Transparent
      colorClasses = "bg-blue-300 border-blue-400 dark:bg-blue-500/20 dark:border-blue-500/40";
      break;
    case "COMPLETED":
      // Light: Emerald 300 (Solid) | Night: Emerald Transparent
      colorClasses = "bg-emerald-300 border-emerald-400 dark:bg-emerald-500/20 dark:border-emerald-500/40";
      break;
    case "DELIVERED":
      // Light: Purple 300 (Solid) | Night: Purple Transparent
      colorClasses = "bg-purple-300 border-purple-400 dark:bg-purple-500/20 dark:border-purple-500/40";
      break;
    case "CHANGES_REQUESTED":
      // Light: Red 300 (Solid) | Night: Red Transparent
      colorClasses = "bg-red-300 border-red-400 dark:bg-red-500/20 dark:border-red-500/40";
      break;
    case "IN_DESIGN":
    case "DESIGN":
    default:
      // Light: Orange 300 (Solid) | Night: Orange Transparent
      colorClasses = "bg-orange-300 border-orange-400 dark:bg-orange-500/20 dark:border-orange-500/40";
      break;
  }

  return (
    <span className={`${baseClasses} ${colorClasses}`}>
      {status.replace(/_/g, " ")}
    </span>
  );
};

export default function CaseListRow({ data, role }: { data: CaseRowData, role: string }) {
  const router = useRouter();
  const [busy, setBusy] = useState(false);

  const handleRowClick = (e: React.MouseEvent) => {
    if ((e.target as HTMLElement).closest("button, a")) return;
    router.push(`/portal/cases/${data.id}`);
  };

  const markDelivered = async (e: React.MouseEvent) => {
    e.stopPropagation();
    setBusy(true);
    try {
        const res = await fetch(`/api/cases/${data.id}/transition`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ to: "DELIVERED" })
        });
        if (!res.ok) throw new Error("Failed");
        router.refresh();
    } catch {
        alert("Error updating status");
        setBusy(false);
    }
  };

  const fmtDate = (d?: Date | null) => d ? new Date(d).toLocaleDateString() : "—";

  return (
    <tr
      onClick={handleRowClick}
      className="hover:bg-[var(--accent-dim)] transition-colors group cursor-pointer border-t border-border"
    >
      <td className="p-3">
        <CopyableId id={data.id} truncate />
      </td>
      <td className="p-3 font-medium text-foreground">
        {data.patientAlias}
      </td>
      
      {role === "customer" ? (
        <td className="p-3 text-foreground/90">
            {data.patientLastName && data.patientFirstName 
                ? `${data.patientLastName}, ${data.patientFirstName}` 
                : <span className="text-muted italic">No name</span>}
        </td>
      ) : (
        <td className="p-3 text-muted">{data.doctorName ?? "—"}</td>
      )}

      <td className="p-3 text-muted">{data.clinic.name}</td>
      
      {role !== "customer" && (
        <td className="p-3">
            {data.assigneeUser ? (
                <DesignerAvatar name={data.assigneeUser.name} email={data.assigneeUser.email} />
            ) : (
                <span className="text-muted/50 text-xs italic">—</span>
            )}
        </td>
      )}

      <td className="p-3 text-muted">{data.toothCodes}</td>
      
      <td className="p-3 relative text-center">
         <div className={`transition-opacity duration-200 ${(role === "customer" && data.status === "COMPLETED") ? "group-hover:opacity-10" : ""}`}>
            <StatusBadge status={data.status} />
         </div>

         {role === "customer" && data.status === "COMPLETED" && (
            <button 
                onClick={markDelivered}
                disabled={busy}
                className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-all bg-purple-600 text-white text-[10px] uppercase font-bold px-3 py-1.5 rounded shadow-lg hover:bg-purple-500 hover:scale-105 z-10 whitespace-nowrap ring-1 ring-white/20 cursor-pointer"
            >
                {busy ? "..." : "Mark Delivered"}
            </button>
        )}
      </td>
      
      <td className="p-3 text-muted">{fmtDate(data.dueDate)}</td>
      <td className="p-3 text-muted/70">{fmtDate(data.createdAt)}</td> 
    </tr>
  );
}
--- END OF FILE ---

FILE: ./components/PublicFooter.tsx
// portal/components/PublicFooter.tsx
export default function PublicFooter() {
  return (
    <footer className="border-t border-border bg-background py-12 text-center">
      <div className="container mx-auto px-6">
        <p className="text-muted text-sm">
          © {new Date().getFullYear()} Lumera Dental Lab. All rights reserved.
        </p>
        <p className="text-muted/50 text-xs mt-2">
          Made in USA. Designed Globally.
        </p>
      </div>
    </footer>
  );
}
--- END OF FILE ---

FILE: ./components/CopyableId.tsx
// portal/components/CopyableId.tsx
"use client";

import { useState } from "react";

type Props = {
  id: string;
  truncate?: boolean;
};

export default function CopyableId({ id, truncate = false }: Props) {
  const [copied, setCopied] = useState(false);

  const handleCopy = (e: React.MouseEvent) => {
    e.preventDefault(); // Prevent row clicks if nested
    e.stopPropagation();
    
    if (typeof navigator !== "undefined" && navigator.clipboard) {
      navigator.clipboard.writeText(id);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  return (
    <button
      type="button"
      onClick={handleCopy}
      className="group relative inline-flex items-center gap-1.5 rounded px-1.5 py-0.5 hover:bg-[var(--accent-dim)] transition-colors cursor-pointer"
      title="Click to copy Case ID"
    >
      <code className="text-xs text-muted group-hover:text-foreground transition-colors font-mono">
        {truncate ? `${id.slice(-6)}...` : id}
      </code>
      
      {/* Visual Feedback */}
      {copied ? (
        <span className="text-[10px] text-green-400 font-medium animate-pulse">
          Copied
        </span>
      ) : (
        /* Hidden copy icon that appears on hover */
        <svg 
          className="w-3 h-3 text-muted opacity-0 group-hover:opacity-100 transition-opacity" 
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
      )}
    </button>
  );
}
--- END OF FILE ---

FILE: ./components/AddressPicker.tsx
// portal/components/AddressPicker.tsx
"use client";

import { useEffect, useState, useMemo, useCallback } from "react";
import SearchableSelect from "@/components/SearchableSelect";

export type AddressData = {
  id?: string | null;
  street: string;
  city: string;
  state: string;
  zipCode: string;
};

type Props = {
  value: AddressData;
  onChange: (val: AddressData) => void;
};

export default function AddressPicker({ value, onChange }: Props) {
  const [existing, setExisting] = useState<any[]>([]);
  const [selectedId, setSelectedId] = useState<string>("");
  
  // Debounce logic for search
  const [searchTerm, setSearchTerm] = useState("");

  // Fetch addresses (filtered by term if present)
  const fetchAddresses = useCallback(async (term: string) => {
    try {
      const qs = term ? `?q=${encodeURIComponent(term)}` : "";
      const res = await fetch(`/api/addresses${qs}`);
      if (res.ok) {
        const data = await res.json();
        if (Array.isArray(data)) setExisting(data);
      }
    } catch (e) {
      console.error("Failed to load addresses", e);
    }
  }, []);

  // Debounced search handler
  useEffect(() => {
    const timer = setTimeout(() => {
        // ✅ FIX: Removed "if (searchTerm)" check. 
        // Now it fetches ALL addresses if searchTerm is empty (resetting the list).
        fetchAddresses(searchTerm); 
    }, 400); // 400ms delay
    
    return () => clearTimeout(timer);
  }, [searchTerm, fetchAddresses]);

  // Sync internal ID if value changes externally
  useEffect(() => {
    if (value.id) setSelectedId(value.id);
  }, [value.id]);

  const options = useMemo(() => {
    const list = existing.map((addr) => ({
      id: addr.id,
      label: `${addr.street || "Unknown"}, ${addr.city || "Unknown"}`,
      subLabel: `${addr.state || ""} ${addr.zipCode || ""}`
    }));

    // Inject current value if missing from list (preserves display when paging/filtering)
    if (value.id && !list.find(o => o.id === value.id)) {
        list.unshift({
            id: value.id,
            label: `${value.street || "Unknown"}, ${value.city || "Unknown"}`,
            subLabel: `${value.state || ""} ${value.zipCode || ""} (Current)`
        });
    }

    return list;
  }, [existing, value]);

  function handleSelectExisting(id: string) {
    const match = existing.find((a) => a.id === id) 
               || (id === value.id ? { ...value } : null);

    if (match) {
      setSelectedId(id);
      onChange({
        id: match.id,
        street: match.street || "",
        city: match.city || "",
        state: match.state || "",
        zipCode: match.zipCode || ""
      });
    }
  }

  function handleChangeField(field: keyof AddressData, val: string) {
    // Clear ID to imply new/unlinked address
    onChange({ ...value, id: null, [field]: val });
    setSelectedId(""); 
  }

  return (
    <div className="space-y-4 pt-2 border-t border-border">
      <div className="flex items-center justify-between">
        <h4 className="text-xs font-bold text-accent uppercase tracking-wider">Address</h4>
        <span className="text-[10px] text-muted">Search or enter new</span>
      </div>

      {/* Search Bar with Live Search */}
      <SearchableSelect
        label=""
        placeholder="🔍 Search existing addresses..."
        options={options}
        value={selectedId}
        onChange={handleSelectExisting}
        onSearch={setSearchTerm} // Hook up live search
      />

      {/* Manual Fields */}
      <div>
        <input 
          placeholder="Street Address" 
          className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2 text-foreground text-sm focus:border-accent/50 outline-none mb-2 placeholder:text-muted transition-colors duration-200"
          value={value.street}
          onChange={(e) => handleChangeField("street", e.target.value)}
        />
        <div className="grid grid-cols-3 gap-2">
          <input 
            placeholder="City" 
            className="bg-surface-highlight border border-border rounded-lg px-3 py-2 text-foreground text-sm focus:border-accent/50 outline-none placeholder:text-muted transition-colors duration-200"
            value={value.city}
            onChange={(e) => handleChangeField("city", e.target.value)}
          />
          <input 
            placeholder="State" 
            className="bg-surface-highlight border border-border rounded-lg px-3 py-2 text-foreground text-sm focus:border-accent/50 outline-none placeholder:text-muted transition-colors duration-200"
            value={value.state}
            onChange={(e) => handleChangeField("state", e.target.value)}
          />
          <input 
            placeholder="Zip" 
            className="bg-surface-highlight border border-border rounded-lg px-3 py-2 text-foreground text-sm focus:border-accent/50 outline-none placeholder:text-muted transition-colors duration-200"
            value={value.zipCode}
            onChange={(e) => handleChangeField("zipCode", e.target.value)}
          />
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/SearchableSelect.tsx
// portal/components/SearchableSelect.tsx
"use client";
import { useState, useRef, useEffect } from "react";

type Option = { id: string; label: string; subLabel?: string };
type Props = {
  label: string;
  options: Option[];
  value: string;
  onChange: (val: string) => void;
  onSearch?: (term: string) => void;
  placeholder?: string;
  disabled?: boolean;
};

export default function SearchableSelect({ label, options, value, onChange, onSearch, placeholder, disabled }: Props) {
  const [isOpen, setIsOpen] = useState(false);
  const [search, setSearch] = useState("");
  const containerRef = useRef<HTMLDivElement>(null);

  const selectedOption = options.find((o) => o.id === value);

  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value;
    setSearch(val);
    if (onSearch) {
      onSearch(val);
    }
  };

  const handleToggle = () => {
    if (disabled) return;
    
    const nextState = !isOpen;
    setIsOpen(nextState);
    if (nextState) {
        setSearch("");
        if (onSearch) onSearch("");
    }
  };

  const displayedOptions = onSearch 
    ? options 
    : options.filter((o) =>
        o.label.toLowerCase().includes(search.toLowerCase()) ||
        (o.subLabel && o.subLabel.toLowerCase().includes(search.toLowerCase()))
      );

  return (
    <div className="space-y-2 relative" ref={containerRef}>
      {label && <label className="text-sm font-medium text-muted">{label}</label>}
      
      <button
        type="button"
        disabled={disabled}
        onClick={handleToggle}
        className={`
          w-full rounded-lg bg-surface-highlight border border-border px-4 py-3 text-left flex items-center justify-between transition
          ${disabled ? "opacity-50 cursor-not-allowed" : "hover:border-accent/30 focus:border-accent/50 cursor-pointer"}
        `}
      >
        <div className="flex flex-col items-start truncate">
            <span className={selectedOption ? "text-foreground" : "text-muted"}>
            {selectedOption ? selectedOption.label : placeholder || "Select..."}
            </span>
            {selectedOption?.subLabel && (
                <span className="text-[10px] text-muted">{selectedOption.subLabel}</span>
            )}
        </div>
        
        <svg className="w-4 h-4 text-muted shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="absolute z-50 w-full mt-1 bg-surface border border-border rounded-lg shadow-2xl max-h-60 flex flex-col overflow-hidden transition-colors duration-200">
          <div className="p-2 border-b border-border sticky top-0 bg-surface transition-colors duration-200">
            <input
              autoFocus
              value={search}
              onChange={handleSearchChange}
              placeholder="Type to search..."
              className="w-full bg-surface-highlight text-foreground text-sm rounded px-3 py-2 border border-border focus:border-accent/50 outline-none transition-colors duration-200"
            />
          </div>

          <div className="overflow-y-auto flex-1 custom-scrollbar">
            {displayedOptions.length === 0 ? (
              <div className="p-3 text-sm text-muted text-center">No results found.</div>
            ) : (
              displayedOptions.map((opt) => (
                <button
                  key={opt.id}
                  type="button"
                  onClick={() => {
                    onChange(opt.id);
                    setIsOpen(false);
                  }}
                  className={`
                    w-full text-left px-4 py-3 text-sm border-b border-border hover:bg-[var(--accent-dim)] transition cursor-pointer
                    ${value === opt.id ? "bg-accent/10 text-accent" : "text-foreground/80"}
                  `}
                >
                  <div className="font-medium">{opt.label}</div>
                  {opt.subLabel && <div className="text-xs text-muted">{opt.subLabel}</div>}
                </button>
              ))
            )}
          </div>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CaseProcessBar.tsx
"use client";

import { useState } from "react";
import type { Role, ProductionStage } from "@/lib/types";
import { StageProgress, STAGE_LABEL } from "./case-process/StageProgress";
import { ShippingModal } from "./case-process/ShippingModal";

export default function CaseProcessBar({
  caseId,
  stage,
  status,
  role,
  carrier,
  tracking,
}: {
  caseId: string;
  stage: ProductionStage;
  status: string;
  role: Role;
  carrier?: string | null;
  tracking?: string | null;
}) {
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);
  const [showShipModal, setShowShipModal] = useState(false);

  // Status Checks
  const isFullyDelivered = status === "DELIVERED";
  const isShippedOrDone = ["SHIPPED", "COMPLETED", "DELIVERED"].includes(status);
  
  // Permissions
  const canEdit = role === "admin" || role === "lab" || role === "milling";
  const isDoctor = role === "customer";

  // --- LOGIC: Next Stage Calculation ---
  let nextStage: ProductionStage | null = null;
  let nextLabel = "";
  let canAdvance = false;
  let reason = "";

  if (stage === "DESIGN") {
    nextStage = "MILLING_GLAZING";
    nextLabel = "Start Milling";
    const isApproved = ["APPROVED", "IN_MILLING", "SHIPPED", "COMPLETED", "DELIVERED"].includes(status);
    
    if (isApproved) {
      if (role === "lab") {
         canAdvance = false;
         reason = "Waiting for Milling Center pickup";
      } else {
         canAdvance = true;
      }
    } else {
      canAdvance = false;
      reason = "Requires Design Approval";
    }
  } 
  else if (stage === "MILLING_GLAZING") {
    nextStage = "SHIPPING";
    nextLabel = "Ship Case";
    canAdvance = true; 
  } 
  else if (stage === "SHIPPING") {
    nextStage = "COMPLETED";
    nextLabel = "Mark Arrived";
    canAdvance = true; 
  } 
  else if (stage === "COMPLETED" && !isFullyDelivered) {
    nextStage = "DELIVERED";
    nextLabel = "Mark Delivered";
    canAdvance = true;
  }

  // --- VISIBILITY CHECK ---
  const showButton = 
    (canEdit && nextStage !== null) || 
    (isDoctor && nextStage === "DELIVERED" && !isFullyDelivered);

  // --- HANDLERS ---
  const getTrackingLink = (num: string, cx?: string | null) => {
    if (!num) return "#";
    const c = (cx || "").toLowerCase();
    if (c.includes("ups")) return `https://www.ups.com/track?tracknum=${num}`;
    if (c.includes("fedex")) return `https://www.fedex.com/fedextrack/?trknbr=${num}`;
    if (c.includes("usps")) return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${num}`;
    if (c.includes("dhl")) return `https://www.dhl.com/en/express/tracking.html?AWB=${num}`;
    return `https://www.google.com/search?q=${num}`;
  };

  async function handleAdvanceClick() {
    if (!nextStage || !canAdvance || busy) return;
    if (isDoctor && nextStage !== "DELIVERED") return;

    if (nextStage === "SHIPPING" && canEdit) {
        setShowShipModal(true);
        return;
    }
    if (nextStage === "DELIVERED") { await submitStatusChange("DELIVERED"); return; }
    if (nextStage === "COMPLETED") { await submitStatusChange("COMPLETED"); return; }
    await submitStageChange(nextStage);
  }

  async function submitStatusChange(newStatus: string) {
    setBusy(true); setErr(null);
    try {
      const res = await fetch(`/api/cases/${caseId}/transition`, {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ to: newStatus }),
      });
      if (!res.ok) throw new Error("Failed");
      window.location.reload();
    } catch { setBusy(false); }
  }

  async function submitStageChange(newStage: ProductionStage) {
    setBusy(true); setErr(null);
    try {
      const res = await fetch(`/api/cases/${caseId}/stage`, {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ stage: newStage }),
      });
      if (!res.ok) throw new Error("Failed");
      window.location.reload();
    } catch (e: any) { setErr(e?.message); setBusy(false); }
  }

  async function submitShipping(data: { carrier: string; tracking: string }) {
    setBusy(true); setErr(null);
    try {
        const res = await fetch(`/api/cases/${caseId}/shipping`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ carrier: data.carrier, tracking: data.tracking, eta: null })
        });
        if (!res.ok) throw new Error("Shipping update failed");
        window.location.reload();
    } catch (e: any) { setErr(e.message); setBusy(false); }
  }

  return (
    // UPDATED: pb-12 (Large bottom buffer for labels), pt-6 (Spacious top)
    <div className="bg-surface border border-border rounded-3xl pt-6 px-6 pb-12 shadow-sm">
      
      {/* HEADER */}
      <div className="flex flex-wrap items-center justify-between gap-4 mb-2">
        <div>
          <h2 className="text-sm font-semibold text-foreground">Manufacturing Process</h2>
          <p className="text-xs font-medium">
            Status: <span className={isFullyDelivered ? "text-green-500 font-bold tracking-wide" : "text-muted"}>
              {isFullyDelivered ? "DELIVERED TO PATIENT" : STAGE_LABEL[stage]}
            </span>
          </p>
        </div>

        {/* TRACKING BADGE */}
        {isShippedOrDone && tracking && (
          <div className="flex items-center gap-3 bg-blue-500/10 border border-blue-500/20 px-4 py-2 rounded-lg shadow-lg shadow-blue-900/10 animate-in fade-in slide-in-from-right-2">
            <div className="p-2 bg-blue-500 rounded-full text-white">
               <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" /></svg>
            </div>
            <div>
               <div className="flex items-center gap-2">
                   <div className="text-[10px] text-blue-300 uppercase font-bold tracking-wider">{carrier || "Shipped"} Tracking</div>
                   {canEdit && <button onClick={() => setShowShipModal(true)} className="text-muted hover:text-foreground"><svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>}
               </div>
               <a href={getTrackingLink(tracking, carrier)} target="_blank" rel="noopener noreferrer" className="text-sm font-mono font-medium text-foreground hover:text-accent flex items-center gap-1 group transition-colors">
                  {tracking}
                  <svg className="w-3 h-3 opacity-50 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
               </a>
            </div>
          </div>
        )}

        {/* ACTION BUTTON */}
        {showButton && nextStage && (
          <div className="flex flex-col items-end">
             <button
              onClick={handleAdvanceClick}
              disabled={busy}
              className={`
                px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-2
                ${canAdvance 
                  ? "bg-accent hover:bg-accent/80 text-white shadow-lg" 
                  : "bg-surface text-muted cursor-not-allowed border border-border"}
              `}
            >
              {busy ? "Updating..." : <>{nextLabel} →</>}
            </button>
            {!canAdvance && reason && <span className="text-[10px] text-orange-400 mt-1">{reason}</span>}
          </div>
        )}
      </div>

      {/* PROGRESS BAR */}
      <StageProgress currentStage={stage} isFullyDelivered={isFullyDelivered} />

      {/* MODAL */}
      <ShippingModal
        isOpen={showShipModal}
        busy={busy}
        initialCarrier={carrier || "UPS"}
        initialTracking={tracking || ""}
        onClose={() => setShowShipModal(false)}
        onSubmit={submitShipping}
      />
      
      {err && <p className="mt-2 text-xs text-center text-red-400">{err}</p>}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/UploadButtons.tsx
// components/UploadButtons.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

type Props = {
  caseId: string;
  label: "SCAN" | "MODEL_PLUS_DESIGN" | "DESIGN_ONLY";
  accept: string;
  title: string;
  disabled?: boolean;
};

export default function UploadButtons({
  caseId,
  label,
  accept,
  title,
  disabled,
}: Props) {
  const [file, setFile] = useState<File | null>(null);
  const [busy, setBusy] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);
  const router = useRouter();

  async function upload() {
    setMsg(null);
    setErr(null);
    if (!file) return setErr("Choose a file first.");
    if (disabled) return setErr("This slot is locked at the current stage.");

    setBusy(true);
    try {
      const fd = new FormData();
      fd.append("label", label);
      // best-effort kind based on extension
      const ext = (file.name.split(".").pop() || "").toLowerCase();
      const kind =
        ext === "stl" ? "STL" : ext === "ply" ? "PLY" : ext === "obj" ? "OBJ" : "OTHER";
      fd.append("kind", kind);
      fd.append("file", file);

      const res = await fetch(`/api/cases/${caseId}/files`, {
        method: "POST",
        body: fd,
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j.error || "Upload failed");

      setMsg("Saved.");
      setFile(null);
      router.refresh();
    } catch (e: any) {
      setErr(e?.message || "Upload failed");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="rounded-xl border border-border p-4 bg-surface">
      <h2 className="font-medium mb-2">{title}</h2>
      <div className="flex items-center gap-3">
        <input
          type="file"
          accept={accept}
          onChange={(e) => setFile(e.target.files?.[0] ?? null)}
          className="text-sm"
          disabled={disabled}
        />
        <button
          type="button"
          className="rounded-md bg-accent text-white text-sm px-3 py-1.5 disabled:opacity-50 hover:bg-accent/80 transition"
          onClick={upload}
          disabled={busy || disabled}
        >
          {busy ? "Uploading…" : "Upload"}
        </button>
      </div>
      {disabled && (
        <p className="text-xs text-muted mt-2">
          This slot can’t be changed at the current stage.
        </p>
      )}
      {msg && <p className="text-emerald-400 text-sm mt-2">{msg}</p>}
      {err && <p className="text-red-400 text-sm mt-2">{err}</p>}
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/case-process/ShippingModal.tsx
//portal/components/case-process/ShippingModal.tsx
"use client";

import { useState } from "react";

interface ShippingModalProps {
  isOpen: boolean;
  busy: boolean;
  initialCarrier?: string;
  initialTracking?: string;
  onClose: () => void;
  onSubmit: (data: { carrier: string; tracking: string }) => void;
}

export function ShippingModal({
  isOpen,
  busy,
  initialCarrier,
  initialTracking,
  onClose,
  onSubmit,
}: ShippingModalProps) {
  const [carrier, setCarrier] = useState(initialCarrier || "UPS");
  const [tracking, setTracking] = useState(initialTracking || "");
  const [otherCarrier, setOtherCarrier] = useState("");

  if (!isOpen) return null;

  const handleSubmit = () => {
    const finalCarrier = carrier === "Other" ? otherCarrier : carrier;
    if (finalCarrier && tracking) {
      onSubmit({ carrier: finalCarrier, tracking });
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-background/95 backdrop-blur-sm p-4">
      <div className="w-full max-w-sm bg-surface border border-border rounded-xl p-6 shadow-2xl space-y-4 animate-in fade-in zoom-in-95">
        <h3 className="text-lg font-semibold text-foreground">Shipment Details</h3>
        
        <div className="space-y-3">
          <div>
            <label className="block text-xs font-bold text-muted uppercase mb-1">Carrier</label>
            <select
              className="w-full bg-surface-highlight border border-border rounded-lg p-2 text-foreground outline-none focus:border-accent"
              value={carrier}
              onChange={(e) => setCarrier(e.target.value)}
            >
              <option value="UPS">UPS</option>
              <option value="FedEx">FedEx</option>
              <option value="USPS">USPS</option>
              <option value="DHL">DHL</option>
              <option value="Other">Other</option>
            </select>
          </div>

          {carrier === "Other" && (
            <input
              placeholder="Enter Carrier Name"
              className="w-full bg-surface-highlight border border-border rounded-lg p-2 text-foreground outline-none focus:border-accent"
              value={otherCarrier}
              onChange={(e) => setOtherCarrier(e.target.value)}
            />
          )}

          <div>
            <label className="block text-xs font-bold text-muted uppercase mb-1">Tracking Number</label>
            <input
              placeholder="1Z999..."
              className="w-full bg-surface-highlight border border-border rounded-lg p-2 text-foreground outline-none focus:border-accent font-mono"
              value={tracking}
              onChange={(e) => setTracking(e.target.value)}
            />
          </div>
        </div>

        <div className="flex justify-end gap-2 pt-2">
          <button
            onClick={onClose}
            className="px-4 py-2 text-muted hover:text-foreground transition text-sm font-medium"
            disabled={busy}
          >
            Cancel
          </button>
          <button
            onClick={handleSubmit}
            disabled={busy || !tracking}
            className="px-6 py-2 bg-accent text-white font-bold rounded-lg hover:bg-accent/80 transition disabled:opacity-50 text-sm"
          >
            {busy ? "Saving..." : "Confirm & Ship"}
          </button>
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/case-process/StageProgress.tsx
// portal/components/case-process/StageProgress.tsx
"use client";

import React, { useEffect, useState } from "react";
import { useTheme } from "next-themes";
import type { ProductionStage } from "@/lib/types";

// The strict 4-stage order
export const STAGE_ORDER: ProductionStage[] = ["DESIGN", "MILLING_GLAZING", "SHIPPING", "COMPLETED"];

export const STAGE_LABEL: Record<ProductionStage, string> = {
  DESIGN: "Designing",
  MILLING_GLAZING: "Milling",
  SHIPPING: "Shipping",
  COMPLETED: "Arrived",
  DELIVERED: "Delivered",
};

interface StageProgressProps {
  currentStage: ProductionStage;
  isFullyDelivered: boolean;
}

export function StageProgress({ currentStage, isFullyDelivered }: StageProgressProps) {
  const currentIndex = STAGE_ORDER.indexOf(currentStage);
  const { resolvedTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  // Wait for hydration to avoid mismatch
  useEffect(() => {
    setMounted(true);
  }, []);

  return (
    <div className="flex items-center w-full px-2 mt-4">
      {STAGE_ORDER.map((s, idx) => {
        const isLast = idx === STAGE_ORDER.length - 1;
        const isDone = idx < currentIndex || isFullyDelivered;
        const isCurrent = idx === currentIndex && !isFullyDelivered;
        const isFullyFinished = isLast && isFullyDelivered;

        // Logic: Line is active if the NEXT node is reached
        const isLineActive = (idx + 1) <= currentIndex || isFullyDelivered;

        // --- DYNAMIC COLOR LOGIC (Bypassing Tailwind) ---
        // If not mounted yet, default to light mode to prevent crash/flash
        const isDark = mounted && resolvedTheme === "dark";
        
        // Active Line: White in Dark Mode, Black in Light Mode
        const activeLineColor = isDark ? "#ffffff" : "#000000";
        
        // Inactive Line: Dark Gray in Dark Mode, Light Gray in Light Mode
        const inactiveLineColor = isDark ? "#374151" : "#d1d5db"; // gray-700 vs gray-300

        return (
          <React.Fragment key={s}>
            {/* NODE */}
            <div className="flex flex-col items-center relative z-10">
              <div
                className={`
                  w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-bold border-2 transition-all duration-300
                  ${isFullyFinished
                    ? "bg-green-600 border-green-600 text-white shadow-lg shadow-green-500/30 scale-110" 
                    : (isDone || (isLast && isCurrent))
                      ? "!bg-blue-600 !border-blue-600 text-white" 
                      : isCurrent
                        ? "bg-surface !border-blue-600 text-blue-600 scale-110 shadow-lg shadow-blue-500/20"
                        : "bg-surface border-gray-300 dark:border-gray-700 text-muted"}
                `}
              >
                {(isDone || isFullyFinished) ? "✓" : idx + 1}
              </div>

              {/* LABEL */}
              <span
                className={`
                  absolute -bottom-7 whitespace-nowrap text-[9px] font-bold tracking-wider uppercase transition-colors
                  ${isFullyFinished
                    ? "text-green-600 dark:text-green-400"
                    : isCurrent ? "text-blue-600 dark:text-blue-400" : "text-gray-400"}
                `}
              >
                {(isLast && isFullyDelivered) ? STAGE_LABEL.DELIVERED : STAGE_LABEL[s]}
              </span>
            </div>

            {/* SEGMENTED LINE */}
            {!isLast && (
              <div
                className="h-1.5 flex-1 mx-2 rounded-full transition-colors duration-200"
                style={{ 
                  backgroundColor: isLineActive ? activeLineColor : inactiveLineColor 
                }}
              />
            )}
          </React.Fragment>
        );
      })}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/STLViewer.tsx
// portal/components/STLViewer.tsx
"use client";

import { useEffect, useRef, useState } from "react";
import * as THREE from "three";
import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";

export default function STLViewer({ url }: { url: string }) {
  const ref = useRef<HTMLDivElement | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!ref.current || !url) return;

    let cancelled = false;
    setError(null);

    const container = ref.current;
    const width = container.clientWidth || 400;
    const height = container.clientHeight || 320;

    // 1. Scene Setup
    const scene = new THREE.Scene();
    // Use transparent background to let CSS variable show through
    scene.background = null;

    // 2. Camera
    const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
    camera.position.set(0, 0, 150);

    // 3. Renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    // Add alpha to renderer to support transparency
    renderer.setClearColor(0x000000, 0);
    
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
    container.appendChild(renderer.domElement);

    // 4. Lighting
    const ambient = new THREE.AmbientLight(0xffffff, 0.3);
    scene.add(ambient);

    const dirLight = new THREE.DirectionalLight(0xffffff, 2.2);
    dirLight.position.set(15, 25, 20); 
    scene.add(dirLight);

    const fillLight = new THREE.DirectionalLight(0xffffff, 0.6);
    fillLight.position.set(-15, 5, 10);
    scene.add(fillLight);

    const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
    backLight.position.set(0, -10, -20);
    scene.add(backLight);

    const group = new THREE.Group();
    scene.add(group);

    let controls: OrbitControls | undefined;
    let raf = 0;

    const init = async () => {
      const { OrbitControls } = await import("three/examples/jsm/controls/OrbitControls.js");
      const { STLLoader } = await import("three/examples/jsm/loaders/STLLoader.js");
      const { PLYLoader } = await import("three/examples/jsm/loaders/PLYLoader.js");
      const { OBJLoader } = await import("three/examples/jsm/loaders/OBJLoader.js");
      const { mergeVertices } = await import("three/examples/jsm/utils/BufferGeometryUtils.js");

      if (cancelled) return;
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.rotateSpeed = 0.8;

      const fitCameraToObj = (obj: THREE.Object3D) => {
        const box = new THREE.Box3().setFromObject(obj);
        const size = new THREE.Vector3();
        const center = new THREE.Vector3();
        box.getSize(size);
        box.getCenter(center);

        obj.position.sub(center);

        const maxDim = Math.max(size.x, size.y, size.z) || 10;
        const fov = camera.fov * (Math.PI / 180);
        let cameraZ = Math.abs(maxDim / (2 * Math.tan(fov / 2)));
        cameraZ *= 2.0;

        camera.position.set(0, 0, cameraZ);
        camera.lookAt(0, 0, 0);
        controls?.target.set(0, 0, 0);
        controls?.update();
      };

      const processGeometry = (geometry: THREE.BufferGeometry) => {
        geometry.deleteAttribute('normal'); 
        geometry.deleteAttribute('uv');
        let smoothGeometry = mergeVertices(geometry, 1e-4);
        smoothGeometry.computeVertexNormals();
        return smoothGeometry;
      };

      const addMesh = (geometry: THREE.BufferGeometry) => {
        const smoothGeo = processGeometry(geometry);
        const material = new THREE.MeshStandardMaterial({
          color: 0xf0f0f0, 
          roughness: 0.65,   
          metalness: 0.0,    
          flatShading: false,
        });

        const mesh = new THREE.Mesh(smoothGeo, material);
        group.add(mesh);
        fitCameraToObj(mesh);
      };

      const cleanUrl = url.split("?")[0].toLowerCase();
      try {
        if (cleanUrl.endsWith(".stl")) {
          new STLLoader().load(url, (geo) => !cancelled && addMesh(geo), undefined, (err) => !cancelled && handleError(err));
        } else if (cleanUrl.endsWith(".ply")) {
          new PLYLoader().load(url, (geo) => !cancelled && addMesh(geo), undefined, (err) => !cancelled && handleError(err));
        } else if (cleanUrl.endsWith(".obj")) {
          new OBJLoader().load(url, (obj) => {
              if (cancelled) return;
              obj.traverse((child) => {
                if ((child as THREE.Mesh).isMesh) {
                   const mesh = child as THREE.Mesh;
                   const processed = processGeometry(mesh.geometry.clone());
                   mesh.geometry = processed;
                   mesh.material = new THREE.MeshStandardMaterial({ color: 0xf0f0f0, roughness: 0.65, metalness: 0.0 });
                }
              });
              group.add(obj);
              fitCameraToObj(obj);
            }, undefined, (err) => !cancelled && handleError(err)
          );
        } else {
           new STLLoader().load(url, (geo) => !cancelled && addMesh(geo), undefined, (err) => !cancelled && handleError(err));
        }
      } catch (err) {
        handleError(err);
      }
    };

    const handleError = (err: any) => {
      console.error("3D Load Error:", err);
      setError("Failed to load 3D model.");
    };

    init();

    const animate = () => {
      if (cancelled) return;
      raf = requestAnimationFrame(animate);
      controls?.update();
      renderer.render(scene, camera);
    };
    animate();

    const onResize = () => {
      if (!container) return;
      const w = container.clientWidth;
      const h = container.clientHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    };
    window.addEventListener("resize", onResize);
    return () => {
      cancelled = true;
      cancelAnimationFrame(raf);
      window.removeEventListener("resize", onResize);
      renderer.dispose();
      controls?.dispose();
      scene.clear();
      if (container.contains(renderer.domElement)) {
        container.removeChild(renderer.domElement);
      }
    };
  }, [url]);

  return (
    // FIX: Container background also Midnight Blue to match scene
    <div className="relative w-full h-full bg-background">
      <div ref={ref} className="w-full h-full cursor-move" />
      {error && (
        <div className="absolute inset-0 flex items-center justify-center bg-background/80 z-10">
          <p className="text-sm text-red-400 font-medium px-4 py-2 bg-surface rounded-md border border-red-500/30">
            {error}
          </p>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/CaseInfo.tsx
// portal/components/new-case/CaseInfo.tsx
"use client";

import { CaseData } from "./types";

interface CaseInfoProps {
  data: CaseData;
  update: (fields: Partial<CaseData>) => void;
}

function addDays(dateStr: string, days: number) {
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return "";
  d.setDate(d.getDate() + days);
  return d.toISOString().split("T")[0];
}

// ✅ HELPER: Strict Manual Check for YYYY-MM-DD
function isDateIncorrect(dateStr: string) {
  if (!dateStr) return false;
  const parts = dateStr.split("-");
  if (parts.length !== 3) return true;

  const y = parseInt(parts[0]);
  const m = parseInt(parts[1]);
  const d = parseInt(parts[2]);

  // Check 1: Year must be 4 digits (e.g. 1000-9999)
  if (y < 1000 || y > 9999) return true;
  // Check 2: Month 1-12
  if (m < 1 || m > 12) return true;
  // Check 3: Day 1-31
  if (d < 1 || d > 31) return true;

  return false;
}

export default function CaseInfo({ data, update }: CaseInfoProps) {
  
  const handleOrderDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newOrderDate = e.target.value;
    update({ orderDate: newOrderDate });

    // Auto-suggest due date only if the date looks valid enough
    if (!isDateIncorrect(newOrderDate)) {
       const newDueDate = addDays(newOrderDate, 8); 
       update({ dueDate: newDueDate });
    }
  };

  // 1. Check Format (Day > 31, Month > 12, Year != 4 digits)
  const orderFormatInvalid = isDateIncorrect(data.orderDate);
  const dueFormatInvalid = isDateIncorrect(data.dueDate);

  // 2. Check Timing (Due < Order)
  const timingInvalid = data.orderDate && data.dueDate && data.dueDate < data.orderDate;

  return (
    <div className="rounded-xl border border-border bg-surface p-6 space-y-6 shadow-lg transition-colors duration-200">
      <div className="flex justify-between items-center border-b border-border pb-2">
        <h2 className="text-lg font-medium text-foreground">Case Information</h2>
        {/* Live Alias Preview */}
        <div className="flex items-center gap-2">
           <span className="text-[10px] uppercase text-muted tracking-wider">Auto-ID:</span>
           <span className="font-mono text-sm font-bold text-blue-400 bg-blue-500/10 px-2 py-1 rounded border border-blue-500/20">
              {data.patientAlias || "Waiting for data..."}
           </span>
        </div>
      </div>
      
      {/* Name Fields */}
      <div className="grid gap-6 md:grid-cols-2">
        <div className="space-y-2">
          <label className="text-sm font-medium text-muted">Patient First Name</label>
          <input
            required
            value={data.patientFirstName}
            onChange={(e) => update({ patientFirstName: e.target.value })}
            placeholder="e.g. John"
            className="w-full rounded-lg bg-surface-highlight border border-border px-4 py-3 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition-colors duration-200"
          />
        </div>
        <div className="space-y-2">
          <label className="text-sm font-medium text-muted">Patient Last Name</label>
          <input
            required
            value={data.patientLastName}
            onChange={(e) => update({ patientLastName: e.target.value })}
            placeholder="e.g. Doe"
            className="w-full rounded-lg bg-surface-highlight border border-border px-4 py-3 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition-colors duration-200"
          />
        </div>
      </div>

      {/* Dates */}
      <div className="grid gap-6 md:grid-cols-2">
        <div className="space-y-2">
          <label className="text-sm font-medium text-muted">Date of Order</label>
          <input
            type="date"
            required
            value={data.orderDate}
            onChange={handleOrderDateChange}
            className={`w-full rounded-lg bg-surface-highlight border px-4 py-3 text-foreground placeholder:text-muted outline-none transition-colors duration-200 ${orderFormatInvalid ? 'border-red-500/50' : 'border-border focus:border-accent/50'}`}
          />
          {orderFormatInvalid && (
            <p className="text-xs text-red-400 font-medium animate-pulse">
                Date is incorrect.
            </p>
          )}
        </div>
      
        <div className="space-y-2">
          <label className="text-sm font-medium text-muted">Due Date</label>
          <input
            type="date"
            required
            value={data.dueDate} 
            onChange={(e) => update({ dueDate: e.target.value })} 
            className={`w-full rounded-lg bg-surface-highlight border px-4 py-3 text-foreground placeholder:text-muted outline-none transition-colors duration-200 ${dueFormatInvalid || timingInvalid ? 'border-red-500/50' : 'border-border focus:border-accent/50'}`}
          />
          {(dueFormatInvalid || timingInvalid) && (
            <p className="text-xs text-red-400 font-medium animate-pulse">
                Date is incorrect.
            </p>
          )}
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/Prescription.tsx
// portal/components/new-case/Prescription.tsx
"use client";

// ✅ FIX: Import 'CaseData' and 'ProductType' instead of 'NewCaseState'
import { CaseData, ProductType } from "./types";

interface Props {
  data: CaseData;
  onChange: (updates: Partial<CaseData>) => void;
}

const PRODUCTS = ["ZIRCONIA", "MULTILAYER_ZIRCONIA", "EMAX", "INLAY_ONLAY"];

export default function Prescription({ data, onChange }: Props) {
  return (
    <div className="rounded-xl border border-border bg-surface p-6 space-y-6 shadow-lg">
      <h2 className="text-lg font-medium text-foreground border-b border-border pb-2">
        Prescription
      </h2>
      
      <div className="grid gap-6 md:grid-cols-3">
        <div className="space-y-2">
          <label className="text-sm font-medium text-muted">Product</label>
          <select
            value={data.product}
            // ✅ FIX: Cast to ProductType
            onChange={(e) => onChange({ product: e.target.value as ProductType })}
            className="w-full rounded-lg bg-surface-highlight border border-border px-4 py-3 text-foreground focus:border-accent/50 outline-none transition appearance-none"
          >
            {PRODUCTS.map(p => (
              <option key={p} value={p} className="bg-gray-900">
                {p.replace(/_/g, " ")}
              </option>
            ))}
          </select>
        </div>
        
        <div className="space-y-2">
          <label className="text-sm font-medium text-muted">Shade (e.g. A2)</label>
          <input
            value={data.shade}
            onChange={(e) => onChange({ shade: e.target.value })}
            placeholder="A2"
            className="w-full rounded-lg bg-surface-highlight border border-border px-4 py-3 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition"
          />
        </div>
        
        <div className="space-y-2">
          <label className="text-sm font-medium text-muted">Material (Optional)</label>
          <input
            value={data.material || ""}
            onChange={(e) => onChange({ material: e.target.value as any })}
            placeholder="e.g. Zirconia"
            className="w-full rounded-lg bg-surface-highlight border border-border px-4 py-3 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition"
          />
        </div>
      </div>

      <div className="space-y-2">
        <div className="flex justify-between items-center">
            <label className="text-sm font-medium text-muted">Designer Preferences</label>
            <span className="text-[10px] text-muted">Auto-filled from doctor profile</span>
        </div>
        <textarea
          value={data.designPreferences || ""}
          onChange={(e) => onChange({ designPreferences: e.target.value })}
          placeholder="E.g. Contacts heavy, light occlusion, open embrasures..."
          className="w-full rounded-lg bg-surface-highlight border border-border px-4 py-3 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition h-24 resize-none"
        />
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/TeethSelection.tsx
// portal/components/new-case/TeethSelection.tsx
"use client";

import { useEffect, useMemo } from "react";
import { CaseData, ProductType, MaterialType, ServiceLevel } from "./types";
import ToothSelector from "@/components/ToothSelector";

interface TeethSelectionProps {
  data: CaseData;
  update: (fields: Partial<CaseData>) => void;
}

const PRICING = {
  ZIRCONIA: { HT: { IN_HOUSE: 55, STANDARD: 65 }, ML: { IN_HOUSE: 65, STANDARD: 75 } },
  EMAX: { default: { IN_HOUSE: 110, STANDARD: 120 } },
  NIGHTGUARD: { HARD: { IN_HOUSE: 50, STANDARD: 60 }, SOFT: { IN_HOUSE: 50, STANDARD: 60 } },
  INLAY_ONLAY: { default: { IN_HOUSE: 65, STANDARD: 75 } }
};

export default function TeethSelection({ data, update }: TeethSelectionProps) {
  
  const isNightguard = data.product === "NIGHTGUARD";

  // --- SHADE LOGIC ---
  const shadeParts = useMemo(() => {
    if (!data.shade) return { incisal: "", body: "", gingival: "" };
    
    if (data.shade.includes("/")) {
      const parts = data.shade.split("/");
      return {
        incisal: parts[0] || "",
        body: parts[1] || "",
        gingival: parts[2] || ""
      };
    }
    
    return { incisal: "", body: data.shade, gingival: "" };
  }, [data.shade]);

  const updateShade = (type: "incisal" | "body" | "gingival", value: string) => {
    const newParts = { ...shadeParts, [type]: value };
    if (!newParts.incisal && !newParts.gingival) {
      update({ shade: newParts.body });
      return;
    }

    const b = newParts.body;
    const i = newParts.incisal || b;
    const g = newParts.gingival || b;
    update({ shade: `${i}/${b}/${g}` });
  };

  useEffect(() => {
    if (isNightguard) {
      if (data.toothCodes.length === 0 || data.toothCodes[0] !== "Full Arch") {
         update({ toothCodes: ["Full Arch"], shade: "" }); 
      }
    } else {
      if (data.toothCodes.includes("Full Arch")) {
          update({ toothCodes: [] });
      }
    }
  }, [isNightguard, data.toothCodes, update]);

  const handleProductChange = (type: ProductType) => {
    let defaultMaterial: MaterialType = null;
    if (type === "ZIRCONIA") defaultMaterial = "HT";
    if (type === "NIGHTGUARD") defaultMaterial = "HARD";
    update({ product: type, material: defaultMaterial });
  };

  const getPrice = () => {
    const { product, material, serviceLevel } = data;
    if (product === "ZIRCONIA" && material) return PRICING.ZIRCONIA[material as "HT"|"ML"]?.[serviceLevel] || 0;
    if (product === "NIGHTGUARD" && material) return PRICING.NIGHTGUARD[material as "HARD"|"SOFT"]?.[serviceLevel] || 0;
    if (product === "EMAX") return PRICING.EMAX.default[serviceLevel] || 0;
    if (product === "INLAY_ONLAY") return PRICING.INLAY_ONLAY.default[serviceLevel] || 0;
    return 0;
  };

  const currentPrice = getPrice();

  return (
    <div className="rounded-xl border border-border bg-surface p-6 space-y-6 shadow-lg transition-colors duration-200">
      <h2 className="text-lg font-medium text-foreground border-b border-border pb-2">
        Prescription & Teeth
      </h2>

      {/* 1. PRODUCT & MATERIAL ROW */}
      <div className="grid gap-6 md:grid-cols-2">
        <div className="space-y-2">
          <label className="text-sm font-medium text-muted">Product</label>
          <div className="grid grid-cols-2 gap-2">
             {(["ZIRCONIA", "EMAX", "NIGHTGUARD", "INLAY_ONLAY"] as ProductType[]).map((type) => (
               <button
                 key={type}
                 type="button"
                 onClick={() => handleProductChange(type)}
                 // ✅ FIX: Use Tinted Accent Style (Matches Service Level)
                 className={`px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 border cursor-pointer
                   ${data.product === type 
                     ? "bg-accent/10 border-accent/50 text-accent shadow-sm" 
                     : "bg-surface border-border text-muted hover:bg-[var(--accent-dim)]"
                   }`}
              >
                 {type.replace("_", " ")}
               </button>
            ))}
          </div>
        </div>

        <div className="space-y-4">
           
           {data.product === "ZIRCONIA" && (
             <div className="space-y-2">
               <label className="text-sm font-medium text-muted">Zirconia Material</label>
               <div className="flex gap-2">
                 {(["HT", "ML"] as MaterialType[]).map(m => (
                    <button key={m} type="button" onClick={() => update({ material: m })}
                      className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-colors duration-200 cursor-pointer ${data.material === m ?
                      "bg-accent/10 border-accent/50 text-accent shadow-sm" : "bg-surface border-border text-muted hover:bg-[var(--accent-dim)]"}`}>
                      {m}
                    </button>
                 ))}
               </div>
             </div>
           )}
           
           {isNightguard && (
             <div className="space-y-2">
               <label className="text-sm font-medium text-muted">Material Hardness</label>
               <div className="flex gap-2">
                 {(["HARD", "SOFT"] as MaterialType[]).map(m => (
                    <button key={m} type="button" onClick={() => update({ material: m })}
                      className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-colors duration-200 cursor-pointer ${data.material === m ? 
                      "bg-accent/10 border-accent/50 text-accent shadow-sm" : "bg-surface border-border text-muted hover:bg-[var(--accent-dim)]"}`}>
                      {m}
                    </button>
                 ))}
               </div>
             </div>
           )}

           {/* SHADE LAYERING */}
           {!isNightguard && (
               <div className="space-y-2">
                <label className="text-sm font-medium text-muted">Shade Layering</label>
                <div className="grid grid-cols-3 gap-2">
                  <div className="space-y-1">
                    <input
                      value={shadeParts.body}
                      onChange={(e) => updateShade("body", e.target.value)}
                      placeholder="Body (A2)"
                      className="w-full rounded-lg bg-surface-highlight border border-border px-3 py-2 text-foreground outline-none focus:border-accent/50 text-center placeholder:text-muted transition-colors duration-200"
                    />
                    <div className="text-[10px] text-accent text-center font-bold uppercase tracking-wider">Body *</div>
                  </div>
                  <div className="space-y-1">
                    <input
                      value={shadeParts.incisal}
                      onChange={(e) => updateShade("incisal", e.target.value)}
                      placeholder="Matching Body"
                      className="w-full rounded-lg bg-surface-highlight border border-border px-3 py-2 text-foreground outline-none focus:border-accent/50 text-center placeholder:text-muted transition-colors duration-200"
                    />
                    <div className="text-[10px] text-muted text-center uppercase tracking-wider">Incisal</div>
                  </div>
                  <div className="space-y-1">
                    <input
                      value={shadeParts.gingival}
                      onChange={(e) => updateShade("gingival", e.target.value)}
                      placeholder="Matching Body"
                      className="w-full rounded-lg bg-surface-highlight border border-border px-3 py-2 text-foreground outline-none focus:border-accent/50 text-center placeholder:text-muted transition-colors duration-200"
                    />
                    <div className="text-[10px] text-muted text-center uppercase tracking-wider">Gingival</div>
                  </div>
                </div>
             </div>
           )}
        </div>
      </div>

      {/* 2. PRICING TIER */}
      <div className="p-4 rounded-lg bg-surface border border-border transition-colors duration-200">
        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
           <div className="flex gap-4 w-full md:w-auto">
              {(["IN_HOUSE", "STANDARD"] as ServiceLevel[]).map((level) => (
                <label key={level} className={`flex-1 md:flex-none flex items-center gap-2 cursor-pointer p-3 rounded-lg border transition-colors duration-200 ${data.serviceLevel === level ?
                 "bg-accent/10 border-accent/50" : "border-transparent hover:bg-[var(--accent-dim)]"}`}>
                   <input 
                    type="radio" 
                    name="serviceLevel" 
                    checked={data.serviceLevel === level}
                    onChange={() => update({ serviceLevel: level })}
                    className="accent-accent"
                  />
                  <span className={`text-sm font-bold ${data.serviceLevel === level ?
                    "text-accent" : "text-muted"}`}>
                    {level.replace("_", " ")}
                  </span>
                </label>
              ))}
           </div>
           <div className="text-right">
             <span className="text-xs text-muted block">Estimated Unit Price</span>
             <span className="text-2xl font-bold text-emerald-400">${currentPrice}</span>
           </div>
        </div>
      </div>

      {/* 3. TOOTH SELECTOR */}
      {!isNightguard && (
        <div className="space-y-2">
           <div className="flex justify-between items-center px-1">
              <h3 className="text-sm font-medium text-muted">Select Teeth <span className="text-accent">*</span></h3>
              <span className="text-xs text-muted">
                 {data.toothCodes.length > 0 ? `${data.toothCodes.length} selected` : "None"}
              </span>
           </div>
           
           <div className="bg-surface rounded-xl border border-border p-4 flex justify-center transition-colors duration-200">
              <ToothSelector 
                value={data.toothCodes.join(",")} 
                onChange={(val) => update({ toothCodes: val.split(",").map(t => t.trim()).filter(Boolean) })} 
              />
           </div>
        </div>
      )}

      {/* 4. DESIGN PREFERENCES */}
      <div className="space-y-2">
         <div className="flex justify-between items-center">
             <label className="text-sm font-medium text-muted">Designer Preferences</label>
             <span className="text-[10px] text-muted">Auto-filled from doctor profile</span>
         </div>
         <textarea
           value={data.designPreferences}
           onChange={(e) => update({ designPreferences: e.target.value })}
           placeholder="E.g. Contacts heavy, light occlusion, open embrasures..."
           className="w-full rounded-lg bg-surface-highlight border border-border px-4 py-3 text-foreground placeholder:text-muted focus:border-accent/50 outline-none transition-colors duration-200 h-24 resize-none"
         />
      </div>

    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/types.ts
// portal/components/new-case/types.ts

export type ProductType = "ZIRCONIA" | "EMAX" | "NIGHTGUARD" | "INLAY_ONLAY";
export type MaterialType = "HT" | "ML" | "HARD" | "SOFT" | null;
export type ServiceLevel = "IN_HOUSE" | "STANDARD";

export interface DoctorRow {
  id: string;
  name: string | null;
  email: string;
  
  // ✅ FIX: Allow clinic to be null (if doctor has no primary clinic)
  clinic: { 
    id: string; 
    name: string; 
    priceTier: string | null;
  } | null;

  // Secondary Clinics
  secondaryClinics: {
    id: string;
    name: string;
    priceTier: string | null;
  }[];
  
  preferenceNote?: string | null;
  defaultDesignPreferences?: string | null;
}

export interface CaseData {
  doctorUserId: string;
  doctorName: string;
  clinicId: string;
  
  patientFirstName: string;
  patientLastName: string;
  patientAlias: string;
  
  orderDate: string; 
  dueDate: string;
  product: ProductType;
  material: MaterialType;
  serviceLevel: ServiceLevel;
  shade: string;
  designPreferences: string;
  
  toothCodes: string[];
  
  scanHtml: File | null;
  rxPdf: File | null;
  constructionInfo: File | null;
  modelTop: File | null;
  modelBottom: File | null;
}

const today = new Date();
const defaultDue = new Date(today);
defaultDue.setDate(today.getDate() + 8);

export const INITIAL_DATA: CaseData = {
  doctorUserId: "",
  doctorName: "",
  clinicId: "", 
  
  patientFirstName: "",
  patientLastName: "",
  patientAlias: "",
  
  orderDate: today.toISOString().split("T")[0],
  dueDate: defaultDue.toISOString().split("T")[0],
  
  product: "ZIRCONIA",
  material: "HT",
  serviceLevel: "STANDARD",
  shade: "",
  designPreferences: "",
  
  toothCodes: [],
  
  scanHtml: null,
  rxPdf: null,
  constructionInfo: null,
  modelTop: null,
  modelBottom: null,
};
--- END OF FILE ---

FILE: ./components/new-case/ProductionFiles.tsx
// portal/components/new-case/ProductionFiles.tsx
"use client";

import { useRef } from "react";
import { CaseData } from "./types";
import { useTheme } from "@/components/ThemeProvider";

interface ProductionFilesProps {
  data: CaseData;
  update: (fields: Partial<CaseData>) => void;
}

const CustomFileInput = ({ 
  label, 
  file, 
  accept, 
  req = false,
  onChange 
}: { 
  label: string, 
  file: File | null, 
  accept: string, 
  req?: boolean,
  onChange: (f: File | null) => void 
}) => {
  const inputRef = useRef<HTMLInputElement>(null);
  const { isDark } = useTheme();

  return (
    <div className="space-y-1">
      <div className="flex justify-between items-end gap-2 overflow-hidden">
        <label className="text-xs font-medium text-muted uppercase tracking-wider shrink-0">
          {label} {req && <span className="text-accent">*</span>}
        </label>
        
        {file && (
          <span className="text-[10px] text-emerald-400 font-mono truncate min-w-0" title={file.name}>
            ✓ {file.name}
          </span>
        )}
      </div>
      
      {/* Custom Trigger Area */}
      <div 
        onClick={() => inputRef.current?.click()}
        className="flex items-center justify-between gap-3 rounded-lg p-2 bg-surface-highlight border border-border cursor-pointer hover:border-accent/30 transition-colors duration-200 group"
      >
        <span className="text-sm text-foreground/50 truncate pl-1">
            {file ? file.name : "No file chosen..."}
        </span>

        {/* ✅ THE FIX: A real button, styled explicitly */}
        <button
            type="button"
            className="px-3 py-1.5 rounded text-xs font-bold bg-accent hover:bg-accent/80 transition-colors"
            style={{ color: isDark ? 'white' : 'black' }}
        >
            Browse
        </button>

        <input
            ref={inputRef}
            type="file"
            accept={accept}
            onChange={(e) => onChange(e.target.files?.[0] || null)}
            className="hidden" // Completely hide the native input
        />
      </div>
    </div>
  );
};

export default function ProductionFiles({ data, update }: ProductionFilesProps) {
  return (
    <div className="rounded-xl border border-border bg-surface p-6 space-y-4 shadow-lg">
      <h2 className="text-lg font-medium text-foreground border-b border-border pb-2">
         Production Files
      </h2>
      <div className="grid grid-cols-1 gap-6">
         <div className="grid md:grid-cols-2 gap-6">
            <CustomFileInput 
              label="Scan Viewer (HTML)" 
              file={data.scanHtml} 
              accept=".html" 
              req={true} 
              onChange={(f) => update({ scanHtml: f })} 
            />
            <CustomFileInput 
              label="Rx PDF" 
              file={data.rxPdf} 
              accept=".pdf" 
              req={true} 
              onChange={(f) => update({ rxPdf: f })} 
            />
         </div>

         <div className="w-full h-px bg-border" />

         <div>
            <span className="text-[10px] uppercase tracking-wider text-muted mb-2 block">
              Optional now (Required before Milling)
            </span>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <CustomFileInput 
                  label="Construction Info" 
                  file={data.constructionInfo} 
                  accept=".pdf,.xml,.txt,.constructionInfo" 
                  onChange={(f) => update({ constructionInfo: f })} 
                />
                <CustomFileInput 
                  label="Model Top (STL)" 
                  file={data.modelTop} 
                  accept=".stl,.ply" 
                  onChange={(f) => update({ modelTop: f })} 
                />
                <CustomFileInput 
                  label="Model Bottom (STL)" 
                  file={data.modelBottom} 
                  accept=".stl,.ply" 
                  onChange={(f) => update({ modelBottom: f })} 
                />
            </div>
         </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/DoctorSelection.tsx
// portal/components/new-case/DoctorSelection.tsx
"use client";

import { useMemo } from "react";
import SearchableSelect from "@/components/SearchableSelect";
import { CaseData, DoctorRow, ServiceLevel } from "./types";

interface DoctorSelectionProps {
  doctors: DoctorRow[];
  data: CaseData;
  update: (fields: Partial<CaseData>) => void;
}

export default function DoctorSelection({ doctors, data, update }: DoctorSelectionProps) {
  
  // 1. Doctor Options
  const doctorOptions = useMemo(() => {
    return doctors.map((d) => ({
      id: d.id,
      label: d.name ? `${d.name} (${d.email})` : d.email,
      subLabel: d.clinic?.name || "No Clinic"
    }));
  }, [doctors]);

  // 2. Resolve Selected Doctor
  const selectedDoctor = useMemo(() => 
    doctors.find(d => d.id === data.doctorUserId), 
  [doctors, data.doctorUserId]);

  // 3. Resolve Available Clinics (Primary + Secondary)
  const availableClinics = useMemo(() => {
    if (!selectedDoctor) return [];
    
    // Start with Primary
    const list = selectedDoctor.clinic ? [selectedDoctor.clinic] : [];
    
    // Add Secondary (Unique check to be safe)
    if (selectedDoctor.secondaryClinics && selectedDoctor.secondaryClinics.length > 0) {
      selectedDoctor.secondaryClinics.forEach(sc => {
        if (!list.find(c => c.id === sc.id)) {
          list.push(sc);
        }
      });
    }
    return list;
  }, [selectedDoctor]);

  // 4. Handle Doctor Change
  const handleDoctorChange = (newId: string) => {
    const doc = doctors.find((d) => d.id === newId);
    if (doc) {
      const newPrefs = doc.preferenceNote || doc.defaultDesignPreferences || "";
      
      // Calculate clinics for this new doctor
      const clinics = doc.clinic ? [doc.clinic] : [];
      if (doc.secondaryClinics) clinics.push(...doc.secondaryClinics);
      
      // Auto-Select Logic: If only 1 clinic, pick it. Else reset.
      let autoClinicId = "";
      let newServiceLevel: ServiceLevel = "STANDARD";

      if (clinics.length === 1) {
        autoClinicId = clinics[0].id;
        if (clinics[0].priceTier === "IN_HOUSE") newServiceLevel = "IN_HOUSE";
      } else if (clinics.length > 1) {
        // If multiple, default to primary
        if (doc.clinic) {
           autoClinicId = doc.clinic.id;
           if (doc.clinic.priceTier === "IN_HOUSE") newServiceLevel = "IN_HOUSE";
        }
      }

      update({
        doctorUserId: newId,
        doctorName: doc.name || doc.email,
        designPreferences: newPrefs,
        clinicId: autoClinicId, // Set or Clear
        serviceLevel: newServiceLevel
      });
    }
  };

  // 5. Handle Clinic Change
  const handleClinicChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const newClinicId = e.target.value;
    const targetClinic = availableClinics.find(c => c.id === newClinicId);
    
    let newServiceLevel: ServiceLevel = "STANDARD";
    if (targetClinic?.priceTier === "IN_HOUSE") {
      newServiceLevel = "IN_HOUSE";
    }

    update({ 
      clinicId: newClinicId,
      serviceLevel: newServiceLevel 
    });
  };

  return (
    <div className="rounded-xl border border-border bg-surface p-6 space-y-4 shadow-lg transition-colors duration-200">
      <div className="flex items-center justify-between border-b border-border pb-2">
        <h2 className="text-lg font-medium text-foreground">Doctor & Clinic</h2>
        <span className="text-[10px] uppercase tracking-wider text-blue-400 font-bold bg-blue-500/10 px-2 py-1 rounded">Required</span>
      </div>
      
      <SearchableSelect
        label="Select Doctor"
        placeholder="Search by name, email, or clinic..."
        options={doctorOptions}
        value={data.doctorUserId}
        onChange={handleDoctorChange}
      />

      {/* ✅ ALWAYS SHOW CLINIC (Read-only if single, Dropdown if multiple) */}
      {availableClinics.length > 0 && (
        <div className="space-y-1 animate-in fade-in slide-in-from-top-2 duration-300">
          <label className="text-xs font-medium text-muted uppercase tracking-wider">
            Select Clinic <span className="text-accent">*</span>
          </label>
          <div className="relative">
            <select
              value={data.clinicId}
              onChange={handleClinicChange}
              disabled={availableClinics.length === 1} // Disable if only 1 option
              className={`w-full rounded-lg bg-surface-highlight border border-border px-4 py-3 text-foreground focus:border-accent/50 outline-none transition appearance-none 
                ${availableClinics.length === 1 ? "opacity-60 cursor-not-allowed" : "cursor-pointer hover:bg-[var(--accent-dim)]"}`}
            >
              {availableClinics.map(c => (
                <option key={c.id} value={c.id} className="bg-surface-highlight">
                  {c.name} {c.priceTier === "IN_HOUSE" ? "(In-House)" : ""}
                </option>
              ))}
            </select>
            
            {/* Show Arrow only if multiple options */}
            {availableClinics.length > 1 && (
              <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none opacity-50">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M6 9l6 6 6-6" />
                </svg>
              </div>
            )}
          </div>
          
          {/* Helper Text */}
          {availableClinics.length === 1 && (
             <p className="text-[10px] text-muted pl-1 mt-1">
               Doctor is only associated with this clinic.
             </p>
          )}
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/ShippingEditor.tsx
"use client";
import { useState } from "react";

type Role = "customer" | "lab" | "admin";

export default function ShippingEditor({
  caseId,
  role,
  carrier,
  tracking,
  eta, // ISO string or null
}: {
  caseId: string;
  role: Role;
  carrier?: string | null;
  tracking?: string | null;
  eta?: string | null;
}) {
  const canEdit = role === "lab" || role === "admin";
  const [form, setForm] = useState({
    carrier: carrier ?? "",
    tracking: tracking ?? "",
    // datetime-local wants "YYYY-MM-DDTHH:MM"
    eta: eta ? new Date(eta).toISOString().slice(0, 16) : "",
  });
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | undefined>();

  if (!canEdit) return null;

  async function save() {
    setBusy(true);
    setErr(undefined);
    const body: any = {
      carrier: form.carrier,
      tracking: form.tracking,
      eta: form.eta ? new Date(form.eta).toISOString() : null,
    };
    const r = await fetch(`/api/cases/${caseId}/shipping`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    setBusy(false);
    if (r.ok) {
      if (typeof window !== "undefined") window.location.reload();
    } else {
      const j = await r.json().catch(() => ({}));
      setErr(j.error || "Save failed");
    }
  }

  return (
    <div className="space-y-2">
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <input
          className="rounded-lg p-2 bg-surface-highlight border border-border text-foreground transition-colors duration-200"
          placeholder="Carrier"
          value={form.carrier}
          onChange={(e) => setForm({ ...form, carrier: e.target.value })}
        />
        <input
          className="rounded-lg p-2 bg-surface-highlight border border-border text-foreground transition-colors duration-200"
          placeholder="Tracking #"
          value={form.tracking}
          onChange={(e) => setForm({ ...form, tracking: e.target.value })}
        />
        <input
          type="datetime-local"
          className="rounded-lg p-2 bg-surface-highlight border border-border text-foreground transition-colors duration-200"
          value={form.eta}
          onChange={(e) => setForm({ ...form, eta: e.target.value })}
        />
      </div>
      {err && <p className="text-red-400 text-sm">{err}</p>}
      <button
        onClick={save}
        disabled={busy}
        className="rounded-lg px-3 py-2 bg-accent text-white disabled:opacity-60 hover:bg-accent/80 transition-colors duration-200"
      >
        {busy ? "Saving…" : "Save"}
      </button>
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/DesignerPicker.tsx
// components/DesignerPicker.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

type UserOption = {
  id: string;
  name: string | null;
  email: string;
};

type Props = {
  caseId: string;
  currentAssigneeId: string | null;
  designers: UserOption[];
  disabled?: boolean;
};

export default function DesignerPicker({ caseId, currentAssigneeId, designers, disabled }: Props) {
  const router = useRouter();
  const [busy, setBusy] = useState(false);

  async function handleChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const newVal = e.target.value;
    setBusy(true);
    try {
      const res = await fetch(`/api/cases/${caseId}/assign`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ assigneeId: newVal || null }),
      });
      if (!res.ok) throw new Error("Failed");
      
      router.refresh();
    } catch {
      // ✅ Removed unused 'err'
      alert("Failed to update assignment.");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className={`flex items-center gap-3 bg-surface-highlight rounded-lg px-3 py-2 border border-border transition-colors duration-200 ${disabled ? "opacity-50" : "hover:border-accent/50"}`}>
      <svg className="w-4 h-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
      <div className="flex-1">
        <select
          value={currentAssigneeId || ""}
          onChange={handleChange}
          disabled={busy || disabled}
          className={`w-full bg-transparent border-none text-sm text-foreground focus:ring-0 p-0 transition-colors duration-200 ${
            disabled ? "cursor-not-allowed" : "cursor-pointer"
          }`}
        >
          <option value="" className="bg-surface text-muted">-- Unassigned --</option>
          {designers.map(d => (
            <option key={d.id} value={d.id} className="bg-surface text-foreground">
              {d.name || d.email}
            </option>
          ))}
        </select>
      </div>
      {busy && <span className="text-[10px] text-accent animate-pulse">...</span>}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/NewCaseForm.tsx
// portal/components/NewCaseForm.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import { useRouter } from "next/navigation";
import { CaseData, INITIAL_DATA, DoctorRow, ServiceLevel } from "./new-case/types";
import { useTheme } from "@/components/ThemeProvider"; // ✅ Import Theme Hook

import DoctorSelection from "./new-case/DoctorSelection";
import CaseInfo from "./new-case/CaseInfo";
import TeethSelection from "./new-case/TeethSelection";
import ProductionFiles from "./new-case/ProductionFiles";

export default function NewCaseForm({ doctors }: { doctors: DoctorRow[] }) {
  const router = useRouter();
  const { isDark } = useTheme(); // ✅ Get actual theme state
  const [data, setData] = useState<CaseData>(INITIAL_DATA);
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | undefined>();
  const [ok, setOk] = useState<string | undefined>();

  // ✅ STABILIZED: Wrapped in useCallback to prevent infinite loops in children
  const update = useCallback((fields: Partial<CaseData>) => {
    setData(prev => ({ ...prev, ...fields }));
  }, []);

  // ✅ AUTO-SELECT
  useEffect(() => {
    if (!data.doctorUserId && doctors.length > 0) {
      const first = doctors[0];
      const prefs = first.preferenceNote || first.defaultDesignPreferences || "";
      const clinics = first.clinic ? [first.clinic, ...first.secondaryClinics] : [...first.secondaryClinics];
      let initialClinicId = "";
      let initialLevel: ServiceLevel = "STANDARD";

      if (clinics.length === 1) {
        initialClinicId = clinics[0].id;
        if (clinics[0].priceTier === "IN_HOUSE") initialLevel = "IN_HOUSE";
      }

      update({
        doctorUserId: first.id,
        doctorName: first.name || first.email,
        designPreferences: prefs,
        clinicId: initialClinicId,
        serviceLevel: initialLevel
      });
    }
  }, [doctors, data.doctorUserId, update]); 

  // ✅ AUTO-ALIAS
  useEffect(() => {
    const last = (data.patientLastName || "XX").replace(/[^a-zA-Z]/g, "").slice(0, 2).padEnd(2, "X");
    const first = (data.patientFirstName || "XX").replace(/[^a-zA-Z]/g, "").slice(0, 2).padEnd(2, "X");
    const color = (data.shade || "NO").replace(/[^a-zA-Z0-9]/g, "").slice(0, 2).padEnd(2, "X");
    const prod = (data.product || "XX").slice(0, 2);
    const generated = `${last}${first}${color}${prod}00`.toUpperCase();

    if (data.patientAlias !== generated) {
       update({ patientAlias: generated });
    }
  }, [data.patientLastName, data.patientFirstName, data.shade, data.product, data.patientAlias, update]);

  async function submit(e: React.FormEvent) {
    e.preventDefault();
    setErr(undefined);
    setOk(undefined);

    if (!data.doctorUserId) return setErr("Please select a doctor account.");
    if (!data.clinicId) return setErr("Please select a clinic.");
    if (!data.patientFirstName.trim() || !data.patientLastName.trim()) return setErr("Patient Name is required.");
    if (data.toothCodes.length === 0) return setErr("Please select at least one tooth.");
    if (!data.scanHtml) return setErr("Please upload a scan viewer HTML file.");
    if (!data.rxPdf) return setErr("Please upload the Rx PDF.");
    
    setBusy(true);
    try {
      const fd = new FormData();
      fd.append("patientAlias", data.patientAlias);
      fd.append("patientFirstName", data.patientFirstName);
      fd.append("patientLastName", data.patientLastName);
      fd.append("doctorUserId", data.doctorUserId);
      fd.append("clinicId", data.clinicId);
      fd.append("toothCodes", data.toothCodes.join(",")); 
      
      fd.append("orderDate", new Date(data.orderDate).toISOString());
      fd.append("dueDate", new Date(data.dueDate).toISOString());

      fd.append("product", data.product);
      if (data.material) fd.append("material", data.material);
      fd.append("serviceLevel", data.serviceLevel);
      if (data.shade) fd.append("shade", data.shade);
      if (data.designPreferences) fd.append("designPreferences", data.designPreferences);

      if (data.scanHtml) fd.append("scanHtml", data.scanHtml);
      if (data.rxPdf) fd.append("rxPdf", data.rxPdf);
      if (data.constructionInfo) fd.append("constructionInfo", data.constructionInfo);
      if (data.modelTop) fd.append("modelTop", data.modelTop);
      if (data.modelBottom) fd.append("modelBottom", data.modelBottom);

      const r = await fetch("/api/cases/new", { method: "POST", body: fd });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.error || "Create failed");

      setOk("Case created. Redirecting…");
      router.push(`/portal/cases/${encodeURIComponent(j.id)}`);
    } catch (e: any) {
      setErr(e.message || "Something went wrong.");
      setBusy(false);
    }
  }

  return (
    <div className="flex-1 min-h-0 w-full max-w-5xl mx-auto overflow-y-auto custom-scrollbar pr-2 pb-20">
      
      <form onSubmit={submit} className="space-y-6">
        <DoctorSelection doctors={doctors} data={data} update={update} />
        <CaseInfo data={data} update={update} />
        <TeethSelection data={data} update={update} />
        <ProductionFiles data={data} update={update} />

        <div className="flex flex-col items-end gap-3 pt-6 border-t border-border">
          {err && <p className="text-red-400 text-sm font-medium bg-red-500/10 px-3 py-1 rounded">{err}</p>}
          {ok && <p className="text-emerald-400 text-sm font-medium bg-emerald-500/10 px-3 py-1 rounded">{ok}</p>}
          
          <button
            type="submit"
            disabled={busy}
            // ✅ FORCE OVERRIDE: Inline styles bypass Tailwind completely.
            // If this stays white in light mode, your browser logic is broken.
            style={{
                color: isDark ? 'white' : 'black',
                borderColor: isDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)'
            }}
            className="px-8 py-3 rounded-lg bg-accent font-bold hover:bg-accent/80 transition disabled:opacity-50 cursor-pointer border"
          >
             {busy ? "Creating Case..." : "Create Case"}
          </button>
        </div>
      </form>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/Comments.tsx
// portal/components/Comments.tsx
"use client";

import { useEffect, useState } from "react";

// Helper to detect if a line is an image URL
function extractImage(body: string) {
  const imgRegex = /(https?:\/\/[^\s]+|\/uploads\/[^\s]+)\.(jpg|jpeg|png|gif|webp)/i;
  const match = body.match(imgRegex);
  
  if (match) {
    return {
      imageUrl: match[0],
      text: body.replace(match[0], "").trim(),
    };
  }
  return { imageUrl: null, text: body };
}

export default function Comments({ caseId }: { caseId: string }) {
  const [items, setItems] = useState<any[]>([]);
  const [body, setBody] = useState("");
  const [loading, setLoading] = useState(true);
  const [posting, setPosting] = useState(false);
  const [error, setError] = useState<string | undefined>();

  async function load() {
    setLoading(true);
    setError(undefined);
    try {
      const r = await fetch(`/api/cases/${caseId}/comments`, { cache: "no-store" });
      const j = await r.json();
      if (!r.ok) throw new Error(j.error || "Failed to load comments");
      setItems(j.comments ?? []);
    } catch (e: any) {
      setError(e.message || "Failed to load");
    } finally {
      setLoading(false);
    }
  }

  async function post() {
    if (!body.trim()) return;
    setPosting(true);
    setError(undefined);
    try {
      const r = await fetch(`/api/cases/${caseId}/comments`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ body }),
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.error || "Failed to post");
      setBody("");
      await load();
    } catch (e: any) {
      setError(e.message || "Failed to post");
    } finally {
      setPosting(false);
    }
  }

  useEffect(() => { load(); /* eslint-disable-next-line */ }, [caseId]);

  return (
    <div className="space-y-4">
      {loading ? (
        <p className="text-muted text-sm">Loading comments…</p>
      ) : error ? (
        <p className="text-red-400 text-sm">{error}</p>
      ) : (
        <div className="space-y-3">
          {items.length === 0 && <p className="text-muted text-sm">No comments yet.</p>}
          {items.map((c) => {
            const { imageUrl, text } = extractImage(c.body);
            return (
              <div key={c.id} className="rounded-lg border border-border p-3 bg-surface-highlight">
                <div className="text-[10px] uppercase tracking-wide text-muted/60 mb-2">
                  {new Date(c.createdAt).toLocaleString()}
                </div>
                
                {imageUrl && (
                  <div className="mb-2 rounded overflow-hidden border border-border bg-surface">
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img 
                      src={imageUrl} 
                      alt="Attachment" 
                      className="max-w-full h-auto object-contain max-h-60"
                    />
                  </div>
                )}
                
                {text && <div className="whitespace-pre-wrap text-sm text-foreground/90">{text}</div>}
              </div>
            );
          })}
        </div>
      )}

      <div className="flex gap-2 items-start pt-2 border-t border-border">
        <input
          value={body}
          onChange={(e) => setBody(e.target.value)}
          placeholder="Write a comment…"
          className="flex-1 rounded-lg p-2 bg-surface-highlight border border-border text-foreground text-sm focus:border-accent/50 outline-none transition"
          onKeyDown={(e) => e.key === "Enter" && !e.shiftKey && post()}
        />
        <button
          onClick={post}
          disabled={posting || !body.trim()}
          className="rounded-lg px-3 py-2 bg-accent text-white text-sm font-medium disabled:opacity-50 hover:bg-accent/80 transition"
        >
          {posting ? "..." : "Post"}
        </button>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CasePreviewSwitcher.tsx
// portal/components/CaseViewerTabs.tsx
"use client";

import { useEffect, useState, memo } from "react";
import dynamic from "next/dynamic";
import CaseActions from "@/components/CaseActions";
import type { Role, CaseStatus } from "@/lib/types";

// Dynamic import for 3D Panel
const Case3DPanel = dynamic(() => import("@/components/Case3DPanel"), {
  ssr: false, 
  loading: () => (
    <div className="w-full h-full bg-surface animate-pulse flex items-center justify-center text-muted text-sm">
      Loading 3D Viewer...
    </div>
  ),
});

type TabKey = "scan" | "design_with_model" | "design_only";

// --- STABLE WRAPPERS (Prevent Reloads on AutoRefresh) ---

// Helper: Check if URLs point to the same file (ignoring ?signature=...)
const areUrlsEqual = (prev: { url: string | null }, next: { url: string | null }) => {
  if (prev.url === next.url) return true; // Exact match
  if (!prev.url || !next.url) return false; // One is missing
  
  // Compare only the base path (e.g. https://bucket/file.stl)
  const prevBase = prev.url.split("?")[0];
  const nextBase = next.url.split("?")[0];
  return prevBase === nextBase;
};

// 1. Stable 3D Panel
const Stable3D = memo(({ url }: { url: string | null }) => {
  return <Case3DPanel url={url} />;
}, areUrlsEqual);

// ✅ FIX: Add display name
Stable3D.displayName = "Stable3D";

// 2. Stable Iframe (Exocad)
const StableIframe = memo(({ url, title }: { url: string; title: string }) => {
  const handleIframeLoad = (e: React.SyntheticEvent<HTMLIFrameElement, Event>) => {
    try {
      const iframe = e.target as HTMLIFrameElement;
      const doc = iframe.contentDocument;
      if (doc) {
        doc.body.style.backgroundColor = "#0a1020";
        const style = doc.createElement("style");
        style.textContent = `
          body, html { background-color: #0a1020 !important; }
          #background { background-color: #0a1020 !important; }
          .webviewer-canvas-container { background-color: #0a1020 !important; }
        `;
        doc.head.appendChild(style);
      }
    } catch (err) {
      console.warn("Could not inject styles into viewer (Cross-Origin blocking?)", err);
    }
  };

  return (
    <div className="w-full h-full bg-[#0a1020] rounded-lg overflow-hidden">
      <iframe 
        src={url} 
        className="w-full h-full border-0 block" 
        title={title}
        onLoad={handleIframeLoad} 
      />
    </div>
  );
}, (prev, next) => areUrlsEqual({ url: prev.url }, { url: next.url }));

// ✅ FIX: Add display name
StableIframe.displayName = "StableIframe";


export default function CaseViewerTabs({
  caseId,
  role,
  status,
  scan3DUrl,
  designWithModel3DUrl,
  designOnly3DUrl,
  scanHtmlUrl,
  designHtmlUrl,
}: {
  caseId: string;
  role: Role;
  status: string;
  scan3DUrl: string | null;
  designWithModel3DUrl: string | null;
  designOnly3DUrl: string | null;
  scanHtmlUrl: string | null;
  designHtmlUrl: string | null;
}) {
  const [tab, setTab] = useState<TabKey>("scan");
  
  const hasScanViewer = !!scanHtmlUrl || !!scan3DUrl;
  const hasDesignViewer = !!designHtmlUrl || !!designWithModel3DUrl;
  const hasDesignOnlyViewer = !!designOnly3DUrl;

  useEffect(() => {
    if (typeof window === "undefined") return;
    const STORAGE_KEY = "lumera.caseViewerTab";
    const stored = window.localStorage.getItem(STORAGE_KEY) as TabKey | null;

    const available: Record<TabKey, boolean> = {
      scan: hasScanViewer,
      design_with_model: hasDesignViewer,
      design_only: hasDesignOnlyViewer,
    };
    const order: TabKey[] = ["scan", "design_with_model", "design_only"];

    if (stored && available[stored]) {
      if (stored !== tab) setTab(stored);
      return;
    }
    if (available[tab]) return;
    for (const key of order) {
      if (available[key]) {
        setTab(key);
        window.localStorage.setItem(STORAGE_KEY, key);
        return;
      }
    }
  }, [hasScanViewer, hasDesignViewer, hasDesignOnlyViewer, tab]);

  function selectTab(key: TabKey) {
    setTab(key);
    if (typeof window !== "undefined") {
      window.localStorage.setItem("lumera.caseViewerTab", key);
    }
  }

  const tabBtn = (key: TabKey, label: string, active: boolean, disabled: boolean) => (
    <button
      type="button"
      onClick={() => !disabled && selectTab(key)}
      disabled={disabled}
      className={`
        px-4 h-full text-sm font-medium border-b-2 transition-colors flex items-center
        ${
          active
            ? "border-accent text-accent" 
            : disabled
            ? "border-transparent text-muted/50 cursor-not-allowed"
            : "border-transparent text-muted hover:text-foreground"
        }
      `}
    >
      {label}
    </button>
  );

  const renderContent = () => {
    if (tab === "scan") {
      if (scanHtmlUrl) {
        return <StableIframe url={scanHtmlUrl} title="Exocad Scan Viewer" />;
      }
      return <Stable3D url={scan3DUrl} />;
    }

    if (tab === "design_with_model") {
      if (designHtmlUrl) {
        return <StableIframe url={designHtmlUrl} title="Exocad Design Viewer" />;
      }
      return <Stable3D url={designWithModel3DUrl} />;
    }

    return <Stable3D url={designOnly3DUrl} />;
  };

  return (
    <div className="rounded-xl border border-border bg-surface flex flex-col h-full overflow-hidden shadow-2xl">
      <div className="flex items-center border-b border-border px-2 bg-surface-highlight h-14 shrink-0">
        {tabBtn("scan", "Scan", tab === "scan", !hasScanViewer)}
        {tabBtn("design_with_model", "Design + Model", tab === "design_with_model", !hasDesignViewer)}
        {tabBtn("design_only", "Design Only", tab === "design_only", !hasDesignOnlyViewer)}
        
        <div className="ml-auto pr-2">
          <CaseActions 
            caseId={caseId} 
            role={role} 
            currentStatus={status as CaseStatus} 
          />
        </div>
      </div>

      <div className="flex-1 p-2 relative min-h-0 bg-[#0a1020]">
        {renderContent()}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CaseActions.tsx
// portal/components/CaseActions.tsx
"use client";

import { useState } from "react";
import type { Role } from "@/lib/types";

type Props = {
  caseId: string;
  role: Role;
  currentStatus: string;
};

export default function CaseActions({ caseId, role, currentStatus }: Props) {
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  async function change(to: string) {
    setBusy(true);
    setErr(null);
    try {
      const r = await fetch(`/api/cases/${caseId}/transition`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ to }), 
      });
      
      const j = await r.json().catch(() => ({}));
      
      if (r.ok) {
        window.location.reload();
      } else {
        throw new Error(j.error || "Action failed");
      }
    } catch (e: any) {
      setErr(e.message);
      setBusy(false);
      // Auto-clear error after 5 seconds
      setTimeout(() => setErr(null), 5000);
    }
  }

  const isApproved = 
    currentStatus === "APPROVED" ||
    currentStatus === "IN_MILLING" || 
    currentStatus === "SHIPPED" ||
    currentStatus === "COMPLETED";
  
  const canCustomer = new Set(["APPROVED", "CHANGES_REQUESTED"]);
  
  const showApprove = !isApproved && (role !== "customer" || canCustomer.has("APPROVED"));
  const showRequest = !isApproved && (role !== "customer" || canCustomer.has("CHANGES_REQUESTED"));

  if (isApproved) return null; 

  return (
    // FIX: 'relative' establishes the anchor for the absolute error message
    <div className="relative flex items-center gap-2">
      {showRequest && (
        <button 
          onClick={() => change("CHANGES_REQUESTED")} 
          disabled={busy}
          className="px-3 py-1.5 rounded-md border border-border hover:bg-[var(--accent-dim)] transition text-foreground text-xs font-medium disabled:opacity-50"
        >
          Request Changes
        </button>
      )}
      
      {showApprove && (
        <button 
          onClick={() => change("APPROVED")} 
          disabled={busy}
          className="px-3 py-1.5 rounded-md bg-accent text-white text-xs font-bold hover:bg-accent/80 transition shadow-lg disabled:opacity-50"
        >
          {busy ? "Updating..." : "Approve Design"}
        </button>
      )}

      {/* FIX: 'absolute' takes it out of flow so it doesn't stretch the header */}
      {err && (
        <div className="absolute top-full right-0 mt-3 z-50 w-max max-w-[250px] bg-surface border border-red-500/30 text-red-200 text-xs px-3 py-2 rounded-lg shadow-2xl animate-in fade-in slide-in-from-top-1">
          <div className="flex items-center gap-2">
            <svg className="w-4 h-4 text-red-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{err}</span>
          </div>
          {/* Little arrow pointing up */}
          <div className="absolute -top-1 right-4 w-2 h-2 bg-surface border-t border-l border-red-500/30 rotate-45" />
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/ReviewToggle.tsx
"use client";

import { useState } from "react";

type Role = "customer" | "lab" | "admin";

export default function ReviewToggle({
  caseId,
  role,
  needsReview,
  reviewQuestion,
}: {
  caseId: string;
  role: Role;
  needsReview: boolean;
  reviewQuestion?: string | null;
}) {
  const canEdit = role === "lab" || role === "admin";
  const [busy, setBusy] = useState(false);

  if (!canEdit) return null;

  async function request() {
    const q = prompt("What should the doctor review? (short)");
    if (q == null) return;
    setBusy(true);
    const r = await fetch(`/api/cases/${caseId}/review`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ needsReview: true, question: q }),
    });
    setBusy(false);
    if (r.ok) location.reload();
    else alert((await r.json()).error || "Failed");
  }

  async function clearReview() {
    if (!confirm("Clear doctor review?")) return;
    setBusy(true);
    const r = await fetch(`/api/cases/${caseId}/review`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ needsReview: false }),
    });
    setBusy(false);
    if (r.ok) location.reload();
    else alert((await r.json()).error || "Failed");
  }

  return (
    <div className="space-y-2">
      {needsReview ? (
        <>
          <p className="text-amber-300 text-sm">
            Review requested{reviewQuestion ? `: ${reviewQuestion}` : ""}
          </p>
          <div className="flex gap-2">
            <button
              onClick={request}
              disabled={busy}
              className="rounded-lg px-3 py-2 border border-border hover:bg-[var(--accent-dim)] transition"
            >
              Update question
            </button>
            <button
              onClick={clearReview}
              disabled={busy}
              className="rounded-lg px-3 py-2 bg-accent text-white hover:bg-accent/80 transition"
            >
              Clear review
            </button>
          </div>
        </>
      ) : (
        <button
          onClick={request}
          disabled={busy}
          className="rounded-lg px-3 py-2 border border-border bg-surface"
        >
          Request Doctor Review
        </button>
      )}
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/ProgressTracker.tsx
// portal/components/ProgressTracker.tsx
"use client";

// Export this type so others can reuse it if needed
export type Stage = "DESIGN" | "MILLING_GLAZING" | "SHIPPING";

const STAGES: Stage[] = ["DESIGN", "MILLING_GLAZING", "SHIPPING"];

export default function ProgressTracker({
  stage,
  onClickStage,
}: {
  stage: Stage;
  onClickStage?: (stage: Stage) => void;
}) {
  const activeIdx = STAGES.indexOf(stage);

  return (
    <div className="rounded-xl border border-border p-4 bg-surface">
      <div className="flex items-center justify-between gap-2">
        {STAGES.map((s, i) => {
          const done = i < activeIdx;
          const active = i === activeIdx;
          const isClickable = !!onClickStage;

          return (
            <button
              key={s}
              type="button"
              onClick={() => isClickable && onClickStage(s)}
              disabled={!isClickable}
              className={`
                flex-1 py-2 rounded-lg text-xs font-medium border transition-all
                ${active
                  ? "bg-accent text-white border-accent shadow-md scale-105"
                  : done
                  ? "bg-accent/20 text-foreground border-accent/30"
                  : "bg-surface text-muted border-border"}
                ${isClickable ? "cursor-pointer hover:bg-[var(--accent-dim)]" : "cursor-default"}
              `}
            >
              {s.replace("_", " ")}
            </button>
          );
        })}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/UserForm.tsx
// portal/components/UserForm.tsx
"use client";
import { useState, useMemo, useEffect } from "react";
import { useRouter } from "next/navigation";
import AddressPicker, { AddressData } from "@/components/AddressPicker";
import SearchableSelect from "@/components/SearchableSelect";
import ClinicForm from "@/components/ClinicForm"; 

type Clinic = { id: string; name: string };
type UserOption = { id: string; name: string | null; email: string };

export default function UserForm({ 
  clinics, 
  salesReps = [], 
  initialData, 
  onClose 
}: { 
  clinics: Clinic[], 
  salesReps?: UserOption[],
  initialData?: any, 
  onClose?: () => void 
}) {
  const router = useRouter();
  
  // --- STATE ---
  const [formData, setFormData] = useState({
    name: initialData?.name || "",
    email: initialData?.email || "",
    role: initialData?.role || "customer",
    clinicId: initialData?.clinicId || "", 
    phoneNumber: initialData?.phoneNumber || "",
    preferenceNote: initialData?.preferenceNote || "",
    salesRepId: initialData?.salesRepId || "", // ✅ STATE
  });

  const [address, setAddress] = useState<AddressData>({
    id: initialData?.address?.id || null,
    street: initialData?.address?.street || "",
    city: initialData?.address?.city || "",
    state: initialData?.address?.state || "",
    zipCode: initialData?.address?.zipCode || ""
  });

  const [secondaryIds, setSecondaryIds] = useState<Set<string>>(new Set());
  const [secondarySearch, setSecondarySearch] = useState(""); 
  const [showClinicForm, setShowClinicForm] = useState(false);

  useEffect(() => {
    if (initialData?.secondaryClinics) {
      const ids = initialData.secondaryClinics.map((c: any) => c.id);
      setSecondaryIds(new Set(ids));
    }
  }, [initialData]);

  const [loading, setLoading] = useState(false);
  const [msg, setMsg] = useState("");
  const [error, setError] = useState("");

  const isEdit = !!initialData;

  // --- HELPERS ---

  const toggleSecondary = (id: string) => {
    const next = new Set(secondaryIds);
    if (next.has(id)) next.delete(id);
    else next.add(id);
    setSecondaryIds(next);
  };

  const clinicOptions = useMemo(() => {
    return clinics.map(c => ({ id: c.id, label: c.name }));
  }, [clinics]);

  // ✅ NEW: Rep Options
  const repOptions = useMemo(() => {
    return salesReps.map(r => ({ id: r.id, label: r.name || r.email }));
  }, [salesReps]);

  const filteredSecondaryClinics = useMemo(() => {
    const q = secondarySearch.toLowerCase();
    
    return clinics
      .filter(c => 
        c.id !== formData.clinicId && // Exclude primary
        c.name.toLowerCase().includes(q)
      )
      .sort((a, b) => {
        const aChecked = secondaryIds.has(a.id);
        const bChecked = secondaryIds.has(b.id);
        
        if (aChecked === bChecked) return a.name.localeCompare(b.name);
        return aChecked ? -1 : 1;
      });
  }, [clinics, formData.clinicId, secondarySearch, secondaryIds]);

  // --- SUBMIT ---

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setLoading(true);
    setError("");
    setMsg("");

    try {
      const url = isEdit ? `/api/users/${initialData.id}` : "/api/users/new";
      const method = isEdit ? "PUT" : "POST";

      const payload = { 
        ...formData, 
        address,
        secondaryClinicIds: Array.from(secondaryIds) 
      };

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed");

      setMsg(isEdit ? "User updated!" : "User created!");
      
      if (!isEdit) {
        setFormData({
          name: "", email: "", role: "customer",
          clinicId: "", phoneNumber: "", preferenceNote: "",
          salesRepId: ""
        });
        setAddress({ id: null, street: "", city: "", state: "", zipCode: "" });
        setSecondaryIds(new Set());
      }
      
      router.refresh();
      if (onClose) setTimeout(onClose, 800);

    } catch (err: any) {
      setError(err.message || "Error saving user.");
    } finally {
      setLoading(false);
    }
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && (e.target as HTMLElement).tagName !== "TEXTAREA") {
      e.preventDefault();
    }
  };

  return (
    <>
      <div className="w-full max-w-lg bg-surface rounded-xl border border-border shadow-2xl flex flex-col max-h-[85vh]">
        
        <form onSubmit={handleSubmit} onKeyDown={handleKeyDown} className="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
          <div className="flex items-center justify-between">
             <h3 className="text-lg font-medium text-foreground">{isEdit ? "Edit User" : "New User"}</h3>
             <span className="text-[10px] uppercase font-bold text-muted tracking-wider">Admin Console</span>
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-medium text-muted mb-1 uppercase">Name</label>
              <input type="text" className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2 text-foreground focus:border-accent/50 outline-none"
                value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} placeholder="Full Name" />
            </div>
            <div>
              <label className="block text-xs font-medium text-muted mb-1 uppercase">Role</label>
              <select className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2 text-foreground focus:border-accent/50 outline-none"
                value={formData.role} 
                onChange={(e) => setFormData({...formData, role: e.target.value})}>
                <option value="customer">Doctor (Customer)</option>
                <option value="lab">Lab Tech</option>
                <option value="admin">Admin</option>
                <option value="milling">Milling Center</option>
                <option value="sales">Sales Rep</option> {/* ✅ ADDED */}
              </select>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
                <label className="block text-xs font-medium text-muted mb-1 uppercase">Email</label>
                <input type="email" required className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2 text-foreground focus:border-accent/50 outline-none"
                  value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} placeholder="email@example.com" />
            </div>
            <div>
                <label className="block text-xs font-medium text-muted mb-1 uppercase">Phone</label>
                <input type="text" className="w-full bg-surface-highlight border border-border rounded-lg px-4 py-2 text-foreground focus:border-accent/50 outline-none"
                value={formData.phoneNumber} onChange={(e) => setFormData({...formData, phoneNumber: e.target.value})} placeholder="(555) 000-0000" />
            </div>
          </div>

          <AddressPicker value={address} onChange={setAddress} />

          {formData.role === "customer" && (
            <div className="space-y-4 pt-2 border-t border-border">
              
              {/* PRIMARY CLINIC */}
              <div className="bg-surface rounded-lg p-4 border border-border space-y-3">
                <div className="flex justify-between items-center">
                  <label className="block text-xs font-medium text-muted uppercase">Primary Clinic</label>
                  <button 
                    type="button" 
                    onClick={() => setShowClinicForm(true)} 
                    className="text-[10px] font-bold text-accent hover:text-foreground uppercase tracking-wider transition-colors flex items-center gap-1"
                  >
                    + New Clinic
                  </button>
                </div>
                
                <SearchableSelect
                  label=""
                  placeholder="Search Primary Clinic..."
                  options={clinicOptions}
                  value={formData.clinicId}
                  onChange={(val) => setFormData({ ...formData, clinicId: val })}
                />
              </div>

              {/* ✅ NEW: SALES REP SELECTION */}
              <div className="bg-surface rounded-lg p-4 border border-border space-y-3">
                <label className="block text-xs font-medium text-muted uppercase">Sales Representative</label>
                <SearchableSelect
                  label=""
                  placeholder="Assign a Sales Rep (Optional)..."
                  options={repOptions}
                  value={formData.salesRepId}
                  onChange={(val) => setFormData({ ...formData, salesRepId: val })}
                />
              </div>

              {/* SECONDARY CLINICS */}
              {formData.clinicId && (
                <div className="bg-surface rounded-lg p-4 border border-border space-y-3">
                    <label className="block text-xs font-medium text-muted uppercase">Additional Clinics</label>
                    
                    <div className="relative">
                      <input 
                        className="w-full bg-surface-highlight border border-border rounded-lg pl-8 pr-3 py-2 text-sm text-foreground focus:border-accent/50 outline-none placeholder-muted"
                        placeholder="Filter list..."
                        value={secondarySearch}
                        onChange={(e) => setSecondarySearch(e.target.value)}
                      />
                      <svg className="absolute left-2.5 top-2.5 w-4 h-4 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                    </div>

                    <div className="max-h-40 overflow-y-auto custom-scrollbar space-y-1 p-1 bg-surface rounded border border-border">
                      {filteredSecondaryClinics.length === 0 ? (
                        <p className="text-muted text-xs italic p-2 text-center">
                          {secondarySearch ? "No matching clinics." : "No other clinics available."}
                        </p>
                      ) : (
                        filteredSecondaryClinics.map(c => {
                          const isChecked = secondaryIds.has(c.id);
                          return (
                            <label key={c.id} className={`flex items-center gap-3 p-2 rounded hover:bg-[var(--accent-dim)] cursor-pointer transition ${isChecked ? "bg-[var(--accent-dim)] border border-border" : "border border-transparent"}`}>
                              <div className={`w-4 h-4 rounded border flex items-center justify-center shrink-0 ${isChecked ? "bg-accent border-accent" : "border-border"}`}>
                                {isChecked && <svg className="w-3 h-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M5 13l4 4L19 7" /></svg>}
                              </div>
                              <input type="checkbox" className="hidden" checked={isChecked} onChange={() => toggleSecondary(c.id)} />
                              <span className={`text-sm ${isChecked ? "text-foreground font-medium" : "text-muted"}`}>{c.name}</span>
                            </label>
                          )
                        })
                      )}
                    </div>
                </div>
              )}

              <div>
                  <label className="block text-xs font-medium text-muted mb-1 uppercase">Preference Note</label>
                  <textarea rows={3} className="w-full bg-surface border border-border rounded-lg px-4 py-2 text-foreground focus:border-accent/50 outline-none resize-none"
                  value={formData.preferenceNote} onChange={(e) => setFormData({...formData, preferenceNote: e.target.value})} placeholder="Doctor preferences..." />
              </div>
            </div>
          )}

          {error && <p className="text-red-400 text-sm bg-red-500/10 p-2 rounded text-center">{error}</p>}
          {msg && <p className="text-emerald-400 text-sm bg-emerald-500/10 p-2 rounded text-center">{msg}</p>}
        </form>

        <div className="p-4 border-t border-border bg-surface flex justify-end gap-3 rounded-b-xl shrink-0">
          {onClose && <button type="button" onClick={onClose} className="px-4 py-2 text-muted hover:text-foreground transition">Cancel</button>}
          <button onClick={handleSubmit} disabled={loading} className="px-6 py-2 bg-accent text-white font-bold rounded-lg hover:bg-accent/80 transition-colors">
            {loading ? "Saving..." : (isEdit ? "Update User" : "Create User")}
          </button>
        </div>
      </div>

      {showClinicForm && (
        <ClinicForm 
          onClose={() => setShowClinicForm(false)} 
        />
      )}
    </>
  );
}
--- END OF FILE ---

FILE: ./components/ToothSelector.tsx
// portal/components/ToothSelector.tsx
"use client";

import { useState, useEffect } from "react";
import Image from "next/image";

export interface ToothSelectorProps {
  value: string;
  onChange: (val: string) => void;
}

const UPPER_TEETH = Array.from({ length: 16 }, (_, i) => i + 1);
const LOWER_TEETH = Array.from({ length: 16 }, (_, i) => 32 - i);

export default function ToothSelector({ value, onChange }: ToothSelectorProps) {
  const [selected, setSelected] = useState<Set<number>>(new Set());

  useEffect(() => {
    if (value) {
      const nums = value
        .split(",")
        .map((s: string) => parseInt(s.trim()))
        .filter((n: number) => !isNaN(n));
      setSelected(new Set(nums));
    }
  }, [value]);

  const toggleTooth = (num: number) => {
    const next = new Set(selected);
    if (next.has(num)) next.delete(num);
    else next.add(num);
    setSelected(next);
    onChange(Array.from(next).sort((a, b) => a - b).join(", "));
  };

  const ToothImage = ({ num }: { num: number }) => {
    const active = selected.has(num);
    return (
      <button
        type="button"
        onClick={() => toggleTooth(num)}
        // ✅ FIX: "Tighter" padding (p-1), "Smaller" scale (105), Ring Indicator.
        className={`
          group flex flex-col items-center justify-end transition-all duration-200 
          p-1 rounded-md flex-1 min-w-[32px] max-w-[50px] cursor-pointer relative
          ${active 
            ? "scale-105 z-20 ring-2 ring-accent bg-accent/20 opacity-100 shadow-sm" 
            : "scale-100 opacity-60 grayscale hover:grayscale-0 hover:opacity-100 hover:scale-105 hover:bg-black/5 dark:hover:bg-white/5"}
        `}
      >
        {/* Responsive Image Container */}
        <div className="relative w-full aspect-[2/3]">
           <Image
             src={`/Images/T${num}.png`} 
             alt="" 
             fill
             className="object-contain"
             sizes="(max-width: 768px) 30px, 60px"
             priority={num < 10}
           />
        </div>
        
        {/* Number */}
        <span className={`
          mt-1 font-bold transition-colors text-[10px] sm:text-xs leading-none
          ${active ? "text-accent" : "text-muted group-hover:text-foreground/80"}
        `}>
          #{num}
        </span>
      </button>
    );
  };

  return (
    // ✅ FIX: Removed "overflow-hidden" to prevent top clipping
    <div className="w-full bg-surface rounded-xl border border-border p-4 sm:p-6 flex flex-col items-center gap-6 select-none shadow-inner">
      
      {/* Upper Arch */}
      <div className="w-full flex flex-col items-center gap-2">
        <span className="text-xs text-muted uppercase tracking-widest font-semibold">Upper Arch</span>
        <div className="flex w-full overflow-x-visible pb-2 px-1 gap-1 justify-between">
          {UPPER_TEETH.map((t) => <ToothImage key={t} num={t} />)}
        </div>
      </div>

      {/* Divider */}
      <div className="w-2/3 h-px bg-gradient-to-r from-transparent via-border to-transparent" />

      {/* Lower Arch */}
      <div className="w-full flex flex-col items-center gap-2">
        <div className="flex w-full overflow-x-visible pb-2 px-1 gap-1 justify-between">
          {LOWER_TEETH.map((t) => <ToothImage key={t} num={t} />)}
        </div>
        <span className="text-xs text-muted uppercase tracking-widest font-semibold">Lower Arch</span>
      </div>

      {selected.size === 0 && (
        <p className="text-xs text-red-400/80 mt-1 font-medium animate-pulse">
          Click teeth to select
        </p>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CaseViewerTabs.tsx
// portal/components/CaseViewerTabs.tsx
"use client";

import { useEffect, useState, memo } from "react";
import dynamic from "next/dynamic";
import CaseActions from "@/components/CaseActions";
import type { Role, CaseStatus } from "@/lib/types";

// Dynamic import for 3D Panel
const Case3DPanel = dynamic(() => import("@/components/Case3DPanel"), {
  ssr: false, 
  loading: () => (
    <div className="w-full h-full bg-background animate-pulse flex items-center justify-center text-muted text-sm">
      Loading 3D Viewer...
    </div>
  ),
});

type TabKey = "scan" | "design_with_model" | "design_only";

// --- STABLE WRAPPERS ---

const areUrlsEqual = (prev: { url: string | null }, next: { url: string | null }) => {
  if (prev.url === next.url) return true;
  if (!prev.url || !next.url) return false;
  const prevBase = prev.url.split("?")[0];
  const nextBase = next.url.split("?")[0];
  return prevBase === nextBase;
};

// 1. Stable 3D Panel
const Stable3DComponent = ({ url }: { url: string | null }) => {
  return <Case3DPanel url={url} />;
};
const Stable3D = memo(Stable3DComponent, areUrlsEqual);
// ✅ CRITICAL FIX: Explicit Display Name
Stable3D.displayName = "Stable3D";

// 2. Stable Iframe
const StableIframeComponent = ({ url, title }: { url: string; title: string }) => {
  const handleIframeLoad = (e: React.SyntheticEvent<HTMLIFrameElement, Event>) => {
    try {
      const iframe = e.target as HTMLIFrameElement;
      const doc = iframe.contentDocument;
      if (doc) {
        // Theme-aware background injection - uses CSS variable
        doc.body.style.backgroundColor = "var(--background)";
        const style = doc.createElement("style");
        style.textContent = `
          body, html { background-color: var(--background) !important; }
          #background { background-color: var(--background) !important; }
          .webviewer-canvas-container { background-color: var(--background) !important; }
        `;
        doc.head.appendChild(style);
      }
    } catch (err) {
      console.warn("Could not inject styles into viewer", err);
    }
  };

  return (
    <div className="w-full h-full bg-background rounded-lg overflow-hidden">
      <iframe 
        src={url} 
        className="w-full h-full border-0 block" 
        title={title}
        onLoad={handleIframeLoad} 
      />
    </div>
  );
};
const StableIframe = memo(StableIframeComponent, (prev, next) => areUrlsEqual({ url: prev.url }, { url: next.url }));
// ✅ CRITICAL FIX: Explicit Display Name
StableIframe.displayName = "StableIframe";

export default function CaseViewerTabs({
  caseId,
  role,
  status,
  scan3DUrl,
  designWithModel3DUrl,
  designOnly3DUrl,
  scanHtmlUrl,
  designHtmlUrl,
}: {
  caseId: string;
  role: Role;
  status: string;
  scan3DUrl: string | null;
  designWithModel3DUrl: string | null;
  designOnly3DUrl: string | null;
  scanHtmlUrl: string | null;
  designHtmlUrl: string | null;
}) {
  const [tab, setTab] = useState<TabKey>("scan");
  
  const hasScanViewer = !!scanHtmlUrl || !!scan3DUrl;
  const hasDesignViewer = !!designHtmlUrl || !!designWithModel3DUrl;
  const hasDesignOnlyViewer = !!designOnly3DUrl;

  useEffect(() => {
    if (typeof window === "undefined") return;
    const STORAGE_KEY = "lumera.caseViewerTab";
    const stored = window.localStorage.getItem(STORAGE_KEY) as TabKey | null;

    const available: Record<TabKey, boolean> = {
      scan: hasScanViewer,
      design_with_model: hasDesignViewer,
      design_only: hasDesignOnlyViewer,
    };
    const order: TabKey[] = ["scan", "design_with_model", "design_only"];

    if (stored && available[stored]) {
      if (stored !== tab) setTab(stored);
      return;
    }
    if (available[tab]) return;
    for (const key of order) {
      if (available[key]) {
        setTab(key);
        window.localStorage.setItem(STORAGE_KEY, key);
        return;
      }
    }
  }, [hasScanViewer, hasDesignViewer, hasDesignOnlyViewer, tab]);

  function selectTab(key: TabKey) {
    setTab(key);
    if (typeof window !== "undefined") {
      window.localStorage.setItem("lumera.caseViewerTab", key);
    }
  }

  const tabBtn = (key: TabKey, label: string, active: boolean, disabled: boolean) => (
    <button
      type="button"
      onClick={() => !disabled && selectTab(key)}
      disabled={disabled}
      className={`
        px-4 h-full text-sm font-medium border-b-2 transition-colors flex items-center
        ${
          active
            ? "border-accent text-accent" 
            : disabled
            ? "border-transparent text-muted/30 cursor-not-allowed"
            : "border-transparent text-muted hover:text-foreground"
        }
      `}
    >
      {label}
    </button>
  );

  const renderContent = () => {
    if (tab === "scan") {
      if (scanHtmlUrl) return <StableIframe url={scanHtmlUrl} title="Exocad Scan Viewer" />;
      return <Stable3D url={scan3DUrl} />;
    }
    if (tab === "design_with_model") {
      if (designHtmlUrl) return <StableIframe url={designHtmlUrl} title="Exocad Design Viewer" />;
      return <Stable3D url={designWithModel3DUrl} />;
    }
    return <Stable3D url={designOnly3DUrl} />;
  };

  return (
    <div className="rounded-xl border border-border bg-background flex flex-col h-full overflow-hidden shadow-2xl">
      <div className="flex items-center border-b border-border px-2 bg-surface h-14 shrink-0">
        {tabBtn("scan", "Scan", tab === "scan", !hasScanViewer)}
        {tabBtn("design_with_model", "Design + Model", tab === "design_with_model", !hasDesignViewer)}
        {tabBtn("design_only", "Design Only", tab === "design_only", !hasDesignOnlyViewer)}
        
        <div className="ml-auto pr-2">
          <CaseActions 
            caseId={caseId} 
            role={role} 
            currentStatus={status as CaseStatus} 
          />
        </div>
      </div>

      <div className="flex-1 p-2 relative min-h-0 bg-background">
        {renderContent()}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/FileUploader.tsx
// portal/components/FileUploader.tsx
"use client";

import { useState } from "react";

type Role = "customer" | "lab" | "admin" | "milling";

export default function FileUploader({
  caseId,
  role,
  label,
  slot,
  accept,
  description,
}: {
  caseId: string;
  role: Role;
  label?: string;
  slot?: string;
  accept?: string;
  description?: string;
}) {
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | undefined>();
  const [ok, setOk] = useState<string | undefined>();
  const [file, setFile] = useState<File | null>(null);

  if (role === "customer") return null;

  const activeLabel = label || slot || "file";
  const labelText = description || activeLabel.replace(/_/g, " ");
  
  const finalAccept = accept || (activeLabel === "construction_info" 
    ? ".pdf,.xml,.txt,.constructionInfo" 
    : ".stl,.ply,.obj");

  function onFileChange(e: React.ChangeEvent<HTMLInputElement>) {
    const f = e.target.files?.[0] || null;
    setFile(f);
    setErr(undefined);
    setOk(undefined);
  }

  async function send() {
    if (!file) return setErr("Please choose a file first.");

    setBusy(true);
    setErr(undefined);
    setOk(undefined);

    try {
      // 1. Get the Presigned URL
      const urlRes = await fetch(`/api/cases/${caseId}/files/upload-url`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          filename: file.name, 
          contentType: file.type || "application/octet-stream",
          label: activeLabel
        }),
      });
      
      if (!urlRes.ok) throw new Error("Failed to get upload permission");
      const { url, key } = await urlRes.json();

      // 2. Upload directly to Cloudflare R2
      const uploadRes = await fetch(url, {
        method: "PUT",
        body: file,
        headers: { "Content-Type": file.type || "application/octet-stream" },
      });

      if (!uploadRes.ok) throw new Error("Upload to cloud failed");

      // 3. Save the record in the Database
      const dbRes = await fetch(`/api/cases/${caseId}/files`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          key,
          label: activeLabel,
          size: file.size,
          filename: file.name
        }),
      });

      if (!dbRes.ok) throw new Error("Failed to save file record");

      setOk("Uploaded successfully.");
      setTimeout(() => window.location.reload(), 600);

    } catch (e: any) {
      console.error(e);
      setErr(e?.message || "Upload failed");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="space-y-2">
      <div className="text-xs text-muted capitalize">{labelText}</div>

      <label className="flex items-center justify-between gap-3 rounded-lg p-2 bg-surface border border-border cursor-pointer hover:border-accent/30 transition-colors duration-200">
        <div className="flex-1 min-w-0 text-foreground/80">
          {file ? (
            <>
              <div className="font-medium text-xs truncate" title={file.name}>{file.name}</div>
              <div className="text-[10px] text-muted">{(file.size / (1024 * 1024)).toFixed(2)} MB</div>
            </>
          ) : (
            <div className="text-xs text-muted truncate">Choose file…</div>
          )}
        </div>
        <div className="shrink-0 rounded-md bg-accent text-white px-3 py-1.5 text-xs font-medium">Browse</div>
        <input type="file" accept={finalAccept} onChange={onFileChange} className="hidden" />
      </label>

      <div className="flex items-center gap-2">
        <button
          onClick={send}
          disabled={busy || !file}
          className="rounded-lg px-3 py-1.5 bg-accent text-white text-xs font-bold disabled:opacity-50 hover:bg-accent/80 transition-colors duration-200"
        >
          {busy ? "Uploading…" : "Upload"}
        </button>
        {ok && <span className="text-emerald-400 text-xs animate-pulse">{ok}</span>}
        {err && <span className="text-red-400 text-xs">{err}</span>}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/Case3DPanel.tsx
// portal/components/Case3DPanel.tsx
"use client";

import { useEffect, useState } from "react";
import STLViewer from "./STLViewer";

// Removed unused 'title' prop
export default function Case3DPanel({ url }: { url: string | null }) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) return <div className="w-full h-full bg-surface animate-pulse" />;

  if (!url) {
    return (
      <div className="w-full h-full flex items-center justify-center text-muted text-sm">
        No 3D model available
      </div>
    );
  }

  return (
    <div className="w-full h-full bg-surface relative">
      <STLViewer url={url} />
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/ActionsBar.tsx
// components/ActionsBar.tsx
"use client";

import { useState } from "react";

type Role = "customer" | "lab" | "admin";
type Status =
  | "NEW"
  | "IN_DESIGN"
  | "READY_FOR_REVIEW"
  | "CHANGES_REQUESTED"
  | "APPROVED"
  | "IN_MILLING"
  | "SHIPPED";

export default function ActionsBar({
  caseId,
  role,
  status,
}: {
  caseId: string;
  role: Role;
  status: Status;
}) {
  const [note, setNote] = useState("");
  const [busy, setBusy] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  const canDoctor = role === "customer";
  const canLab = role === "lab" || role === "admin";

  async function send(to: Status) {
    setBusy(true);
    setMsg(null);
    setErr(null);
    try {
      const res = await fetch(`/api/cases/${caseId}/transition`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ to, note: note || undefined }),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j.error || "Action failed");
      setMsg("Saved.");
      setNote("");
      location.reload();
    } catch (e: any) {
      setErr(e?.message || "Action failed");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="rounded-xl border border-border p-4 bg-surface">
      <div className="flex flex-wrap items-center gap-3">
        <input
          type="text"
          value={note}
          onChange={(e) => setNote(e.target.value)}
          placeholder="Optional note…"
          className="px-3 py-1.5 rounded-md bg-surface-highlight border border-border text-sm flex-1 min-w-[200px] text-foreground placeholder:text-muted"
        />

        {/* Doctor actions */}
        {canDoctor && (
          <>
            <button
              disabled={busy}
              onClick={() => send("APPROVED")}
              className="px-3 py-1.5 rounded-md bg-emerald-400 text-black text-sm"
            >
              Approve
            </button>
            <button
              disabled={busy}
              onClick={() => send("CHANGES_REQUESTED")}
              className="px-3 py-1.5 rounded-md bg-amber-300 text-black text-sm"
            >
              Request Changes
            </button>
          </>
        )}

        {/* Lab can mark ready for review, or move back to design */}
        {canLab && (
          <>
            <button
              disabled={busy}
              onClick={() => send("READY_FOR_REVIEW")}
              className="px-3 py-1.5 rounded-md bg-accent text-white text-sm hover:bg-accent/80 transition"
            >
              Ready for Review
            </button>
            <button
              disabled={busy}
              onClick={() => send("IN_DESIGN")}
              className="px-3 py-1.5 rounded-md bg-surface-highlight text-foreground text-sm border border-border hover:bg-[var(--accent-dim)] transition"
            >
              Back to Design
            </button>
          </>
        )}
      </div>

      {msg && <p className="text-emerald-400 text-sm mt-2">{msg}</p>}
      {err && <p className="text-red-400 text-sm mt-2">{err}</p>}

      <p className="text-muted text-xs mt-2">
        Status now: <b>{status}</b>
      </p>
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/ThemeToggle.tsx
// portal/components/ThemeToggle.tsx
"use client";

import { useTheme } from "./ThemeProvider";
import { Sun, Moon } from "lucide-react";

export default function ThemeToggle({ expanded = true }: { expanded?: boolean }) {
  const { isDark, toggleTheme } = useTheme();

  return (
    <button
      onClick={toggleTheme}
      className={`
        h-11 flex items-center rounded-lg transition-colors duration-200 group relative
        ${expanded 
          ? "w-full px-3 justify-start" 
          : "w-11 justify-center"
        }
        text-muted hover:bg-[var(--accent-dim)] hover:text-accent cursor-pointer
      `}
      title={isDark ? "Switch to Light Mode" : "Switch to Night Mode"}
    >
      <div className="shrink-0 group-hover:scale-110 transition-transform flex items-center justify-center">
        {isDark ? (
          <Sun size={20} className="text-yellow-400" />
        ) : (
          <Moon size={20} className="text-accent" />
        )}
      </div>
      
      <span 
        className={`
          ml-3 font-medium whitespace-nowrap transition-opacity duration-300 overflow-hidden
          ${expanded ? "opacity-100 w-auto" : "opacity-0 w-0 hidden"}
        `}
      >
        {isDark ? "Light Mode" : "Night Mode"}
      </span>
    </button>
  );
}
--- END OF FILE ---

FILE: ./components/ThemeProvider.tsx
// portal/components/ThemeProvider.tsx
"use client";

import { createContext, useContext, useEffect, useState } from "react";

const ThemeContext = createContext({
  isDark: true,
  toggleTheme: () => {},
});

export function ThemeProvider({ children }: { children: React.ReactNode }) {
  const [isDark, setIsDark] = useState(true);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    const saved = localStorage.getItem("lumera-theme");
    // Default to dark if no preference or explicitly dark
    const initial = saved ? saved === "dark" : true; 
    setIsDark(initial);
  }, []);

  const applyTheme = (dark: boolean) => {
    if (dark) {
      document.documentElement.classList.add("dark");
      document.documentElement.classList.remove("light");
    } else {
      document.documentElement.classList.remove("dark");
      document.documentElement.classList.add("light");
    }
  };

  const toggleTheme = () => {
    const next = !isDark;
    setIsDark(next);
    localStorage.setItem("lumera-theme", next ? "dark" : "light");
    applyTheme(next);
  };

  return (
    <ThemeContext.Provider value={{ isDark, toggleTheme }}>
      {/* This script runs IMMEDIATELY before the body is rendered.
        It prevents the theme flash by applying the class before React mounts.
      */}
      <script
        dangerouslySetInnerHTML={{
          __html: `
            (function() {
              try {
                var saved = localStorage.getItem('lumera-theme');
                var isDark = saved ? saved === 'dark' : true;
                if (isDark) {
                  document.documentElement.classList.add('dark');
                  document.documentElement.classList.remove('light');
                } else {
                  document.documentElement.classList.remove('dark');
                  document.documentElement.classList.add('light');
                }
              } catch (e) {}
            })();
          `,
        }}
      />
      {children}
    </ThemeContext.Provider>
  );
}

export const useTheme = () => useContext(ThemeContext);
--- END OF FILE ---

FILE: ./components/HtmlViewerUploader.tsx
// components/HtmlViewerUploader.tsx
"use client";

import { useState } from "react";

type Role = "customer" | "lab" | "admin" | "milling";

export default function HtmlViewerUploader({
  caseId,
  role,
  label,
  description,
}: {
  caseId: string;
  role: Role;
  label: "scan_html" | "design_with_model_html";
  description: string;
}) {
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | undefined>();
  const [ok, setOk] = useState<string | undefined>();
  const [file, setFile] = useState<File | null>(null);

  // Customers cannot upload viewers
  if (role === "customer") return null;

  function onFileChange(e: React.ChangeEvent<HTMLInputElement>) {
    const f = e.target.files?.[0] || null;
    setFile(f);
    setErr(undefined);
    setOk(undefined);
  }

  async function send() {
    if (!file) return setErr("Please choose a file first.");

    setBusy(true);
    setErr(undefined);
    setOk(undefined);

    try {
      // 1. Get Permission (Presigned URL)
      const urlRes = await fetch(`/api/cases/${caseId}/files/upload-url`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          filename: file.name, 
          contentType: file.type || "text/html",
          label: label
        }),
      });
      
      if (!urlRes.ok) throw new Error("Failed to get upload permission");
      const { url, key } = await urlRes.json();

      // 2. Upload Direct to Cloud
      const uploadRes = await fetch(url, {
        method: "PUT",
        body: file,
        headers: { "Content-Type": file.type || "text/html" },
      });

      if (!uploadRes.ok) throw new Error("Upload to cloud failed");

      // 3. Save Record to DB
      const dbRes = await fetch(`/api/cases/${caseId}/files`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          key,
          label: label,
          size: file.size,
          filename: file.name
        }),
      });

      if (!dbRes.ok) throw new Error("Failed to save record");

      setOk("Viewer uploaded.");
      setTimeout(() => window.location.reload(), 600);

    } catch (e: any) {
      console.error(e);
      setErr(e?.message || "Upload failed");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="space-y-2">
      <div className="text-xs text-muted">{description}</div>

      <label className="flex items-center justify-between gap-3 rounded-lg p-2 bg-surface-highlight border border-border cursor-pointer hover:border-accent/30 transition-colors">
        <div className="flex-1 min-w-0 text-foreground/80">
          {file ? (
            <>
              <div className="font-medium text-xs truncate" title={file.name}>
                {file.name}
              </div>
              <div className="text-[10px] text-muted">
                {(file.size / (1024 * 1024)).toFixed(2)} MB
              </div>
            </>
          ) : (
            <div className="text-xs text-muted truncate">
              Choose Exocad HTML…
            </div>
          )}
        </div>
        <div className="shrink-0 rounded-md bg-accent text-white px-3 py-1.5 text-xs font-medium">
          Browse
        </div>
        <input
          type="file"
          accept=".html,text/html"
          onChange={onFileChange}
          className="hidden"
        />
      </label>

      <div className="flex items-center gap-2">
        <button
          onClick={send}
          disabled={busy || !file}
          className="rounded-lg px-3 py-1.5 bg-accent text-white text-xs font-bold disabled:opacity-50 hover:bg-accent/80 transition-colors"
        >
          {busy ? "Uploading…" : "Upload viewer"}
        </button>
        {ok && <span className="text-emerald-400 text-xs animate-pulse">{ok}</span>}
        {err && <span className="text-red-400 text-xs">{err}</span>}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CommentsPanel.tsx
// portal/components/CommentsPanel.tsx
"use client";

import { useState, useRef, useEffect } from "react";
import Image from "next/image"; // ✅ Import Image
import ImageAnnotator from "./ImageAnnotator";

type Attachment = {
  id: string;
  url: string;
  kind: string;
};

type Comment = {
  id: string;
  body: string;
  at: Date | string;
  author: string;
  role: string;
  attachments?: Attachment[];
};

function fixUrl(url: string) {
  if (!url) return "";
  if (url.startsWith("http://") || url.startsWith("https://")) {
    return url;
  }
  let clean = url.replace(/^public\//, "");
  if (!clean.startsWith("/")) clean = "/" + clean;
  return clean;
}

export default function CommentsPanel({
  caseId,
  comments: initialComments,
  canPost,
  currentUserName,
  currentUserRole,
}: {
  caseId: string;
  comments: Comment[];
  canPost: boolean;
  currentUserName: string;
  currentUserRole: string;
}) {
  const [comments, setComments] = useState<Comment[]>(initialComments);
  const [body, setBody] = useState("");
  const [posting, setPosting] = useState(false);
  const [annotatingFile, setAnnotatingFile] = useState<File | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [zoomImg, setZoomImg] = useState<string | null>(null);

  useEffect(() => {
    setComments(initialComments);
  }, [initialComments]);

  async function handlePost(attachmentId?: string) {
    if (!body.trim() && !attachmentId) return;

    setPosting(true);
    try {
      const res = await fetch(`/api/cases/${caseId}/comments`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          body: body || (attachmentId ? "Attached image" : ""),
          attachmentFileId: attachmentId 
        }),
      });
      if (!res.ok) throw new Error("Failed to post");

      const newComment = await res.json();
      const mapped: Comment = {
        id: newComment.id,
        body: newComment.body,
        at: new Date(newComment.createdAt),
        author: currentUserName,
        role: currentUserRole,
        attachments: newComment.attachments?.map((a: any) => ({
          id: a.id,
          url: a.url,
          kind: a.kind
        })) || []
      };

      setComments((prev) => [mapped, ...prev]);
      setBody("");
    } catch (e) {
      console.error(e);
      alert("Failed to post comment");
    } finally {
      setPosting(false);
    }
  }

  function onFileSelect(e: React.ChangeEvent<HTMLInputElement>) {
    const file = e.target.files?.[0];
    if (!file) return;
    setAnnotatingFile(file);
    e.target.value = "";
  }

  async function onAnnotationSave(blob: Blob) {
    setAnnotatingFile(null); 
    setPosting(true);
    try {
      const file = new File([blob], "annotation.png", { type: "image/png" });
      const label = "Photo";

      const urlRes = await fetch(`/api/cases/${caseId}/files/upload-url`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          filename: file.name, 
          contentType: file.type,
          label: label
        }),
      });
      if (!urlRes.ok) throw new Error("Failed to get upload URL");
      const { url, key } = await urlRes.json();

      const uploadRes = await fetch(url, {
        method: "PUT",
        body: file,
        headers: { "Content-Type": file.type },
      });
      if (!uploadRes.ok) throw new Error("Failed to upload image");

      const upRes = await fetch(`/api/cases/${caseId}/files`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          key,
          label: label,
          size: file.size,
          filename: file.name
        }),
      });

      if (!upRes.ok) throw new Error("Failed to save image record");
      const upData = await upRes.json();
      
      await handlePost(upData.id);
    } catch (e) {
      console.error(e);
      alert("Failed to upload annotation");
      setPosting(false);
    }
  }

  function renderBody(text: string) {
    const regex = /((?:https?:\/\/[^\s]+|(?:\/uploads\/)[^\s]+)\.(?:png|jpg|jpeg|gif|webp))/gi;
    const parts = text.split(regex);
    return parts.map((part, i) => {
      if (part.match(regex)) {
        const safeSrc = fixUrl(part);
        return (
          <div key={i} className="my-3 relative w-full h-64">
            {/* ✅ Optimized Inline Image */}
            <Image
              src={safeSrc}
              alt="Inline Content"
              fill
              className="rounded-lg border border-border cursor-zoom-in object-contain"
              onClick={() => setZoomImg(safeSrc)}
              unoptimized
            />
          </div>
        );
      }
      if (!part) return null;
      return <span key={i}>{part}</span>;
    });
  }

  return (
    <div className="flex flex-col h-full min-h-0 transition-colors duration-200">
      <h3 className="text-xs font-semibold text-muted uppercase tracking-wider mb-4 flex-shrink-0">
        Discussion
      </h3>

      <div className="flex-1 overflow-y-auto min-h-0 space-y-4 space-y-reverse pr-2 custom-scrollbar flex flex-col-reverse">
        {comments.length === 0 ? (
          <p className="text-muted text-sm text-center py-4">No comments yet.</p>
        ) : (
          comments.map((c) => {
            const isInternal = c.role === "admin" || c.role === "lab" || c.role === "milling";
            const maskAsLumera = currentUserRole === "customer" && isInternal;
            
            const displayAuthor = maskAsLumera ? "Lumera" : c.author;
            const displayInitials = maskAsLumera ? "L" : displayAuthor.substring(0, 2).toUpperCase();
            
            const bubbleStyle = isInternal 
                ? "bg-blue-500/20 text-blue-300 border border-blue-500/30" 
                : "bg-emerald-500/20 text-emerald-300 border border-emerald-500/30";
            return (
              <div key={c.id} className="group flex gap-3">
                <div 
                  className={`
                    w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shrink-0
                    ${bubbleStyle}
                  `}
                >
                  {displayInitials}
                </div>

                <div className="flex-1 min-w-0">
                  <div className="flex items-baseline justify-between">
                    <span className="text-sm font-medium text-foreground">
                      {displayAuthor}
                      {!maskAsLumera && c.role !== "customer" && (
                        <span className="ml-2 text-[10px] opacity-50 uppercase border border-border px-1 rounded">{c.role}</span>
                      )}
                    </span>
                    <span className="text-[10px] text-muted">
                      {new Date(c.at).toLocaleString()}
                    </span>
                  </div>
                  
                  <div className="mt-1 text-sm text-foreground/80 whitespace-pre-wrap leading-relaxed">
                    {renderBody(c.body)}
                  </div>

                  {c.attachments && c.attachments.length > 0 && (
                    <div className="mt-3 flex flex-wrap gap-2">
                      {c.attachments.map((att) => {
                        const safeSrc = fixUrl(att.url);
                        return (
                          <div 
                            key={att.id}
                            onClick={() => setZoomImg(safeSrc)} 
                            className="relative w-24 h-24 rounded-lg overflow-hidden border border-border cursor-zoom-in hover:border-accent/30 transition-colors bg-surface"
                          >
                            {/* ✅ OPTIMIZED: Use Next.js Image for thumbnails */}
                            <Image 
                              src={safeSrc} 
                              alt="Attachment" 
                              fill
                              className="object-cover" 
                              sizes="96px"
                              unoptimized // For Signed URLs
                            />
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            );
          })
        )}
      </div>

      {canPost && (
        <div className="mt-4 pt-4 border-t border-border flex-shrink-0">
          <div className="relative flex items-center gap-2">
            <input 
              type="file" 
              ref={fileInputRef}
              accept="image/*"
              className="hidden"
              onChange={onFileSelect}
            />
            
            <button
              onClick={() => fileInputRef.current?.click()}
              className="p-2 rounded-lg bg-surface text-muted hover:text-foreground hover:bg-[var(--accent-dim)] transition-colors duration-200"
              title="Attach Image & Draw"
            >
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
              </svg>
            </button>

            <input
              value={body}
              onChange={(e) => setBody(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                  e.preventDefault();
                  handlePost();
                }
              }}
              placeholder="Type a message..."
              className="flex-1 bg-surface-highlight border border-border rounded-lg px-3 py-2 text-sm text-foreground placeholder:text-muted focus:outline-none focus:border-accent/30 transition-colors duration-200"
            />
            
            <button
              onClick={() => handlePost()}
              disabled={posting || (!body.trim())}
              className="p-2 rounded-lg bg-accent text-white hover:bg-accent/80 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
            >
              {posting ? (
                <div className="w-5 h-5 border-2 border-muted border-t-foreground rounded-full animate-spin" />
              ) : (
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
              )}
            </button>
          </div>
        </div>
      )}

      {annotatingFile && (
        <ImageAnnotator
          file={annotatingFile}
          onSave={onAnnotationSave}
          onCancel={() => setAnnotatingFile(null)}
        />
      )}

      {zoomImg && (
        <div 
          className="fixed inset-0 z-50 flex items-center justify-center bg-background/95 backdrop-blur-sm p-4 transition-colors duration-200"
          onClick={() => setZoomImg(null)}
        >
          {/* Zoomed image stays as standard img for full quality/simplicity */}
          {/* eslint-disable-next-line @next/next/no-img-element */}
          <img 
            src={zoomImg} 
            alt="Zoomed" 
            className="max-w-full max-h-full rounded-lg shadow-2xl" 
          />
          <button className="absolute top-4 right-4 text-muted hover:text-foreground">
            <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/Logo.tsx
// portal/components/Logo.tsx
"use client";

import React, { useEffect, useState } from "react";
import Image from "next/image";
import { useTheme } from "./ThemeProvider";

interface LogoProps {
  className?: string;
  showText?: boolean;
}

export default function Logo({ className = "", showText = true }: LogoProps) {
  const { isDark } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  // Default to Dark Mode (White Logo) on server/initial render
  const showLightLogo = mounted && !isDark;

  return (
    <div className={`relative flex items-center justify-center select-none ${className}`}>
      {showText ? (
        <div className="relative w-full h-16 flex items-center justify-center">
          {showLightLogo ? (
            <Image 
              key="light-logo"
              src="/Images/Lumera-Lab-Black-and-Purple.png" 
              alt="Lumera Dental" 
              width={192} 
              height={51} 
              className="w-48 h-auto object-contain animate-in fade-in duration-200"
              priority
              unoptimized // ✅ FIX: Forces direct load of local file
            />
          ) : (
            <Image 
              key="dark-logo"
              src="/Images/Lumera-Lab-White.png" 
              alt="Lumera Dental" 
              width={192} 
              height={51} 
              className="w-48 h-auto object-contain animate-in fade-in duration-200"
              priority
              unoptimized // ✅ FIX: Forces direct load of local file
            />
          )}
        </div>
      ) : (
        // Collapsed Icon
        <Image 
          src="/Images/Icon-Purple.png" 
          alt="Lumera Icon" 
          width={32} 
          height={32} 
          className="w-8 h-8 object-contain"
          unoptimized
        />
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/AutoRefresh.tsx
// components/AutoRefresh.tsx
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";

export default function AutoRefresh({ intervalMs = 60000 }: { intervalMs?: number }) {
  const router = useRouter();

  useEffect(() => {
    const interval = setInterval(() => {
      // Re-run the Server Component data fetching
      router.refresh(); 
    }, intervalMs);

    // Cleanup timer on unmount
    return () => clearInterval(interval);
  }, [router, intervalMs]);

  return null; // Invisible component
}
--- END OF FILE ---

FILE: ./components/ClinicForm.tsx
//components/ClinicForm.tsx
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";
import AddressPicker, { AddressData } from "@/components/AddressPicker";

export default function ClinicForm({ initialData, onClose }: { initialData?: any, onClose: () => void }) {
  const router = useRouter();
  const [form, setForm] = useState(initialData || {
    name: "", phone: "",
    taxId: "", bankName: "", routingNumber: "", bankLast4: "",
    billingCycleDay: 1, paymentTerms: 30, priceTier: "STANDARD"
  });
  const [address, setAddress] = useState<AddressData>({
    id: initialData?.address?.id || null,
    street: initialData?.address?.street || "",
    city: initialData?.address?.city || "",
    state: initialData?.address?.state || "",
    zipCode: initialData?.address?.zipCode || ""
  });
  const [busy, setBusy] = useState(false);

  async function save(e: React.FormEvent) {
    e.preventDefault();
    setBusy(true);
    const url = initialData ? `/api/clinics/${initialData.id}` : "/api/clinics";
    const method = initialData ? "PUT" : "POST";
    
    const payload = { ...form, address };
    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      router.refresh();
      onClose();
    } else {
      alert("Failed to save");
      setBusy(false);
    }
  }

  // ✅ PREVENT ENTER SUBMISSION
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && (e.target as HTMLElement).tagName !== "TEXTAREA") {
      e.preventDefault();
    }
  };

  const set = (field: string, val: any) => setForm((prev: any) => ({ ...prev, [field]: val }));

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-background/95 backdrop-blur-sm p-4">
      {/* Layout Container: Flex column to manage scrolling vs fixed footer */}
      <div className="w-full max-w-2xl bg-surface border border-border rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
        
        {/* Header */}
        <div className="p-6 border-b border-border shrink-0">
           <h2 className="text-xl font-semibold text-foreground">{initialData ? "Edit Clinic" : "New Clinic"}</h2>
        </div>

        {/* Scrollable Body */}
        <form onSubmit={save} onKeyDown={handleKeyDown} className="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
          
          <div className="space-y-4">
            <h3 className="text-xs font-bold text-accent uppercase tracking-wider">Details</h3>
            <div className="grid grid-cols-2 gap-4">
              <input placeholder="Clinic Name *" required className="p-2 bg-surface-highlight border border-border rounded text-foreground focus:border-accent/50 outline-none" 
                value={form.name} onChange={e => set("name", e.target.value)} />
              <input placeholder="Phone" className="p-2 bg-surface-highlight border border-border rounded text-foreground focus:border-accent/50 outline-none" 
                value={form.phone || ""} onChange={e => set("phone", e.target.value)} />
            </div>
          </div>

          <AddressPicker value={address} onChange={setAddress} />

          <div className="space-y-4 pt-2 border-t border-border">
            <h3 className="text-xs font-bold text-accent uppercase tracking-wider">Billing & Financials</h3>
            <div className="grid grid-cols-3 gap-4">
               <select className="p-2 bg-surface-highlight border border-border rounded text-foreground focus:border-accent/50 outline-none"
                  value={form.priceTier} onChange={e => set("priceTier", e.target.value)}>
                  <option value="STANDARD">Standard</option>
                  <option value="IN_HOUSE">In-House</option>
               </select>
               <input type="number" placeholder="Cycle Day (1-28)" className="p-2 bg-surface-highlight border border-border rounded text-foreground focus:border-accent/50 outline-none" 
                 value={form.billingCycleDay} onChange={e => set("billingCycleDay", e.target.value)} />
               <input type="number" placeholder="Net Terms (e.g. 30)" className="p-2 bg-surface-highlight border border-border rounded text-foreground focus:border-accent/50 outline-none" 
                 value={form.paymentTerms} onChange={e => set("paymentTerms", e.target.value)} />
            </div>
            
            <div className="grid grid-cols-2 gap-4">
               <input placeholder="Bank Name" className="p-2 bg-surface-highlight border border-border rounded text-foreground focus:border-accent/50 outline-none" 
                 value={form.bankName || ""} onChange={e => set("bankName", e.target.value)} />
               <input placeholder="Tax ID" className="p-2 bg-surface-highlight border border-border rounded text-foreground focus:border-accent/50 outline-none" 
                 value={form.taxId || ""} onChange={e => set("taxId", e.target.value)} />
            </div>
           
            <div className="grid grid-cols-2 gap-4">
               <input placeholder="Routing Number" className="p-2 bg-surface-highlight border border-border rounded text-foreground focus:border-accent/50 outline-none" 
                 value={form.routingNumber || ""} onChange={e => set("routingNumber", e.target.value)} />
               <input placeholder="Account Last 4" className="p-2 bg-surface-highlight border border-border rounded text-foreground focus:border-accent/50 outline-none" 
                 value={form.bankLast4 || ""} onChange={e => set("bankLast4", e.target.value)} />
            </div>
          </div>
        </form>

        {/* Footer */}
        <div className="p-4 border-t border-border bg-surface flex justify-end gap-3 rounded-b-xl shrink-0">
            <button type="button" onClick={onClose} className="px-4 py-2 text-muted hover:text-foreground">Cancel</button>
            <button onClick={save} disabled={busy} className="px-6 py-2 bg-accent text-white font-bold rounded hover:bg-accent/80 transition">
              {busy ? "Saving..." : "Save Clinic"}
            </button>
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/PublicNavbar.tsx
// portal/components/PublicNavbar.tsx
"use client";

import Link from "next/link";
import Image from "next/image";
import { usePathname } from "next/navigation";

export default function PublicNavbar() {
  const pathname = usePathname();

  const navLink = (path: string, label: string) => {
    const isActive = pathname === path;
    return (
      <Link
        href={path}
        className={`text-sm font-medium transition-colors hover:text-foreground ${
          isActive ? "text-foreground" : "text-muted"
        }`}
      >
        {label}
      </Link>
    );
  };

  return (
    <header className="sticky top-0 z-50 w-full border-b border-border bg-background/80 backdrop-blur-md">
      <div className="container mx-auto px-6 h-16 flex items-center justify-between">
        {/* Brand */}
        <Link href="/" className="flex items-center gap-2 group">
          <Image 
            src="/Images/Lumera-Lab-White.png" 
            alt="Lumera" 
            width={320} 
            height={64} 
            className="h-16 w-auto"
          />
        </Link>

        {/* Desktop Nav */}
        <nav className="hidden md:flex items-center gap-8">
          {navLink("/", "Home")}
          {navLink("/work", "Our Work")}
          {navLink("/about", "About")}
          {navLink("/contact", "Contact")}
        </nav>

        {/* CTA / Login */}
        <div className="flex items-center gap-4">
          {/* FIX: Corrected route from /auth/login to /login */}
          <Link 
            href="/login" 
            className="text-sm font-medium text-muted hover:text-foreground transition-colors"
          >
            Log In
          </Link>
          <Link
            href="/contact"
            className="hidden sm:inline-flex items-center justify-center px-4 py-2 text-sm font-semibold text-background bg-foreground rounded-full hover:bg-foreground/90 transition-colors shadow-lg"
          >
            Send a Case
          </Link>
        </div>
      </div>
    </header>
  );
}
--- END OF FILE ---

FILE: ./components/BillingList.tsx
// portal/components/BillingList.tsx
"use client";

import { useState, useMemo } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { formatCurrency, BillingType } from "@/lib/pricing";

type BillingCase = {
  id: string;
  orderDate: Date | string;
  patientAlias: string;
  patientFirstName: string | null;
  patientLastName: string | null;
  doctorName: string | null;
  product: string;
  units: number;
  cost: number | string;
  billingType: string;
  clinic: { name: string };
};

type Props = {
  cases: BillingCase[];
  isAdminOrLab: boolean;
  totalCount: number;
};

type SortConfig = {
  key: string | null;
  direction: "asc" | "desc" | null;
};

const SortableHeader = ({ 
  label, colKey, sortConfig, onSort, align = "left", className = ""
}: any) => {
  const isActive = sortConfig.key === colKey;
  return (
    <th 
      className={`
        p-4 font-medium cursor-pointer transition-colors select-none group border-b-2 outline-none whitespace-nowrap
        ${isActive ? "text-accent border-accent" : "text-muted border-transparent hover:text-foreground"}
        ${align === "right" ? "text-right" : align === "center" ? "text-center" : "text-left"}
        ${className}
      `}
      onClick={() => onSort(colKey)}
    >
      <div className={`flex items-center gap-1 ${align === "right" ? "justify-end" : align === "center" ? "justify-center" : "justify-start"}`}>
        {label}
        {isActive && (
          <span className="text-accent text-[10px] leading-none">
            {sortConfig.direction === "asc" ? "▲" : "▼"}
          </span>
        )}
      </div>
    </th>
  );
};

export default function BillingList({ cases, isAdminOrLab, totalCount }: Props) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [sortConfig, setSortConfig] = useState<SortConfig>({ key: null, direction: null });
  const [loadingMore, setLoadingMore] = useState(false);

  const sortedCases = useMemo(() => {
    if (!sortConfig.key || !sortConfig.direction) return cases;
    return [...cases].sort((a, b) => {
      let aVal: any = "";
      let bVal: any = "";
      switch (sortConfig.key) {
        case "date": aVal = new Date(a.orderDate).getTime(); bVal = new Date(b.orderDate).getTime(); break;
        case "clinic": aVal = a.clinic.name; bVal = b.clinic.name; break;
        case "alias": aVal = a.patientAlias; bVal = b.patientAlias; break;
        case "doctor": aVal = a.doctorName || ""; bVal = b.doctorName || ""; break;
        case "patientName": 
            aVal = `${a.patientLastName} ${a.patientFirstName}`; 
            bVal = `${b.patientLastName} ${b.patientFirstName}`; 
            break;
        case "product": aVal = a.product; bVal = b.product; break;
        case "units": aVal = a.units; bVal = b.units; break;
        case "cost": aVal = Number(a.cost); bVal = Number(b.cost); break;
      }
      if (aVal < bVal) return sortConfig.direction === "asc" ? -1 : 1;
      if (aVal > bVal) return sortConfig.direction === "asc" ? 1 : -1;
      return 0;
    });
  }, [cases, sortConfig]);

  const handleSort = (key: string) => {
    setSortConfig((current) => {
      if (current.key !== key) return { key, direction: "asc" };
      if (current.direction === "asc") return { key, direction: "desc" };
      return { key: null, direction: null };
    });
  };

  const handleLoadMore = () => {
    setLoadingMore(true);
    const params = new URLSearchParams(searchParams.toString());
    const currentLimit = parseInt(params.get("limit") || "50");
    const newLimit = currentLimit + 50;
    params.set("limit", newLimit.toString());
    router.replace(`?${params.toString()}`, { scroll: false });
    setTimeout(() => setLoadingMore(false), 2000);
  };

  return (
    // ✅ Fixed: Using semantic border and bg colors
    <div className="flex-1 min-h-0 rounded-xl border border-border bg-surface overflow-hidden flex flex-col shadow-2xl">
      <div className="flex-1 overflow-y-auto custom-scrollbar">
        <table className="w-full text-sm text-left border-collapse">
          <thead className="bg-surface text-muted sticky top-0 backdrop-blur-md z-10 border-b border-border">
            <tr>
              <SortableHeader label="Created On" colKey="date" sortConfig={sortConfig} onSort={handleSort} />
              {isAdminOrLab && <SortableHeader label="Clinic" colKey="clinic" sortConfig={sortConfig} onSort={handleSort} />}
              <SortableHeader label="Patient Name" colKey="patientName" sortConfig={sortConfig} onSort={handleSort} />
              <SortableHeader label="Alias" colKey="alias" sortConfig={sortConfig} onSort={handleSort} />
              {isAdminOrLab && <SortableHeader label="Doctor" colKey="doctor" sortConfig={sortConfig} onSort={handleSort} />}
              <SortableHeader label="Product" colKey="product" sortConfig={sortConfig} onSort={handleSort} />
              <SortableHeader label="Units" colKey="units" sortConfig={sortConfig} onSort={handleSort} align="center" />
              <SortableHeader label="Cost" colKey="cost" sortConfig={sortConfig} onSort={handleSort} align="right" />
            </tr>
          </thead>
          <tbody className="divide-y divide-border">
             {sortedCases.length === 0 ? (
              <tr>
                <td colSpan={isAdminOrLab ? 8 : 6} className="p-12 text-center text-muted">
                   No records found matching your filters.
                </td>
              </tr>
            ) : (
              sortedCases.map((c) => {
                const isWarranty = c.billingType === BillingType.WARRANTY;
                return (
                  <tr key={c.id} className="hover:bg-[var(--accent-dim)] transition-colors">
                    <td className="p-4 text-muted">{new Date(c.orderDate).toLocaleDateString()}</td>
                    {isAdminOrLab && <td className="p-4 text-muted">{c.clinic.name}</td>}
                    <td className="p-4 font-medium text-foreground">{c.patientLastName}, {c.patientFirstName}</td>
                    <td className="p-4 font-mono text-xs text-muted">{c.patientAlias}</td>
                    {isAdminOrLab && <td className="p-4 text-muted">{c.doctorName || "—"}</td>}
                    <td className="p-4 text-muted">
                      {c.product.replace(/_/g, " ")}
                      {isWarranty && <span className="ml-2 px-2 py-0.5 rounded text-[10px] bg-yellow-500/10 text-yellow-600 border border-yellow-500/20 uppercase tracking-wide">Warranty</span>}
                    </td>
                    <td className="p-4 text-center text-muted">{c.units}</td>
                    <td className={`p-4 text-right font-mono ${isWarranty ? "text-muted line-through" : "text-emerald-600"}`}>
                      {formatCurrency(Number(c.cost))}
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>

      {/* ✅ UNIFIED FOOTER: Using semantic colors */}
      <div className="flex-none h-14 p-3 border-t border-border bg-surface flex items-center justify-between">
        <span className="text-xs text-muted pl-2">
          Showing {cases.length} of {totalCount} records
        </span>
        
        {cases.length < totalCount && (
          <button
            onClick={handleLoadMore}
            disabled={loadingMore}
            className="px-4 py-1.5 rounded-lg bg-surface border border-border hover:bg-[var(--accent-dim)] text-xs font-bold text-foreground transition-colors flex items-center gap-2"
          >
            {loadingMore ? (
              <>
                <div className="w-3 h-3 border-2 border-muted border-t-foreground rounded-full animate-spin" />
                Loading...
              </>
            ) : "Load More"}
          </button>
        )}
      </div>
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/BillingStats.tsx
// portal/components/BillingStats.tsx
"use client";

import { formatCurrency } from "@/lib/pricing";

type Props = {
  totalCost: number;
  caseCount: number;
  totalUnits: number;
};

export default function BillingStats({ totalCost, caseCount, totalUnits }: Props) {
  return (
    <div className="flex-none grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div className="rounded-2xl border border-border bg-surface p-6 shadow-sm">
        <div className="text-sm text-muted mb-1">Total Cost (Filtered)</div>
        <div className="text-4xl font-light text-accent">
          {formatCurrency(totalCost)}
        </div>
      </div>
      <div className="rounded-2xl border border-border bg-surface p-6 shadow-sm">
        <div className="text-sm text-muted mb-1">Cases Processed</div>
        <div className="text-4xl font-light text-foreground">{caseCount}</div>
      </div>
      <div className="rounded-2xl border border-border bg-surface p-6 shadow-sm">
        <div className="text-sm text-muted mb-1">Total Units</div>
        <div className="text-4xl font-light text-blue-500">{totalUnits}</div>
      </div>
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/AdminTabs.tsx
// portal/components/AdminTabs.tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";

export function AdminTabs() {
  const pathname = usePathname();
  
  const Tab = ({ href, label }: { href: string; label: string }) => {
    const active = pathname.startsWith(href);
    return (
      <Link
        href={href}
        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
          active ? "bg-accent text-white" : "text-muted hover:bg-[var(--accent-dim)] hover:text-foreground"
        }`}
      >
        {label}
      </Link>
    );
  };

  return (
    <div className="flex items-center gap-2">
      <Tab href="/portal/admin/users" label="Users" />
      <Tab href="/portal/admin/clinics" label="Clinics" />
      <Tab href="/portal/admin/addresses" label="Addresses" />
      <Tab href="/portal/admin/requests" label="Requests" />
      <Tab href="/portal/admin/financials" label="Financials" />
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/ImageAnnotator.tsx
// portal/components/ImageAnnotator.tsx
"use client";

import { useEffect, useRef, useState } from "react";

interface ImageAnnotatorProps {
  file: File;
  onSave: (annotatedFile: File) => void;
  onCancel: () => void;
}

export default function ImageAnnotator({ file, onSave, onCancel }: ImageAnnotatorProps) {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [imageLoaded, setImageLoaded] = useState(false);

  // Load image onto canvas
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = () => {
      // Fit canvas to image aspect ratio within a max container
      const maxWidth = Math.min(800, window.innerWidth - 64);
      const scale = maxWidth / img.width;
      
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      
      // Draw initial image
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      setImageLoaded(true);
    };
  }, [file]);

  const startDrawing = (e: React.MouseEvent | React.TouchEvent) => {
    setIsDrawing(true);
    draw(e);
  };

  const stopDrawing = () => {
    setIsDrawing(false);
    const canvas = canvasRef.current;
    if (canvas) {
      const ctx = canvas.getContext("2d");
      ctx?.beginPath(); // Reset path so lines don't connect
    }
  };

  const draw = (e: React.MouseEvent | React.TouchEvent) => {
    if (!isDrawing) return;
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    // Calculate coordinates
    const rect = canvas.getBoundingClientRect();
    let clientX, clientY;

    if ('touches' in e) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = (e as React.MouseEvent).clientX;
      clientY = (e as React.MouseEvent).clientY;
    }

    const x = clientX - rect.left;
    const y = clientY - rect.top;

    ctx.lineWidth = 4;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#ef4444"; // Tailwind red-500

    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  };

  const handleSave = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    canvas.toBlob((blob) => {
      if (blob) {
        const newFile = new File([blob], `annotated-${file.name}`, { type: "image/png" });
        onSave(newFile);
      }
    }, "image/png");
  };

  return (
    <div className="fixed inset-0 z-50 bg-background/95 flex flex-col items-center justify-center p-4">
      {/* Toolbar */}
      <div className="w-full max-w-4xl flex justify-between items-center mb-4 text-foreground">
        <h3 className="text-lg font-medium">Draw on Image</h3>
        <div className="flex gap-3">
          <button 
            onClick={onCancel}
            className="px-4 py-2 rounded-lg hover:bg-[var(--accent-dim)] transition"
          >
            Cancel
          </button>
          <button 
            onClick={handleSave}
            disabled={!imageLoaded}
            className="px-6 py-2 bg-accent hover:bg-accent/80 rounded-lg font-bold text-white transition"
          >
            Save Annotation
          </button>
        </div>
      </div>

      {/* Canvas Container */}
      <div 
        ref={containerRef}
        className="relative bg-surface rounded-lg overflow-hidden shadow-2xl border border-border"
      >
        <canvas
          ref={canvasRef}
          onMouseDown={startDrawing}
          onMouseUp={stopDrawing}
          onMouseOut={stopDrawing}
          onMouseMove={draw}
          onTouchStart={startDrawing}
          onTouchEnd={stopDrawing}
          onTouchMove={draw}
          className="cursor-crosshair block"
        />
        {!imageLoaded && (
          <div className="absolute inset-0 flex items-center justify-center text-muted">
            Loading image...
          </div>
        )}
      </div>
      
      <p className="mt-4 text-muted text-sm">
        Click and drag to draw. Ideal for marking margins or contacts.
      </p>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/BillingToolbar.tsx
// portal/components/BillingToolbar.tsx
"use client";

import { useRouter, useSearchParams } from "next/navigation";
import { useState, useEffect } from "react";
import Link from "next/link";

const MONTHS = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];

type Props = {
  selYear: number;
  selMonth: number;
  qFilter: string;
  doctorFilter: string;
  clinicFilter: string;
  isAdminOrLab: boolean;
  isFiltered: boolean;
};

export default function BillingToolbar({
  selYear,
  selMonth,
  qFilter,
  doctorFilter,
  clinicFilter,
  isAdminOrLab,
  isFiltered,
}: Props) {
  const router = useRouter();
  const searchParams = useSearchParams();

  // Local state for debouncing
  const [filters, setFilters] = useState({
    year: selYear,
    month: selMonth,
    q: qFilter,
    doctor: doctorFilter,
    clinic: clinicFilter,
  });

  // Sync state if parent props change (e.g. via Reset link)
  useEffect(() => {
    setFilters({
      year: selYear,
      month: selMonth,
      q: qFilter,
      doctor: doctorFilter,
      clinic: clinicFilter,
    });
  }, [selYear, selMonth, qFilter, doctorFilter, clinicFilter]);

  // Debounced URL Update
  useEffect(() => {
    const timer = setTimeout(() => {
      const params = new URLSearchParams();
      
      params.set("year", String(filters.year));
      params.set("month", String(filters.month));
      
      if (filters.q) params.set("q", filters.q);
      if (filters.doctor) params.set("doctor", filters.doctor);
      if (filters.clinic) params.set("clinic", filters.clinic);

      router.replace(`?${params.toString()}`, { scroll: false });
    }, 400);

    return () => clearTimeout(timer);
  }, [filters, router]);

  // Handle Immediate Changes (Selects)
  const updateInstant = (key: string, val: string | number) => {
    setFilters(prev => ({ ...prev, [key]: val }));
  };

  // Logic: Start at 2024, end at Current Year
  const currentYear = new Date().getFullYear();
  const startYear = 2024;
  const years = Array.from(
    { length: currentYear - startYear + 1 },
    (_, i) => startYear + i
  );

  return (
    <div className="flex-none space-y-4 mb-6">
      <header>
        <h1 className="text-2xl font-semibold text-foreground">Billing & Invoices</h1>
        <p className="text-muted text-sm mt-1">
          Manage costs, view history, and track monthly usage.
        </p>
      </header>

      <div className="flex flex-wrap gap-2 items-center bg-surface p-2 rounded-xl border border-border">
        {/* Year Select */}
        <select
          value={filters.year}
          onChange={(e) => updateInstant("year", Number(e.target.value))}
          className="bg-surface-highlight border border-border rounded-lg px-3 py-1.5 text-sm text-foreground focus:border-accent/50 outline-none transition appearance-none cursor-pointer hover:bg-[var(--accent-dim)]"
        >
          {years.map((y) => (
            <option key={y} value={y} className="bg-surface">
              {y}
            </option>
          ))}
        </select>

        {/* Month Select */}
        <select
          value={filters.month}
          onChange={(e) => updateInstant("month", Number(e.target.value))}
          className="bg-surface-highlight border border-border rounded-lg px-3 py-1.5 text-sm text-foreground focus:border-accent/50 outline-none transition appearance-none cursor-pointer hover:bg-[var(--accent-dim)]"
        >
          {MONTHS.map((m, i) => (
            <option key={m} value={i + 1} className="bg-surface">
              {m}
            </option>
          ))}
        </select>

        {/* Search */}
        <input
          value={filters.q}
          onChange={(e) => updateInstant("q", e.target.value)}
          placeholder="Search Patient or Case ID..."
          className="bg-surface-highlight border border-border rounded-lg px-3 py-1.5 text-sm text-foreground placeholder-muted focus:border-accent/50 outline-none w-48 transition"
        />

        {/* Admin Filters */}
        {isAdminOrLab && (
          <>
            <input
              value={filters.doctor}
              onChange={(e) => updateInstant("doctor", e.target.value)}
              placeholder="Filter by Doctor..."
              className="bg-surface-highlight border border-border rounded-lg px-3 py-1.5 text-sm text-foreground placeholder-muted focus:border-accent/50 outline-none w-40 transition"
            />
            <input
              value={filters.clinic}
              onChange={(e) => updateInstant("clinic", e.target.value)}
              placeholder="Filter by Clinic..."
              className="bg-surface-highlight border border-border rounded-lg px-3 py-1.5 text-sm text-foreground placeholder-muted focus:border-accent/50 outline-none w-40 transition"
            />
          </>
        )}

        {isFiltered && (
          <Link
            href="/portal/billing"
            className="px-3 py-1.5 text-sm text-muted hover:text-foreground hover:bg-[var(--accent-dim)] rounded-lg transition"
          >
            Reset
          </Link>
        )}
      </div>
    </div>
  );
}

--- END OF FILE ---

FILE: ./sentry.edge.config.ts
// This file configures the initialization of Sentry for edge features (middleware, edge routes, and so on).
// The config you add here will be used whenever one of the edge features is loaded.
// Note that this config is unrelated to the Vercel Edge Runtime and is also required when running locally.
// https://docs.sentry.io/platforms/javascript/guides/nextjs/

import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: "https://2f3ab16a8319fa13da4170d7cde35177@o4510789473665024.ingest.us.sentry.io/4510791337377792",

  // Define how likely traces are sampled. Adjust this value in production, or use tracesSampler for greater control.
  tracesSampleRate: 1,

  // Enable logs to be sent to Sentry
  enableLogs: true,

  // Enable sending user PII (Personally Identifiable Information)
  // https://docs.sentry.io/platforms/javascript/guides/nextjs/configuration/options/#sendDefaultPii
  sendDefaultPii: true,
});

--- END OF FILE ---

FILE: ./package.json
{
  "name": "portal",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "npx prisma generate && next build --turbopack",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@aws-sdk/client-s3": "^3.975.0",
    "@aws-sdk/s3-request-presigner": "^3.975.0",
    "@prisma/client": "5.22.0",
    "@sentry/nextjs": "^10.37.0",
    "archiver": "^7.0.1",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "lucide-react": "^0.563.0",
    "next": "^15.1.0",
    "next-themes": "^0.4.6",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "resend": "^6.6.0",
    "three": "^0.171.0",
    "zod": "^4.3.5"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@tailwindcss/postcss": "^4",
    "@types/archiver": "^7.0.0",
    "@types/bcryptjs": "^2.4.6",
    "@types/estree": "^1.0.8",
    "@types/json-schema": "^7.0.15",
    "@types/jsonwebtoken": "^9.0.10",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@types/stats.js": "^0.17.4",
    "@types/three": "^0.180.0",
    "@types/webxr": "^0.5.24",
    "eslint": "^9",
    "eslint-config-next": "15.5.4",
    "prisma": "5.22.0",
    "tailwindcss": "^4",
    "ts-node": "^10.9.2",
    "typescript": "^5"
  },
  "prisma": {
    "seed": "node prisma/seed.mjs"
  },
  "engines": {
    "node": "22.x",
    "npm": ">=10"
  }
}

--- END OF FILE ---

FILE: ./instrumentation-client.ts
// This file configures the initialization of Sentry on the client.
// The added config here will be used whenever a users loads a page in their browser.
// https://docs.sentry.io/platforms/javascript/guides/nextjs/

import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: "https://2f3ab16a8319fa13da4170d7cde35177@o4510789473665024.ingest.us.sentry.io/4510791337377792",

  // Add optional integrations for additional features
  integrations: [Sentry.replayIntegration()],

  // Define how likely traces are sampled. Adjust this value in production, or use tracesSampler for greater control.
  tracesSampleRate: 1,
  // Enable logs to be sent to Sentry
  enableLogs: true,

  // Define how likely Replay events are sampled.
  // This sets the sample rate to be 10%. You may want this to be 100% while
  // in development and sample at a lower rate in production
  replaysSessionSampleRate: 0.1,

  // Define how likely Replay events are sampled when an error occurs.
  replaysOnErrorSampleRate: 1.0,

  // Enable sending user PII (Personally Identifiable Information)
  // https://docs.sentry.io/platforms/javascript/guides/nextjs/configuration/options/#sendDefaultPii
  sendDefaultPii: true,
});

export const onRouterTransitionStart = Sentry.captureRouterTransitionStart;

--- END OF FILE ---

FILE: ./lib/prisma.ts
// portal/lib/prisma.ts
import { PrismaClient } from "@prisma/client";

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

// Function to add connection parameters for resilience
const getUrl = () => {
  let url = process.env.DATABASE_URL;
  if (!url) return undefined;
  
  const hasParams = url.includes("?");
  const separator = hasParams ? "&" : "?";

  // 1. Connection Limit: Serverless environments need lower limits per instance
  if (!url.includes("connection_limit")) {
    url += `${separator}connection_limit=10`;
  }
  
  // 2. ✅ CRITICAL FIX: Increase Pool Timeout
  // Default is 10s. Neon cold starts can take 3-10s. 
  // We set it to 60s to ensure we wait for the wake-up without crashing.
  if (!url.includes("pool_timeout")) {
    url += `&pool_timeout=60`;
  }

  // 3. Connect Timeout (Socket timeout)
  if (!url.includes("connect_timeout")) {
    url += `&connect_timeout=60`;
  }
  
  return url;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    datasourceUrl: getUrl(),
    log: process.env.NODE_ENV === "development" ? ["error", "warn"] : ["error"],
  });

if (process.env.NODE_ENV !== "production") {
  globalForPrisma.prisma = prisma;
}
--- END OF FILE ---

FILE: ./lib/financial_config.ts
// portal/lib/financial_config.ts

export const PRODUCT_KEYS = {
  ZIRCONIA_HT: "ZIRCONIA_HT",
  ZIRCONIA_ML: "ZIRCONIA_ML",
  EMAX: "EMAX",
  NIGHTGUARD_HARD: "NIGHTGUARD_HARD",
  NIGHTGUARD_SOFT: "NIGHTGUARD_SOFT",
} as const;

export type ProductKey = keyof typeof PRODUCT_KEYS;

export const SALES_COMMISSION_PER_UNIT = 1.00;

// 1. REVENUE: What we charge Clinics (Per Unit)
export const CLIENT_PRICING = {
  IN_HOUSE: {
    [PRODUCT_KEYS.ZIRCONIA_HT]: 55.00,
    [PRODUCT_KEYS.ZIRCONIA_ML]: 65.00,
    [PRODUCT_KEYS.EMAX]: 115.00,
    [PRODUCT_KEYS.NIGHTGUARD_HARD]: 55.00,
    [PRODUCT_KEYS.NIGHTGUARD_SOFT]: 55.00,
  },
  STANDARD: {
    [PRODUCT_KEYS.ZIRCONIA_HT]: 65.00,
    [PRODUCT_KEYS.ZIRCONIA_ML]: 75.00,
    [PRODUCT_KEYS.EMAX]: 125.00,
    [PRODUCT_KEYS.NIGHTGUARD_HARD]: 65.00,
    [PRODUCT_KEYS.NIGHTGUARD_SOFT]: 65.00,
  },
};

// 2. COSTS: What we pay Vendors (Per Unit)
export const VENDOR_COSTS = {
  HAUS_MILLING: {
    [PRODUCT_KEYS.ZIRCONIA_HT]: 30.00,
    [PRODUCT_KEYS.ZIRCONIA_ML]: 37.00,
    [PRODUCT_KEYS.EMAX]: 85.00,
    [PRODUCT_KEYS.NIGHTGUARD_HARD]: 35.00,
    [PRODUCT_KEYS.NIGHTGUARD_SOFT]: 35.00,
  },
  DESIGN_FEE: {
    // $5 per unit for crowns, $0 (pending agreement) for nightguards
    [PRODUCT_KEYS.ZIRCONIA_HT]: 5.00,
    [PRODUCT_KEYS.ZIRCONIA_ML]: 5.00,
    [PRODUCT_KEYS.EMAX]: 5.00,
    [PRODUCT_KEYS.NIGHTGUARD_HARD]: 0.00,
    [PRODUCT_KEYS.NIGHTGUARD_SOFT]: 0.00,
  },
};

// Helper to map your Database string to these Keys
export function resolveProductKey(product: string, material: string | null): ProductKey {
  const p = (product || "").toUpperCase();
  const m = (material || "").toUpperCase();

  if (p === "ZIRCONIA") {
    return m === "ML" ? "ZIRCONIA_ML" : "ZIRCONIA_HT";
  }
  if (p === "EMAX") return "EMAX";
  if (p === "NIGHTGUARD") {
    return m === "SOFT" ? "NIGHTGUARD_SOFT" : "NIGHTGUARD_HARD";
  }
  if (p === "INLAY_ONLAY") return "EMAX"; // Usually priced same as Emax
  
  // Fallback
  return "ZIRCONIA_HT";
}
--- END OF FILE ---

FILE: ./lib/cost-engine.ts
// portal/lib/cost-engine.ts
import { VENDOR_COSTS, SALES_COMMISSION_PER_UNIT, resolveProductKey } from "./financial_config";

export function calculateProductionCosts(
  product: string,
  material: string | null,
  units: number,
  hasSalesRep: boolean // ✅ This was missing
) {
  const key = resolveProductKey(product, material);
  
  // Cost Calculations
  const unitMillingCost = VENDOR_COSTS.HAUS_MILLING[key] || 0;
  const unitDesignCost = VENDOR_COSTS.DESIGN_FEE[key] || 0;
  
  // ✅ Commission Logic
  const unitCommission = hasSalesRep ? SALES_COMMISSION_PER_UNIT : 0;

  return {
    milling: unitMillingCost * units,
    design: unitDesignCost * units,
    commission: unitCommission * units, // ✅ Return this property
    total: (unitMillingCost + unitDesignCost + unitCommission) * units
  };
}
--- END OF FILE ---

FILE: ./lib/pricing.ts
// portal/lib/pricing.ts
import { CLIENT_PRICING, resolveProductKey } from "./financial_config";

// Re-export constants for UI components
export const PriceTier = {
  STANDARD: "STANDARD",
  IN_HOUSE: "IN_HOUSE",
} as const;

export const ProductKind = {
  ZIRCONIA: "ZIRCONIA",
  MULTILAYER_ZIRCONIA: "MULTILAYER_ZIRCONIA",
  EMAX: "EMAX",
  INLAY_ONLAY: "INLAY_ONLAY",
  NIGHTGUARD: "NIGHTGUARD",
} as const;

export const BillingType = {
  BILLABLE: "BILLABLE",
  WARRANTY: "WARRANTY",
} as const;

export function countUnits(toothCodes: string | null): number {
  if (!toothCodes) return 0;
  const units = toothCodes.split(",").map(s => s.trim()).filter(s => s !== "");
  return units.length;
}

export function calculateCaseCost(
  tier: string,       
  product: string,    
  units: number,
  billingType: string,
  material: string | null = null // Added material
): number {
  if (billingType === BillingType.WARRANTY) {
    return 0.00;
  }

  // Use the shared config
  const key = resolveProductKey(product, material);
  const safeTier = tier === "IN_HOUSE" ? "IN_HOUSE" : "STANDARD";
  
  const unitPrice = CLIENT_PRICING[safeTier][key] || 0;

  return unitPrice * units;
}

export function formatCurrency(amount: number | string) {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
  }).format(Number(amount));
}
--- END OF FILE ---

FILE: ./lib/storage.ts
// portal/lib/storage.ts
import { S3Client, PutObjectCommand, GetObjectCommand, DeleteObjectCommand } from "@aws-sdk/client-s3";
import { getSignedUrl } from "@aws-sdk/s3-request-presigner";

// --- CONFIGURATION ---
// You will need to add these to your .env file later
const R2_ACCOUNT_ID = process.env.R2_ACCOUNT_ID;
const ACCESS_KEY_ID = process.env.AWS_ACCESS_KEY_ID;
const SECRET_ACCESS_KEY = process.env.AWS_SECRET_ACCESS_KEY;
const BUCKET_NAME = process.env.AWS_BUCKET_NAME;

// Check for missing config in production
if (!ACCESS_KEY_ID || !SECRET_ACCESS_KEY || !BUCKET_NAME) {
  // We don't throw error in dev so the app doesn't crash if you're just testing UI
  if (process.env.NODE_ENV === "production") {
    throw new Error("Fatal: Missing S3 Storage Configuration");
  }
}

// Initialize S3 Client (Works for AWS S3, Cloudflare R2, DigitalOcean Spaces, etc.)
// Currently configured for Cloudflare R2 (Recommended for zero egress fees)
// If using AWS, remove the "endpoint" line and "region" logic might differ.
const s3 = new S3Client({
  region: "auto",
  endpoint: `https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com`, // Replace with AWS endpoint if using AWS
  credentials: {
    accessKeyId: ACCESS_KEY_ID || "",
    secretAccessKey: SECRET_ACCESS_KEY || "",
  },
});

/**
 * Uploads a file buffer to S3
 */
export async function uploadFile(
  buffer: Buffer, 
  key: string, 
  contentType: string
): Promise<string> {
  const command = new PutObjectCommand({
    Bucket: BUCKET_NAME,
    Key: key,
    Body: buffer,
    ContentType: contentType,
  });

  await s3.send(command);

  // Return the key (path) to store in the DB
  return key;
}

/**
 * Generates a temporary signed URL for viewing private files (Secure)
 * Valid for 1 hour.
 */
export async function getSignedFileUrl(key: string): Promise<string> {
  const command = new GetObjectCommand({
    Bucket: BUCKET_NAME,
    Key: key,
  });
  
  // URL expires in 3600 seconds (1 hour)
  return await getSignedUrl(s3, command, { expiresIn: 3600 });
}

/**
 * Deletes a file from S3
 */
export async function deleteFile(key: string) {
  const command = new DeleteObjectCommand({
    Bucket: BUCKET_NAME,
    Key: key,
  });
  await s3.send(command);
}

/**
 * Helper to get a raw stream (Useful for batch zipping)
 */
export async function getFileStream(key: string) {
  const command = new GetObjectCommand({
    Bucket: BUCKET_NAME,
    Key: key,
  });
  const response = await s3.send(command);
  return response.Body;
}

/**
 * Generates a signed URL for UPLOADING directly from the browser.
 * Valid for 10 minutes.
 */
export async function getPresignedUploadUrl(
  key: string, 
  contentType: string
): Promise<string> {
  const command = new PutObjectCommand({
    Bucket: BUCKET_NAME,
    Key: key,
    ContentType: contentType,
  });
  // URL expires in 600 seconds (10 minutes)
  return await getSignedUrl(s3, command, { expiresIn: 600 });
}
--- END OF FILE ---

FILE: ./lib/schemas.ts
// portal/lib/schemas.ts
import { z } from "zod";
import { ProductKind, BillingType } from "@/lib/pricing";

// --- EXISTING CASE SCHEMAS (Keep these) ---
const ProductEnum = z.nativeEnum(ProductKind);
const BillingEnum = z.nativeEnum(BillingType);

const FileSchema = z.custom<File>((v) => v instanceof File, {
  message: "Must be a valid file upload",
});

export const CreateCaseSchema = z.object({
  patientAlias: z.string().min(1, "Patient Alias is required"),
  doctorUserId: z.string().min(1, "Doctor ID is required"),
  toothCodes: z.string().min(1, "Tooth Codes are required"),
  orderDate: z.string().refine((val) => !isNaN(Date.parse(val)), {
    message: "Invalid Order Date",
  }).transform((val) => new Date(val)),
  product: ProductEnum.default(ProductKind.ZIRCONIA),
  billingType: BillingEnum.default(BillingType.BILLABLE),
  shade: z.string().optional(),
  material: z.string().optional(),
  designPreferences: z.string().optional(),
  scanHtml: FileSchema.refine((f) => f.size > 0, "Scan HTML file is empty"),
  rxPdf: FileSchema.refine((f) => f.size > 0, "Rx PDF file is empty"),
  constructionInfo: FileSchema.optional().nullable(),
  modelTop: FileSchema.optional().nullable(),
  modelBottom: FileSchema.optional().nullable(),
});

export type CreateCaseInput = z.infer<typeof CreateCaseSchema>;

// --- ✅ NEW: USER SCHEMA ---
export const CreateUserSchema = z.object({
  email: z.string().email("Invalid email address"),
  name: z.string().min(1, "Name is required"),
  role: z.enum(["customer", "lab", "admin", "milling"]).default("customer"),
  phoneNumber: z.string().optional(),
  
  // Logic: Either clinicId OR newClinicName must be present for doctors
  clinicId: z.string().optional(),
  newClinicName: z.string().optional(),
  
  preferenceNote: z.string().optional(),
  
  address: z.object({
    id: z.string().optional().nullable(),
    street: z.string().optional(),
    city: z.string().optional(),
    state: z.string().optional(),
    zipCode: z.string().optional(),
  }).optional(),
}).refine(data => {
  if (data.role === 'customer') {
    return !!data.clinicId || !!data.newClinicName;
  }
  return true;
}, {
  message: "Doctors must be assigned to an existing Clinic or a New Clinic.",
  path: ["clinicId"], // Error will appear on this field
});

export type CreateUserInput = z.infer<typeof CreateUserSchema>;
--- END OF FILE ---

FILE: ./lib/types.ts
// FILE: lib/types.ts

export type Role = "customer" | "lab" | "admin" | "milling" | "sales";

export type CaseStatus = 
  | "IN_DESIGN" 
  | "READY_FOR_REVIEW" 
  | "CHANGES_REQUESTED" 
  | "APPROVED" 
  | "IN_MILLING" 
  | "SHIPPED" 
  | "COMPLETED" 
  | "DELIVERED";

export type ProductionStage = "DESIGN" | "MILLING_GLAZING" | "SHIPPING" | "COMPLETED" | "DELIVERED";

// ✅ NEW: Shared Shipping Address Type
export interface ShippingTarget {
  name: string;
  attn: string | null;
  phone: string | null;
  street: string | null;
  city: string | null;
  state: string | null;
  zip: string | null;
}
--- END OF FILE ---

FILE: ./lib/auth.ts
// portal/lib/auth.ts
import { cookies } from "next/headers";
import jwt from "jsonwebtoken";

export type Session = {
  userId: string;
  role: "customer" | "lab" | "admin" | "milling";
  clinicId?: string;
  iat?: number;
  exp?: number;
};

const COOKIE_NAME = "lumera_session";

// 1. SECURE SECRET HANDLING
// In production, fail hard if the secret is missing to prevent insecure deployments.
const SECRET = process.env.JWT_SECRET;
if (process.env.NODE_ENV === "production" && !SECRET) {
  throw new Error("FATAL: JWT_SECRET is not defined.");
}
const FINAL_SECRET = SECRET || "dev-secret";

// 2. CENTRALIZED COOKIE CONFIG
export const COOKIE_OPTIONS = {
  name: COOKIE_NAME,
  duration: "24h", // Reduced from 7d to 24h for security
  options: {
    httpOnly: true,
    sameSite: "lax" as const,
    secure: process.env.NODE_ENV === "production", // ✅ Auto-enable HTTPS in prod
    path: "/",
    maxAge: 60 * 60 * 24, // 1 Day (seconds)
  },
};

export async function getSession(): Promise<Session | null> {
  const jar = await cookies();
  const token = jar.get(COOKIE_NAME)?.value;
  if (!token) return null;

  try {
    return jwt.verify(token, FINAL_SECRET) as Session;
  } catch {
    return null;
  }
}

// Helper to sign tokens consistently
export function signToken(payload: object) {
  return jwt.sign(payload, FINAL_SECRET, { 
    // ✅ FIX: Cast to 'any' to resolve the "Type 'string' is not assignable" error.
    // The library expects a specific 'StringValue' type, but 'string' works fine at runtime.
    expiresIn: COOKIE_OPTIONS.duration as any 
  });
}
--- END OF FILE ---

FILE: ./instrumentation.ts
import * as Sentry from "@sentry/nextjs";

export async function register() {
  if (process.env.NEXT_RUNTIME === "nodejs") {
    await import("./sentry.server.config");
  }

  if (process.env.NEXT_RUNTIME === "edge") {
    await import("./sentry.edge.config");
  }
}

export const onRequestError = Sentry.captureRequestError;

--- END OF FILE ---

FILE: ./next.config.ts
import { withSentryConfig } from '@sentry/nextjs';
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  experimental: {
    // Increase body size limit for middleware buffering (Fixes 10MB limit error)
    middlewareClientMaxBodySize: '500mb', 
    
    // Increase limit for Server Actions (just in case)
    serverActions: {
      bodySizeLimit: '500mb',
    },
  },
};

export default withSentryConfig(nextConfig, {
  // For all available options, see:
  // https://www.npmjs.com/package/@sentry/webpack-plugin#options

  org: "lumera-lab",

  project: "nextjs",

  // Only print logs for uploading source maps in CI
  silent: !process.env.CI,

  // For all available options, see:
  // https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/

  // Upload a larger set of source maps for prettier stack traces (increases build time)
  widenClientFileUpload: true,

  // Route browser requests to Sentry through a Next.js rewrite to circumvent ad-blockers.
  // This can increase your server load as well as your hosting bill.
  // Note: Check that the configured route will not match with your Next.js middleware, otherwise reporting of client-
  // side errors will fail.
  tunnelRoute: "/monitoring",

  webpack: {
    // Enables automatic instrumentation of Vercel Cron Monitors. (Does not yet work with App Router route handlers.)
    // See the following for more information:
    // https://docs.sentry.io/product/crons/
    // https://vercel.com/docs/cron-jobs
    automaticVercelMonitors: true,

    // Tree-shaking options for reducing bundle size
    treeshake: {
      // Automatically tree-shake Sentry logger statements to reduce bundle size
      removeDebugLogging: true,
    },
  },
});

--- END OF FILE ---

