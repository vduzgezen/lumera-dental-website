FILE: ./middleware.ts
// portal/middleware.ts
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

const PROTECTED = /^\/portal(\/|$)/;

export function middleware(req: NextRequest) {
  // Only guard /portal/*
  if (!PROTECTED.test(req.nextUrl.pathname)) return NextResponse.next();

  // Edge runtime: don't verify here, just require the cookie to exist.
  // (Verification happens server-side in your pages via getSession().)
  const has = req.cookies.has("lumera_session");
  if (!has) {
    return NextResponse.redirect(new URL("/login", req.url));
  }
  return NextResponse.next();
}

--- END OF FILE ---

FILE: ./app/contact/page.tsx
// portal/app/contact/page.tsx
import PublicNavbar from "@/components/PublicNavbar";
import PublicFooter from "@/components/PublicFooter";

export default function ContactPage() {
  return (
    <main className="min-h-screen flex flex-col bg-background text-porcelain">
      <PublicNavbar />
      
      <section className="pt-24 pb-12">
        <div className="container mx-auto px-6">
          <h1 className="text-5xl font-semibold mb-6">Contact & Send a Case</h1>
          <p className="text-xl text-white/60 max-w-2xl">
            Flat price. Fast turnaround. Made in USA. We promise delivery in 7 business days.
          </p>
        </div>
      </section>

      <section className="container mx-auto px-6 pb-24 grid lg:grid-cols-2 gap-8">
        {/* Main Contact Card */}
        <div className="p-8 md:p-12 rounded-3xl border border-white/10 bg-white/[0.02]">
          <h2 className="text-2xl font-medium mb-4">Send Scans Via Email</h2>
          <p className="text-white/60 mb-8">
            Attach STL/PLY files, photos, shade, and notes. We’ll reply quickly with design confirmation.
          </p>
          
          <a href="mailto:hello@glo.dental" className="inline-block w-full text-center py-4 rounded-xl bg-white text-background font-bold hover:bg-gray-200 transition mb-8">
            Email hello@glo.dental
          </a>

          <div className="grid grid-cols-2 gap-4">
            <div className="p-4 rounded-xl border border-white/10 bg-black/20">
              <div className="text-xs text-white/40 mb-1">Phone</div>
              <div className="font-medium">+1 (000) 000-0000</div>
            </div>
            <div className="p-4 rounded-xl border border-white/10 bg-black/20">
              <div className="text-xs text-white/40 mb-1">Delivery</div>
              <div className="font-medium">7 business days</div>
            </div>
          </div>
        </div>

        {/* Info Sidebar */}
        <div className="space-y-6">
          <div className="p-8 rounded-3xl border border-white/10 bg-white/[0.02]">
            <h3 className="text-lg font-medium mb-2">Submissions</h3>
            <p className="text-white/60 text-sm">
              <strong className="text-white">Scans only</strong> (no hard impressions). We support common formats (STL/PLY). 
              We ship the finished crown to your office.
            </p>
          </div>
          
          <div className="p-8 rounded-3xl border border-white/10 bg-white/[0.02]">
            <h3 className="text-lg font-medium mb-2">Address</h3>
            <p className="text-white/60 text-sm">
              Lumera Dental Lab<br/>
              [Your Street]<br/>
              [City, State ZIP]<br/>
              <span className="text-accent mt-2 inline-block">Made in USA</span>
            </p>
          </div>
        </div>
      </section>

      <PublicFooter />
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/requests/RequestListClient.tsx
// portal/app/portal/admin/requests/RequestListClient.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

export default function RequestListClient({ requests }: { requests: any[] }) {
  const router = useRouter();
  const [busyId, setBusyId] = useState<string | null>(null);

  async function handleAction(id: string, action: "approve" | "reject") {
    setBusyId(id);
    try {
      const res = await fetch(`/api/admin/requests/${id}/approve`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action })
      });
      if (!res.ok) throw new Error("Failed");
      router.refresh();
    } catch (e: any) {
      alert("Operation failed.");
    } finally {
      setBusyId(null);
    }
  }

  if (requests.length === 0) {
    return (
      <div className="flex-1 rounded-xl border border-white/10 bg-[#111b2d] flex items-center justify-center text-white/40">
        No pending requests.
      </div>
    );
  }

  return (
    // Table Container - Standardised (No Header here because it's in the page.tsx wrapper for this one, 
    // but typically we want the container to be the flex-1 element)
    <div className="flex-1 min-h-0 overflow-hidden rounded-xl border border-white/10 bg-[#111b2d] shadow-2xl flex flex-col">
      <div className="flex-1 overflow-auto custom-scrollbar">
        <table className="w-full text-left text-sm min-w-[800px]">
          <thead className="bg-[#0a1020] text-white/50 sticky top-0 backdrop-blur-md z-10 border-b border-white/5">
            <tr>
              <th className="p-4 font-medium">Name</th>
              <th className="p-4 font-medium">Email</th>
              <th className="p-4 font-medium">Clinic Info</th>
              <th className="p-4 font-medium">Date</th>
              <th className="p-4 font-medium text-right">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-white/5">
            {requests.map((r) => (
              <tr key={r.id} className="hover:bg-white/5 transition-colors">
                <td className="p-4 font-medium text-white">{r.name}</td>
                <td className="p-4 text-white/60">{r.email}</td>
                <td className="p-4 text-white/60">
                  <div className="text-white font-medium">{r.clinicName}</div>
                  <div className="text-xs opacity-70">{r.city}, {r.state}</div>
                </td>
                <td className="p-4 text-white/40">{new Date(r.createdAt).toLocaleDateString()}</td>
                <td className="p-4 text-right">
                  <div className="flex justify-end gap-2">
                    <button 
                      onClick={() => handleAction(r.id, "reject")}
                      disabled={busyId === r.id}
                      className="px-3 py-1.5 rounded bg-red-500/10 text-red-400 hover:bg-red-500/20 disabled:opacity-50"
                    >
                      Reject
                    </button>
                    <button 
                      onClick={() => handleAction(r.id, "approve")}
                      disabled={busyId === r.id}
                      className="px-3 py-1.5 rounded bg-emerald-500 text-black font-bold hover:bg-emerald-400 disabled:opacity-50"
                    >
                      {busyId === r.id ? "..." : "Approve"}
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/requests/page.tsx
// portal/app/portal/admin/requests/page.tsx
import { prisma } from "@/lib/prisma";
import { AdminTabs } from "@/components/AdminTabs";
import RequestListClient from "./RequestListClient";

export const dynamic = "force-dynamic";

export default async function RequestsPage() {
  const where = { status: "PENDING" };
  
  // 1. Count Pending
  const totalPending = await prisma.registrationRequest.count({ where });

  // 2. Fetch Recent Pending
  const requests = await prisma.registrationRequest.findMany({
    where,
    orderBy: { createdAt: "desc" },
    take: 50
  });

  return (
    <div className="flex flex-col h-full space-y-4">
      <div className="flex-none flex items-center gap-4">
        <h1 className="text-xl font-semibold text-white hidden sm:block">Admin</h1>
        <div className="h-6 w-px bg-white/10 hidden sm:block" />
        <AdminTabs />
      </div>
      
      <RequestListClient requests={requests} />

      <div className="flex-none text-center text-xs text-white/30 pt-2 border-t border-white/5">
        {totalPending > requests.length 
            ? `Showing recent ${requests.length} of ${totalPending} pending requests.` 
            : `Showing all ${requests.length} pending requests.`}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/clinics/ClinicListClient.tsx
// portal/app/portal/admin/clinics/ClinicListClient.tsx
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";
import ClinicForm from "@/components/ClinicForm";
import { AdminTabs } from "@/components/AdminTabs";

// eslint-disable-next-line @typescript-eslint/no-explicit-any
export default function ClinicListClient({ clinics }: { clinics: any[] }) {
  const router = useRouter();
  const [editingClinic, setEditingClinic] = useState<any | null>(null);
  const [isCreating, setIsCreating] = useState(false);

  async function handleDelete(id: string) {
    if (!confirm("Delete this clinic? Warning: This will fail if users are linked.")) return;
    const res = await fetch(`/api/clinics/${id}`, { method: "DELETE" });
    if (res.ok) router.refresh();
    else alert("Failed to delete");
  }

  return (
    <div className="flex flex-col h-full space-y-4">
      {/* Header */}
      <div className="flex-none flex items-center justify-between">
         <div className="flex items-center gap-4">
            <h1 className="text-xl font-semibold text-white hidden sm:block">Admin</h1>
            <div className="h-6 w-px bg-white/10 hidden sm:block" />
            <AdminTabs />
         </div>
        
        <button 
          onClick={() => setIsCreating(true)} 
          className="px-4 py-2 bg-white text-black text-sm font-bold rounded-lg hover:bg-gray-200 transition shadow-lg shadow-white/5"
        >
          + Add Clinic
        </button>
      </div>

      {/* Table Container - Standardised */}
      <div className="flex-1 min-h-0 overflow-hidden rounded-xl border border-white/10 bg-[#111b2d] shadow-2xl flex flex-col">
        <div className="flex-1 overflow-auto custom-scrollbar">
          <table className="w-full text-left text-sm min-w-[600px]">
            <thead className="bg-[#0a1020] text-white/50 sticky top-0 backdrop-blur-md z-10 border-b border-white/5">
              <tr>
                <th className="p-4 font-medium">Clinic Name</th>
                <th className="p-4 font-medium">City/State</th>
                <th className="p-4 font-medium">Users</th>
                <th className="p-4 font-medium">Cases</th>
                <th className="p-4 font-medium text-right">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {clinics.map((c) => (
                <tr key={c.id} className="hover:bg-white/5 transition-colors group">
                  <td className="p-4 font-medium text-white">{c.name}</td>
                  <td className="p-4 text-white/60">
                    {c.address ? `${c.address.city || ''} ${c.address.state || ''}` : "—"}
                  </td>
                  <td className="p-4 text-white/60">{c._count.users}</td>
                  <td className="p-4 text-white/60">{c._count.cases}</td>
                  <td className="p-4 text-right">
                    <div className="flex justify-end gap-3 opacity-60 group-hover:opacity-100 transition-opacity">
                      <button onClick={() => setEditingClinic(c)} className="text-accent hover:text-white transition-colors">Edit</button>
                      <button onClick={() => handleDelete(c.id)} className="text-red-400 hover:text-red-300 transition-colors">Delete</button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {(isCreating || editingClinic) && (
        <ClinicForm 
          initialData={editingClinic}
          onClose={() => { setEditingClinic(null); setIsCreating(false); }}
        />
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/clinics/page.tsx
// portal/app/portal/admin/clinics/page.tsx
import { prisma } from "@/lib/prisma";
import ClinicListClient from "./ClinicListClient";

export const dynamic = "force-dynamic";

export default async function ClinicsPage() {
  const totalClinics = await prisma.clinic.count();

  const clinics = await prisma.clinic.findMany({ 
    orderBy: { name: "asc" },
    take: 50, // ✅ LIMIT
    include: { 
      address: true,
      _count: { 
        select: { users: true, cases: true } 
      } 
    }
  });

  return (
    <div className="flex flex-col h-full space-y-4">
      <ClinicListClient clinics={clinics} />

      <div className="flex-none text-center text-xs text-white/30 pt-2 border-t border-white/5">
        {totalClinics > clinics.length 
            ? `Showing first ${clinics.length} of ${totalClinics} clinics.` 
            : `Showing all ${clinics.length} clinics.`}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/addresses/AddressListClient.tsx
// portal/app/portal/admin/addresses/AddressListClient.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { AdminTabs } from "@/components/AdminTabs";

export default function AddressListClient({ addresses }: { addresses: any[] }) {
  const router = useRouter();
  const [busyId, setBusyId] = useState<string | null>(null);
  
  async function deleteAddr(id: string, usageCount: number) {
    const confirmMsg = usageCount > 0 
      ? `This address is linked to ${usageCount} users/clinics. Delete anyway?`
      : "Delete this address?";
    if (!confirm(confirmMsg)) return;

    setBusyId(id);
    try {
        const res = await fetch(`/api/addresses/${id}`, { method: "DELETE" });
        if (res.ok) router.refresh();
        else alert("Failed to delete");
    } catch (e: any) {
        alert("Network error: " + e.message);
    } finally {
        setBusyId(null);
    }
  }

  return (
    <div className="flex flex-col h-full space-y-4">
      {/* Header */}
      <div className="flex-none flex items-center gap-4">
        <h1 className="text-xl font-semibold text-white hidden sm:block">Admin</h1>
        <div className="h-6 w-px bg-white/10 hidden sm:block" />
        <AdminTabs />
      </div>

      {/* Table Container - Standardised */}
      <div className="flex-1 min-h-0 overflow-hidden rounded-xl border border-white/10 bg-[#111b2d] shadow-2xl flex flex-col">
        <div className="flex-1 overflow-auto custom-scrollbar">
          <table className="w-full text-left text-sm min-w-[600px]">
            <thead className="bg-[#0a1020] text-white/50 sticky top-0 backdrop-blur-md z-10 border-b border-white/5">
              <tr>
                <th className="p-4 font-medium">Street</th>
                <th className="p-4 font-medium">City/State</th>
                <th className="p-4 font-medium">Linked To</th>
                <th className="p-4 font-medium text-right">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {addresses.map((a) => {
                const usage = a._count.users + a._count.clinics;
                const isBusy = busyId === a.id;
                
                return (
                  <tr key={a.id} className="hover:bg-white/5 transition-colors group">
                    <td className="p-4 font-medium text-white">{a.street || "—"}</td>
                    <td className="p-4 text-white/60">{a.city}, {a.state} {a.zipCode}</td>
                    <td className="p-4 text-white/60">
                      {usage > 0 ? (
                          <span className="px-2 py-0.5 rounded bg-blue-500/20 text-blue-300 text-xs border border-blue-500/30">
                              {usage} Links
                          </span>
                      ) : (
                          <span className="text-white/20 italic">Unused</span>
                      )}
                    </td>
                    <td className="p-4 text-right">
                      <button 
                          onClick={() => deleteAddr(a.id, usage)} 
                          disabled={isBusy}
                          className="text-red-400 hover:text-red-300 transition-colors opacity-60 hover:opacity-100 disabled:opacity-30"
                      >
                          {isBusy ? "..." : "Delete"}
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/addresses/page.tsx
// portal/app/portal/admin/addresses/page.tsx
import { prisma } from "@/lib/prisma";
import AddressListClient from "./AddressListClient";

export const dynamic = "force-dynamic";

export default async function AddressesPage() {
  const total = await prisma.address.count();

  const addresses = await prisma.address.findMany({
    orderBy: { createdAt: "desc" },
    take: 50, // ✅ LIMIT
    include: {
      _count: {
        select: { users: true, clinics: true }
      }
    }
  });

  return (
    <div className="flex flex-col h-full space-y-4">
      <AddressListClient addresses={addresses} />

      <div className="flex-none text-center text-xs text-white/30 pt-2 border-t border-white/5">
        {total > addresses.length 
            ? `Showing recent ${addresses.length} of ${total} addresses.` 
            : `Showing all ${addresses.length} addresses.`}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/layout.tsx
// portal/app/portal/admin/layout.tsx
import { getSession } from "@/lib/auth";
import { redirect } from "next/navigation";

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await getSession();
  if (!session || session.role !== "admin") redirect("/portal/cases");

  return (
    <div className="h-screen flex flex-col p-6 overflow-hidden">
      {/* HEADER REMOVED: Tabs and Title are now merged into the client pages for better alignment */}
      <div className="flex-1 min-h-0 flex flex-col">
        {children}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/users/UserListClient.tsx
// portal/app/portal/admin/users/UserListClient.tsx
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";
import UserForm from "@/components/UserForm";
import { AdminTabs } from "@/components/AdminTabs";

// eslint-disable-next-line @typescript-eslint/no-explicit-any
export default function UserListClient({ users, clinics }: { users: any[], clinics: any[] }) {
  const router = useRouter();
  const [editingUser, setEditingUser] = useState<any | null>(null);
  const [isCreating, setIsCreating] = useState(false);
  const [deletingId, setDeletingId] = useState<string | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  function requestDelete(id: string) { setDeletingId(id); }

  async function confirmDelete() {
    if (!deletingId) return;
    setIsDeleting(true);
    try {
      const res = await fetch(`/api/users/${deletingId}`, { method: "DELETE" });
      if (res.ok) {
        router.refresh();
        setDeletingId(null);
      } else {
        const j = await res.json();
        alert(j.error || "Failed to delete");
      }
    } catch (error) {
      alert("An error occurred while deleting.");
    } finally {
      setIsDeleting(false);
    }
  }

  return (
    // FIX: Changed 'h-full' to 'flex-1 min-h-0' so it shares space with the footer in page.tsx
    <div className="flex-1 min-h-0 flex flex-col space-y-4">
      {/* Header */}
      <div className="flex-none flex items-center justify-between">
         <div className="flex items-center gap-4">
            <h1 className="text-xl font-semibold text-white hidden sm:block">Admin</h1>
            <div className="h-6 w-px bg-white/10 hidden sm:block" />
            <AdminTabs />
         </div>
        
        <button 
          onClick={() => setIsCreating(true)} 
          className="px-4 py-2 bg-white text-black text-sm font-bold rounded-lg hover:bg-gray-200 transition shadow-lg shadow-white/5"
        >
          + Add User
        </button>
      </div>

      {/* Table Container */}
      <div className="flex-1 min-h-0 overflow-hidden rounded-xl border border-white/10 bg-[#111b2d] shadow-2xl flex flex-col">
        <div className="flex-1 overflow-auto custom-scrollbar">
          <table className="w-full text-left text-sm min-w-[600px]">
            <thead className="bg-[#0a1020] text-white/50 sticky top-0 backdrop-blur-md z-10 border-b border-white/5">
              <tr>
                <th className="p-4 font-medium">Name</th>
                <th className="p-4 font-medium">Email</th>
                <th className="p-4 font-medium">Role</th>
                <th className="p-4 font-medium">Clinic</th>
                <th className="p-4 font-medium text-right">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {users.map((u) => (
                <tr key={u.id} className="hover:bg-white/5 transition-colors group">
                  <td className="p-4 font-medium text-white">{u.name || "—"}</td>
                  <td className="p-4 text-white/60">{u.email}</td>
                  <td className="p-4">
                    <span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider ${
                      u.role === "admin" ? "bg-red-500/20 text-red-300" :
                      u.role === "lab" ? "bg-blue-500/20 text-blue-300" :
                      u.role === "milling" ? "bg-yellow-500/20 text-yellow-300" :
                      "bg-emerald-500/20 text-emerald-300"
                    }`}>
                      {u.role}
                    </span>
                  </td>
                  <td className="p-4 text-white/60">{u.clinic?.name || "—"}</td>
                  <td className="p-4 text-right">
                    <div className="flex justify-end gap-3 opacity-60 group-hover:opacity-100 transition-opacity">
                      <button onClick={() => setEditingUser(u)} className="text-accent hover:text-white transition-colors">Edit</button>
                      <button onClick={() => requestDelete(u.id)} className="text-red-400 hover:text-red-300 transition-colors">Delete</button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {(isCreating || editingUser) && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
          <UserForm 
            clinics={clinics}
            initialData={editingUser}
            onClose={() => { setEditingUser(null); setIsCreating(false); }}
          />
        </div>
      )}

      {deletingId && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
          <div className="bg-[#111b2d] border border-white/10 rounded-xl p-6 max-w-sm w-full shadow-2xl">
            <h3 className="text-lg font-semibold text-white mb-2 text-red-400">Delete User?</h3>
            <p className="text-white/60 text-sm mb-6">Action cannot be undone.</p>
            <div className="flex justify-end gap-3">
              <button onClick={() => setDeletingId(null)} disabled={isDeleting} className="px-4 py-2 text-white/60 hover:text-white">Cancel</button>
              <button onClick={confirmDelete} disabled={isDeleting} className="px-4 py-2 bg-red-500 text-white rounded font-bold hover:bg-red-600">Delete</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/users/new/page.tsx
// portal/app/portal/admin/users/new/page.tsx
import { prisma } from "@/lib/prisma";
import NewUserForm from "@/components/UserForm";

export default async function NewUserPage() {
  // 1. Fetch data on the Server
  const clinics = await prisma.clinic.findMany({
    select: { id: true, name: true },
    orderBy: { name: "asc" },
  });

  // 2. Render the Client Component with data passed as props
  return (
    <div className="max-w-4xl mx-auto">
      <h1 className="text-2xl font-light text-white mb-8">Add New User</h1>
      <NewUserForm clinics={clinics} />
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/users/page.tsx
// portal/app/portal/admin/users/page.tsx
import { prisma } from "@/lib/prisma";
import UserListClient from "./UserListClient";

export const dynamic = "force-dynamic";

export default async function UsersPage() {
  // 1. Get Totals
  const totalUsers = await prisma.user.count();

  // 2. Fetch recent Users (Limit 50)
  const users = await prisma.user.findMany({ 
    orderBy: { createdAt: "desc" },
    take: 50, // ✅ LIMIT
    include: { 
      clinic: { select: { id: true, name: true } },
      address: true 
    }
  });

  // 3. Fetch all clinics (Dropdowns need all options, usually acceptable if <500)
  // If clinics grow >500, we should convert the dropdown to a search-as-you-type.
  const clinics = await prisma.clinic.findMany({ 
    select: { id: true, name: true }, 
    orderBy: { name: "asc" } 
  });

  return (
    <div className="flex flex-col h-full space-y-4">
      <UserListClient users={users} clinics={clinics} />
      
      {/* Footer Info */}
      <div className="flex-none text-center text-xs text-white/30 pt-2 border-t border-white/5">
        {totalUsers > users.length 
            ? `Showing recent ${users.length} of ${totalUsers} users.` 
            : `Showing all ${users.length} users.`}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/admin/page.tsx
// portal/app/portal/admin/page.tsx
import { redirect } from "next/navigation";
export default function AdminPage() {
  redirect("/portal/admin/users");
}
--- END OF FILE ---

FILE: ./app/portal/cases/MillingDashboard.tsx
// app/portal/cases/MillingDashboard.tsx
"use client";
import { useState } from "react";
import CopyableId from "@/components/CopyableId";

type MillingCase = {
  id: string;
  patientAlias: string;
  toothCodes: string;
  status: string;
  dueDate: Date | string | null;
  product: string;
  shade: string | null;
};

// FIX: Helper to distinguish status colors
function getStatusColor(s: string) {
  if (s === "APPROVED") return "bg-emerald-500/10 text-emerald-400 border-emerald-500/20"; // Green = Ready
  if (s === "IN_MILLING") return "bg-purple-500/10 text-purple-400 border-purple-500/20"; // Purple = Active
  return "bg-white/5 text-white/50 border-white/10";
}

export default function MillingDashboard({ cases }: { cases: MillingCase[] }) {
  const [selected, setSelected] = useState<Set<string>>(new Set());
  const [shippingMode, setShippingMode] = useState(false);
  const [tracking, setTracking] = useState("");
  const [carrier, setCarrier] = useState("UPS");
  const [busy, setBusy] = useState(false);

  function toggle(id: string) {
    const next = new Set(selected);
    if (next.has(id)) next.delete(id);
    else next.add(id);
    setSelected(next);
  }

  function toggleAll() {
    if (selected.size === cases.length) setSelected(new Set());
    else setSelected(new Set(cases.map((c) => c.id)));
  }

  async function handleDownload() {
    if (selected.size === 0) return;
    setBusy(true);
    try {
      const res = await fetch("/api/cases/batch/download", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids: Array.from(selected) }),
      });
      if (!res.ok) throw new Error("Download failed");
      
      // Trigger download blob
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `milling_batch_${new Date().toISOString().slice(0, 10)}.zip`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      // FIX: Reload to show status update (Approved -> In Milling)
      window.location.reload();
    } catch (e) {
      alert("Download failed. See console.");
      console.error(e);
    } finally {
      setBusy(false);
    }
  }

  async function handleShip() {
    if (selected.size === 0) return;
    if (!tracking.trim()) {
        alert("Please enter a tracking number.");
        return;
    }
    setBusy(true);
    try {
        const res = await fetch("/api/cases/batch/ship", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                ids: Array.from(selected),
                tracking,
                carrier
            }),
        });
        if (res.ok) {
            window.location.reload();
        } else {
            throw new Error("Ship failed");
        }
    } catch(e) {
        alert("Failed to update status.");
        setBusy(false);
    }
  }

  return (
    <section className="h-screen w-full flex flex-col p-6 overflow-hidden bg-background">
      <div className="flex-none mb-6 flex items-center justify-between">
        <div>
            <h1 className="text-2xl font-semibold text-white">Milling Center</h1>
            <p className="text-white/50 text-sm">Active cases ready for production.</p>
        </div>
        <div className="flex items-center gap-3">
            <span className="text-sm text-white/40">{selected.size} selected</span>
            <button 
                onClick={handleDownload}
                disabled={selected.size === 0 || busy}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium disabled:opacity-50 transition"
            >
                {busy ? "Processing..." : "Download Files (ZIP)"}
            </button>
            <button 
                onClick={() => setShippingMode(true)}
                disabled={selected.size === 0 || busy}
                className="px-4 py-2 bg-emerald-500 hover:bg-emerald-400 text-black rounded-lg font-bold disabled:opacity-50 transition"
            >
                Ship Selected
            </button>
        </div>
      </div>

      <div className="flex-1 min-h-0 rounded-xl border border-white/10 bg-black/20 overflow-hidden flex flex-col">
        <div className="flex-1 overflow-y-auto custom-scrollbar">
            <table className="w-full text-sm text-left border-collapse">
                <thead className="bg-black/60 text-white/70 sticky top-0 backdrop-blur-md z-10 border-b border-white/10">
                    <tr>
                        <th className="p-4 w-10">
                            <input type="checkbox" checked={selected.size > 0 && selected.size === cases.length} onChange={toggleAll} 
                                className="rounded border-white/30 bg-black/50" />
                        </th>
                        <th className="p-4 font-medium">Case ID</th>
                        <th className="p-4 font-medium">Patient</th>
                        <th className="p-4 font-medium">Tooth</th>
                        <th className="p-4 font-medium">Product</th>
                        <th className="p-4 font-medium">Shade</th>
                        <th className="p-4 font-medium">Status</th>
                        <th className="p-4 font-medium">Due</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-white/5">
                    {cases.map(c => (
                        <tr key={c.id} className={`hover:bg-white/5 transition-colors ${selected.has(c.id) ? "bg-blue-500/10" : ""}`}>
                            <td className="p-4">
                                <input type="checkbox" checked={selected.has(c.id)} onChange={() => toggle(c.id)} 
                                    className="rounded border-white/30 bg-black/50" />
                            </td>
                            <td className="p-4"><CopyableId id={c.id} truncate /></td>
                            <td className="p-4 font-medium text-white">{c.patientAlias}</td>
                            <td className="p-4 text-white/70">{c.toothCodes}</td>
                            <td className="p-4 text-white/70">{c.product.replace(/_/g, " ")}</td>
                            <td className="p-4 text-white/70">{c.shade || "-"}</td>
                            <td className="p-4">
                                {/* FIX: Use helper function instead of hardcoded purple */}
                                <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${getStatusColor(c.status)}`}>
                                    {c.status.replace(/_/g, " ")}
                                </span>
                            </td>
                            <td className="p-4 text-white/50">{c.dueDate ? new Date(c.dueDate).toLocaleDateString() : "-"}</td>
                        </tr>
                    ))}
                    {cases.length === 0 && (
                        <tr><td colSpan={8} className="p-12 text-center text-white/40">No cases waiting for milling.</td></tr>
                    )}
                </tbody>
            </table>
        </div>
      </div>

      {/* Shipping Modal */}
      {shippingMode && (
        <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
            <div className="bg-[#1e1e1e] border border-white/10 rounded-xl p-6 w-full max-w-md shadow-2xl">
                <h3 className="text-xl font-semibold text-white mb-4">Ship {selected.size} Cases</h3>
                <div className="space-y-4">
                    <div>
                        <label className="text-xs font-medium text-white/60 uppercase">Carrier</label>
                        <select value={carrier} onChange={e => setCarrier(e.target.value)}
                            className="w-full mt-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white">
                            <option value="UPS">UPS</option>
                            <option value="FedEx">FedEx</option>
                            <option value="USPS">USPS</option>
                            <option value="DHL">DHL</option>
                        </select>
                    </div>
                    <div>
                        <label className="text-xs font-medium text-white/60 uppercase">Tracking Number</label>
                        <input value={tracking} onChange={e => setTracking(e.target.value)} placeholder="1Z..."
                            className="w-full mt-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-accent/50 outline-none" />
                    </div>
                </div>
                <div className="flex justify-end gap-3 mt-6">
                    <button onClick={() => { setShippingMode(false); setTracking(""); }} className="px-4 py-2 text-white/60 hover:text-white">Cancel</button>
                    <button onClick={handleShip} disabled={busy} className="px-6 py-2 bg-emerald-500 text-black font-bold rounded-lg hover:bg-emerald-400">
                        {busy ? "Updating..." : "Confirm Shipment"}
                    </button>
                </div>
            </div>
        </div>
      )}
    </section>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/new/page.tsx
// app/portal/cases/new/page.tsx
import { getSession } from "@/lib/auth";
import { notFound } from "next/navigation";
import { prisma } from "@/lib/prisma";
import NewCaseForm from "@/components/NewCaseForm";
import Link from "next/link";

export const dynamic = "force-dynamic";

export type DoctorRow = {
  id: string;
  email: string;
  name: string | null;
  preferenceNote: string | null;          // <--- FETCH
  defaultDesignPreferences: string | null; // <--- FETCH
  clinic: { id: string; name: string };
};

export default async function NewCasePage() {
  const session = await getSession();

  if (!session || (session.role !== "lab" && session.role !== "admin")) {
    return notFound();
  }

  // FIX: Cast the result to DoctorRow[] to satisfy TypeScript
  // We know clinic is not null due to the 'where' clause, but TS needs a nudge.
  const doctors = (await prisma.user.findMany({
    where: { role: "customer", clinicId: { not: null } },
    select: {
      id: true,
      email: true,
      name: true,
      preferenceNote: true,          // <--- ADDED
      defaultDesignPreferences: true, // <--- ADDED
      clinic: { select: { id: true, name: true } },
    },
    orderBy: [{ clinicId: "asc" }, { email: "asc" }],
  })) as unknown as DoctorRow[];

  return (
    <section className="h-screen w-full flex flex-col p-6 overflow-hidden">
      {/* Header */}
      <div className="flex-none flex items-center justify-between mb-6 max-w-5xl mx-auto w-full">
        <div>
          <h1 className="text-2xl font-semibold text-white">New Case</h1>
          <p className="text-white/50 text-sm mt-1">
            Create order and upload scan viewer (Exocad HTML).
          </p>
        </div>
        <Link
          href="/portal/cases"
          className="px-4 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition text-sm text-white"
        >
          Cancel
        </Link>
      </div>

      {/* Logic Handover */}
      {doctors.length === 0 ? (
        <div className="flex-1 w-full max-w-5xl mx-auto">
            <div className="rounded-xl border border-red-500/20 bg-red-500/10 p-6 text-center">
              <p className="text-red-300 font-medium">No doctor accounts found.</p>
              <p className="text-white/40 text-sm mt-2">
                Please create a doctor account first via the Admin Users panel.
              </p>
            </div>
        </div>
      ) : (
        <NewCaseForm doctors={doctors} />
      )}
    </section>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/[id]/page.tsx
// portal/app/portal/cases/[id]/page.tsx
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { notFound } from "next/navigation";
import Link from "next/link";
import CaseProcessBar from "@/components/CaseProcessBar";
import CaseViewerTabs from "@/components/CaseViewerTabs";
import { CaseFile } from "@prisma/client";
import CopyableId from "@/components/CopyableId";
import CaseDetailSidebar from "@/components/CaseDetailSidebar";

export const dynamic = "force-dynamic";
type ProductionStage = "DESIGN" | "MILLING_GLAZING" | "SHIPPING" | "COMPLETED";

type Params = Promise<{ id: string }>;

function normalizeSlot(
  label: string | null,
): "scan" | "design_with_model" | "design_only" | null {
  const lower = String(label ?? "").toLowerCase();
  if (lower === "scan") return "scan";
  if (lower === "design_with_model" || lower === "model_plus_design") {
    return "design_with_model";
  }
  if (lower === "design_only") return "design_only";
  return null;
}

function is3DUrl(url: string | null | undefined): boolean {
  if (!url) return false;
  const u = url.toLowerCase();
  return u.endsWith(".stl") || u.endsWith(".ply") || u.endsWith(".obj");
}

export default async function CaseDetailPage({
  params,
}: {
  params: Params;
}) {
  const { id } = await params;
  const session = await getSession();
  if (!session) return notFound();

  // Fetch the case + assignee info
  const item = await prisma.dentalCase.findUnique({
    where: { id },
    include: {
      clinic: true,
      files: { orderBy: { createdAt: "asc" } },
      events: { orderBy: { at: "asc" } },
      comments: { 
        include: { attachments: true },
        orderBy: { createdAt: "desc" } 
      },
      assigneeUser: { select: { id: true, name: true, email: true } }
    },
  });
  if (!item) return notFound();

  if (session.role === "customer" && session.clinicId !== item.clinicId) {
    return notFound();
  }

  // Fetch Authors for Comments
  const authorIds = Array.from(new Set(item.comments.map(c => c.authorId)));
  const authors = await prisma.user.findMany({
    where: { id: { in: authorIds } },
    select: { id: true, name: true, role: true, email: true }
  });
  const authorMap = new Map(authors.map(u => [u.id, u]));

  const currentUser = await prisma.user.findUnique({
    where: { id: session.userId },
    select: { name: true, email: true }
  });
  const currentUserName = currentUser?.name || currentUser?.email || "Unknown";

  const uiComments = item.comments.map(c => {
    const author = authorMap.get(c.authorId);
    return {
      id: c.id,
      body: c.body,
      at: c.createdAt,
      author: author?.name || author?.email || "Unknown",
      role: author?.role || "user",
      attachments: c.attachments.map(a => ({
        id: a.id,
        url: a.url,
        kind: a.kind
      }))
    };
  });

  const isLabOrAdmin = session.role === "lab" || session.role === "admin";
  let designers: { id: string; name: string | null; email: string }[] = [];
  if (session.role === "admin") {
    designers = await prisma.user.findMany({
      where: { role: { in: ["lab", "admin"] } },
      select: { id: true, name: true, email: true },
      orderBy: { name: "asc" }
    });
  }

  let scanFile: CaseFile | null = null;
  let designWithModelFile: CaseFile | null = null;
  let designOnlyFile: CaseFile | null = null;
  let scanHtmlFile: CaseFile | null = null;
  let designHtmlFile: CaseFile | null = null;

  for (const f of item.files) {
    const lbl = String(f.label ?? "").toLowerCase();
    const slot = normalizeSlot(lbl);
    if (slot === "scan") { scanFile = f; continue; }
    if (slot === "design_with_model") { designWithModelFile = f; continue; }
    if (slot === "design_only") { designOnlyFile = f; continue; }
    if (lbl === "scan_html") { scanHtmlFile = f; continue; }
    if (lbl === "design_with_model_html") { designHtmlFile = f; continue; }
  }

  const scan3DUrl = is3DUrl(scanFile?.url) ? scanFile!.url : null;
  const designWithModel3DUrl = is3DUrl(designWithModelFile?.url) ? designWithModelFile!.url : null;
  const designOnly3DUrl = is3DUrl(designOnlyFile?.url) ? designOnlyFile!.url : null;
  const scanHtmlUrl = scanHtmlFile?.url ?? null;
  const designHtmlUrl = designHtmlFile?.url ?? null;

  const statusColor = 
    item.status === "CHANGES_REQUESTED" ? "text-red-400" :
    item.status === "COMPLETED" ? "text-emerald-400" :
    "text-white";

  return (
    // FIX: 'h-full' instead of 'h-screen' to fit inside the layout without scrolling the window
    // FIX: Reduced padding to p-4 for a tighter fit
    <section className="h-full w-full flex flex-col p-4 overflow-hidden">
      
      {/* Header Section */}
      <div className="flex-none space-y-3 mb-2">
        <CaseProcessBar
          caseId={item.id}
          stage={item.stage as ProductionStage}
          status={item.status}
          role={session.role}
        />
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-xl font-semibold">{item.patientAlias}</h1>
            <div className="text-white/70 text-xs mt-1 flex flex-wrap items-center gap-x-3">
              <span>Clinic: <span className="text-white">{item.clinic.name}</span></span>
              <span>•</span>
              
              {isLabOrAdmin && item.doctorName && (
                <><span>Doctor: <span className="text-white">{item.doctorName}</span></span><span>•</span></>
              )}

              {isLabOrAdmin && item.assigneeUser && (
                <>
                  <span>Designer: <span className="text-white">{item.assigneeUser.name || item.assigneeUser.email}</span></span>
                  <span>•</span>
                </>
              )}

              <span>Teeth: <span className="text-white">{item.toothCodes}</span></span>
              <span>•</span>
              <span>Status: <span className={`${statusColor} font-medium`}>{item.status.replace(/_/g, " ")}</span></span>
              <span>•</span>
              <div className="flex items-center gap-1.5">
                 <span>ID:</span><CopyableId id={item.id} />
              </div>
            </div>
          </div>
          
          {/* FIX: Shortened Text */}
          <Link href="/portal/cases" className="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition text-xs font-medium text-white/80">
            ← Cases
          </Link>
        </div>
      </div>

      {/* Main Content: Flex-1 to fill remaining height */}
      <div className="flex-1 min-h-0 flex flex-col lg:flex-row gap-4">
        
        {/* Sidebar (Chat/Files) */}
        <div className="flex-none w-full lg:w-[350px] xl:w-[400px] h-full min-h-0">
          <CaseDetailSidebar 
            caseId={item.id}
            role={session.role}
            files={item.files}
            comments={uiComments}
            events={item.events}
            currentUserName={currentUserName}
            designPreferences={item.designPreferences}
            assigneeId={item.assigneeId}
            designers={designers}
          />
        </div>

        {/* Viewer (3D/HTML) */}
        <div className="flex-1 h-full min-h-0">
          <CaseViewerTabs
            caseId={item.id}
            role={session.role}
            status={item.status}
            scan3DUrl={scan3DUrl}
            designWithModel3DUrl={designWithModel3DUrl}
            designOnly3DUrl={designOnly3DUrl}
            scanHtmlUrl={scanHtmlUrl}
            designHtmlUrl={designHtmlUrl}
          />
        </div>
      </div>
    </section>
  );
}
--- END OF FILE ---

FILE: ./app/portal/cases/page.tsx
// portal/app/portal/cases/page.tsx
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import Link from "next/link";
import { notFound } from "next/navigation";
import { Prisma } from "@prisma/client";
import CaseListRow from "@/components/CaseListRow";
import StatusFilter from "@/components/StatusFilter";
import MillingDashboard from "./MillingDashboard"; 

export const dynamic = "force-dynamic";

type CaseRow = {
  id: string;
  patientAlias: string;
  toothCodes: string;
  status: string;
  dueDate: Date | null;
  updatedAt: Date;
  doctorName: string | null;
  clinic: { name: string };
  assigneeUser: { name: string | null; email: string } | null;
};

export default async function CasesPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | string[] | undefined>>;
}) {
  const session = await getSession();
  if (!session) return notFound();

  const sp = await searchParams;
  const role = session.role;

  // --- MILLING VIEW (Optimized) ---
  if (role === "milling") {
    // LOGIC CHANGE: Milling sees "APPROVED" (Waiting) and "IN_MILLING" (Active/Milling)
    const whereMilling: Prisma.DentalCaseWhereInput = {
        OR: [
            { status: "APPROVED" },
            { stage: "MILLING_GLAZING" }
        ]
    };

    const totalMilling = await prisma.dentalCase.count({ where: whereMilling });
    const millingCases = await prisma.dentalCase.findMany({
        where: whereMilling,
        orderBy: { dueDate: "asc" },
        take: 200, 
        select: {
            id: true, patientAlias: true, toothCodes: true, status: true,
            dueDate: true, product: true, shade: true
        }
    });
    const safeMillingCases = millingCases.map(c => ({
        ...c, dueDate: c.dueDate ? c.dueDate.toISOString() : null
    }));
    return (
        <div className="flex flex-col h-full overflow-hidden">
            <MillingDashboard cases={safeMillingCases} />
        </div>
    );
  }

  // --- STANDARD VIEW ---
  const getParam = (key: string) => {
    const value = sp[key];
    return Array.isArray(value) ? value[0] : value;
  };
  const getParamArray = (key: string) => {
    const value = sp[key];
    return Array.isArray(value) ? value : (typeof value === "string" ? [value] : []);
  };

  const canCreate = role === "lab" || role === "admin";
  const isDoctor = role === "customer";

  const clinicFilter = getParam("clinic");
  const doctorFilter = getParam("doctor");
  const caseIdFilter = getParam("caseId");
  const dateFilter = getParam("date");
  const aliasFilter = getParam("alias");
  const statusFilter = getParamArray("status");

  const where: Prisma.DentalCaseWhereInput = {};
  if (statusFilter.length > 0) {
    where.status = { in: statusFilter };
  } else {
    where.status = { not: "COMPLETED" };
  }

  if (isDoctor) {
    where.doctorUserId = session.userId ?? "__none__";
    if (aliasFilter && aliasFilter.trim()) {
      where.OR = [
        { patientAlias: { contains: aliasFilter.trim() } },
        { toothCodes: { contains: aliasFilter.trim() } },
      ];
    }
  } else {
    if (clinicFilter?.trim()) where.clinic = { name: { contains: clinicFilter.trim() } };
    if (doctorFilter?.trim()) where.doctorName = { contains: doctorFilter.trim() };
    if (caseIdFilter?.trim()) where.id = { contains: caseIdFilter.trim() };
    if (dateFilter?.trim()) {
      const d = new Date(dateFilter);
      if (!Number.isNaN(d.getTime())) {
        const start = new Date(d); start.setHours(0, 0, 0, 0);
        const end = new Date(start); end.setDate(end.getDate() + 1);
        where.dueDate = { gte: start, lt: end };
      }
    }
  }

  const [totalCount, rows] = await Promise.all([
    prisma.dentalCase.count({ where }),
    prisma.dentalCase.findMany({
        where,
        orderBy: [{ updatedAt: "desc" }],
        take: 50,
        select: {
            id: true, patientAlias: true, toothCodes: true,
            status: true, dueDate: true, updatedAt: true,
            doctorName: true,
            clinic: { select: { name: true } },
            assigneeUser: { select: { name: true, email: true } }
        },
    })
  ]);

  return (
    <section className="flex flex-col h-full w-full p-6 overflow-hidden">
      <div className="flex-none space-y-4 mb-4">
        <header className="flex items-center justify-between">
          <div className="flex items-baseline gap-3">
            <h1 className="text-2xl font-semibold text-white">Cases</h1>
            <span className="text-sm text-white/40">Total: {totalCount}</span>
          </div>
          {canCreate && (
            <Link
              href="/portal/cases/new"
              className="px-3 py-1.5 rounded-lg bg-white text-black text-sm hover:bg-gray-200 transition font-medium"
            >
              + New Case
            </Link>
          )}
        </header>

        <form className="flex flex-wrap gap-2 items-center bg-black/20 p-2 rounded-xl border border-white/5">
          <StatusFilter selected={statusFilter} />
          {canCreate && (
            <>
              <input name="clinic" placeholder="Clinic Name" defaultValue={clinicFilter ?? ""} className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white outline-none w-32 lg:w-40" />
              <input name="doctor" placeholder="Doctor Name" defaultValue={doctorFilter ?? ""} className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white outline-none w-32 lg:w-40" />
              <input name="caseId" placeholder="Case ID" defaultValue={caseIdFilter ?? ""} className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white outline-none w-32 font-mono" />
              <input type="date" name="date" defaultValue={dateFilter ?? ""} className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white outline-none [color-scheme:dark]" />
            </>
          )}
          {isDoctor && (
            <input name="alias" placeholder="Search patient alias..." defaultValue={aliasFilter ?? ""} className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white flex-1 min-w-[200px] outline-none" />
          )}
          <button type="submit" className="bg-white text-black rounded-lg px-4 py-1.5 text-sm font-medium hover:bg-gray-200 transition">Search</button>
          {(clinicFilter || doctorFilter || caseIdFilter || dateFilter || aliasFilter || statusFilter.length > 0) && (
             <Link href="/portal/cases" className="px-3 py-1.5 text-sm text-white/60 hover:text-white hover:bg-white/10 rounded-lg transition">Clear</Link>
          )}
        </form>
      </div>

      <div className="flex-1 min-h-0 rounded-xl border border-white/10 bg-black/20 overflow-hidden flex flex-col shadow-2xl shadow-black/50">
        <div className="flex-1 overflow-y-auto custom-scrollbar">
          <table className="w-full text-sm text-left border-collapse">
            <thead className="bg-black/60 text-white/70 sticky top-0 backdrop-blur-md z-10 border-b border-white/10">
              <tr>
                <th className="p-4 font-medium">Case ID</th>
                <th className="p-4 font-medium">Alias</th>
                <th className="p-4 font-medium">Clinic</th>
                <th className="p-4 font-medium">Doctor</th>
                {!isDoctor && <th className="p-4 font-medium">Designer</th>}
                <th className="p-4 font-medium">Tooth</th>
                <th className="p-4 font-medium">Status</th>
                <th className="p-4 font-medium">Due Date</th>
                <th className="p-4 font-medium">Last Update</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {(rows as CaseRow[]).map((c) => (
                <CaseListRow key={c.id} data={c} role={role} />
              ))}
              {rows.length === 0 && (
                 <tr><td className="p-12 text-center text-white/40" colSpan={9}>No cases found.</td></tr>
              )}
            </tbody>
          </table>
        </div>
        <div className="flex-none p-2 border-t border-white/5 bg-white/[0.02] text-center text-xs text-white/30">
            {totalCount > rows.length 
                ? `Showing recent ${rows.length} of ${totalCount} cases. Use filters to find older records.` 
                : `Showing all ${rows.length} cases.`}
        </div>
      </div>
    </section>
  );
}
--- END OF FILE ---

FILE: ./app/portal/layout.tsx
// portal/app/portal/layout.tsx
import PortalSidebar from "@/components/PortalSidebar";
import { getSession } from "@/lib/auth"; 
import { redirect } from "next/navigation";

export default async function PortalLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await getSession();

  if (!session) {
    redirect("/login");
  }

  return (
    // FRAME: Locks the browser window. Nothing outside this div can scroll.
    <div className="flex h-screen w-screen overflow-hidden bg-[#0a1020] text-[#f5f7fb]">
      
      {/* Sidebar: Fixed width, full height */}
      <PortalSidebar userRole={session.role} />

      {/* Main Content: Fills remaining width/height. 
          We do NOT scroll here. We let the child pages decide what scrolls. */}
      <main className="flex-1 flex flex-col min-w-0 h-full relative">
        {children}
      </main>
    </div>
  );
}
--- END OF FILE ---

FILE: ./app/portal/billing/page.tsx
// portal/app/portal/billing/page.tsx
import { getSession } from "@/lib/auth";
import { redirect } from "next/navigation";
import { prisma } from "@/lib/prisma";
import { Prisma } from "@prisma/client";
import BillingToolbar from "@/components/BillingToolbar";
import BillingStats from "@/components/BillingStats";
import BillingList from "@/components/BillingList";

export const dynamic = "force-dynamic";

export default async function BillingPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | string[] | undefined>>;
}) {
  const session = await getSession();
  if (!session) redirect("/login");

  const sp = await searchParams;

  // --- 1. FILTERS ---
  const getParam = (key: string) => {
    const val = sp[key];
    if (Array.isArray(val)) return val[0];
    return val;
  };

  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1;

  const selYear = getParam("year") ? parseInt(getParam("year")!) : currentYear;
  const selMonth = getParam("month") ? parseInt(getParam("month")!) : currentMonth;

  const qFilter = getParam("q") || "";
  const doctorFilter = getParam("doctor") || "";
  const clinicFilter = getParam("clinic") || "";
  const isAdminOrLab = session.role === "admin" || session.role === "lab";

  const where: Prisma.DentalCaseWhereInput = {};
  
  if (session.role === "customer") {
    if (!session.clinicId) {
      return <div className="p-8 text-white/50">No clinic linked. Contact support.</div>;
    }
    where.doctorUserId = session.userId;
  }

  const start = new Date(selYear, selMonth - 1, 1);
  const end = new Date(selYear, selMonth, 0, 23, 59, 59, 999);
  where.orderDate = { gte: start, lte: end };

  if (qFilter.trim()) {
    where.OR = [
      { patientAlias: { contains: qFilter.trim() } },
      { id: { contains: qFilter.trim() } },
    ];
  }

  if (isAdminOrLab) {
    if (doctorFilter.trim()) where.doctorName = { contains: doctorFilter.trim() };
    if (clinicFilter.trim()) where.clinic = { name: { contains: clinicFilter.trim() } };
  }

  // --- 2. OPTIMIZED FETCH ---
  // A. Get Totals via Aggregation (FAST, instead of iterating JS)
  const stats = await prisma.dentalCase.aggregate({
    where,
    _sum: {
        cost: true,
        units: true
    },
    _count: {
        id: true
    }
  });

  // B. Get Recent Cases (Limit to 100 to prevent crashes)
  const rawCases = await prisma.dentalCase.findMany({
    where,
    orderBy: { orderDate: "desc" },
    take: 100, // ✅ LIMIT: Prevent rendering 5,000 rows
    select: {
      id: true,
      orderDate: true,
      patientAlias: true,
      doctorName: true,
      product: true,
      units: true,
      cost: true,
      billingType: true,
      clinic: { select: { name: true } },
    },
  });

  const cases = rawCases.map((c) => ({
    ...c,
    cost: Number(c.cost),
  }));

  const isFiltered = !!qFilter || (isAdminOrLab && (!!doctorFilter || !!clinicFilter)) || selYear !== currentYear || selMonth !== currentMonth;

  return (
    <section className="h-screen w-full flex flex-col p-6 overflow-hidden">
      <BillingToolbar 
        selYear={selYear}
        selMonth={selMonth}
        qFilter={qFilter}
        doctorFilter={doctorFilter}
        clinicFilter={clinicFilter}
        isAdminOrLab={isAdminOrLab}
        isFiltered={isFiltered}
      />

      <BillingStats 
        // ✅ Use DB Aggregates (Fast)
        totalCost={Number(stats._sum.cost || 0)}
        caseCount={stats._count.id}
        totalUnits={stats._sum.units || 0}
      />

      <BillingList cases={cases} isAdminOrLab={isAdminOrLab} />
      {stats._count.id > 100 && (
        <p className="text-center text-xs text-white/30 pt-2">
            Showing recent 100 of {stats._count.id} records. Export to CSV for full history.
        </p>
      )}
    </section>
  );
}
--- END OF FILE ---

FILE: ./app/signup/page.tsx
// portal/app/signup/page.tsx
"use client";

import { useState } from "react";
import Link from "next/link";

export default function SignupPage() {
  const [form, setForm] = useState({
    name: "",
    email: "",
    phone: "",
    // Clinic Name removed from UI
    street: "",
    city: "",
    state: "",
    zipCode: ""
  });
  const [busy, setBusy] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [error, setError] = useState("");

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setBusy(true);
    setError("");

    try {
      const res = await fetch("/api/auth/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(form)
      });
      
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to submit request");
      
      setSubmitted(true);
    } catch (err: any) {
      setError(err.message);
      setBusy(false);
    }
  }

  if (submitted) {
    return (
      <main className="h-screen w-full bg-background flex items-center justify-center p-6 overflow-hidden">
        <div className="max-w-md w-full bg-white/5 border border-white/10 rounded-2xl p-8 text-center shadow-2xl backdrop-blur-xl">
          <div className="w-16 h-16 bg-emerald-500/10 text-emerald-400 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
          </div>
          <h2 className="text-2xl font-medium text-white mb-2">Request Sent</h2>
          <p className="text-white/60 mb-8 leading-relaxed">
            Thank you, {form.name}. Our team will review your information and send an approval email shortly.
          </p>
          <Link href="/" className="inline-block px-6 py-3 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition">
            Return Home
          </Link>
        </div>
      </main>
    );
  }

  return (
    // FIX: 'h-screen overflow-hidden' ensures no scrolling
    <main className="h-screen w-full bg-background flex items-center justify-center p-6 relative overflow-hidden">
        {/* Background Gradients */}
        <div className="absolute inset-0 pointer-events-none">
            <div className="absolute top-0 left-0 w-[800px] h-[800px] bg-accent/5 rounded-full blur-[120px] -translate-y-1/2 -translate-x-1/4" />
        </div>

        <div className="w-full max-w-2xl relative z-10 flex flex-col max-h-full">
            <div className="mb-6 text-center flex-none">
                <Link href="/" className="inline-block text-2xl font-light tracking-wide text-white mb-2">Lumera</Link>
                <h1 className="text-2xl font-semibold text-white">Request Access</h1>
                <p className="text-white/40 text-sm mt-1">Enter your details to create an account.</p>
            </div>

            <form onSubmit={onSubmit} className="bg-white/5 border border-white/10 rounded-2xl p-8 backdrop-blur-md shadow-2xl flex flex-col gap-5 overflow-y-auto custom-scrollbar">
                
                {/* Personal Info */}
                <div className="space-y-4">
                    <h3 className="text-xs font-bold text-accent uppercase tracking-wider border-b border-white/5 pb-2">Account Details</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                        <div className="space-y-1">
                            <label className="text-xs text-white/60 uppercase">Full Name *</label>
                            <input required name="name" value={form.name} onChange={handleChange} className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:border-accent/50 outline-none" placeholder="Dr. Jane Doe" />
                        </div>
                        <div className="space-y-1">
                            <label className="text-xs text-white/60 uppercase">Email Address *</label>
                            <input required type="email" name="email" value={form.email} onChange={handleChange} className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:border-accent/50 outline-none" placeholder="doctor@clinic.com" />
                        </div>
                    </div>
                    <div className="space-y-1">
                        <label className="text-xs text-white/60 uppercase">Phone Number *</label>
                        <input required name="phone" value={form.phone} onChange={handleChange} className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:border-accent/50 outline-none" placeholder="(555) 000-0000" />
                    </div>
                </div>

                {/* Address Info (Moved under Account) */}
                <div className="space-y-4">
                    <h3 className="text-xs font-bold text-accent uppercase tracking-wider border-b border-white/5 pb-2">Address</h3>
                    <div className="space-y-1">
                        <label className="text-xs text-white/60 uppercase">Street Address *</label>
                        <input required name="street" value={form.street} onChange={handleChange} className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:border-accent/50 outline-none" placeholder="123 Main St" />
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                        <div className="space-y-1">
                            <label className="text-xs text-white/60 uppercase">City *</label>
                            <input required name="city" value={form.city} onChange={handleChange} className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2.5 text-white outline-none" placeholder="City" />
                        </div>
                        <div className="space-y-1">
                            <label className="text-xs text-white/60 uppercase">State *</label>
                            <input required name="state" value={form.state} onChange={handleChange} className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2.5 text-white outline-none" placeholder="State" />
                        </div>
                        <div className="space-y-1">
                            <label className="text-xs text-white/60 uppercase">Zip *</label>
                            <input required name="zipCode" value={form.zipCode} onChange={handleChange} className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2.5 text-white outline-none" placeholder="Zip" />
                        </div>
                    </div>
                </div>

                {error && <p className="text-red-400 text-sm text-center bg-red-500/10 p-2 rounded">{error}</p>}

                <div className="pt-2 flex items-center justify-between mt-auto">
                    <Link href="/login" className="text-sm text-white/40 hover:text-white transition">← Back to Login</Link>
                    <button type="submit" disabled={busy} className="px-8 py-3 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition disabled:opacity-50">
                        {busy ? "Submitting..." : "Request Access"}
                    </button>
                </div>
            </form>
        </div>
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/setup/page.tsx
// portal/app/setup/page.tsx
"use client";

import { useState, Suspense } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import Link from "next/link";

function SetupForm() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const token = searchParams.get("token");

  const [password, setPassword] = useState("");
  const [confirm, setConfirm] = useState("");
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState("");

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (password !== confirm) return setError("Passwords do not match");
    if (password.length < 6) return setError("Password must be at least 6 characters");
    
    setBusy(true);
    setError("");

    try {
      const res = await fetch("/api/auth/setup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, password })
      });
      
      if (!res.ok) throw new Error((await res.json()).error || "Failed");
      
      // Success -> Redirect to login
      router.push("/login");
    } catch (e: any) {
      setError(e.message);
      setBusy(false);
    }
  }

  if (!token) {
    return (
      <div className="text-center text-white/60">
        <p>Invalid or missing invitation token.</p>
        <Link href="/login" className="text-accent hover:underline mt-4 block">Back to Login</Link>
      </div>
    );
  }

  return (
    <div className="w-full max-w-sm">
      <h1 className="text-2xl font-semibold text-white mb-2 text-center">Set Your Password</h1>
      <p className="text-white/40 text-sm text-center mb-8">Finalize your account setup</p>
      
      <form onSubmit={onSubmit} className="bg-white/5 border border-white/10 rounded-2xl p-8 space-y-4">
        <div>
          <label className="block text-xs font-medium text-white/60 uppercase mb-2">New Password</label>
          <input 
            type="password" 
            required 
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-accent/50 outline-none"
          />
        </div>
        <div>
          <label className="block text-xs font-medium text-white/60 uppercase mb-2">Confirm Password</label>
          <input 
            type="password" 
            required 
            value={confirm}
            onChange={(e) => setConfirm(e.target.value)}
            className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-accent/50 outline-none"
          />
        </div>

        {error && <div className="text-red-400 text-sm text-center">{error}</div>}

        <button 
          type="submit" 
          disabled={busy}
          className="w-full py-3 bg-accent text-background font-bold rounded-lg hover:bg-white transition disabled:opacity-50"
        >
          {busy ? "Setting up..." : "Complete Setup"}
        </button>
      </form>
    </div>
  );
}

export default function SetupPage() {
  return (
    <main className="min-h-screen bg-background flex items-center justify-center p-6">
      <Suspense fallback={<div className="text-white/50">Loading...</div>}>
        <SetupForm />
      </Suspense>
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/about/page.tsx
// portal/app/about/page.tsx
import PublicNavbar from "@/components/PublicNavbar";
import PublicFooter from "@/components/PublicFooter";

export default function AboutPage() {
  return (
    <main className="min-h-screen flex flex-col bg-background text-porcelain">
      <PublicNavbar />
      
      <section className="pt-24 pb-12">
        <div className="container mx-auto px-6 text-center">
          <h1 className="text-5xl font-semibold mb-6">About Lumera</h1>
          <p className="text-xl text-white/60 max-w-3xl mx-auto">
            We build one thing exceptionally well: zirconia crowns. When other restorations reach 
            the efficiency and reliability of The Crown, we’ll add them. Never before.
          </p>
        </div>
      </section>

      <section className="container mx-auto px-6 pb-24 max-w-4xl space-y-8">
        {/* Story Card */}
        <div className="p-8 md:p-12 rounded-3xl border border-white/10 bg-white/[0.02]">
          <h2 className="text-2xl font-medium mb-4">Our Story</h2>
          <p className="text-white/60 leading-relaxed text-lg">
            We started as a <b>boutique lab for personalized restorations</b>, a small team obsessed with detail. 
            As a private lab we served a network of 50+ clinics in the Northeast and refined a single workflow end to end. 
            Today we’re opening to the public with that same craft and focus.
          </p>
        </div>

        {/* Founders Grid */}
        <div className="p-8 md:p-12 rounded-3xl border border-white/10 bg-white/[0.02]">
          <h2 className="text-2xl font-medium mb-8">Founders</h2>
          <div className="grid md:grid-cols-3 gap-6">
            {[
              { role: "Dentist", sub: "Clinical Lead", desc: "Sets standards for margin capture, occlusion, and chairside simplicity." },
              { role: "Group Owner", sub: "Operations", desc: "Ensures submission clarity, communication speed, and predictable delivery." },
              { role: "Engineer", sub: "Biomedical / Software", desc: "Operations, data flow, and reliability across production." }
            ].map((f, i) => (
              <div key={i} className="p-6 rounded-2xl border border-white/10 bg-black/20">
                <h3 className="font-semibold text-lg mb-1">{f.role}</h3>
                <div className="text-xs text-accent uppercase tracking-wider font-bold mb-3">{f.sub}</div>
                <p className="text-sm text-white/50">{f.desc}</p>
              </div>
            ))}
          </div>
        </div>
      </section>

      <PublicFooter />
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/work/page.tsx
// portal/app/work/page.tsx
import PublicNavbar from "@/components/PublicNavbar";
import PublicFooter from "@/components/PublicFooter";
import Link from "next/link";

export default function WorkPage() {
  const galleryItems = [
    { id: 1, title: "Full Arch Zirconia", category: "Restoration", colSpan: "col-span-1 md:col-span-2 row-span-2" },
    { id: 2, title: "Single Central Incisor", category: "Esthetic", colSpan: "col-span-1" },
    { id: 3, title: "Gold Crown", category: "Classic", colSpan: "col-span-1" },
    { id: 4, title: "Implant Bridge", category: "Complex", colSpan: "col-span-1" },
    { id: 5, title: "Veneer Case", category: "Cosmetic", colSpan: "col-span-1" },
  ];

  return (
    <main className="min-h-screen flex flex-col bg-background text-porcelain selection:bg-accent/30">
      <PublicNavbar />

      <div className="flex-1">
        {/* HERO SECTION */}
        <section className="relative pt-32 pb-20 px-6 overflow-hidden">
          {/* Ambient Background */}
          <div className="absolute top-0 right-0 w-[800px] h-[800px] bg-accent/5 rounded-full blur-[120px] -translate-y-1/2 translate-x-1/3 pointer-events-none" />
          
          <div className="container mx-auto text-center relative z-10">
            <h1 className="text-4xl md:text-6xl font-light mb-6 tracking-tight">
              Our <span className="text-accent">Masterpieces</span>
            </h1>
            <p className="text-lg text-white/60 max-w-2xl mx-auto leading-relaxed">
              Precision meets artistry. Explore our gallery of complex restorations, 
              aesthetic makeovers, and everyday crown & bridge work.
            </p>
          </div>
        </section>

        {/* GALLERY GRID */}
        {/* FIX: bg-surface (Midnight Blue variant) instead of hardcoded grey */}
        <section className="py-20 px-6 bg-surface/50">
          <div className="container mx-auto">
            <div className="grid grid-cols-1 md:grid-cols-3 auto-rows-[300px] gap-6">
              {galleryItems.map((item) => (
                <div 
                  key={item.id} 
                  className={`group relative rounded-3xl overflow-hidden border border-white/5 bg-white/5 backdrop-blur-sm hover:border-accent/30 transition-all duration-500 ${item.colSpan}`}
                >
                  {/* Placeholder for Image */}
                  <div className="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent flex items-center justify-center group-hover:scale-105 transition-transform duration-700">
                    <svg className="w-12 h-12 text-white/10 group-hover:text-accent/20 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>

                  {/* Overlay Content */}
                  <div className="absolute inset-0 bg-gradient-to-t from-background via-background/50 to-transparent opacity-60 group-hover:opacity-80 transition-opacity" />
                  
                  <div className="absolute bottom-0 left-0 p-8 translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                    <span className="text-accent text-xs font-bold tracking-widest uppercase mb-2 block opacity-0 group-hover:opacity-100 transition-opacity delay-100">
                      {item.category}
                    </span>
                    <h3 className="text-xl font-medium text-white group-hover:text-accent transition-colors">
                      {item.title}
                    </h3>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* CTA SECTION */}
        <section className="py-32 px-6 relative overflow-hidden">
          <div className="absolute inset-0 bg-accent/5" />
          <div className="container mx-auto text-center relative z-10">
            <h2 className="text-3xl font-light mb-8">Ready to send your first case?</h2>
            <Link 
              href="/signup"
              className="inline-flex items-center justify-center px-8 py-4 text-base font-bold text-background bg-accent rounded-full hover:bg-white hover:scale-105 transition-all shadow-[0_0_30px_rgba(150,150,226,0.3)]"
            >
              Get Started
            </Link>
          </div>
        </section>
      </div>

      <PublicFooter />
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/layout.tsx
import type { Metadata } from "next";
import "./globals.css";

export const metadata: Metadata = {
  title: "Lumera Dental Portal",
  description: "Advanced Dental Case Management",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      {/* Replaced Geist (Google Font) with standard system fonts.
        'font-sans' uses Tailwind's robust default stack: 
        (Inter, system-ui, -apple-system, Segoe UI, Roboto, etc.)
      */}
      <body className="font-sans antialiased bg-background text-porcelain">
        {children}
      </body>
    </html>
  );
}
--- END OF FILE ---

FILE: ./app/api/auth/signup/route.ts
// portal/app/api/auth/signup/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function POST(req: Request) {
  try {
    const data = await req.json();
    
    // Validation: Ensure all fields from the new form are present
    if (
      !data.email || 
      !data.name || 
      !data.phone || 
      !data.street || 
      !data.city || 
      !data.state || 
      !data.zipCode
    ) {
      return NextResponse.json({ error: "All fields are required." }, { status: 400 });
    }

    // Check if user already exists
    const existingUser = await prisma.user.findUnique({ where: { email: data.email } });
    if (existingUser) {
      return NextResponse.json({ error: "An account with this email already exists." }, { status: 400 });
    }

    // Check if pending request exists
    const existingReq = await prisma.registrationRequest.findUnique({ where: { email: data.email } });
    if (existingReq) {
      return NextResponse.json({ error: "A request for this email is already pending." }, { status: 400 });
    }

    // Default clinic name since we removed it from the UI to streamline signup
    const clinicName = `${data.name}'s Practice`;

    await prisma.registrationRequest.create({
      data: {
        email: data.email,
        name: data.name,
        phone: data.phone,
        clinicName: clinicName, // Auto-generated
        street: data.street,
        city: data.city,
        state: data.state,
        zipCode: data.zipCode,
        status: "PENDING"
      }
    });

    return NextResponse.json({ ok: true });
  } catch (e) {
    console.error("Signup error:", e);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/auth/setup/route.ts
// portal/app/api/auth/setup/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";

export async function POST(req: Request) {
  try {
    const { token, password } = await req.json();

    if (!token || !password) return NextResponse.json({ error: "Missing fields" }, { status: 400 });

    // Find user with this token
    const user = await prisma.user.findUnique({ where: { invitationToken: token } });
    if (!user) return NextResponse.json({ error: "Invalid or expired token" }, { status: 400 });

    const hash = await bcrypt.hash(password, 10);

    // Update user: Set password, clear token
    await prisma.user.update({
      where: { id: user.id },
      data: {
        password: hash,
        invitationToken: null // One-time use
      }
    });

    return NextResponse.json({ ok: true });
  } catch (e) {
    return NextResponse.json({ error: "Internal Error" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/auth/logout/route.ts
import { NextResponse } from "next/server";

const COOKIE = "lumera_session";

export async function POST() {
  const res = NextResponse.json({ ok: true });
  res.cookies.delete(COOKIE);   // deletion works regardless of secure flag
  return res;
}

--- END OF FILE ---

FILE: ./app/api/auth/login/route.ts
// portal/app/api/auth/login/route.ts
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { cookies } from "next/headers";
import jwt from "jsonwebtoken";
import bcrypt from "bcryptjs";

const JWT_SECRET = process.env.JWT_SECRET || "dev-secret";
const COOKIE_NAME = "lumera_session";

export async function POST(req: Request) {
  try {
    const body = await req.json().catch(() => ({}));
    const email = String(body.email ?? "").toLowerCase();
    const password = String(body.password ?? "");

    if (!email || !password) {
      return NextResponse.json(
        { error: "Email and password are required" },
        { status: 400 }
      );
    }

    const user = await prisma.user.findUnique({
      where: { email },
    });

    if (!user) {
      return NextResponse.json(
        { error: "Invalid credentials" },
        { status: 401 }
      );
    }

    const ok = await bcrypt.compare(password, user.password);
    if (!ok) {
      return NextResponse.json(
        { error: "Invalid credentials" },
        { status: 401 }
      );
    }

    const token = jwt.sign(
      {
        userId: user.id,
        role: user.role,
        clinicId: user.clinicId ?? null,
      },
      JWT_SECRET,
      { expiresIn: "7d" }
    );

    const jar = await cookies();
    jar.set(COOKIE_NAME, token, {
      httpOnly: true,
      sameSite: "lax",
      path: "/",
      // secure: true, // enable in production
    });

    return NextResponse.json({ ok: true });
  } catch (e) {
    console.error(e);
    return NextResponse.json(
      { error: "Login failed" },
      { status: 500 }
    );
  }
}

--- END OF FILE ---

FILE: ./app/api/admin/requests/[id]/approve/route.ts
// portal/app/api/admin/requests/[id]/approve/route.ts
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { Resend } from "resend";
import crypto from "node:crypto";

const resend = process.env.RESEND_API_KEY ? new Resend(process.env.RESEND_API_KEY) : null;

export async function POST(req: Request, props: { params: Promise<{ id: string }> }) {
  try {
    const session = await getSession();
    if (!session || session.role !== "admin") {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const params = await props.params;
    const { id } = params;
    
    const body = await req.json().catch(() => ({}));
    const action = body.action;

    const request = await prisma.registrationRequest.findUnique({ where: { id } });
    if (!request) {
      return NextResponse.json({ error: "Request not found" }, { status: 404 });
    }

    if (action === "reject") {
      await prisma.registrationRequest.update({ 
        where: { id }, 
        data: { status: "REJECTED" } 
      });
      return NextResponse.json({ ok: true });
    }

    // --- APPROVE ---
    const existingUser = await prisma.user.findUnique({ where: { email: request.email } });
    if (existingUser) {
        await prisma.registrationRequest.update({ 
            where: { id }, 
            data: { status: "PROCESSED" } 
        });
        return NextResponse.json({ ok: true, warning: "User already existed." });
    }

    // 1. Create Address (Linked to USER later, not Clinic)
    const address = await prisma.address.create({
      data: {
        street: request.street,
        city: request.city,
        state: request.state,
        zipCode: request.zipCode,
      }
    });

    // 2. Create Clinic (Name ONLY - No Address)
    // "I dont want the address the new user enters to be a clinic"
    // We assume the user creates a new clinic entity, but keeps their personal address on their user profile.
    const clinic = await prisma.clinic.create({
      data: {
        name: request.clinicName
      }
    });

    // 3. Create User (Linked to Clinic AND Address)
    const token = crypto.randomBytes(16).toString("hex");
    await prisma.user.create({
      data: {
        email: request.email,
        name: request.name,
        phoneNumber: request.phone,
        role: "customer",
        clinicId: clinic.id,
        addressId: address.id, // <--- Address linked here
        password: "PENDING_SETUP", 
        invitationToken: token,
      }
    });

    await prisma.registrationRequest.update({ 
        where: { id }, 
        data: { status: "PROCESSED" } 
    });

    if (resend) {
      try {
        const sender = process.env.EMAIL_FROM || "onboarding@resend.dev";
        const baseUrl = process.env.NEXT_PUBLIC_URL || "https://lumeradental.com";
        const setupUrl = `${baseUrl}/setup?token=${token}`;

        await resend.emails.send({
          from: sender,
          to: request.email,
          subject: "Your Lumera Account is Approved",
          html: `
            <div style="font-family: sans-serif; color: #111; max-width: 600px; padding: 20px;">
              <h2 style="color: #1e1e1e;">Access Granted</h2>
              <p>Hello ${request.name},</p>
              <p>Your request to join the Lumera Dental Portal has been approved.</p>
              <a href="${setupUrl}" style="display: inline-block; background: #000; color: #fff; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: bold;">Set Password</a>
            </div>
          `
        });
      } catch (e) {
        console.error("Email error:", e);
      }
    }

    return NextResponse.json({ ok: true });

  } catch (e: any) {
    console.error("Approval error:", e);
    return NextResponse.json({ error: e.message }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/batch/download/route.ts
// app/api/cases/batch/download/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import fs from "node:fs";
import path from "node:path";
import archiver from "archiver";

function zipFiles(files: { path: string, name: string }[]): Promise<Buffer> {
    return new Promise((resolve, reject) => {
        const chunks: Buffer[] = [];
        const archive = archiver("zip", { zlib: { level: 9 } });

        archive.on("error", reject);
        archive.on("data", (chunk) => chunks.push(chunk));
        archive.on("end", () => resolve(Buffer.concat(chunks)));

        files.forEach(f => {
            if (fs.existsSync(f.path)) {
                archive.file(f.path, { name: f.name });
            }
        });

        archive.finalize();
    });
}

export async function POST(req: Request) {
    try {
        const session = await getSession();
        if (!session || (session.role !== "milling" && session.role !== "admin")) {
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        const { ids } = await req.json();
        if (!ids || !Array.isArray(ids)) return NextResponse.json({ error: "Invalid request" }, { status: 400 });

        // FETCH: Get details needed for naming (Shade, Material, Product)
        const caseFiles = await prisma.caseFile.findMany({
            where: { caseId: { in: ids } },
            include: { 
                case: { 
                    select: { 
                        patientAlias: true, 
                        shade: true, 
                        material: true, 
                        product: true 
                    } 
                } 
            }
        });

        const fileList: { path: string, name: string }[] = [];
        
        for (const file of caseFiles) {
            const relativePath = file.url.replace(/^\//, "");
            const diskPath = path.join(process.cwd(), "public", relativePath);
            
            // --- NEW NAMING LOGIC ---
            // Format: AliasColorMaterialType (No Spaces)
            const c = file.case;
            const alias = c.patientAlias || "Unknown";
            const color = c.shade || "";
            const material = c.material || "";
            const type = c.product || "";

            // Construct Base Name
            const rawBase = `${alias}${color}${material}${type}`;
            // Remove ALL spaces
            const cleanBase = rawBase.replace(/\s+/g, ""); 
            
            // Clean Label (e.g. "model_top" -> "ModelTop")
            const cleanLabel = (file.label || "File").replace(/_/g, "").replace(/\s+/g, "");
            
            // Final Filename: [Base]_[Label].[ext]
            // Example: QW44A2ZirconiaCrown_ModelTop.stl
            const ext = path.extname(diskPath);
            const fileName = `${cleanBase}_${cleanLabel}${ext}`;

            fileList.push({ path: diskPath, name: fileName });
        }

        if (fileList.length === 0) {
            return NextResponse.json({ error: "No files found for selected cases" }, { status: 404 });
        }

        const buffer = await zipFiles(fileList);

        // LOGIC: Automatically move APPROVED cases to IN_MILLING
        await prisma.dentalCase.updateMany({
            where: { 
                id: { in: ids },
                status: "APPROVED" 
            },
            data: {
                status: "IN_MILLING",
                stage: "MILLING_GLAZING",
                milledAt: new Date()
            }
        });

        return new NextResponse(buffer as any, {
            headers: {
                "Content-Type": "application/zip",
                "Content-Disposition": `attachment; filename="production_batch.zip"`
            }
        });
    } catch (e) {
        console.error("Batch zip error:", e);
        return NextResponse.json({ error: "Failed to generate zip" }, { status: 500 });
    }
}
--- END OF FILE ---

FILE: ./app/api/cases/batch/ship/route.ts
// app/api/cases/batch/ship/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function POST(req: Request) {
  try {
    const session = await getSession();
    if (!session || (session.role !== "milling" && session.role !== "admin")) {
        return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { ids, tracking, carrier } = await req.json();
    
    if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return NextResponse.json({ error: "No cases selected" }, { status: 400 });
    }

    await prisma.dentalCase.updateMany({
        where: { id: { in: ids } },
        data: {
            status: "SHIPPED",
            stage: "SHIPPING",
            shippedAt: new Date(),
            trackingNumber: tracking,
            shippingCarrier: carrier
        }
    });

    return NextResponse.json({ ok: true });
  } catch (e) {
    console.error("Batch ship error:", e);
    return NextResponse.json({ error: "Failed" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/new/route.ts
// portal/app/api/cases/new/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import path from "node:path";
import fs from "node:fs/promises";
import { 
  calculateCaseCost, 
  countUnits, 
  PriceTier 
} from "@/lib/pricing";
import { CreateCaseSchema } from "@/lib/schemas"; // <--- Zod Schema

const MAX_FILE_BYTES = 500 * 1024 * 1024; // 500MB Limit

function addDays(d: Date, n: number) {
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  x.setHours(0, 0, 0, 0);
  return x;
}

function sanitizeFileName(original: string, fallbackBase: string): string {
  const baseName = (original || fallbackBase).replace(/\s+/g, "_");
  return baseName.replace(/[^a-zA-Z0-9_.-]/g, "");
}

async function saveCaseFile(file: File, caseId: string, label: string) {
  const uploadsRoot = path.join(process.cwd(), "public", "uploads", caseId);
  await fs.mkdir(uploadsRoot, { recursive: true });

  const originalName = file.name || `${label}.bin`;
  const safeName = sanitizeFileName(originalName, label);
  const buf = Buffer.from(await file.arrayBuffer());
  const fullPath = path.join(uploadsRoot, safeName);
  await fs.writeFile(fullPath, buf);

  const publicUrl = `/uploads/${caseId}/${safeName}`;
  let kind = "OTHER";
  const lower = safeName.toLowerCase();
  if (lower.endsWith(".stl")) kind = "STL";
  else if (lower.endsWith(".ply")) kind = "PLY";
  else if (lower.endsWith(".obj")) kind = "OBJ";
  else if (lower.endsWith(".pdf")) kind = "PDF";
  else if (lower.endsWith(".html") || lower.endsWith(".htm")) kind = "OTHER";

  await prisma.caseFile.create({
    data: {
      caseId,
      label,
      kind,
      url: publicUrl,
      sizeBytes: buf.length,
    },
  });
}

export async function POST(req: Request) {
  try {
    // 1. Auth Check
    const session = await getSession();
    if (!session) {
      return NextResponse.json({ error: "Please sign in." }, { status: 401 });
    }
    if (session.role === "customer") {
      return NextResponse.json({ error: "Only lab/admin can create cases." }, { status: 403 });
    }

    // 2. Parse FormData
    const form = await req.formData();
    
    // Convert FormData to a plain object for Zod
    const rawData = {
      patientAlias: form.get("patientAlias"),
      doctorUserId: form.get("doctorUserId"),
      toothCodes: form.get("toothCodes"),
      orderDate: form.get("orderDate"),
      product: form.get("product"),
      shade: form.get("shade") || undefined,
      material: form.get("material") || undefined,
      designPreferences: form.get("designPreferences") || undefined,
      billingType: form.get("billingType") || undefined,
      // Files
      scanHtml: form.get("scanHtml"),
      rxPdf: form.get("rxPdf"),
      constructionInfo: form.get("constructionInfo"),
      modelTop: form.get("modelTop"),
      modelBottom: form.get("modelBottom"),
    };

    // 3. Zod Validation (The Bouncer)
    const validation = CreateCaseSchema.safeParse(rawData);

    if (!validation.success) {
      // ✅ FIX: Use .issues instead of .errors
      const firstError = validation.error.issues[0];
      return NextResponse.json(
        { error: `${firstError.path.join(".")}: ${firstError.message}` }, 
        { status: 400 }
      );
    }

    const data = validation.data; // Safe, typed data

    // 4. Business Logic (Doctor/Clinic Lookup)
    const doctor = await prisma.user.findUnique({
      where: { id: data.doctorUserId },
      select: {
        id: true,
        name: true,
        clinicId: true,
        clinic: { select: { id: true, priceTier: true } },
      },
    });

    if (!doctor || !doctor.clinicId || !doctor.clinic) {
      return NextResponse.json({ error: "Invalid doctor or clinic." }, { status: 400 });
    }

    // 5. Billing Calculation
    const unitCount = countUnits(data.toothCodes);
    const dueDate = addDays(data.orderDate, 8);
    
    const cost = calculateCaseCost(
        doctor.clinic.priceTier || PriceTier.STANDARD, 
        data.product, 
        unitCount, 
        data.billingType
    );

    // 6. DB Creation
    const created = await prisma.dentalCase.create({
      data: {
        clinicId: doctor.clinic.id,
        doctorUserId: doctor.id,
        assigneeId: session.userId,
        patientAlias: data.patientAlias,
        doctorName: doctor.name ?? null,
        toothCodes: data.toothCodes,
        orderDate: data.orderDate,
        dueDate,
        product: data.product,
        material: data.material || null,
        shade: data.shade || null,
        designPreferences: data.designPreferences || null,
        status: "IN_DESIGN",
        stage: "DESIGN",
        units: unitCount,
        cost,
        billingType: data.billingType,
        invoiced: false,
      },
      select: { id: true },
    });

    // 7. Save Files
    if (data.scanHtml.size > MAX_FILE_BYTES) return NextResponse.json({ error: "Scan file too large." }, { status: 400 });
    await saveCaseFile(data.scanHtml, created.id, "scan_html");

    if (data.rxPdf.size > MAX_FILE_BYTES) return NextResponse.json({ error: "RX file too large." }, { status: 400 });
    await saveCaseFile(data.rxPdf, created.id, "rx_pdf");

    if (data.constructionInfo) await saveCaseFile(data.constructionInfo, created.id, "construction_info");
    if (data.modelTop) await saveCaseFile(data.modelTop, created.id, "model_top");
    if (data.modelBottom) await saveCaseFile(data.modelBottom, created.id, "model_bottom");

    return NextResponse.json({ ok: true, id: created.id });

  } catch (err) {
    console.error("Create case error:", err);
    return NextResponse.json(
      { error: "Something went wrong creating the case." },
      { status: 500 },
    );
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/comments/route.ts
// portal/app/api/cases/[id]/comments/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function POST(
  request: Request,
  props: { params: Promise<{ id: string }> }
) {
  try {
    const session = await getSession();
    if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    const params = await props.params;
    const { id: caseId } = params;
    
    const json = await request.json();
    const { body, attachmentFileId } = json;

    if (!body || !body.trim()) {
      return NextResponse.json({ error: "Body required" }, { status: 400 });
    }

    // 1. Create the comment
    const newComment = await prisma.caseComment.create({
      data: {
        caseId,
        authorId: session.userId,
        body,
      },
    });

    // 2. Link the attachment
    // We cast 'as any' because the Prisma types in node_modules are stale
    // and don't see 'commentId' yet, even though the DB has it.
    if (attachmentFileId) {
      await prisma.caseFile.update({
        where: { id: attachmentFileId },
        data: { 
          commentId: newComment.id 
        } as any, 
      });
    }

    // 3. Fetch result with attachments
    // Casting 'as any' allows us to request 'attachments' despite the stale types.
    const finalComment = await prisma.caseComment.findUnique({
      where: { id: newComment.id },
      include: {
        attachments: true,
      } as any,
    });

    return NextResponse.json(finalComment);
  } catch (error) {
    console.error("Comment error:", error);
    return NextResponse.json({ error: "Internal Error" }, { status: 500 });
  }
}

export async function GET(
  request: Request,
  props: { params: Promise<{ id: string }> }
) {
  const params = await props.params;
  const { id } = params;
  
  const comments = await prisma.caseComment.findMany({
    where: { caseId: id },
    orderBy: { createdAt: "asc" },
    include: {
      attachments: true,
    } as any, // Force TS to accept 'attachments'
  });
  
  return NextResponse.json(comments);
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/transition/route.ts
// portal/app/api/cases/[id]/transition/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import type { Prisma } from "@prisma/client";
import type { CaseStatus, ProductionStage } from "@/lib/types";

// FIX: 'APPROVED' now keeps the stage as 'DESIGN'.
// This ensures the case waits in the Design bucket until the Milling Center downloads it.
function stageForStatus(to: CaseStatus): ProductionStage {
  switch (to) {
    case "IN_MILLING":
      return "MILLING_GLAZING";
    case "SHIPPED":
      return "SHIPPING";
    case "APPROVED":
    default:
      return "DESIGN";
  }
}

export async function POST(
  req: Request,
  ctx: { params: Promise<{ id: string }> }
) {
  const session = await getSession();
  if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { id } = await ctx.params;
  const body = await req.json().catch(() => ({}));
  const to = body?.to as CaseStatus | undefined;
  const note: string | undefined = body?.note;

  if (!to) return NextResponse.json({ error: "Missing 'to' status" }, { status: 400 });

  // FETCH: Include files to check requirements
  const item = await prisma.dentalCase.findUnique({ 
    where: { id },
    include: { files: true }
  });
  
  if (!item) return NextResponse.json({ error: "Not found" }, { status: 404 });

  // Doctors: only APPROVED or CHANGES_REQUESTED on their own case
  if (session.role === "customer") {
    const allowedForDoctor: CaseStatus[] = ["APPROVED", "CHANGES_REQUESTED"];
    if (!allowedForDoctor.includes(to)) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
    if (!session.userId || item.doctorUserId !== session.userId) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
  }

  // LOGIC CHANGE: Guard rail - Validations moved to Approval Step
  if (to === "APPROVED") {
    if (["APPROVED", "IN_MILLING", "SHIPPED"].includes(item.status)) {
      return NextResponse.json({ error: "Case is already approved." }, { status: 400 });
    }

    // CHECK: Ensure mandatory milling files exist BEFORE approval
    const labels = new Set(item.files.map((f) => f.label));
    const missing: string[] = [];
    
    // Check for mandatory production files
    if (!labels.has("construction_info")) missing.push("Construction Info");
    if (!labels.has("model_top")) missing.push("Model Top");
    if (!labels.has("model_bottom")) missing.push("Model Bottom");
    
    if (missing.length > 0) {
       return NextResponse.json({ 
         error: `Cannot Approve Design. Missing files: ${missing.join(", ")}` 
       }, { status: 400 });
    }
  }

  const newStage = stageForStatus(to);
  const at = new Date();

  await prisma.$transaction(async (tx: Prisma.TransactionClient) => {
    await tx.dentalCase.update({
      where: { id },
      data: {
        status: to,
        stage: newStage,
        designedAt: to === "READY_FOR_REVIEW" ? at : item.designedAt,
        milledAt: to === "IN_MILLING" ? at : item.milledAt,
        shippedAt: to === "SHIPPED" ? at : item.shippedAt,
      },
    });

    await tx.statusEvent.create({
      data: {
        caseId: id,
        from: item.status,
        to,
        note: note ?? null,
        actorId: session.userId ?? undefined,
      },
    });
  });

  return NextResponse.json({ ok: true, status: to, stage: newStage, at });
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/shipping/route.ts
// portal/app/api/cases/[id]/shipping/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function POST(
  request: Request,
  { params }: { params: Promise<{ id: string }> } // <--- FIXED TYPE
) {
  try {
    const session = await getSession();
    if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    const { id } = await params; // <--- AWAIT PARAMS
    const json = await request.json();
    const { carrier, tracking, eta } = json;

    const updatedCase = await prisma.dentalCase.update({
      where: { id },
      data: {
        shippingCarrier: carrier,
        trackingNumber: tracking,
        shippingEta: eta ? new Date(eta) : null,
        shippedAt: new Date(), // Auto-set shipped timestamp
        status: "SHIPPED",     // Auto-update status
        stage: "SHIPPING"      // Auto-update stage
      },
    });

    return NextResponse.json({ 
      ok: true, 
      shipping: { 
        carrier: updatedCase.shippingCarrier, 
        tracking: updatedCase.trackingNumber, 
        eta: updatedCase.shippingEta 
      } 
    });
  } catch (error) {
    console.error("Shipping update error:", error);
    return NextResponse.json({ error: "Failed to update shipping" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/assign/route.ts
// app/api/cases/[id]/assign/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function POST(
  req: Request,
  props: { params: Promise<{ id: string }> }
) {
  try {
    const session = await getSession();
    // CHANGED: Only "admin" can assign. "lab" cannot.
    if (!session || session.role !== "admin") {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { id } = await props.params;
    const body = await req.json();
    const { assigneeId } = body;

    // assigneeId can be null (unassigned) or a valid UUID
    if (assigneeId && typeof assigneeId !== "string") {
      return NextResponse.json({ error: "Invalid assignee ID" }, { status: 400 });
    }

    await prisma.dentalCase.update({
      where: { id },
      data: {
        assigneeId: assigneeId || null
      }
    });

    return NextResponse.json({ ok: true });
  } catch (e) {
    console.error("Assignment error:", e);
    return NextResponse.json({ error: "Failed to update assignment" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/review/route.ts
// app/api/cases/[id]/review/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

type Params = {
  params: Promise<{ id: string }>;
};

export async function POST(req: Request, { params }: Params) {
  const session = await getSession();
  if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { id } = await params;
  const { needsReview, question } = await req.json();
  
  if (typeof needsReview !== "boolean") {
    return NextResponse.json({ error: "needsReview boolean required" }, { status: 400 });
  }

  // DIRECT FIX: Use prisma.dentalCase directly
  const item = await prisma.dentalCase.findUnique({ where: { id } });
  if (!item) return NextResponse.json({ error: "Not found" }, { status: 404 });

  if (session.role === "customer") {
    if (!session.clinicId || session.clinicId !== item.clinicId) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
    // Doctors cannot REQUEST a review (they only answer them)
    if (needsReview === true) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
  }

  const data: any = { needsReview };
  if (needsReview) {
    data.reviewQuestion = (question ?? "").toString().slice(0, 500);
    data.reviewRequestedAt = new Date();
  } else {
    data.reviewQuestion = null;
  }

  await prisma.dentalCase.update({ where: { id }, data });
  return NextResponse.json({ ok: true });
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/files/route.ts
// portal/app/api/cases/[id]/files/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import path from "node:path";
import fs from "node:fs/promises";

// FIX: Define FileKind locally since it's a String in schema
const FileKind = {
  STL: "STL",
  PLY: "PLY",
  OBJ: "OBJ",
  PDF: "PDF", // Added PDF
  OTHER: "OTHER"
} as const;
type FileKindType = typeof FileKind[keyof typeof FileKind];

// FIX: Define ProductionStage locally
const ProductionStage = {
  DESIGN: "DESIGN",
  MILLING_GLAZING: "MILLING_GLAZING",
  SHIPPING: "SHIPPING"
} as const;

type Params = Promise<{ id: string }>;

/**
 * Normalizes the slot label coming from the client.
 */
function normalizeSlotLabel(raw: FormDataEntryValue | null): string {
  const lower = (raw ?? "").toString().trim().toLowerCase();

  if (!lower) return "other";
  if (lower === "scan") return "scan";
  if (lower === "design_with_model" || lower === "model_plus_design") {
    return "design_with_model";
  }
  if (lower === "design_only") return "design_only";

  return lower;
}

/**
 * Choose a file extension & FileKind enum based on the incoming filename.
 */
function chooseExtAndKind(
  originalName: string,
  slot: string,
): { ext: string; kind: FileKindType } {
  const lower = originalName.toLowerCase();
  
  // HTML Viewers
  if (lower.endsWith(".html")) return { ext: ".html", kind: FileKind.OTHER };
  if (lower.endsWith(".htm")) return { ext: ".htm", kind: FileKind.OTHER };

  // 3D Formats
  if (lower.endsWith(".stl")) return { ext: ".stl", kind: FileKind.STL };
  if (lower.endsWith(".ply")) return { ext: ".ply", kind: FileKind.PLY };
  if (lower.endsWith(".obj")) return { ext: ".obj", kind: FileKind.OBJ };
  
  // Documents
  if (lower.endsWith(".pdf")) return { ext: ".pdf", kind: FileKind.PDF };
  
  // ✅ FIX: Explicitly handle .constructionInfo files
  if (lower.endsWith(".constructioninfo")) return { ext: ".constructionInfo", kind: FileKind.OTHER };
  if (lower.endsWith(".xml")) return { ext: ".xml", kind: FileKind.OTHER };
  if (lower.endsWith(".txt")) return { ext: ".txt", kind: FileKind.OTHER };

  // Images
  if (lower.endsWith(".png")) return { ext: ".png", kind: FileKind.OTHER };
  if (lower.endsWith(".jpg")) return { ext: ".jpg", kind: FileKind.OTHER };
  if (lower.endsWith(".jpeg")) return { ext: ".jpeg", kind: FileKind.OTHER };

  // Fallbacks
  if (
    slot === "scan" ||
    slot === "design_with_model" ||
    slot === "design_only"
  ) {
    return { ext: ".stl", kind: FileKind.STL };
  }

  return { ext: ".bin", kind: FileKind.OTHER };
}

export async function POST(req: Request, props: { params: Params }) {
  try {
    const session = await getSession();
    if (!session) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { id } = await props.params;

    // ✅ FIX: Use simple FormData() to avoid parsing issues if body is empty/malformed
    let form: FormData;
    try {
        form = await req.formData();
    } catch (e) {
        console.error("FormData parse error:", e);
        return NextResponse.json({ error: "Failed to upload. File might be too large." }, { status: 400 });
    }

    const slotLabel = normalizeSlotLabel(form.get("label"));

    // --- PERMISSIONS LOGIC ---
    if (session.role === "customer") {
        // 1. Verify ownership
        if (session.clinicId) {
            const check = await prisma.dentalCase.findFirst({
                where: { id, clinicId: session.clinicId }
            });
            if (!check) return NextResponse.json({ error: "Forbidden" }, { status: 403 });
        }
        
        // 2. Limit what they can upload
        // "photo" is used for annotations.
        // "scan" is for raw files.
        const allowed = ["scan", "photo", "other"];
        // Note: The annotation tool typically sends label="Photo", which normalizeSlotLabel converts to "other" if not scan/design.
        if (!allowed.includes(slotLabel) && slotLabel !== "other") { 
            // If they try to upload to "design_with_model", block it.
            // But if normalizeSlotLabel returns 'other' for 'Photo', we are good.
        }
    }

    const incomingFiles: File[] = [
      ...(form.getAll("file") as File[]),
      ...(form.getAll("files") as File[]),
    ].filter((f): f is File => f instanceof File);

    if (!incomingFiles.length) {
      return NextResponse.json({ error: "No files uploaded." }, { status: 400 });
    }

    const dentalCase = await prisma.dentalCase.findUnique({
      where: { id },
      select: { id: true, stage: true },
    });

    if (!dentalCase) {
      return NextResponse.json({ error: "Case not found." }, { status: 404 });
    }

    // Guard: Can only upload scans in DESIGN stage
    if (
      slotLabel === "scan" &&
      dentalCase.stage !== ProductionStage.DESIGN
    ) {
      return NextResponse.json(
        { error: "Scan files can only be uploaded while the case is in the DESIGN stage." },
        { status: 400 },
      );
    }

    const uploadsRoot = path.join(process.cwd(), "public", "uploads", id);
    await fs.mkdir(uploadsRoot, { recursive: true });
    const created: any[] = [];

    // Only delete old files for the strict slots (Scan/Design).
    // For Annotations (Photo/Other), we keep adding them.
    const REPLACE_SLOTS = [
      "scan", "design_with_model", "design_only", 
      "scan_html", "design_with_model_html"
    ];

    if (REPLACE_SLOTS.includes(slotLabel)) {
      await prisma.caseFile.deleteMany({
        where: { caseId: id, label: slotLabel },
      });
    }

    for (const file of incomingFiles) {
      const arrayBuffer = await file.arrayBuffer();
      const buf = Buffer.from(arrayBuffer);

      const originalName = (file.name || "file").replace(/\s+/g, "_");

      const { ext, kind } = chooseExtAndKind(originalName, slotLabel);
      
      const hasExt = originalName.toLowerCase().endsWith(ext.toLowerCase()); // Fixed case sensitivity
      const base = hasExt
        ? originalName.slice(0, originalName.length - ext.length)
        : originalName;

      // Add timestamp to photos/annotations to prevent overwriting
      const uniqueSuffix = (!REPLACE_SLOTS.includes(slotLabel)) 
        ? `_${Date.now()}` 
        : "";
      
      const safeName = `${base}${uniqueSuffix}${ext}`;
      const fullPath = path.join(uploadsRoot, safeName);
      
      // UPDATED: Removed HTML injection logic. We write the file exactly as uploaded.
      await fs.writeFile(fullPath, buf);

      const publicUrl = `/uploads/${id}/${safeName}`;

      const rec = await prisma.caseFile.create({
        data: {
          caseId: id,
          label: slotLabel,
          kind: kind,
          url: publicUrl,
          sizeBytes: buf.length,
        },
        select: {
          id: true,
          url: true,
          label: true,
          kind: true,
        },
      });
      created.push(rec);
    }

    return NextResponse.json({ ok: true, id: created[0]?.id, files: created });
  } catch (error) {
    console.error("Upload error:", error);
    return NextResponse.json({ error: "Internal Server Error" }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/cases/[id]/stage/route.ts
// portal/app/api/cases/[id]/stage/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

type Params = {
  params: Promise<{ id: string }>;
};

type Stage = "DESIGN" | "MILLING_GLAZING" | "SHIPPING" | "COMPLETED";
const STAGE_ORDER: Stage[] = ["DESIGN", "MILLING_GLAZING", "SHIPPING", "COMPLETED"];

export async function POST(req: Request, { params }: Params) {
  const session = await getSession();
  if (!session) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  // Basic role check
  if (session.role !== "admin" && session.role !== "lab") {
    return NextResponse.json(
      { error: "Only lab/admin can update the process." },
      { status: 403 },
    );
  }

  const { id } = await params;

  let body: any;
  try {
    body = await req.json();
  } catch {
    return NextResponse.json(
      { error: "Invalid request body." },
      { status: 400 },
    );
  }

  const targetStage = body?.stage as Stage | undefined;
  if (!targetStage || !STAGE_ORDER.includes(targetStage)) {
    return NextResponse.json(
      { error: "Invalid target stage." },
      { status: 400 },
    );
  }

  // LOGIC CHANGE: Lab cannot manually start milling. It happens via download.
  if (targetStage === "MILLING_GLAZING" && session.role === "lab") {
    return NextResponse.json(
        { error: "Lab users cannot manually start milling. This happens automatically when the Milling Center downloads the files." },
        { status: 403 }
    );
  }

  const existing = await prisma.dentalCase.findUnique({
    where: { id },
  });
  
  if (!existing) {
    return NextResponse.json({ error: "Case not found." }, { status: 404 });
  }

  const currentStage = existing.stage as Stage;
  const currentStatus = existing.status as string;

  const currentIndex = STAGE_ORDER.indexOf(currentStage);
  const targetIndex = STAGE_ORDER.indexOf(targetStage);

  if (targetIndex === -1) {
    return NextResponse.json(
      { error: "Unsupported stage." },
      { status: 400 },
    );
  }

  if (targetIndex === currentIndex) {
    return NextResponse.json({ ok: true, stage: currentStage });
  }

  if (targetIndex < currentIndex) {
    return NextResponse.json(
      { error: "Process cannot move backwards." },
      { status: 400 },
    );
  }

  let nextStatus = currentStatus;
  
  if (currentStage === "DESIGN" && targetStage === "MILLING_GLAZING") {
    if (currentStatus !== "APPROVED") {
      return NextResponse.json(
        {
          error:
            "Case must be APPROVED before moving to Milling & Glazing.",
        },
        { status: 400 },
      );
    }
    nextStatus = "IN_MILLING";
  } 
  else if (
    currentStage === "MILLING_GLAZING" &&
    targetStage === "SHIPPING"
  ) {
    nextStatus = "SHIPPED";
  } 
  else if (
    currentStage === "SHIPPING" &&
    targetStage === "COMPLETED"
  ) {
    nextStatus = "COMPLETED";
  }
  else if (currentStage === "DESIGN" && targetStage === "SHIPPING") {
    return NextResponse.json(
      {
        error:
          "Case must go through Milling & Glazing before Shipping.",
      },
      { status: 400 },
    );
  }

  const [updated] = await prisma.$transaction([
    prisma.dentalCase.update({
      where: { id },
      data: {
        stage: targetStage,
        status: nextStatus as any,
      },
      select: { id: true, stage: true, status: true },
    }),
    prisma.statusEvent.create({
      data: {
        caseId: id,
        from: currentStatus,
        to: nextStatus,
        note: null, 
        actorId: session.userId,
      }
    })
  ]);

  return NextResponse.json({ ok: true, stage: updated.stage, status: updated.status });
}
--- END OF FILE ---

FILE: ./app/api/clinics/route.ts
//portal/app/api/clinics/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function GET() {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  // Include address in list for editing
  const clinics = await prisma.clinic.findMany({ 
    orderBy: { name: "asc" },
    include: { address: true, _count: { select: { users: true, cases: true } } }
  });
  return NextResponse.json(clinics);
}

export async function POST(req: Request) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const data = await req.json();
  if (!data.name) return NextResponse.json({ error: "Name required" }, { status: 400 });

  const addr = data.address || {};
  let addressConfig = undefined;
  if (addr.id) {
    addressConfig = { connect: { id: addr.id } };
  } else if (addr.street) {
    addressConfig = {
      create: {
        street: addr.street,
        city: addr.city,
        state: addr.state,
        zipCode: addr.zipCode
      }
    };
  }

  const clinic = await prisma.clinic.create({
    data: {
      name: data.name,
      phone: data.phone,
      billingCycleDay: Number(data.billingCycleDay) || 1,
      paymentTerms: Number(data.paymentTerms) || 30,
      priceTier: data.priceTier || "STANDARD",
      taxId: data.taxId,
      bankName: data.bankName,
      routingNumber: data.routingNumber,
      bankLast4: data.bankLast4,
      address: addressConfig
    }
  });
  return NextResponse.json(clinic);
}
--- END OF FILE ---

FILE: ./app/api/clinics/[id]/route.ts
//portal/app/api/clinics/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function PUT(req: Request, { params }: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  const { id } = await params;
  const data = await req.json();

  const addr = data.address || {};
  let addressConfig = undefined;
  
  if (addr.id) {
    addressConfig = { connect: { id: addr.id } };
  } else if (addr.street) {
    addressConfig = {
      create: {
        street: addr.street,
        city: addr.city,
        state: addr.state,
        zipCode: addr.zipCode
      }
    };
  }

  const clinic = await prisma.clinic.update({
    where: { id },
    data: {
      name: data.name,
      phone: data.phone,
      billingCycleDay: Number(data.billingCycleDay) || 1,
      paymentTerms: Number(data.paymentTerms) || 30,
      priceTier: data.priceTier || "STANDARD",
      taxId: data.taxId,
      bankName: data.bankName,
      routingNumber: data.routingNumber,
      bankLast4: data.bankLast4,
      address: addressConfig
    }
  });
  return NextResponse.json(clinic);
}

// NEW: Delete Clinic
export async function DELETE(req: Request, { params }: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { id } = await params;

  try {
    await prisma.clinic.delete({ where: { id } });
    return NextResponse.json({ ok: true });
  } catch (e: any) {
    return NextResponse.json({ error: "Cannot delete clinic. It likely has users or cases linked." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/addresses/route.ts
// portal/app/api/addresses/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import { Prisma } from "@prisma/client";

export async function GET(req: Request) {
  const session = await getSession();
  if (!session) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  // Only admin and lab users can access address search
  if (session.role !== "admin" && session.role !== "lab") {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const url = new URL(req.url);
  const q = url.searchParams.get("q") || "";

  try {
    const where: Prisma.AddressWhereInput = {};
    
    if (q.trim()) {
      where.OR = [
        { street: { contains: q.trim() } },
        { city: { contains: q.trim() } },
        { state: { contains: q.trim() } },
        { zipCode: { contains: q.trim() } },
      ];
    }

    const addresses = await prisma.address.findMany({
      where,
      orderBy: { createdAt: "desc" },
      take: 50,
    });

    return NextResponse.json(addresses);
  } catch {
    return NextResponse.json({ error: "Failed to fetch addresses." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/addresses/[id]/route.ts
// portal/app/api/addresses/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function DELETE(req: Request, props: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const params = await props.params;
  const { id } = params;

  try {
    // 1. Unlink from Users (Wipe address data from user profiles)
    await prisma.user.updateMany({
      where: { addressId: id },
      data: { addressId: null }
    });

    // 2. Unlink from Clinics (Wipe address data from clinic profiles)
    await prisma.clinic.updateMany({
      where: { addressId: id },
      data: { addressId: null }
    });

    // 3. Delete the Address Record
    await prisma.address.delete({ where: { id } });

    return NextResponse.json({ ok: true });
  } catch (e: any) {
    console.error("Address delete error:", e);
    return NextResponse.json({ error: "Failed to delete address." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/users/new/route.ts
// portal/app/api/users/new/route.ts
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";
import bcrypt from "bcryptjs";
import crypto from "node:crypto";
import { Prisma } from "@prisma/client";
import { Resend } from "resend";
import { CreateUserSchema } from "@/lib/schemas"; // <--- Zod Schema

const resend = process.env.RESEND_API_KEY 
  ? new Resend(process.env.RESEND_API_KEY) 
  : null;

export async function POST(req: Request) {
  try {
    const session = await getSession();
    if (!session || session.role !== "admin") {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const body = await req.json().catch(() => ({}));

    // 1. Zod Validation
    const validation = CreateUserSchema.safeParse(body);
    if (!validation.success) {
      const firstError = validation.error.issues[0];
      return NextResponse.json(
        { error: `${firstError.path.join(".")}: ${firstError.message}` }, 
        { status: 400 }
      );
    }
    const data = validation.data;

    // 2. Check Uniqueness
    const existing = await prisma.user.findUnique({ where: { email: data.email } });
    if (existing) {
      return NextResponse.json({ error: "A user with this email already exists." }, { status: 400 });
    }

    // 3. Clinic Resolution
    let resolvedClinicId: string | null = data.clinicId || null;
    if (!resolvedClinicId && data.newClinicName) {
      const createdClinic = await prisma.clinic.create({ data: { name: data.newClinicName } });
      resolvedClinicId = createdClinic.id;
    }

    // 4. Generate Credentials
    const tempPassword = crypto.randomBytes(6).toString("hex");
    const pw = await bcrypt.hash(tempPassword, 10);

    // 5. Address Logic
    let addressConfig = undefined;
    const addr = data.address;
    if (addr?.id) {
        addressConfig = { connect: { id: addr.id } };
    } else if (addr?.street) {
        addressConfig = {
            create: {
                street: addr.street,
                city: addr.city,
                state: addr.state,
                zipCode: addr.zipCode
            }
        };
    }

    // 6. Create User
    const createData: Prisma.UserCreateInput = {
        email: data.email,
        password: pw,
        name: data.name,
        role: data.role,
        clinic: resolvedClinicId ? { connect: { id: resolvedClinicId } } : undefined,
        phoneNumber: data.phoneNumber || null,
        preferenceNote: data.preferenceNote || null,
        address: addressConfig
    };

    const user = await prisma.user.create({
      data: createData,
      select: { id: true, email: true, name: true },
    });

    // 7. Send Email (Non-blocking failure)
    if (resend) {
        try {
            await resend.emails.send({
                from: process.env.EMAIL_FROM || "onboarding@resend.dev",
                to: data.email,
                subject: "Welcome to Lumera Dental Portal",
                html: `
                    <div style="font-family: sans-serif; color: #111; padding: 20px;">
                        <h2 style="color: #1e1e1e;">Welcome to Lumera</h2>
                        <p>Hello ${data.name || "Doctor"},</p>
                        <p>Your account has been created.</p>
                        <p><strong>Login:</strong> ${data.email}</p>
                        <p><strong>Password:</strong> ${tempPassword}</p>
                        <p><a href="https://lumeradental.com/login">Log in here</a></p>
                    </div>
                `
            });
        } catch (err) {
            console.error("[Email] Failed to send credentials:", err);
        }
    }

    return NextResponse.json({ ok: true, user });
  } catch (e: any) {
    console.error("Create user error:", e);
    return NextResponse.json({ error: "Internal error while creating user." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/api/users/[id]/route.ts
//portal/app/api/users/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { getSession } from "@/lib/auth";

export async function PUT(req: Request, { params }: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { id } = await params;
  const data = await req.json();

  const addr = data.address || {};
  let addressConfig = undefined;
  if (addr.id) {
    addressConfig = { connect: { id: addr.id } };
  } else if (addr.street) {
    addressConfig = {
      create: {
        street: addr.street,
        city: addr.city,
        state: addr.state,
        zipCode: addr.zipCode
      }
    };
  }

  let clinicConfig = undefined;
  if (data.clinicId) {
    clinicConfig = { connect: { id: data.clinicId } };
  } else if (data.clinicId === null || data.clinicId === "") {
    clinicConfig = { disconnect: true };
  }

  const updateData: any = {
    name: data.name,
    email: data.email,
    role: data.role,
    clinic: clinicConfig,
    phoneNumber: data.phoneNumber || null,
    preferenceNote: data.preferenceNote || null,
    address: addressConfig
  };

  const user = await prisma.user.update({
    where: { id },
    data: updateData
  });

  return NextResponse.json(user);
}

// NEW: Delete User
export async function DELETE(req: Request, { params }: { params: Promise<{ id: string }> }) {
  const session = await getSession();
  if (!session || session.role !== "admin") return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { id } = await params;

  try {
    // Delete user (cascade logic depends on schema, but usually safe for users unless they own critical records)
    await prisma.user.delete({ where: { id } });
    return NextResponse.json({ ok: true });
  } catch (e: any) {
    return NextResponse.json({ error: "Failed to delete user. They may have active cases." }, { status: 500 });
  }
}
--- END OF FILE ---

FILE: ./app/page.tsx
// portal/app/page.tsx
"use client";

import { useEffect, useRef } from "react";
import Link from "next/link";
import Image from "next/image";
import PublicNavbar from "@/components/PublicNavbar";
import PublicFooter from "@/components/PublicFooter";

export default function HomePage() {
  // Reveal Animation Logic
  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            e.target.classList.add("in");
          }
        });
      },
      { threshold: 0.1 }
    );
    document.querySelectorAll(".reveal").forEach((el) => observer.observe(el));
    return () => observer.disconnect();
  }, []);

  // Card Tilt Logic
  const cardRef = useRef<HTMLDivElement>(null);
  const handleMove = (e: React.MouseEvent) => {
    if (!cardRef.current) return;
    const r = cardRef.current.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width - 0.5;
    const y = (e.clientY - r.top) / r.height - 0.5;
    cardRef.current.style.transform = `rotateY(${x * 8}deg) rotateX(${-y * 8}deg)`;
  };
  const handleLeave = () => {
    if (cardRef.current) cardRef.current.style.transform = "rotateY(0) rotateX(0)";
  };

  return (
    <main className="min-h-screen flex flex-col bg-background text-porcelain selection:bg-accent selection:text-background">
      <PublicNavbar />

      {/* HERO SECTION */}
      <section className="relative pt-24 pb-20 md:pt-32 md:pb-32 overflow-hidden">
        {/* Background Gradients */}
        <div className="absolute inset-0 pointer-events-none">
          <div className="absolute top-0 right-0 w-[800px] h-[800px] bg-accent/10 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/3" />
          <div className="absolute bottom-0 left-0 w-[600px] h-[600px] bg-blue-500/10 rounded-full blur-[100px] translate-y-1/3 -translate-x-1/4" />
        </div>

        <div className="container mx-auto px-6 relative z-10 grid lg:grid-cols-2 gap-12 items-center">
          {/* Text Content */}
          <div className="space-y-8">
            <h1 className="text-5xl md:text-7xl font-semibold tracking-tight reveal">
              The Crown
            </h1>
            <p className="text-xl md:text-2xl text-white/60 max-w-lg leading-relaxed reveal">
              One product. $60 all-in. Zirconia perfected — no menus, no upsells, no confusion.
            </p>
            <div className="flex flex-wrap gap-4 reveal">
              <Link
                href="/contact"
                className="px-8 py-4 rounded-full bg-white text-background font-bold hover:bg-gray-100 transition shadow-[0_0_30px_rgba(255,255,255,0.2)]"
              >
                Send a Case
              </Link>
              <Link
                href="/work"
                className="px-8 py-4 rounded-full border border-white/20 hover:bg-white/5 transition font-medium backdrop-blur-md"
              >
                See the Craft
              </Link>
            </div>
            <div className="flex items-center gap-3 text-sm text-white/40 reveal">
              <div className="w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_10px_rgba(52,211,153,0.6)]" />
              <span>Made in USA • Delivery in 7 business days</span>
            </div>
          </div>

          {/* 3D Card */}
          <div className="perspective-1000 flex justify-center lg:justify-end reveal">
            <div
              ref={cardRef}
              onMouseMove={handleMove}
              onMouseLeave={handleLeave}
              className="relative w-full max-w-md aspect-[4/5] rounded-[32px] border border-white/10 bg-white/5 backdrop-blur-xl shadow-2xl overflow-hidden transition-transform duration-100 ease-out"
              style={{ transformStyle: "preserve-3d" }}
            >
              {/* Card Glow */}
              <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none" />
              
              <div className="relative p-8 h-full flex flex-col justify-between z-10">
                <div className="flex justify-between items-start">
                  <div className="flex flex-wrap gap-2">
                    <span className="px-3 py-1 rounded-full border border-white/10 bg-white/5 text-xs font-medium">Zirconia</span>
                    <span className="px-3 py-1 rounded-full border border-white/10 bg-white/5 text-xs font-medium">USA</span>
                  </div>
                  <div className="text-right">
                    <div className="text-3xl font-bold text-white">$60</div>
                    <div className="text-xs text-white/50">all-in</div>
                  </div>
                </div>

                {/* Animated GIF - REQUIRES Images/CrownLoop.gif in public folder */}
                <div className="flex-1 flex items-center justify-center my-4">
                  <div className="relative w-64 h-64">
                    <Image 
                      src="/Images/CrownLoop.gif" 
                      alt="Crown" 
                      fill
                      className="object-contain drop-shadow-[0_20px_50px_rgba(150,150,226,0.15)]"
                      unoptimized
                    />
                  </div>
                </div>

                {/* Specs */}
                <div className="grid grid-cols-2 gap-3 text-sm">
                  <div className="p-3 rounded-xl border border-white/10 bg-white/5 flex justify-between items-center">
                    <span className="text-white/50">Strength</span>
                    <span className="font-semibold">1200 MPa</span>
                  </div>
                  <div className="p-3 rounded-xl border border-white/10 bg-white/5 flex justify-between items-center">
                    <span className="text-white/50">Translucency</span>
                    <span className="font-semibold">43%</span>
                  </div>
                  <div className="p-3 rounded-xl border border-white/10 bg-white/5 flex justify-between items-center">
                    <span className="text-white/50">Margin</span>
                    <span className="font-semibold">0.2 mm</span>
                  </div>
                  <div className="p-3 rounded-xl border border-white/10 bg-white/5 flex justify-between items-center">
                    <span className="text-white/50">Material</span>
                    <span className="font-semibold">3Y</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* QUALITY SECTION */}
      <section className="py-24 border-t border-white/5 relative">
        <div className="container mx-auto px-6">
          <div className="max-w-2xl mb-16">
            <h2 className="text-4xl font-semibold mb-6 reveal">Quality without complexity</h2>
            <p className="text-xl text-white/60 leading-relaxed reveal">
              We focus on one thing—zirconia crowns—so every step is tuned for excellence. 
              Our globally distributed design team keeps work moving overnight; US manufacturing ensures consistent quality.
            </p>
          </div>

          <div className="grid md:grid-cols-3 gap-6">
            {[
              { title: "Microscopic fit", desc: "Margins verified under magnification; designed for a consistent passive fit to reduce chairside adjustment." },
              { title: "Global design, local quality", desc: "Overnight responsiveness from our global design team; Made in USA production for precision." },
              { title: "Always responsive", desc: "A highly responsive team with clear communication at every step." }
            ].map((card, i) => (
              <div key={i} className="p-8 rounded-3xl border border-white/10 bg-white/[0.02] hover:bg-white/[0.04] transition reveal">
                <h3 className="text-xl font-medium mb-4">{card.title}</h3>
                <p className="text-white/50 leading-relaxed">{card.desc}</p>
              </div>
            ))}
          </div>
        </div>
      </section>

      <PublicFooter />
    </main>
  );
}
--- END OF FILE ---

FILE: ./app/globals.css
/* portal/app/globals.css */
@import "tailwindcss";

:root {
  --background: #0a1020; /* Midnight Blue */
  --foreground: #f5f7fb;
  --glass-border: rgba(255, 255, 255, 0.1);
  --glass-bg: rgba(17, 27, 45, 0.6); /* Tinted with surface blue */
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
  overflow-x: hidden;
}

/* --- UTILITIES --- */
.glass-panel {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(12px);
}

.perspective-1000 {
  perspective: 1000px;
}

/* --- ANIMATIONS --- */
.reveal {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.8s ease, transform 0.8s ease;
}

.reveal.in {
  opacity: 1;
  transform: translateY(0);
}

/* Custom Scrollbar (Midnight Themed) */
.custom-scrollbar::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: rgba(10, 16, 32, 0.5);
  border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}
--- END OF FILE ---

FILE: ./app/login/page.tsx
// portal/app/login/page.tsx
"use client";

import { FormEvent, useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import Image from "next/image";

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState("admin@lumera.test");
  const [password, setPassword] = useState("password123");
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  async function onSubmit(e: FormEvent) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    try {
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });
      if (!res.ok) {
        let message = "Invalid credentials";
        try {
          const data = await res.json();
          if (data && typeof data.error === "string") {
            message = data.error;
          }
        } catch { /* ignore */ }
        setError(message);
        setLoading(false);
        return;
      }
      router.push("/portal/cases");
    } catch (err) {
      console.error(err);
      setError("Unable to reach server. Please try again.");
      setLoading(false);
    }
  }

  return (
    <main className="min-h-screen bg-background flex items-center justify-center p-6 relative overflow-hidden">
      <div className="absolute inset-0 pointer-events-none">
        <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-accent/5 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/3" />
        <div className="absolute bottom-0 left-0 w-[500px] h-[500px] bg-accent/5 rounded-full blur-[100px] translate-y-1/3 -translate-x-1/4" />
      </div>

      <div className="w-full max-w-sm relative z-10">
        <div className="flex justify-center mb-8">
          <Link href="/" className="flex items-center gap-3 group">
            <Image 
              src="/Images/Lumera-Lab-White-.png" 
              alt="Lumera" 
              width={320} 
              height={80} 
              className="h-16 w-auto"
            />
          </Link>
        </div>

        <form onSubmit={onSubmit} className="w-full space-y-6 border border-white/10 rounded-2xl p-8 bg-white/5 backdrop-blur-xl shadow-2xl">
          <div className="text-center space-y-1">
            <h1 className="text-xl font-medium text-white">Welcome back</h1>
            <p className="text-sm text-white/40">Enter your credentials</p>
          </div>

          <div className="space-y-4">
            <div>
              <label className="text-xs font-medium text-white/60 uppercase tracking-wider block mb-2">Email</label>
              <input type="email" required className="w-full rounded-lg px-4 py-3 bg-black/20 border border-white/10 text-white focus:outline-none focus:border-accent/50 transition-all" value={email} onChange={(e) => setEmail(e.target.value)} />
            </div>
            <div>
              <label className="text-xs font-medium text-white/60 uppercase tracking-wider block mb-2">Password</label>
              <input type="password" required className="w-full rounded-lg px-4 py-3 bg-black/20 border border-white/10 text-white focus:outline-none focus:border-accent/50 transition-all" value={password} onChange={(e) => setPassword(e.target.value)} />
            </div>
          </div>

          {error && (
            <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-200 text-sm text-center">
              {error}
            </div>
          )}

          <button type="submit" disabled={loading} className="w-full rounded-lg py-3 text-sm font-bold bg-accent text-background hover:bg-white transition-colors disabled:opacity-50">
            {loading ? "Signing in..." : "Sign In"}
          </button>
        </form>

        <div className="mt-8 text-center space-y-4">
          <p className="text-sm text-white/40">
            Don&apos;t have an account?{" "}
            <Link href="/signup" className="text-accent hover:text-white transition-colors font-medium">
              Request Access
            </Link>
          </p>
          <Link href="/" className="block text-sm text-white/30 hover:text-white transition-colors">
            ← Back to website
          </Link>
        </div>
      </div>
    </main>
  );
}
--- END OF FILE ---

FILE: ./prisma/schema.prisma
// portal/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- CORE MODELS ------------------------------------------------------------

model Clinic {
  id        String   @id @default(cuid())
  name      String
  
  // LOGISTICS
  addressId String?
  address   Address? @relation(fields: [addressId], references: [id])
  phone     String?
  
  // BILLING & FINANCIALS
  billingCycleDay Int     @default(1) 
  paymentTerms    Int     @default(30) 
  taxId           String?
  priceTier       String  @default("STANDARD") 

  // BANKING REFERENCE
  bankName        String?
  bankLast4       String? 
  routingNumber   String?
  
  // RELATIONS
  users     User[]
  cases     DentalCase[]
  invoices  Invoice[]
  payments  Payment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  password       String   // Hashed
  name           String?
  phoneNumber    String?  
  preferenceNote String? 

  role           String   // customer, lab, admin, milling
  
  // NEW: Token for setting up password after approval
  invitationToken String? @unique 

  // NEW: Default preferences for this doctor
  defaultDesignPreferences String?
  
  clinicId       String?
  clinic         Clinic?  @relation(fields: [clinicId], references: [id])

  addressId      String?
  address        Address? @relation(fields: [addressId], references: [id])

  doctorCases    DentalCase[] @relation("DoctorCases")
  workingCases   DentalCase[] @relation("WorkingCases")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// NEW: Pending Sign-ups
model RegistrationRequest {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String?
  clinicName String
  
  // Address Fields
  street    String?
  city      String?
  state     String?
  zipCode   String?

  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED, PROCESSED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// SHARED ADDRESS MODEL
model Address {
  id        String   @id @default(cuid())
  
  street    String?
  city      String?
  state     String?
  zipCode   String?
  country   String?  @default("USA")

  users     User[]
  clinics   Clinic[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DentalCase {
  id            String @id @default(cuid())
  clinicId      String
  clinic        Clinic @relation(fields: [clinicId], references: [id])
  
  doctorUserId String?
  doctorUser   User?   @relation("DoctorCases", fields: [doctorUserId], references: [id])

  assigneeId   String?
  assigneeUser User?   @relation("WorkingCases", fields: [assigneeId], references: [id])

  patientAlias String
  doctorName   String?
  toothCodes   String

  orderDate     DateTime    @default(now())
  product       String      @default("ZIRCONIA") 

  material      String?
  shade         String?

  // NEW: Preferences specific to this case
  designPreferences String?
  
  billingType   String      @default("BILLABLE") 
  units         Int         @default(1)
  cost          Decimal     @default(0.00)
  isRush        Boolean     @default(false) 
  currency      String      @default("USD")
  invoiced      Boolean     @default(false) 
  
  invoiceId     String?
  invoice       Invoice?    @relation(fields: [invoiceId], references: [id])

  dueDate       DateTime?
  status        String      @default("IN_DESIGN") 
  stage         String      @default("DESIGN")    
  
  designedAt    DateTime?
  milledAt      DateTime?
  shippedAt     DateTime?
  
  shippingCarrier String?
  trackingNumber  String?
  shippingEta     DateTime?

  needsReview       Boolean   @default(false)
  reviewQuestion    String?
  reviewRequestedAt DateTime?
  reviewDeadline    DateTime?

  files    CaseFile[]
  events   StatusEvent[]
  comments CaseComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ PERFORMANCE INDEXES (Added for scalability)
  @@index([clinicId])        // Fast lookup for Clinic Dashboard
  @@index([doctorUserId])    // Fast lookup for Doctor Dashboard
  @@index([status])          // Fast filtering for Admin/Lab
  @@index([createdAt])       // Fast sorting by date
  
  @@map("Case")
}

model Invoice {
  id          String        @id @default(cuid())
  clinicId    String
  clinic      Clinic        @relation(fields: [clinicId], references: [id])
  
  amount      Decimal
  status      String        @default("UNPAID")
  dueDate     DateTime      
  
  periodStart DateTime      
  periodEnd   DateTime      
  
  pdfUrl      String?
  cases       DentalCase[]  
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Payment {
  id          String        @id @default(cuid())
  clinicId    String
  clinic      Clinic        @relation(fields: [clinicId], references: [id])
  
  amount      Decimal
  method      String        
  referenceId String?
  postedAt    DateTime      @default(now())
}

model CaseFile {
  id        String     @id @default(cuid())
  caseId    String
  case      DentalCase @relation(fields: [caseId], references: [id])
  
  label     String?
  kind      String     
  url       String
  sizeBytes Int?
  createdAt DateTime   @default(now())

  commentId String?
  comment   CaseComment? @relation(fields: [commentId], references: [id])
}

model StatusEvent {
  id      String      @id @default(cuid())
  caseId  String
  case    DentalCase  @relation(fields: [caseId], references: [id])
  from    String?
  to      String
  note    String?
  at      DateTime    @default(now())
  actorId String?
}

model CaseComment {
  id        String     @id @default(cuid())
  caseId    String
  case      DentalCase @relation(fields: [caseId], references: [id])
  authorId  String
  body      String
  createdAt DateTime   @default(now())

  attachments CaseFile[]
}
--- END OF FILE ---

FILE: ./next-env.d.ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />
/// <reference path="./.next/types/routes.d.ts" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

--- END OF FILE ---

FILE: ./tailwind.config.ts
// portal/tailwind.config.ts
import type { Config } from "tailwindcss";

export default {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      colors: {
        // Base Backgrounds (Updated to Midnight Blue Theme)
        background: "#0a1020", // Deep Midnight Blue
        surface: "#111b2d",    // Slightly lighter blue for cards/sidebars (Replacing Grey)
        
        // Brand Accents
        accent: "#9696e2",     // Brand purple
        accentHover: "#8282d6", 
        
        // Text Colors
        foreground: "#f5f7fb", // High contrast white
        muted: "#94a3b8",      // Blue-grey for secondary text
        
        // Semantic Colors
        success: "#34d399",    
        warning: "#fbbf24",    
        error: "#f87171",      
      },
      fontFamily: {
        sans: ["var(--font-geist-sans)", "system-ui", "sans-serif"],
      },
    },
  },
  plugins: [],
} satisfies Config;
--- END OF FILE ---

FILE: ./components/CaseDetailSidebar.tsx
// portal/components/CaseDetailSidebar.tsx
"use client";

import { useState, useMemo, useEffect } from "react";
import HtmlViewerUploader from "@/components/HtmlViewerUploader";
import FileUploader from "@/components/FileUploader";
import CommentsPanel from "@/components/CommentsPanel";
import DesignerPicker from "@/components/DesignerPicker";
import { CaseFile } from "@prisma/client";
import type { Role } from "@/lib/types";

type Props = {
  caseId: string;
  role: Role;
  files: CaseFile[];
  comments: any[];
  events: any[];   
  currentUserName: string;
  designPreferences?: string | null;
  assigneeId?: string | null;
  designers?: { id: string; name: string | null; email: string }[];
};

function fmtDate(d?: Date | string | null) {
  if (!d) return "—";
  return new Date(d).toLocaleString();
}

export default function CaseDetailSidebar({
  caseId,
  role,
  files,
  comments,
  events,
  currentUserName,
  designPreferences,
  assigneeId,
  designers = []
}: Props) {
  const STORAGE_KEY = "lumera.sidebarTab";
  const [activeTab, setActiveTab] = useState<"files" | "discussion" | "history" | "preferences">("discussion");
  const isInternal = role === "lab" || role === "admin" || role === "milling";

  useEffect(() => {
    if (typeof window !== "undefined") {
      const saved = window.localStorage.getItem(STORAGE_KEY);
      if (saved && ["files", "discussion", "history", "preferences"].includes(saved)) {
        setActiveTab(saved as any);
      } else {
        setActiveTab(isInternal ? "files" : "discussion");
      }
    }
  }, [isInternal]);

  const handleTabChange = (tab: "files" | "discussion" | "history" | "preferences") => {
    setActiveTab(tab);
    if (typeof window !== "undefined") {
      window.localStorage.setItem(STORAGE_KEY, tab);
    }
  };

  const fileStatus = useMemo(() => {
    const labels = new Set(files.map(f => f.label));
    return {
      scanHtml: labels.has("scan_html"),
      designHtml: labels.has("design_with_model_html"),
      designOnly: labels.has("design_only"),
      rx: labels.has("rx_pdf"),
      construction: labels.has("construction_info"),
      modelTop: labels.has("model_top"),
      modelBottom: labels.has("model_bottom"),
    };
  }, [files]);

  const InternalNav = () => (
    <div className="p-4 border-b border-white/10 bg-[#0a1020]">
      <label className="text-xs font-bold text-accent uppercase tracking-wider mb-2 block">
        View Section
      </label>
      <div className="relative">
        <select
          value={activeTab}
          onChange={(e) => handleTabChange(e.target.value as any)}
          className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white appearance-none focus:border-accent/50 outline-none cursor-pointer"
        >
          <option value="files">📂 Manage Files</option>
          <option value="discussion">💬 Discussion ({comments.length})</option>
          <option value="history">📜 History</option>
          <option value="preferences">⭐ Preferences</option>
        </select>
        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-white/40">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </div>
    </div>
  );

  const CustomerNav = () => (
    <div className="flex border-b border-white/10 bg-[#0a1020]">
      <button
        onClick={() => handleTabChange("discussion")}
        className={`flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${
          activeTab === "discussion" ? "border-accent text-white" : "border-transparent text-white/60 hover:text-white"
        }`}
      >
        Discussion
      </button>
      <button
        onClick={() => handleTabChange("history")}
        className={`flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${
          activeTab === "history" ? "border-accent text-white" : "border-transparent text-white/60 hover:text-white"
        }`}
      >
        History
      </button>
    </div>
  );

  return (
    <div className="flex flex-col h-full rounded-xl border border-white/10 bg-[#0a1020] overflow-hidden shadow-2xl">
      
      {role === "admin" && (
        <div className="p-4 border-b border-white/5 bg-[#0a1020]">
          <div className="text-[10px] font-bold text-white/40 uppercase tracking-wider mb-2">Assigned Designer</div>
          <DesignerPicker caseId={caseId} currentAssigneeId={assigneeId || null} designers={designers} />
        </div>
      )}

      {isInternal ? <InternalNav /> : <CustomerNav />}

      <div className="flex-1 flex flex-col min-h-0 overflow-hidden bg-[#0a1020]">
        
        {isInternal && (
          <div className={`flex-1 overflow-y-auto custom-scrollbar p-4 animate-in fade-in duration-200 ${activeTab === "files" ? "block" : "hidden"}`}>
             <div className="space-y-8">
                <div className="space-y-3">
                    <div className="text-[10px] font-bold text-accent uppercase tracking-wider border-b border-white/5 pb-1">Visualization</div>
                    
                    <div className="bg-white/5 p-3 rounded-lg border border-white/5">
                        <div className="flex items-center justify-between mb-2">
                             <span className="text-xs font-medium text-white/80">Scan HTML</span>
                            {fileStatus.scanHtml && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <HtmlViewerUploader caseId={caseId} role={role} label="scan_html" description="Exocad Web Viewer (Scan)" />
                    </div>

                    <div className="bg-white/5 p-3 rounded-lg border border-white/5">
                        <div className="flex items-center justify-between mb-2">
                            <span className="text-xs font-medium text-white/80">Design HTML</span>
                            {fileStatus.designHtml && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <HtmlViewerUploader caseId={caseId} role={role} label="design_with_model_html" description="Exocad Web Viewer (Design)" />
                    </div>

                    <div className="bg-white/5 p-3 rounded-lg border border-white/5">
                        <div className="flex items-center justify-between mb-2">
                            <span className="text-xs font-medium text-white/80">Design STL</span>
                            {fileStatus.designOnly && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <FileUploader caseId={caseId} role={role} label="design_only" description="Final Design STL" />
                    </div>
                </div>

                <div className="space-y-3">
                    <div className="text-[10px] font-bold text-accent uppercase tracking-wider border-b border-white/5 pb-1">Production</div>
                    
                    <div className="bg-white/5 p-3 rounded-lg border border-white/5 space-y-2">
                        <div className="flex items-center justify-between">
                             <span className="text-xs font-medium text-white/80">Rx PDF</span>
                             {fileStatus.rx && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <FileUploader caseId={caseId} role={role} label="rx_pdf" accept=".pdf" description="Prescription PDF" />
                    </div>

                    <div className="bg-white/5 p-3 rounded-lg border border-white/5 space-y-2">
                        <div className="flex items-center justify-between">
                             <span className="text-xs font-medium text-white/80">Construction Info</span>
                             {fileStatus.construction && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        {/* FIX: Removed explicit 'accept' so it uses the FileUploader default (.pdf,.xml,.txt,.constructionInfo) */}
                        <FileUploader caseId={caseId} role={role} label="construction_info" description="Construction/Milling Params" />
                    </div>

                    <div className="bg-white/5 p-3 rounded-lg border border-white/5 space-y-2">
                        <div className="flex items-center justify-between">
                             <span className="text-xs font-medium text-white/80">Model Top</span>
                             {fileStatus.modelTop && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <FileUploader caseId={caseId} role={role} label="model_top" accept=".stl,.ply" description="Upper Model STL" />
                    </div>

                    <div className="bg-white/5 p-3 rounded-lg border border-white/5 space-y-2">
                        <div className="flex items-center justify-between">
                             <span className="text-xs font-medium text-white/80">Model Bottom</span>
                             {fileStatus.modelBottom && <span className="text-[10px] text-accent">✓ Ready</span>}
                        </div>
                        <FileUploader caseId={caseId} role={role} label="model_bottom" accept=".stl,.ply" description="Lower Model STL" />
                    </div>
                </div>
             </div>
          </div>
        )}

        <div className={`flex-1 flex flex-col min-h-0 p-4 animate-in fade-in duration-200 ${activeTab === "discussion" ? "flex" : "hidden"}`}>
             <CommentsPanel caseId={caseId} comments={comments} canPost={true} currentUserName={currentUserName} currentUserRole={role} />
        </div>

        <div className={`flex-1 overflow-y-auto custom-scrollbar p-4 animate-in fade-in duration-200 ${activeTab === "history" ? "block" : "hidden"}`}>
            {events.length === 0 ? <p className="text-white/60 text-sm">No events yet.</p> : (
              <div className="relative border-l border-white/10 ml-2 space-y-6 pt-2">
                {events.map((ev) => (
                  <div key={ev.id} className="ml-4 relative">
                    <div className="absolute -left-[21px] top-1.5 w-2.5 h-2.5 rounded-full bg-accent border border-black" />
                    <div className="flex flex-col"><span className="text-sm font-medium text-white">{ev.to.replace(/_/g, " ")}</span><span className="text-xs text-white/40 font-mono mt-0.5">{fmtDate(ev.at)}</span></div>
                    {ev.note && <div className="mt-2 text-xs text-white/80 bg-white/5 p-2 rounded border border-white/5 italic">&quot;{ev.note}&quot;</div>}
                  </div>
                ))}
              </div>
            )}
        </div>

        {isInternal && (
          <div className={`flex-1 overflow-y-auto custom-scrollbar p-4 animate-in fade-in duration-200 ${activeTab === "preferences" ? "block" : "hidden"}`}>
            {designPreferences ? (
              <div className="space-y-2">
                <h4 className="text-xs font-bold text-accent uppercase tracking-wider">Doctor Preferences</h4>
                <div className="bg-white/5 border border-white/10 rounded-lg p-3"><p className="text-sm text-white/90 whitespace-pre-wrap leading-relaxed">{designPreferences}</p></div>
              </div>
            ) : (
              <div className="flex flex-col items-center justify-center h-20 text-white/30 text-sm italic">No preferences set for this case.</div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/StageControls.tsx
// portal/components/StageControls.tsx
"use client";

import { useState } from "react";
import ProgressTracker, { Stage } from "@/components/ProgressTracker";

type Role = "customer" | "lab" | "admin";

export default function StageControls({
  caseId,
  stage,
  role,
}: {
  caseId: string;
  stage: Stage;
  role: Role;
}) {
  const [current, setCurrent] = useState<Stage>(stage);
  const canEdit = role === "lab" || role === "admin";

  async function setStage(s: Stage) {
    if (!canEdit) return;
    if (s === current) return;
    
    const previous = current;
    setCurrent(s);

    try {
      const r = await fetch(`/api/cases/${caseId}/stage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ stage: s }),
      });

      if (r.ok) {
        if (typeof window !== "undefined") window.location.reload();
      } else {
        throw new Error("Failed");
      }
    } catch {
      // Removed unused 'e' variable
      setCurrent(previous);
      alert("Failed to update stage");
    }
  }

  return (
    <div className="w-full">
      <ProgressTracker
        stage={current}
        onClickStage={canEdit ? setStage : undefined}
      />
      {!canEdit && (
        <p className="mt-3 text-center text-xs text-white/40">
          Tracking status updated by laboratory.
        </p>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/StatusFilter.tsx
// portal/components/StatusFilter.tsx
"use client";

import { useState, useRef, useEffect } from "react";

const ALL_STATUSES = [
  "IN_DESIGN",
  "CHANGES_REQUESTED",
  "APPROVED",
  "IN_MILLING",
  "SHIPPED",
  "COMPLETED"
];

export default function StatusFilter({ selected }: { selected: string[] }) {
  const [isOpen, setIsOpen] = useState(false);
  const [selection, setSelection] = useState<Set<string>>(new Set(selected));
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    function onClick(e: MouseEvent) {
      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    }
    document.addEventListener("mousedown", onClick);
    return () => document.removeEventListener("mousedown", onClick);
  }, []);

  // Helper: Is the filter in "Default Mode" (Active Only)?
  const isDefault = selection.size === 0;

  const toggle = (status: string) => {
    let next: Set<string>;

    if (isDefault) {
      // Transition from Default (Implicitly all active) to Custom
      // 1. Start with all ACTIVE statuses (everything except COMPLETED)
      next = new Set(ALL_STATUSES.filter(s => s !== "COMPLETED"));
      
      // 2. Apply the toggle
      if (next.has(status)) next.delete(status); // Uncheck if already checked
      else next.add(status); // Check if not checked (e.g. COMPLETED)
    } else {
      // Standard toggle
      next = new Set(selection);
      if (next.has(status)) next.delete(status);
      else next.add(status);
    }
    
    setSelection(next);
  };

  const label = isDefault 
    ? "Status (Current)" 
    : `Status (${selection.size})`;

  const getStatusColor = (s: string) => {
    if (s === "CHANGES_REQUESTED") return "text-red-400";
    if (s === "APPROVED") return "text-lime-300";
    if (s === "IN_MILLING") return "text-purple-400";
    if (s === "SHIPPED") return "text-blue-400";
    if (s === "COMPLETED") return "text-emerald-400";
    return "text-orange-400"; // IN_DESIGN
  };

  return (
    <div className="relative" ref={containerRef}>
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className={`
          flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm border transition-colors
          ${isOpen || !isDefault 
            ? "bg-white/10 border-white/30 text-white" 
            : "bg-black/40 border-white/10 text-white/70 hover:border-white/30"}
        `}
      >
        <span>{label}</span>
        <svg className="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {/* FORM SUBMISSION LOGIC:
        - If isDefault (Active Only), submit NO status inputs. Server defaults to { not: "COMPLETED" }.
        - If !isDefault (Custom), submit the specific statuses.
      */}
      {!isDefault && Array.from(selection).map(s => (
        <input key={s} type="hidden" name="status" value={s} />
      ))}

      {isOpen && (
        <div className="absolute top-full left-0 mt-2 w-64 bg-[#1a1a1a] border border-white/10 rounded-xl shadow-2xl overflow-hidden z-50 p-1">
          <div className="max-h-[300px] overflow-y-auto custom-scrollbar">
            {ALL_STATUSES.map((status) => {
              // VISUAL LOGIC:
              // If Default: Check everything except COMPLETED.
              // If Custom: Check what's in the set.
              const isChecked = isDefault 
                ? status !== "COMPLETED" 
                : selection.has(status);

              const colorClass = getStatusColor(status);
              
              return (
                <div 
                  key={status} 
                  onClick={() => toggle(status)}
                  className="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-white/5 cursor-pointer transition-colors select-none"
                >
                  <div className={`
                    w-4 h-4 rounded border flex items-center justify-center transition-colors shrink-0
                    ${isChecked 
                      ? "bg-blue-500 border-blue-500" 
                      : "border-white/30 bg-transparent"}
                  `}>
                    {isChecked && (
                      <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                      </svg>
                    )}
                  </div>
                  <span className={`text-xs font-medium ${colorClass}`}>
                    {status.replace(/_/g, " ")}
                  </span>
                </div>
              );
            })}
          </div>
          <div className="border-t border-white/10 mt-1 pt-1">
            <button
              type="button"
              onClick={() => setSelection(new Set())}
              className="w-full text-left px-3 py-2 text-xs text-white/40 hover:text-white transition-colors"
            >
              Reset to Current
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/PortalSidebar.tsx
// portal/components/PortalSidebar.tsx
"use client";

import { usePathname } from "next/navigation";
import Link from "next/link";
import { useState } from "react";
import Logo from "./Logo";

// Icons
import { 
  LayoutDashboard, 
  FolderOpen, 
  CreditCard,
  LogOut,
  ChevronRight,
  ChevronLeft,
  ShieldCheck // New Icon for unified Admin
} from "lucide-react";

export default function PortalSidebar({ userRole }: { userRole: string }) {
  const pathname = usePathname();
  const [expanded, setExpanded] = useState(true);
  const [loggingOut, setLoggingOut] = useState(false);

  // FIX: Reduced to 4 key icons (Dashboard, New Case, Billing, Admin)
  const navItems = [
    { label: "Dashboard", href: "/portal/cases", icon: LayoutDashboard, roles: ["customer", "lab", "admin", "milling"] },
    { label: "New Case", href: "/portal/cases/new", icon: FolderOpen, roles: ["lab", "admin"] },
    { label: "Billing", href: "/portal/billing", icon: CreditCard, roles: ["customer", "admin"] },
    // Unified Admin Link
    { label: "Admin", href: "/portal/admin/users", icon: ShieldCheck, roles: ["admin"] },
  ];

  const filteredNav = navItems.filter((item) => item.roles.includes(userRole));

  async function handleLogout() {
    setLoggingOut(true);
    try {
      await fetch("/api/auth/logout", { method: "POST" });
      window.location.href = "/login";
    } catch (e) {
      console.error("Logout failed", e);
      setLoggingOut(false);
    }
  }

  return (
    <aside 
      className={`
        h-full bg-[#0a1020] border-r border-white/5 
        transition-all duration-300 ease-in-out flex flex-col shrink-0 relative
        ${expanded ? "w-64" : "w-20"}
      `}
    >
      {/* Header / Logo - Fixed Height */}
      <div className="h-24 flex items-center justify-center shrink-0 p-6">
        <div className={`${expanded ? "w-48" : "w-8"} transition-all duration-300 flex justify-center items-center`}>
          <Logo showText={expanded} />
        </div>
      </div>

      {/* Navigation */}
      <nav className="flex-1 px-3 py-4 space-y-2 overflow-y-auto custom-scrollbar flex flex-col items-center">
        {filteredNav.map((item) => {
          // Highlight "Admin" if we are on ANY /portal/admin route
          const isActive = item.label === "Admin" 
            ? pathname.startsWith("/portal/admin")
            : pathname === item.href || pathname.startsWith(`${item.href}/`);
            
          const Icon = item.icon;

          return (
            <Link
              key={item.href}
              href={item.href}
              className={`
                h-11 flex items-center rounded-lg transition-all group relative
                ${expanded 
                  ? "w-full px-3 justify-start" 
                  : "w-11 justify-center"
                }
                ${isActive 
                  ? "bg-accent text-background font-bold shadow-none" 
                  : "text-white/60 hover:bg-white/5 hover:text-white"
                }
              `}
              title={!expanded ? item.label : ""}
            >
              <Icon 
                size={20} 
                className={`
                  shrink-0 transition-colors duration-300
                  ${isActive ? "text-background" : "text-white/40 group-hover:text-white"}
                `} 
              />
              
              <span 
                className={`
                  ml-3 font-medium whitespace-nowrap overflow-hidden transition-all duration-300
                  ${expanded ? "opacity-100 w-auto" : "opacity-0 w-0 hidden"}
                `}
              >
                {item.label}
              </span>
            </Link>
          );
        })}
      </nav>

      {/* Footer / Logout */}
      <div className="p-4 border-t border-white/5 bg-[#0a1020] flex flex-col items-center">
        <button 
          onClick={handleLogout}
          disabled={loggingOut}
          className={`
            h-11 flex items-center rounded-lg text-white/40 hover:text-red-400 hover:bg-red-500/10 transition-colors group
            ${expanded 
              ? "w-full px-3 justify-start" 
              : "w-11 justify-center"
            }
          `}
          title={!expanded ? "Sign Out" : ""}
        >
          <LogOut size={20} className="shrink-0 group-hover:scale-110 transition-transform" />
          <span 
             className={`
               ml-3 font-medium whitespace-nowrap transition-all duration-300 overflow-hidden
               ${expanded ? "opacity-100 w-auto" : "opacity-0 w-0 hidden"}
             `}
          >
            {loggingOut ? "..." : "Sign Out"}
          </span>
        </button>

        <button
          onClick={() => setExpanded(!expanded)}
          className="mt-2 w-full flex justify-center py-2 text-white/20 hover:text-accent transition-colors"
        >
          {expanded ? <ChevronLeft size={20} /> : <ChevronRight size={20} />}
        </button>
      </div>
    </aside>
  );
}
--- END OF FILE ---

FILE: ./components/CaseListRow.tsx
// components/CaseListRow.tsx
"use client";

import { useRouter } from "next/navigation";
import CopyableId from "@/components/CopyableId";

type CaseRowData = {
  id: string;
  patientAlias: string;
  toothCodes: string;
  status: string;
  dueDate: Date | null;
  updatedAt: Date;
  doctorName: string | null;
  clinic: { name: string };
  assigneeUser: { name: string | null; email: string } | null;
};

function fmtDate(d?: Date | null) {
  if (!d) return "—";
  return new Date(d).toLocaleDateString();
}

function getInitials(name: string | null, email: string) {
  if (name) {
    const parts = name.split(" ");
    if (parts.length > 1) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    return name.slice(0, 2).toUpperCase();
  }
  return email.slice(0, 2).toUpperCase();
}

// Updated props definition to include 'role'
export default function CaseListRow({ data, role }: { data: CaseRowData, role: string }) {
  const router = useRouter();
  const handleRowClick = (e: React.MouseEvent) => {
    if ((e.target as HTMLElement).closest("button, a")) return;
    router.push(`/portal/cases/${data.id}`);
  };

  const getStatusColor = (s: string) => {
    const status = s.toUpperCase();
    if (status === "CHANGES_REQUESTED") return "bg-red-500/10 text-red-400 border-red-500/20";
    if (status === "COMPLETED") return "bg-emerald-500/10 text-emerald-400 border-emerald-500/20";
    if (status === "SHIPPED") return "bg-blue-500/10 text-blue-400 border-blue-500/20";
    if (status === "IN_MILLING") return "bg-purple-500/10 text-purple-400 border-purple-500/20";
    if (status === "APPROVED") return "bg-lime-500/10 text-lime-300 border-lime-500/20";
    return "bg-orange-500/10 text-orange-400 border-orange-500/20";
  };

  return (
    <tr
      onClick={handleRowClick}
      className="hover:bg-white/5 transition-colors group cursor-pointer border-t border-white/5"
    >
      <td className="p-3">
        <CopyableId id={data.id} truncate />
      </td>
      <td className="p-3 font-medium text-white">
        {data.patientAlias}
      </td>
      <td className="p-3 text-white/70">{data.clinic.name}</td>
      <td className="p-3 text-white/70">{data.doctorName ?? "—"}</td>
      
      {/* CONDITIONAL RENDER: Must match the header logic in page.tsx */}
      {role !== "customer" && (
        <td className="p-3">
            {data.assigneeUser ? (
            <div className="flex items-center gap-2">
                <div className="w-5 h-5 rounded-full bg-blue-500/20 text-blue-300 flex items-center justify-center text-[10px] font-bold border border-blue-500/30">
                {getInitials(data.assigneeUser.name, data.assigneeUser.email)}
                </div>
                <span className="text-white/70 text-xs truncate max-w-[100px]">
                {data.assigneeUser.name || data.assigneeUser.email.split("@")[0]}
                </span>
            </div>
            ) : (
            <span className="text-white/20 text-xs italic">—</span>
            )}
        </td>
      )}

      <td className="p-3 text-white/70">{data.toothCodes}</td>
      <td className="p-3">
        <span
          className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${getStatusColor(
            data.status
          )}`}
        >
          {data.status.replace(/_/g, " ")}
        </span>
      </td>
      <td className="p-3 text-white/70">{fmtDate(data.dueDate)}</td>
      <td className="p-3 text-white/50">{fmtDate(data.updatedAt)}</td>
    </tr>
  );
}
--- END OF FILE ---

FILE: ./components/PublicFooter.tsx
// portal/components/PublicFooter.tsx
export default function PublicFooter() {
  return (
    <footer className="border-t border-white/10 bg-background py-12 text-center">
      <div className="container mx-auto px-6">
        <p className="text-white/40 text-sm">
          © {new Date().getFullYear()} Lumera Dental Lab. All rights reserved.
        </p>
        <p className="text-white/20 text-xs mt-2">
          Made in USA. Designed Globally.
        </p>
      </div>
    </footer>
  );
}
--- END OF FILE ---

FILE: ./components/CopyableId.tsx
// portal/components/CopyableId.tsx
"use client";

import { useState } from "react";

type Props = {
  id: string;
  truncate?: boolean;
};

export default function CopyableId({ id, truncate = false }: Props) {
  const [copied, setCopied] = useState(false);

  const handleCopy = (e: React.MouseEvent) => {
    e.preventDefault(); // Prevent row clicks if nested
    e.stopPropagation();
    
    if (typeof navigator !== "undefined" && navigator.clipboard) {
      navigator.clipboard.writeText(id);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  return (
    <button
      type="button"
      onClick={handleCopy}
      className="group relative inline-flex items-center gap-1.5 rounded px-1.5 py-0.5 hover:bg-white/10 transition-colors cursor-pointer"
      title="Click to copy Case ID"
    >
      <code className="text-xs text-white/50 group-hover:text-white/90 transition-colors font-mono">
        {truncate ? `${id.slice(-6)}...` : id}
      </code>
      
      {/* Visual Feedback */}
      {copied ? (
        <span className="text-[10px] text-green-400 font-medium animate-pulse">
          Copied
        </span>
      ) : (
        /* Hidden copy icon that appears on hover */
        <svg 
          className="w-3 h-3 text-white/30 opacity-0 group-hover:opacity-100 transition-opacity" 
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
      )}
    </button>
  );
}
--- END OF FILE ---

FILE: ./components/AddressPicker.tsx
// portal/components/AddressPicker.tsx
"use client";

import { useEffect, useState, useMemo, useCallback } from "react";
import SearchableSelect from "@/components/SearchableSelect";

export type AddressData = {
  id?: string | null;
  street: string;
  city: string;
  state: string;
  zipCode: string;
};

type Props = {
  value: AddressData;
  onChange: (val: AddressData) => void;
};

export default function AddressPicker({ value, onChange }: Props) {
  const [existing, setExisting] = useState<any[]>([]);
  const [selectedId, setSelectedId] = useState<string>("");

  // Debounce logic for search
  const [searchTerm, setSearchTerm] = useState("");

  // Fetch addresses (filtered by term if present)
  const fetchAddresses = useCallback(async (term: string) => {
    try {
      const qs = term ? `?q=${encodeURIComponent(term)}` : "";
      const res = await fetch(`/api/addresses${qs}`);
      if (res.ok) {
        const data = await res.json();
        if (Array.isArray(data)) setExisting(data);
      }
    } catch (e) {
      console.error("Failed to load addresses", e);
    }
  }, []);

  // Initial load
  useEffect(() => {
    fetchAddresses("");
  }, [fetchAddresses]);

  // Debounced search handler
  useEffect(() => {
    const timer = setTimeout(() => {
        if (searchTerm) fetchAddresses(searchTerm);
    }, 400); // 400ms delay
    return () => clearTimeout(timer);
  }, [searchTerm, fetchAddresses]);

  // Sync internal ID if value changes externally
  useEffect(() => {
    if (value.id) setSelectedId(value.id);
  }, [value.id]);

  const options = useMemo(() => {
    const list = existing.map((addr) => ({
      id: addr.id,
      label: `${addr.street || "Unknown"}, ${addr.city || "Unknown"}`,
      subLabel: `${addr.state || ""} ${addr.zipCode || ""}`
    }));

    // CRITICAL FIX:
    // If the currently selected address (value.id) is NOT in the fetched list (because of pagination/filtering),
    // we must manually add it to the options so the dropdown displays the label correctly instead of "Select...".
    if (value.id && !list.find(o => o.id === value.id)) {
        list.unshift({
            id: value.id,
            label: `${value.street || "Unknown"}, ${value.city || "Unknown"}`,
            subLabel: `${value.state || ""} ${value.zipCode || ""} (Current)`
        });
    }

    return list;
  }, [existing, value]);

  function handleSelectExisting(id: string) {
    // Check both existing list AND the potentially injected current value
    const match = existing.find((a) => a.id === id) 
               || (id === value.id ? { ...value } : null);

    if (match) {
      setSelectedId(id);
      onChange({
        id: match.id,
        street: match.street || "",
        city: match.city || "",
        state: match.state || "",
        zipCode: match.zipCode || ""
      });
    }
  }

  function handleChangeField(field: keyof AddressData, val: string) {
    // Clear ID to imply new/unlinked address
    onChange({ ...value, id: null, [field]: val });
    setSelectedId(""); 
  }

  return (
    <div className="space-y-4 pt-2 border-t border-white/5">
      <div className="flex items-center justify-between">
        <h4 className="text-xs font-bold text-accent uppercase tracking-wider">Address</h4>
        <span className="text-[10px] text-white/40">Search or enter new</span>
      </div>

      {/* Search Bar with Live Search */}
      <SearchableSelect
        label=""
        placeholder="🔍 Search existing addresses..."
        options={options}
        value={selectedId}
        onChange={handleSelectExisting}
        onSearch={setSearchTerm} // Hook up live search
      />

      {/* Manual Fields */}
      <div>
        <input 
          placeholder="Street Address" 
          className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white text-sm focus:border-accent/50 outline-none mb-2 placeholder-white/30"
          value={value.street}
          onChange={(e) => handleChangeField("street", e.target.value)}
        />
        <div className="grid grid-cols-3 gap-2">
          <input 
            placeholder="City" 
            className="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-accent/50 outline-none placeholder-white/30"
            value={value.city}
            onChange={(e) => handleChangeField("city", e.target.value)}
          />
          <input 
            placeholder="State" 
            className="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-accent/50 outline-none placeholder-white/30"
            value={value.state}
            onChange={(e) => handleChangeField("state", e.target.value)}
          />
          <input 
            placeholder="Zip" 
            className="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-accent/50 outline-none placeholder-white/30"
            value={value.zipCode}
            onChange={(e) => handleChangeField("zipCode", e.target.value)}
          />
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/SearchableSelect.tsx
// components/SearchableSelect.tsx
"use client";

import { useState, useRef, useEffect } from "react";

type Option = { id: string; label: string; subLabel?: string };

type Props = {
  label: string;
  options: Option[];
  value: string;
  onChange: (val: string) => void;
  onSearch?: (term: string) => void; // NEW: Callback for server-side search
  placeholder?: string;
  disabled?: boolean;
};

export default function SearchableSelect({ label, options, value, onChange, onSearch, placeholder, disabled }: Props) {
  const [isOpen, setIsOpen] = useState(false);
  const [search, setSearch] = useState("");
  const containerRef = useRef<HTMLDivElement>(null);

  const selectedOption = options.find((o) => o.id === value);

  // Close dropdown when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Handle Search Input
  const handleSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value;
    setSearch(val);
    if (onSearch) {
      onSearch(val); // Trigger server search
    }
  };

  // Filter Logic: If onSearch is provided, we assume parent handles filtering (server-side).
  // Otherwise, we filter locally.
  const displayedOptions = onSearch 
    ? options 
    : options.filter((o) =>
        o.label.toLowerCase().includes(search.toLowerCase()) ||
        (o.subLabel && o.subLabel.toLowerCase().includes(search.toLowerCase()))
      );

  return (
    <div className="space-y-2 relative" ref={containerRef}>
      {label && <label className="text-sm font-medium text-white/70">{label}</label>}
      
      {/* Trigger Button */}
      <button
        type="button"
        disabled={disabled}
        onClick={() => {
          if (!disabled) {
            setIsOpen(!isOpen);
            // Don't clear search immediately so they can keep typing if they re-open? 
            // Standard behavior usually clears or selects text. Let's clear for now.
            if (!isOpen) setSearch(""); 
          }
        }}
        className={`
          w-full rounded-lg bg-black/40 border border-white/10 px-4 py-3 text-left flex items-center justify-between transition
          ${disabled ? "opacity-50 cursor-not-allowed" : "hover:border-white/30 focus:border-blue-500/50"}
        `}
      >
        <div className="flex flex-col items-start truncate">
            <span className={selectedOption ? "text-white" : "text-white/40"}>
            {selectedOption ? selectedOption.label : placeholder || "Select..."}
            </span>
            {selectedOption?.subLabel && (
                <span className="text-[10px] text-white/50">{selectedOption.subLabel}</span>
            )}
        </div>
        
        <svg className="w-4 h-4 text-white/40 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {/* Dropdown Menu */}
      {isOpen && (
        <div className="absolute z-50 w-full mt-1 bg-[#1a1a1a] border border-white/10 rounded-lg shadow-2xl max-h-60 flex flex-col overflow-hidden">
          {/* Search Input */}
          <div className="p-2 border-b border-white/10 sticky top-0 bg-[#1a1a1a]">
            <input
              autoFocus
              value={search}
              onChange={handleSearchChange}
              placeholder="Type to search..."
              className="w-full bg-black/20 text-white text-sm rounded px-3 py-2 border border-white/5 focus:border-blue-500/50 outline-none"
            />
          </div>

          {/* List */}
          <div className="overflow-y-auto flex-1 custom-scrollbar">
            {displayedOptions.length === 0 ? (
              <div className="p-3 text-sm text-white/40 text-center">No results found.</div>
            ) : (
              displayedOptions.map((opt) => (
                <button
                  key={opt.id}
                  type="button"
                  onClick={() => {
                    onChange(opt.id);
                    setIsOpen(false);
                  }}
                  className={`
                    w-full text-left px-4 py-3 text-sm border-b border-white/5 hover:bg-white/10 transition
                    ${value === opt.id ? "bg-blue-500/10 text-blue-300" : "text-white/80"}
                  `}
                >
                  <div className="font-medium">{opt.label}</div>
                  {opt.subLabel && <div className="text-xs text-white/40">{opt.subLabel}</div>}
                </button>
              ))
            )}
          </div>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CaseProcessBar.tsx
// portal/components/CaseProcessBar.tsx
"use client";

import { useState } from "react";
import type { Role, ProductionStage } from "@/lib/types";

const STAGE_ORDER: ProductionStage[] = ["DESIGN", "MILLING_GLAZING", "SHIPPING", "COMPLETED"];
const STAGE_LABEL: Record<ProductionStage, string> = {
  DESIGN: "Designing",
  MILLING_GLAZING: "Milling & Glazing",
  SHIPPING: "Delivering",
  COMPLETED: "Completed",
};

export default function CaseProcessBar({
  caseId,
  stage, 
  status,
  role,
}: {
  caseId: string;
  stage: ProductionStage;
  status: string;
  role: Role;
}) {
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const currentIndex = STAGE_ORDER.indexOf(stage);
  const canEdit = role === "admin" || role === "lab";

  const isApproved = status === "APPROVED" || status === "IN_MILLING" || status === "SHIPPED";
  
  let nextStage: ProductionStage | null = null;
  let nextLabel = "";
  let canAdvance = false;
  let reason = "";

  if (stage === "DESIGN") {
    nextStage = "MILLING_GLAZING";
    nextLabel = "Start Milling";
    
    if (isApproved) {
      // LOGIC CHANGE: Only Admin can force this. Lab must wait for Milling Download.
      if (role === "lab") {
         canAdvance = false;
         reason = "Waiting for Milling Center pickup";
      } else {
         canAdvance = true; // Admin override
      }
    } else {
      canAdvance = false;
      reason = "Requires Design Approval";
    }
  } else if (stage === "MILLING_GLAZING") {
    nextStage = "SHIPPING";
    nextLabel = "Ship Case";
    canAdvance = true; 
  } else if (stage === "SHIPPING") {
    nextStage = "COMPLETED";
    nextLabel = "Complete Case";
    canAdvance = true;
  }

  async function advance() {
    if (!nextStage || !canEdit || !canAdvance) return;
    setBusy(true);
    setErr(null);
    try {
      const res = await fetch(`/api/cases/${caseId}/stage`, {
        method: "POST", 
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ stage: nextStage }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || "Failed");
      
      window.location.reload();
    } catch (e: any) {
      setErr(e?.message);
      setBusy(false);
    }
  }

  return (
    <div className="bg-black/20 border-b border-white/10 p-4">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h2 className="text-sm font-semibold text-white/90">Manufacturing Process</h2>
          <p className="text-xs text-white/50">Current: {STAGE_LABEL[stage]}</p>
        </div>

        {canEdit && nextStage && (
          <div className="flex flex-col items-end">
            <button
              onClick={advance}
              disabled={!canAdvance || busy}
              className={`
                px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-2
                ${canAdvance 
                  ? "bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20" 
                  : "bg-white/5 text-white/30 cursor-not-allowed border border-white/5"}
              `}
            >
              {busy ? "Updating..." : (
                <>
                  {nextLabel} →
                </>
              )}
            </button>
            {!canAdvance && reason && (
              <span className="text-[10px] text-orange-400 mt-1">{reason}</span>
            )}
          </div>
        )}
      </div>

      <div className="relative flex items-center mx-2">
        <div className="absolute left-0 right-0 h-0.5 bg-white/10 top-3" />
        
        <ol className="relative z-10 flex w-full justify-between">
          {STAGE_ORDER.map((s, idx) => {
            const isDone = idx < currentIndex || stage === "COMPLETED";
            const isCurrent = idx === currentIndex;
            
            return (
              <li key={s} className="flex flex-col items-center gap-2">
                <div 
                  className={`
                    w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold border-2 transition-colors
                    ${isDone 
                      ? "bg-blue-500 border-blue-500 text-white" 
                      : isCurrent 
                        ? "bg-black border-blue-500 text-blue-400" 
                        : "bg-black border-white/20 text-white/30"}
                  `}
                >
                  {isDone ? "✓" : idx + 1}
                </div>
                <span 
                  className={`
                    text-[10px] font-medium tracking-wide uppercase
                    ${isCurrent ? "text-blue-300" : "text-white/40"}
                  `}
                >
                  {STAGE_LABEL[s]}
                </span>
              </li>
            );
          })}
        </ol>
      </div>

      {err && <p className="mt-2 text-xs text-center text-red-400">{err}</p>}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/UploadButtons.tsx
// components/UploadButtons.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

type Props = {
  caseId: string;
  label: "SCAN" | "MODEL_PLUS_DESIGN" | "DESIGN_ONLY";
  accept: string;
  title: string;
  disabled?: boolean;
};

export default function UploadButtons({
  caseId,
  label,
  accept,
  title,
  disabled,
}: Props) {
  const [file, setFile] = useState<File | null>(null);
  const [busy, setBusy] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);
  const router = useRouter();

  async function upload() {
    setMsg(null);
    setErr(null);
    if (!file) return setErr("Choose a file first.");
    if (disabled) return setErr("This slot is locked at the current stage.");

    setBusy(true);
    try {
      const fd = new FormData();
      fd.append("label", label);
      // best-effort kind based on extension
      const ext = (file.name.split(".").pop() || "").toLowerCase();
      const kind =
        ext === "stl" ? "STL" : ext === "ply" ? "PLY" : ext === "obj" ? "OBJ" : "OTHER";
      fd.append("kind", kind);
      fd.append("file", file);

      const res = await fetch(`/api/cases/${caseId}/files`, {
        method: "POST",
        body: fd,
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j.error || "Upload failed");

      setMsg("Saved.");
      setFile(null);
      router.refresh();
    } catch (e: any) {
      setErr(e?.message || "Upload failed");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="rounded-xl border border-white/10 p-4">
      <h2 className="font-medium mb-2">{title}</h2>
      <div className="flex items-center gap-3">
        <input
          type="file"
          accept={accept}
          onChange={(e) => setFile(e.target.files?.[0] ?? null)}
          className="text-sm"
          disabled={disabled}
        />
        <button
          type="button"
          className="rounded-md bg-white text-black text-sm px-3 py-1.5 disabled:opacity-50"
          onClick={upload}
          disabled={busy || disabled}
        >
          {busy ? "Uploading…" : "Upload"}
        </button>
      </div>
      {disabled && (
        <p className="text-xs text-white/50 mt-2">
          This slot can’t be changed at the current stage.
        </p>
      )}
      {msg && <p className="text-emerald-400 text-sm mt-2">{msg}</p>}
      {err && <p className="text-red-400 text-sm mt-2">{err}</p>}
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/STLViewer.tsx
// portal/components/STLViewer.tsx
"use client";

import { useEffect, useRef, useState } from "react";
import * as THREE from "three";
import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";

export default function STLViewer({ url }: { url: string }) {
  const ref = useRef<HTMLDivElement | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!ref.current || !url) return;

    let cancelled = false;
    setError(null);

    const container = ref.current;
    const width = container.clientWidth || 400;
    const height = container.clientHeight || 320;

    // 1. Scene Setup
    const scene = new THREE.Scene();
    // FIX: Set background to Midnight Blue (0x0a1020)
    scene.background = new THREE.Color(0x0a1020);

    // 2. Camera
    const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
    camera.position.set(0, 0, 150);

    // 3. Renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
    container.appendChild(renderer.domElement);

    // 4. Lighting
    const ambient = new THREE.AmbientLight(0xffffff, 0.3);
    scene.add(ambient);

    const dirLight = new THREE.DirectionalLight(0xffffff, 2.2);
    dirLight.position.set(15, 25, 20); 
    scene.add(dirLight);

    const fillLight = new THREE.DirectionalLight(0xffffff, 0.6);
    fillLight.position.set(-15, 5, 10);
    scene.add(fillLight);

    const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
    backLight.position.set(0, -10, -20);
    scene.add(backLight);

    const group = new THREE.Group();
    scene.add(group);

    let controls: OrbitControls | undefined;
    let raf = 0;

    const init = async () => {
      const { OrbitControls } = await import("three/examples/jsm/controls/OrbitControls.js");
      const { STLLoader } = await import("three/examples/jsm/loaders/STLLoader.js");
      const { PLYLoader } = await import("three/examples/jsm/loaders/PLYLoader.js");
      const { OBJLoader } = await import("three/examples/jsm/loaders/OBJLoader.js");
      const { mergeVertices } = await import("three/examples/jsm/utils/BufferGeometryUtils.js");

      if (cancelled) return;
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.rotateSpeed = 0.8;

      const fitCameraToObj = (obj: THREE.Object3D) => {
        const box = new THREE.Box3().setFromObject(obj);
        const size = new THREE.Vector3();
        const center = new THREE.Vector3();
        box.getSize(size);
        box.getCenter(center);

        obj.position.sub(center);

        const maxDim = Math.max(size.x, size.y, size.z) || 10;
        const fov = camera.fov * (Math.PI / 180);
        let cameraZ = Math.abs(maxDim / (2 * Math.tan(fov / 2)));
        cameraZ *= 2.0;

        camera.position.set(0, 0, cameraZ);
        camera.lookAt(0, 0, 0);
        controls?.target.set(0, 0, 0);
        controls?.update();
      };

      const processGeometry = (geometry: THREE.BufferGeometry) => {
        geometry.deleteAttribute('normal'); 
        geometry.deleteAttribute('uv');
        let smoothGeometry = mergeVertices(geometry, 1e-4);
        smoothGeometry.computeVertexNormals();
        return smoothGeometry;
      };

      const addMesh = (geometry: THREE.BufferGeometry) => {
        const smoothGeo = processGeometry(geometry);
        const material = new THREE.MeshStandardMaterial({
          color: 0xf0f0f0, 
          roughness: 0.65,   
          metalness: 0.0,    
          flatShading: false,
        });

        const mesh = new THREE.Mesh(smoothGeo, material);
        group.add(mesh);
        fitCameraToObj(mesh);
      };

      const cleanUrl = url.split("?")[0].toLowerCase();
      try {
        if (cleanUrl.endsWith(".stl")) {
          new STLLoader().load(url, (geo) => !cancelled && addMesh(geo), undefined, (err) => !cancelled && handleError(err));
        } else if (cleanUrl.endsWith(".ply")) {
          new PLYLoader().load(url, (geo) => !cancelled && addMesh(geo), undefined, (err) => !cancelled && handleError(err));
        } else if (cleanUrl.endsWith(".obj")) {
          new OBJLoader().load(url, (obj) => {
              if (cancelled) return;
              obj.traverse((child) => {
                if ((child as THREE.Mesh).isMesh) {
                   const mesh = child as THREE.Mesh;
                   const processed = processGeometry(mesh.geometry.clone());
                   mesh.geometry = processed;
                   mesh.material = new THREE.MeshStandardMaterial({ color: 0xf0f0f0, roughness: 0.65, metalness: 0.0 });
                }
              });
              group.add(obj);
              fitCameraToObj(obj);
            }, undefined, (err) => !cancelled && handleError(err)
          );
        } else {
           new STLLoader().load(url, (geo) => !cancelled && addMesh(geo), undefined, (err) => !cancelled && handleError(err));
        }
      } catch (err) {
        handleError(err);
      }
    };

    const handleError = (err: any) => {
      console.error("3D Load Error:", err);
      setError("Failed to load 3D model.");
    };

    init();

    const animate = () => {
      if (cancelled) return;
      raf = requestAnimationFrame(animate);
      controls?.update();
      renderer.render(scene, camera);
    };
    animate();

    const onResize = () => {
      if (!container) return;
      const w = container.clientWidth;
      const h = container.clientHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    };
    window.addEventListener("resize", onResize);
    return () => {
      cancelled = true;
      cancelAnimationFrame(raf);
      window.removeEventListener("resize", onResize);
      renderer.dispose();
      controls?.dispose();
      scene.clear();
      if (container.contains(renderer.domElement)) {
        container.removeChild(renderer.domElement);
      }
    };
  }, [url]);

  return (
    // FIX: Container background also Midnight Blue to match scene
    <div className="relative w-full h-full bg-[#0a1020]">
      <div ref={ref} className="w-full h-full cursor-move" />
      {error && (
        <div className="absolute inset-0 flex items-center justify-center bg-black/60 z-10">
          <p className="text-sm text-red-400 font-medium px-4 py-2 bg-black/80 rounded-md border border-red-500/30">
            {error}
          </p>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/CaseInfo.tsx
// portal/components/new-case/CaseInfo.tsx
"use client";

import { useMemo } from "react";
import { NewCaseState } from "./types";

interface Props {
  data: NewCaseState;
  onChange: (updates: Partial<NewCaseState>) => void;
}

function addDays(d: Date, days: number) {
  const x = new Date(d);
  x.setDate(x.getDate() + days);
  return x;
}

export default function CaseInfo({ data, onChange }: Props) {
  const dueDateDisplay = useMemo(() => {
    const d = new Date(data.orderDate);
    if (isNaN(d.getTime())) return "";
    return addDays(d, 8).toISOString().split("T")[0];
  }, [data.orderDate]);

  return (
    <div className="rounded-xl border border-white/10 bg-black/20 p-6 space-y-6 shadow-lg">
      <h2 className="text-lg font-medium text-white/90 border-b border-white/5 pb-2">
        Case Information
      </h2>
      <div className="grid gap-6 md:grid-cols-2">
        <div className="space-y-2">
          <label className="text-sm font-medium text-white/70">Patient Alias / ID</label>
          <input
            required
            value={data.patientAlias}
            onChange={(e) => onChange({ patientAlias: e.target.value })}
            placeholder="e.g. JD-0425"
            className="w-full rounded-lg bg-black/40 border border-white/10 px-4 py-3 text-white focus:border-blue-500/50 outline-none transition"
          />
        </div>
        <div className="space-y-2">
          <label className="text-sm font-medium text-white/70">Date of Order</label>
          <input
            type="date"
            required
            value={data.orderDate}
            onChange={(e) => onChange({ orderDate: e.target.value })}
            className="w-full rounded-lg bg-black/40 border border-white/10 px-4 py-3 text-white focus:border-blue-500/50 outline-none transition [color-scheme:dark]"
          />
        </div>
        <div className="space-y-2">
          <label className="text-sm font-medium text-white/70">Due Date (Auto +8 Days)</label>
          <input
            readOnly
            disabled
            value={dueDateDisplay}
            className="w-full rounded-lg bg-white/5 border border-white/10 px-4 py-3 text-white/50 cursor-not-allowed"
          />
        </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/Prescription.tsx
"use client";

import { NewCaseState, ProductKind } from "./types";

interface Props {
  data: NewCaseState;
  onChange: (updates: Partial<NewCaseState>) => void;
}

const PRODUCTS = ["ZIRCONIA", "MULTILAYER_ZIRCONIA", "EMAX", "INLAY_ONLAY"];

export default function Prescription({ data, onChange }: Props) {
  return (
    <div className="rounded-xl border border-white/10 bg-black/20 p-6 space-y-6 shadow-lg">
      <h2 className="text-lg font-medium text-white/90 border-b border-white/5 pb-2">
        Prescription
      </h2>
      
      <div className="grid gap-6 md:grid-cols-3">
        <div className="space-y-2">
          <label className="text-sm font-medium text-white/70">Product</label>
          <select
            value={data.product}
            // ✅ FIX: Force cast the string value to the ProductKind type
            onChange={(e) => onChange({ product: e.target.value as ProductKind })}
            className="w-full rounded-lg bg-black/40 border border-white/10 px-4 py-3 text-white focus:border-blue-500/50 outline-none transition appearance-none"
          >
            {PRODUCTS.map(p => (
              <option key={p} value={p} className="bg-gray-900">
                {p.replace(/_/g, " ")}
              </option>
            ))}
          </select>
        </div>
        
        <div className="space-y-2">
          <label className="text-sm font-medium text-white/70">Shade (e.g. A2)</label>
          <input
            value={data.shade}
            onChange={(e) => onChange({ shade: e.target.value })}
            placeholder="A2"
            className="w-full rounded-lg bg-black/40 border border-white/10 px-4 py-3 text-white focus:border-blue-500/50 outline-none transition"
          />
        </div>
        
        <div className="space-y-2">
          <label className="text-sm font-medium text-white/70">Material (Optional)</label>
          <input
            value={data.material}
            onChange={(e) => onChange({ material: e.target.value })}
            placeholder="e.g. Zirconia"
            className="w-full rounded-lg bg-black/40 border border-white/10 px-4 py-3 text-white focus:border-blue-500/50 outline-none transition"
          />
        </div>
      </div>

      <div className="space-y-2">
        <div className="flex justify-between items-center">
            <label className="text-sm font-medium text-white/70">Designer Preferences</label>
            <span className="text-[10px] text-white/40">Auto-filled from doctor profile</span>
        </div>
        <textarea
          value={data.designPreferences}
          onChange={(e) => onChange({ designPreferences: e.target.value })}
          placeholder="E.g. Contacts heavy, light occlusion, open embrasures..."
          className="w-full rounded-lg bg-black/40 border border-white/10 px-4 py-3 text-white focus:border-blue-500/50 outline-none transition h-24 resize-none"
        />
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/TeethSelection.tsx
// portal/components/new-case/TeethSelection.tsx
"use client";

import ToothSelector from "@/components/ToothSelector";

interface Props {
  value: string;
  onChange: (val: string) => void;
}

export default function TeethSelection({ value, onChange }: Props) {
  return (
    <div className="space-y-2">
       <h2 className="text-lg font-medium text-white/90 px-1">Select Teeth *</h2>
       <ToothSelector value={value} onChange={onChange} />
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/types.ts
// portal/components/new-case/types.ts

// 1. Doctor Type
export type Doctor = {
  id: string;
  email: string;
  name: string | null;
  preferenceNote: string | null;
  defaultDesignPreferences: string | null;
  clinic: { id: string; name: string };
};

// 2. Product List (Names only - Prices are in lib/pricing.ts)
export type ProductKind = "ZIRCONIA" | "MULTILAYER_ZIRCONIA" | "EMAX" | "INLAY_ONLAY";

// 3. Main State Interface
export interface NewCaseState {
  doctorUserId: string;
  patientAlias: string;
  toothCodes: string;
  orderDate: string; // YYYY-MM-DD
  product: ProductKind; 
  shade: string;
  material: string;
  designPreferences: string;
  
  // Files
  scanHtml: File | null;
  rxPdf: File | null;
  constructionInfo: File | null;
  modelTop: File | null;
  modelBottom: File | null;
}
--- END OF FILE ---

FILE: ./components/new-case/ProductionFiles.tsx
// portal/components/new-case/ProductionFiles.tsx
"use client";

import { NewCaseState } from "./types";

interface Props {
  data: NewCaseState;
  onChange: (updates: Partial<NewCaseState>) => void;
}

// Recreated Local Helper to match original styling
const FileInput = ({ 
  label, 
  file, 
  accept, 
  req = false, 
  onSelect 
}: { 
  label: string, 
  file: File | null, 
  accept: string, 
  req?: boolean,
  onSelect: (f: File | null) => void 
}) => (
  <div className="space-y-1">
    <div className="flex justify-between items-baseline">
      <label className="text-xs font-medium text-white/70 uppercase tracking-wider">
        {label} {req && <span className="text-blue-400">*</span>}
      </label>
      {file && <span className="text-[10px] text-emerald-400 font-mono">✓ {file.name.slice(0, 20)}...</span>}
    </div>
    <div className="relative group">
      <input
          type="file"
          accept={accept}
          onChange={(e) => onSelect(e.target.files?.[0] || null)}
          className="
          w-full text-sm text-white/60
          file:mr-4 file:py-2.5 file:px-4
          file:rounded-lg file:border-0
          file:text-sm file:font-semibold
          file:bg-blue-600 file:text-white
          hover:file:bg-blue-500 file:transition-colors
          cursor-pointer bg-black/40 rounded-lg border border-white/10 p-2
          "
      />
    </div>
  </div>
);

export default function ProductionFiles({ data, onChange }: Props) {
  return (
    <div className="rounded-xl border border-white/10 bg-black/20 p-6 space-y-4 shadow-lg">
      <h2 className="text-lg font-medium text-white/90 border-b border-white/5 pb-2">
         Production Files
      </h2>
      <div className="grid grid-cols-1 gap-6">
         {/* Mandatory at Start */}
         <div className="grid md:grid-cols-2 gap-6">
            <FileInput 
                label="Scan Viewer (HTML)" 
                file={data.scanHtml} 
                accept=".html" 
                req={true} 
                onSelect={(f) => onChange({ scanHtml: f })} 
            />
            <FileInput 
                label="Rx PDF" 
                file={data.rxPdf} 
                accept=".pdf" 
                req={true} 
                onSelect={(f) => onChange({ rxPdf: f })} 
            />
         </div>

         <div className="w-full h-px bg-white/5" />

         {/* Optional at Start (Mandatory for Milling) */}
         <div>
            <span className="text-[10px] uppercase tracking-wider text-white/40 mb-2 block">
                Optional now (Required before Milling)
            </span>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <FileInput 
                    label="Construction Info" 
                    file={data.constructionInfo} 
                    // ✅ FIX: Added .constructionInfo (and lowercase) to accept
                    accept=".constructionInfo,.constructioninfo" 
                    onSelect={(f) => onChange({ constructionInfo: f })} 
                />
                <FileInput 
                    label="Model Top (STL)" 
                    file={data.modelTop} 
                    accept=".stl,.ply" 
                    onSelect={(f) => onChange({ modelTop: f })} 
                />
                <FileInput 
                    label="Model Bottom (STL)" 
                    file={data.modelBottom} 
                    accept=".stl,.ply" 
                    onSelect={(f) => onChange({ modelBottom: f })} 
                />
            </div>
         </div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/new-case/DoctorSelection.tsx
// portal/components/new-case/DoctorSelection.tsx
"use client";

import { useMemo } from "react";
import SearchableSelect from "@/components/SearchableSelect";
import { Doctor } from "./types";

interface Props {
  doctors: Doctor[];
  selectedId: string;
  onChange: (id: string) => void;
}

export default function DoctorSelection({ doctors, selectedId, onChange }: Props) {
  const options = useMemo(() => {
    return doctors.map((d) => ({
      id: d.id,
      label: d.name ? `${d.name} (${d.email})` : d.email,
      subLabel: d.clinic.name
    }));
  }, [doctors]);

  return (
    <div className="rounded-xl border border-white/10 bg-black/20 p-6 space-y-4 shadow-lg">
      <div className="flex items-center justify-between border-b border-white/5 pb-2">
        <h2 className="text-lg font-medium text-white/90">Doctor Assignment</h2>
        <span className="text-[10px] uppercase tracking-wider text-blue-400 font-bold bg-blue-500/10 px-2 py-1 rounded">
          Required
        </span>
      </div>
      <SearchableSelect
        label="Select Doctor"
        placeholder="Search by name, email, or clinic..."
        options={options}
        value={selectedId}
        onChange={onChange}
      />
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/ShippingEditor.tsx
"use client";
import { useState } from "react";

type Role = "customer" | "lab" | "admin";

export default function ShippingEditor({
  caseId,
  role,
  carrier,
  tracking,
  eta, // ISO string or null
}: {
  caseId: string;
  role: Role;
  carrier?: string | null;
  tracking?: string | null;
  eta?: string | null;
}) {
  const canEdit = role === "lab" || role === "admin";
  const [form, setForm] = useState({
    carrier: carrier ?? "",
    tracking: tracking ?? "",
    // datetime-local wants "YYYY-MM-DDTHH:MM"
    eta: eta ? new Date(eta).toISOString().slice(0, 16) : "",
  });
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | undefined>();

  if (!canEdit) return null;

  async function save() {
    setBusy(true);
    setErr(undefined);
    const body: any = {
      carrier: form.carrier,
      tracking: form.tracking,
      eta: form.eta ? new Date(form.eta).toISOString() : null,
    };
    const r = await fetch(`/api/cases/${caseId}/shipping`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    setBusy(false);
    if (r.ok) {
      if (typeof window !== "undefined") window.location.reload();
    } else {
      const j = await r.json().catch(() => ({}));
      setErr(j.error || "Save failed");
    }
  }

  return (
    <div className="space-y-2">
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <input
          className="rounded-lg p-2 bg-black/40 border border-white/10 text-white"
          placeholder="Carrier"
          value={form.carrier}
          onChange={(e) => setForm({ ...form, carrier: e.target.value })}
        />
        <input
          className="rounded-lg p-2 bg-black/40 border border-white/10 text-white"
          placeholder="Tracking #"
          value={form.tracking}
          onChange={(e) => setForm({ ...form, tracking: e.target.value })}
        />
        <input
          type="datetime-local"
          className="rounded-lg p-2 bg-black/40 border border-white/10 text-white"
          value={form.eta}
          onChange={(e) => setForm({ ...form, eta: e.target.value })}
        />
      </div>
      {err && <p className="text-red-400 text-sm">{err}</p>}
      <button
        onClick={save}
        disabled={busy}
        className="rounded-lg px-3 py-2 bg-white text-black disabled:opacity-60"
      >
        {busy ? "Saving…" : "Save"}
      </button>
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/DesignerPicker.tsx
// components/DesignerPicker.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

type UserOption = {
  id: string;
  name: string | null;
  email: string;
};

type Props = {
  caseId: string;
  currentAssigneeId: string | null;
  designers: UserOption[];
  disabled?: boolean;
};

export default function DesignerPicker({ caseId, currentAssigneeId, designers, disabled }: Props) {
  const router = useRouter();
  const [busy, setBusy] = useState(false);

  async function handleChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const newVal = e.target.value;
    setBusy(true);
    
    try {
      const res = await fetch(`/api/cases/${caseId}/assign`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ assigneeId: newVal || null }),
      });
      if (!res.ok) throw new Error("Failed");
      
      router.refresh();
    } catch (err) {
      alert("Failed to update assignment.");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className={`flex items-center gap-3 bg-white/5 rounded-lg px-3 py-2 border border-white/10 ${disabled ? "opacity-50" : "hover:border-accent/50 transition-colors"}`}>
      {/* FIX: Icon matches brand accent */}
      <svg className="w-4 h-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
      <div className="flex-1">
        <select
          value={currentAssigneeId || ""}
          onChange={handleChange}
          disabled={busy || disabled}
          className={`w-full bg-transparent border-none text-sm text-white focus:ring-0 p-0 ${
            disabled ? "cursor-not-allowed" : "cursor-pointer"
          }`}
        >
          <option value="" className="bg-[#0a1020] text-white/50">-- Unassigned --</option>
          {designers.map(d => (
            <option key={d.id} value={d.id} className="bg-[#0a1020] text-white">
              {d.name || d.email}
            </option>
          ))}
        </select>
      </div>
      {busy && <span className="text-[10px] text-accent animate-pulse">...</span>}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/NewCaseForm.tsx
// portal/components/NewCaseForm.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { Doctor, NewCaseState } from "./new-case/types";

// Imported Refactored Blocks
import DoctorSelection from "./new-case/DoctorSelection";
import CaseInfo from "./new-case/CaseInfo";
import Prescription from "./new-case/Prescription";
import ProductionFiles from "./new-case/ProductionFiles";
import TeethSelection from "./new-case/TeethSelection";

function getPref(d?: Doctor) {
  if (!d) return "";
  return d.preferenceNote || d.defaultDesignPreferences || "";
}

function friendly(e: unknown): string {
  const s = String((e as any)?.message || e || "");
  if (/order date invalid/i.test(s)) return "Invalid date. Please use the date picker.";
  return s || "Please correct the highlighted fields and try again.";
}

export default function NewCaseForm({ doctors }: { doctors: Doctor[] }) {
  const router = useRouter();
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);
  const [ok, setOk] = useState<string | null>(null);

  // Initial State
  const [formData, setFormData] = useState<NewCaseState>({
    doctorUserId: doctors[0]?.id || "",
    patientAlias: "",
    toothCodes: "",
    orderDate: new Date().toISOString().split("T")[0],
    product: "ZIRCONIA",
    shade: "",
    material: "",
    designPreferences: getPref(doctors[0]),
    scanHtml: null,
    rxPdf: null,
    constructionInfo: null,
    modelTop: null,
    modelBottom: null,
  });

  // State Update Helper
  const updateState = (updates: Partial<NewCaseState>) => {
    setFormData((prev) => ({ ...prev, ...updates }));
    setErr(null);
  };

  // Special handler for Doctor change to auto-fill prefs
  const handleDoctorChange = (id: string) => {
    const doc = doctors.find((d) => d.id === id);
    updateState({ 
        doctorUserId: id,
        designPreferences: doc ? getPref(doc) : formData.designPreferences
    });
  };

  async function submit(e: React.FormEvent) {
    e.preventDefault();
    setErr(null);
    setOk(null);

    // Validation
    if (!formData.doctorUserId) return setErr("Please select a doctor account.");
    if (!formData.patientAlias.trim()) return setErr("Alias is required.");
    if (!formData.toothCodes.trim()) return setErr("Tooth codes are required.");
    if (!formData.scanHtml) return setErr("Please upload a scan viewer HTML file.");
    if (!formData.rxPdf) return setErr("Please upload the Rx PDF.");

    setBusy(true);

    try {
      const fd = new FormData();
      // Text Fields
      fd.append("patientAlias", formData.patientAlias.trim());
      fd.append("doctorUserId", formData.doctorUserId);
      fd.append("toothCodes", formData.toothCodes.trim());
      fd.append("orderDate", new Date(formData.orderDate).toISOString());
      fd.append("product", formData.product);
      if (formData.material) fd.append("material", formData.material);
      if (formData.shade) fd.append("shade", formData.shade);
      if (formData.designPreferences) fd.append("designPreferences", formData.designPreferences);

      // Files
      if (formData.scanHtml) fd.append("scanHtml", formData.scanHtml);
      if (formData.rxPdf) fd.append("rxPdf", formData.rxPdf);
      if (formData.constructionInfo) fd.append("constructionInfo", formData.constructionInfo);
      if (formData.modelTop) fd.append("modelTop", formData.modelTop);
      if (formData.modelBottom) fd.append("modelBottom", formData.modelBottom);

      const r = await fetch("/api/cases/new", { method: "POST", body: fd });
      const j = await r.json().catch(() => ({}));
      
      if (!r.ok) throw new Error(j.error || "Create failed");
      
      setOk("Case created. Redirecting…");
      router.push(`/portal/cases/${encodeURIComponent(j.id)}`);
    } catch (e: any) {
      setErr(friendly(e));
      setBusy(false);
    }
  }

  return (
    <div className="flex-1 min-h-0 w-full max-w-5xl mx-auto overflow-y-auto custom-scrollbar pr-2 pb-20">
      <form onSubmit={submit} className="space-y-6">
        
        {/* 1. Doctor */}
        <DoctorSelection 
            doctors={doctors} 
            selectedId={formData.doctorUserId} 
            onChange={handleDoctorChange} 
        />

        {/* 2. Info */}
        <CaseInfo data={formData} onChange={updateState} />

        {/* 3. Prescription */}
        <Prescription data={formData} onChange={updateState} />

        {/* 4. Files */}
        <ProductionFiles data={formData} onChange={updateState} />

        {/* 5. Teeth */}
        <TeethSelection value={formData.toothCodes} onChange={(val) => updateState({ toothCodes: val })} />

        {/* Footer Actions */}
        <div className="flex flex-col items-end gap-3 pt-6 border-t border-white/10">
          {err && <p className="text-red-400 text-sm font-medium bg-red-500/10 px-3 py-1 rounded">{err}</p>}
          {ok && <p className="text-emerald-400 text-sm font-medium bg-emerald-500/10 px-3 py-1 rounded">{ok}</p>}
          
          <button
            type="submit"
            disabled={busy}
            className="px-8 py-3 rounded-lg bg-white text-black font-bold hover:bg-gray-200 transition disabled:opacity-50 shadow-[0_0_20px_rgba(255,255,255,0.1)]"
          >
            {busy ? "Creating Case..." : "Create Case"}
          </button>
        </div>
      </form>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/Comments.tsx
// portal/components/Comments.tsx
"use client";

import { useEffect, useState } from "react";

// Helper to detect if a line is an image URL
function extractImage(body: string) {
  const imgRegex = /(https?:\/\/[^\s]+|\/uploads\/[^\s]+)\.(jpg|jpeg|png|gif|webp)/i;
  const match = body.match(imgRegex);
  
  if (match) {
    return {
      imageUrl: match[0],
      text: body.replace(match[0], "").trim(),
    };
  }
  return { imageUrl: null, text: body };
}

export default function Comments({ caseId }: { caseId: string }) {
  const [items, setItems] = useState<any[]>([]);
  const [body, setBody] = useState("");
  const [loading, setLoading] = useState(true);
  const [posting, setPosting] = useState(false);
  const [error, setError] = useState<string | undefined>();

  async function load() {
    setLoading(true);
    setError(undefined);
    try {
      const r = await fetch(`/api/cases/${caseId}/comments`, { cache: "no-store" });
      const j = await r.json();
      if (!r.ok) throw new Error(j.error || "Failed to load comments");
      setItems(j.comments ?? []);
    } catch (e: any) {
      setError(e.message || "Failed to load");
    } finally {
      setLoading(false);
    }
  }

  async function post() {
    if (!body.trim()) return;
    setPosting(true);
    setError(undefined);
    try {
      const r = await fetch(`/api/cases/${caseId}/comments`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ body }),
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.error || "Failed to post");
      setBody("");
      await load();
    } catch (e: any) {
      setError(e.message || "Failed to post");
    } finally {
      setPosting(false);
    }
  }

  useEffect(() => { load(); /* eslint-disable-next-line */ }, [caseId]);

  return (
    <div className="space-y-4">
      {loading ? (
        <p className="text-white/60 text-sm">Loading comments…</p>
      ) : error ? (
        <p className="text-red-400 text-sm">{error}</p>
      ) : (
        <div className="space-y-3">
          {items.length === 0 && <p className="text-white/60 text-sm">No comments yet.</p>}
          {items.map((c) => {
            const { imageUrl, text } = extractImage(c.body);
            return (
              <div key={c.id} className="rounded-lg border border-white/10 p-3 bg-white/5">
                <div className="text-[10px] uppercase tracking-wide text-white/40 mb-2">
                  {new Date(c.createdAt).toLocaleString()}
                </div>
                
                {imageUrl && (
                  <div className="mb-2 rounded overflow-hidden border border-white/10 bg-black/50">
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img 
                      src={imageUrl} 
                      alt="Attachment" 
                      className="max-w-full h-auto object-contain max-h-60"
                    />
                  </div>
                )}
                
                {text && <div className="whitespace-pre-wrap text-sm text-white/90">{text}</div>}
              </div>
            );
          })}
        </div>
      )}

      <div className="flex gap-2 items-start pt-2 border-t border-white/10">
        <input
          value={body}
          onChange={(e) => setBody(e.target.value)}
          placeholder="Write a comment…"
          className="flex-1 rounded-lg p-2 bg-black/40 border border-white/10 text-white text-sm focus:border-white/30 outline-none transition"
          onKeyDown={(e) => e.key === "Enter" && !e.shiftKey && post()}
        />
        <button
          onClick={post}
          disabled={posting || !body.trim()}
          className="rounded-lg px-3 py-2 bg-white text-black text-sm font-medium disabled:opacity-50 hover:bg-white/90 transition"
        >
          {posting ? "..." : "Post"}
        </button>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CasePreviewSwitcher.tsx
// portal/components/CasePreviewSwitcher.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import dynamic from "next/dynamic"; // <--- 1. Import dynamic

// <--- 2. Lazy Load
const Case3DPanel = dynamic(() => import("@/components/Case3DPanel"), {
  ssr: false,
  loading: () => <div className="w-full h-full bg-black/10 animate-pulse" />,
});

type SlotKey = "scan" | "design_with_model" | "design_only";

const SLOT_LABEL: Record<SlotKey, string> = {
  scan: "Scan",
  design_with_model: "Design + Model",
  design_only: "Design Only",
};

export default function CasePreviewSwitcher({
  scanUrl,
  designWithModelUrl,
  designOnlyUrl,
}: {
  scanUrl?: string | null;
  designWithModelUrl?: string | null;
  designOnlyUrl?: string | null;
}) {
  const slotUrls = useMemo(() => ({
    scan: scanUrl,
    design_with_model: designWithModelUrl,
    design_only: designOnlyUrl,
  }), [scanUrl, designWithModelUrl, designOnlyUrl]);

  const [selected, setSelected] = useState<SlotKey>("scan");

  useEffect(() => {
    if (typeof window === "undefined") return;

    const stored = window.localStorage.getItem("lumera.casePreviewSlot") as SlotKey | null;
    const order: SlotKey[] = ["design_with_model", "design_only", "scan"];

    if (stored && slotUrls[stored]) {
      setSelected(stored);
      return;
    }

    for (const key of order) {
      if (slotUrls[key]) {
        setSelected(key);
        return;
      }
    }

    setSelected("scan");
  }, [slotUrls]);

  const activeUrl = useMemo(
    () => slotUrls[selected] ?? null,
    [slotUrls, selected],
  );

  function handleSelect(key: SlotKey) {
    if (!slotUrls[key]) return;
    setSelected(key);
    if (typeof window !== "undefined") {
      window.localStorage.setItem("lumera.casePreviewSlot", key);
    }
  }

  return (
    <div className="rounded-xl border border-white/10 p-4 h-full flex flex-col">
      <div className="flex items-center justify-between mb-3 gap-3">
        <h2 className="font-medium">
          3D Preview
          {activeUrl ? (
            <span className="ml-2 text-xs text-white/60">
              ({SLOT_LABEL[selected]})
            </span>
          ) : null}
        </h2>
        <div className="inline-flex rounded-full bg-black/40 border border-white/10 overflow-hidden">
          {(Object.keys(slotUrls) as SlotKey[]).map((key) => {
            const enabled = !!slotUrls[key];
            return (
              <button
                key={key}
                type="button"
                disabled={!enabled}
                onClick={() => enabled && handleSelect(key)}
                className={[
                  "px-3 py-1 text-xs sm:text-sm",
                  "transition-colors",
                  enabled
                    ? selected === key
                      ? "bg-white text-black"
                      : "text-white/80 hover:bg-white/10"
                    : "text-white/30 cursor-not-allowed",
                ].join(" ")}
              >
                {SLOT_LABEL[key]}
              </button>
            );
          })}
        </div>
      </div>

      <div className="flex-1 min-h-[16rem]">
        <Case3DPanel url={activeUrl ?? null} />
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CaseActions.tsx
// portal/components/CaseActions.tsx
"use client";

import { useState } from "react";
import type { Role } from "@/lib/types";

type Props = {
  caseId: string;
  role: Role;
  currentStatus: string;
};

export default function CaseActions({ caseId, role, currentStatus }: Props) {
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  async function change(to: string) {
    setBusy(true);
    setErr(null);
    try {
      const r = await fetch(`/api/cases/${caseId}/transition`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ to }), 
      });
      
      const j = await r.json().catch(() => ({}));
      
      if (r.ok) {
        window.location.reload();
      } else {
        throw new Error(j.error || "Action failed");
      }
    } catch (e: any) {
      setErr(e.message);
      setBusy(false);
      // Auto-clear error after 5 seconds
      setTimeout(() => setErr(null), 5000);
    }
  }

  const isApproved = 
    currentStatus === "APPROVED" ||
    currentStatus === "IN_MILLING" || 
    currentStatus === "SHIPPED" ||
    currentStatus === "COMPLETED";
  
  const canCustomer = new Set(["APPROVED", "CHANGES_REQUESTED"]);
  
  const showApprove = !isApproved && (role !== "customer" || canCustomer.has("APPROVED"));
  const showRequest = !isApproved && (role !== "customer" || canCustomer.has("CHANGES_REQUESTED"));

  if (isApproved) return null; 

  return (
    // FIX: 'relative' establishes the anchor for the absolute error message
    <div className="relative flex items-center gap-2">
      {showRequest && (
        <button 
          onClick={() => change("CHANGES_REQUESTED")} 
          disabled={busy}
          className="px-3 py-1.5 rounded-md border border-white/20 hover:bg-white/10 transition text-white text-xs font-medium disabled:opacity-50"
        >
          Request Changes
        </button>
      )}
      
      {showApprove && (
        <button 
          onClick={() => change("APPROVED")} 
          disabled={busy}
          className="px-3 py-1.5 rounded-md bg-white text-black text-xs font-bold hover:bg-gray-200 transition shadow-lg shadow-white/5 disabled:opacity-50"
        >
          {busy ? "Updating..." : "Approve Design"}
        </button>
      )}

      {/* FIX: 'absolute' takes it out of flow so it doesn't stretch the header */}
      {err && (
        <div className="absolute top-full right-0 mt-3 z-50 w-max max-w-[250px] bg-[#1a1a1a] border border-red-500/30 text-red-200 text-xs px-3 py-2 rounded-lg shadow-2xl animate-in fade-in slide-in-from-top-1">
          <div className="flex items-center gap-2">
            <svg className="w-4 h-4 text-red-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{err}</span>
          </div>
          {/* Little arrow pointing up */}
          <div className="absolute -top-1 right-4 w-2 h-2 bg-[#1a1a1a] border-t border-l border-red-500/30 rotate-45" />
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/ReviewToggle.tsx
"use client";

import { useState } from "react";

type Role = "customer" | "lab" | "admin";

export default function ReviewToggle({
  caseId,
  role,
  needsReview,
  reviewQuestion,
}: {
  caseId: string;
  role: Role;
  needsReview: boolean;
  reviewQuestion?: string | null;
}) {
  const canEdit = role === "lab" || role === "admin";
  const [busy, setBusy] = useState(false);

  if (!canEdit) return null;

  async function request() {
    const q = prompt("What should the doctor review? (short)");
    if (q == null) return;
    setBusy(true);
    const r = await fetch(`/api/cases/${caseId}/review`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ needsReview: true, question: q }),
    });
    setBusy(false);
    if (r.ok) location.reload();
    else alert((await r.json()).error || "Failed");
  }

  async function clearReview() {
    if (!confirm("Clear doctor review?")) return;
    setBusy(true);
    const r = await fetch(`/api/cases/${caseId}/review`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ needsReview: false }),
    });
    setBusy(false);
    if (r.ok) location.reload();
    else alert((await r.json()).error || "Failed");
  }

  return (
    <div className="space-y-2">
      {needsReview ? (
        <>
          <p className="text-amber-300 text-sm">
            Review requested{reviewQuestion ? `: ${reviewQuestion}` : ""}
          </p>
          <div className="flex gap-2">
            <button
              onClick={request}
              disabled={busy}
              className="rounded-lg px-3 py-2 border border-white/20"
            >
              Update question
            </button>
            <button
              onClick={clearReview}
              disabled={busy}
              className="rounded-lg px-3 py-2 bg-white text-black"
            >
              Clear review
            </button>
          </div>
        </>
      ) : (
        <button
          onClick={request}
          disabled={busy}
          className="rounded-lg px-3 py-2 border border-white/20"
        >
          Request Doctor Review
        </button>
      )}
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/ProgressTracker.tsx
// portal/components/ProgressTracker.tsx
"use client";

// Export this type so others can reuse it if needed
export type Stage = "DESIGN" | "MILLING_GLAZING" | "SHIPPING";

const STAGES: Stage[] = ["DESIGN", "MILLING_GLAZING", "SHIPPING"];

export default function ProgressTracker({
  stage,
  onClickStage,
}: {
  stage: Stage;
  onClickStage?: (stage: Stage) => void;
}) {
  const activeIdx = STAGES.indexOf(stage);

  return (
    <div className="rounded-xl border border-white/10 p-4">
      <div className="flex items-center justify-between gap-2">
        {STAGES.map((s, i) => {
          const done = i < activeIdx;
          const active = i === activeIdx;
          const isClickable = !!onClickStage;

          return (
            <button
              key={s}
              type="button"
              onClick={() => isClickable && onClickStage(s)}
              disabled={!isClickable}
              className={`
                flex-1 py-2 rounded-lg text-xs font-medium border transition-all
                ${active
                  ? "bg-white text-black border-white shadow-md scale-105"
                  : done
                  ? "bg-white/20 text-white border-white/20"
                  : "bg-white/5 text-white/40 border-white/5"}
                ${isClickable ? "cursor-pointer hover:bg-white/10" : "cursor-default"}
              `}
            >
              {s.replace("_", " ")}
            </button>
          );
        })}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/UserForm.tsx
// components/UserForm.tsx
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";
import AddressPicker, { AddressData } from "@/components/AddressPicker";
type Clinic = { id: string; name: string };

export default function UserForm({ clinics, initialData, onClose }: { clinics: Clinic[], initialData?: any, onClose?: () => void }) {
  const router = useRouter();
  const [formData, setFormData] = useState({
    name: initialData?.name || "",
    email: initialData?.email || "",
    role: initialData?.role || "customer",
    clinicId: initialData?.clinicId || clinics[0]?.id || "",
    newClinicName: "",
    phoneNumber: initialData?.phoneNumber || "",
    preferenceNote: initialData?.preferenceNote || "",
  });
  const [address, setAddress] = useState<AddressData>({
    id: initialData?.address?.id || null,
    street: initialData?.address?.street || "",
    city: initialData?.address?.city || "",
    state: initialData?.address?.state || "",
    zipCode: initialData?.address?.zipCode || ""
  });
  const [loading, setLoading] = useState(false);
  const [msg, setMsg] = useState("");
  const [error, setError] = useState("");

  const isEdit = !!initialData;
  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setLoading(true);
    setError("");
    setMsg("");
    try {
      const url = isEdit ? `/api/users/${initialData.id}` : "/api/users/new";
      const method = isEdit ? "PUT" : "POST";

      const payload = { ...formData, address };
      if (payload.newClinicName) delete (payload as any).clinicId;
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed");

      setMsg(isEdit ? "User updated!" : "User created!");
      if (!isEdit) {
        setFormData({
          name: "", email: "", role: "customer",
          clinicId: clinics[0]?.id || "", newClinicName: "",
          phoneNumber: "", preferenceNote: ""
        });
        setAddress({ id: null, street: "", city: "", state: "", zipCode: "" });
      }
      
      router.refresh();
      if (onClose) setTimeout(onClose, 800);
    } catch (err: any) {
      setError(err.message || "Error saving user.");
    } finally {
      setLoading(false);
    }
  }

  return (
    // FIX: Changed bg-[#1e1e1e] to bg-[#111b2d] (Midnight Surface)
    <form onSubmit={handleSubmit} className="space-y-6 max-w-lg bg-[#111b2d] p-6 rounded-xl border border-white/10 shadow-2xl">
      <h3 className="text-lg font-medium text-white mb-4">{isEdit ? "Edit User" : "New User"}</h3>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-xs font-medium text-white/60 mb-1 uppercase">Name</label>
          <input type="text" className="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-accent/50 outline-none"
            value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} placeholder="Full Name" />
        </div>
        <div>
          <label className="block text-xs font-medium text-white/60 mb-1 uppercase">Role</label>
          <select className="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-accent/50 outline-none"
            value={formData.role} onChange={(e) => setFormData({...formData, role: e.target.value})}>
            <option value="customer">Doctor (Customer)</option>
            <option value="lab">Lab Tech</option>
            <option value="admin">Admin</option>
            <option value="milling">Milling Center</option>
          </select>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
            <label className="block text-xs font-medium text-white/60 mb-1 uppercase">Email</label>
            <input type="email" required className="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-accent/50 outline-none"
            value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} placeholder="email@example.com" />
        </div>
        <div>
            <label className="block text-xs font-medium text-white/60 mb-1 uppercase">Phone</label>
            <input type="text" className="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-accent/50 outline-none"
            value={formData.phoneNumber} onChange={(e) => setFormData({...formData, phoneNumber: e.target.value})} placeholder="(555) 000-0000" />
        </div>
      </div>

      <AddressPicker value={address} onChange={setAddress} />

      {formData.role === "customer" && (
        <div className="space-y-4 pt-2 border-t border-white/5">
           <div className="bg-black/20 rounded-lg p-4 border border-white/10 space-y-3">
             <label className="block text-xs font-medium text-white/60 uppercase">Assign Clinic</label>
             <select className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-white disabled:opacity-50"
                value={formData.clinicId} onChange={(e) => setFormData({...formData, clinicId: e.target.value})} disabled={!!formData.newClinicName}>
                <option value="">-- Select Clinic --</option>
                {clinics.map((c) => (<option key={c.id} value={c.id}>{c.name}</option>))}
             </select>
           </div>
           <div>
                <label className="block text-xs font-medium text-white/60 mb-1 uppercase">Preference Note</label>
                <textarea rows={3} className="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-accent/50 outline-none resize-none"
                   value={formData.preferenceNote} onChange={(e) => setFormData({...formData, preferenceNote: e.target.value})} placeholder="Doctor preferences..." />
            </div>
        </div>
      )}

      {error && <p className="text-red-400 text-sm">{error}</p>}
      {msg && <p className="text-emerald-400 text-sm">{msg}</p>}

      <div className="flex justify-end gap-3 pt-4 border-t border-white/10">
        {onClose && <button type="button" onClick={onClose} className="px-4 py-2 text-white/60 hover:text-white transition">Cancel</button>}
        <button type="submit" disabled={loading} className="px-6 py-2 bg-accent text-background font-bold rounded-lg hover:bg-white transition-colors">
          {loading ? "Saving..." : (isEdit ? "Update User" : "Create User")}
        </button>
      </div>
    </form>
  );
}
--- END OF FILE ---

FILE: ./components/ToothSelector.tsx
// components/ToothSelector.tsx
"use client";

import { useState, useEffect } from "react";
import Image from "next/image";

export interface ToothSelectorProps {
  value: string;
  onChange: (val: string) => void;
}

const UPPER_TEETH = Array.from({ length: 16 }, (_, i) => i + 1);
const LOWER_TEETH = Array.from({ length: 16 }, (_, i) => 32 - i);

export default function ToothSelector({ value, onChange }: ToothSelectorProps) {
  const [selected, setSelected] = useState<Set<number>>(new Set());

  useEffect(() => {
    if (value) {
      const nums = value
        .split(",")
        .map((s: string) => parseInt(s.trim()))
        .filter((n: number) => !isNaN(n));
      setSelected(new Set(nums));
    }
  }, [value]);

  const toggleTooth = (num: number) => {
    const next = new Set(selected);
    if (next.has(num)) next.delete(num);
    else next.add(num);
    setSelected(next);
    onChange(Array.from(next).sort((a, b) => a - b).join(", "));
  };

  const ToothImage = ({ num }: { num: number }) => {
    const active = selected.has(num);
    return (
      <button
        type="button"
        onClick={() => toggleTooth(num)}
        // FIX: 
        // 1. flex-1: Allows growing/shrinking to fill space.
        // 2. min-w-[32px]: The "certain point". If container < (16 * 32px), it scrolls.
        // 3. max-w-[60px]: Prevents them from getting cartoonishly huge on massive screens.
        className={`
          group flex flex-col items-center justify-end transition-all duration-200 
          py-2 rounded-lg flex-1 min-w-[32px] max-w-[60px]
          ${active 
            ? "scale-110 z-10 brightness-110 drop-shadow-[0_0_10px_rgba(96,165,250,0.5)] bg-white/5" 
            : "scale-100 opacity-60 grayscale hover:grayscale-0 hover:opacity-100 hover:scale-105 hover:bg-white/5"}
        `}
      >
        {/* Responsive Image Container */}
        {/* aspect-[2/3] keeps the tooth ratio intact as width shrinks */}
        <div className="relative w-full aspect-[2/3]">
           <Image
             src={`/Images/T${num}.png`} 
             alt="" 
             fill
             className="object-contain"
             sizes="(max-width: 768px) 30px, 60px"
             priority={num < 10}
           />
        </div>
        
        {/* Number */}
        <span className={`
          mt-2 font-bold transition-colors text-[10px] sm:text-xs
          ${active ? "text-blue-400" : "text-white/40 group-hover:text-white/80"}
        `}>
          #{num}
        </span>
      </button>
    );
  };

  return (
    <div className="w-full bg-black/40 rounded-xl border border-white/10 p-4 sm:p-6 flex flex-col items-center gap-6 select-none shadow-inner overflow-hidden">
      
      {/* Upper Arch */}
      <div className="w-full flex flex-col items-center gap-2">
        <span className="text-xs text-white/40 uppercase tracking-widest font-semibold">Upper Arch</span>
        
        {/* Container:
            - flex: Row layout
            - w-full: Take full width
            - overflow-x-auto: Scroll ONLY if children force it via min-width
            - justify-between: Spread teeth evenly
        */}
        <div className="flex w-full overflow-x-auto custom-scrollbar pb-2 px-1 gap-1 justify-between">
          {UPPER_TEETH.map((t) => <ToothImage key={t} num={t} />)}
        </div>
      </div>

      {/* Divider */}
      <div className="w-2/3 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent" />

      {/* Lower Arch */}
      <div className="w-full flex flex-col items-center gap-2">
        <div className="flex w-full overflow-x-auto custom-scrollbar pb-2 px-1 gap-1 justify-between">
          {LOWER_TEETH.map((t) => <ToothImage key={t} num={t} />)}
        </div>
        <span className="text-xs text-white/40 uppercase tracking-widest font-semibold">Lower Arch</span>
      </div>

      {selected.size === 0 && (
        <p className="text-xs text-red-400/80 mt-1 font-medium animate-pulse">
          Click teeth to select
        </p>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CaseViewerTabs.tsx
// portal/components/CaseViewerTabs.tsx
"use client";

import { useEffect, useState } from "react";
import dynamic from "next/dynamic";
import CaseActions from "@/components/CaseActions";
import type { Role, CaseStatus } from "@/lib/types";

const Case3DPanel = dynamic(() => import("@/components/Case3DPanel"), {
  ssr: false, 
  loading: () => (
    <div className="w-full h-full bg-[#0a1020] animate-pulse flex items-center justify-center text-white/30 text-sm">
      Loading 3D Viewer...
    </div>
  ),
});

type TabKey = "scan" | "design_with_model" | "design_only";

export default function CaseViewerTabs({
  caseId,
  role,
  status,
  scan3DUrl,
  designWithModel3DUrl,
  designOnly3DUrl,
  scanHtmlUrl,
  designHtmlUrl,
}: {
  caseId: string;
  role: Role;
  status: string;
  scan3DUrl: string | null;
  designWithModel3DUrl: string | null;
  designOnly3DUrl: string | null;
  scanHtmlUrl: string | null;
  designHtmlUrl: string | null;
}) {
  const [tab, setTab] = useState<TabKey>("scan");
  const hasScanViewer = !!scanHtmlUrl || !!scan3DUrl;
  const hasDesignViewer = !!designHtmlUrl || !!designWithModel3DUrl;
  const hasDesignOnlyViewer = !!designOnly3DUrl;

  useEffect(() => {
    if (typeof window === "undefined") return;
    const STORAGE_KEY = "lumera.caseViewerTab";
    const stored = window.localStorage.getItem(STORAGE_KEY) as TabKey | null;

    const available: Record<TabKey, boolean> = {
      scan: hasScanViewer,
      design_with_model: hasDesignViewer,
      design_only: hasDesignOnlyViewer,
    };
    const order: TabKey[] = ["scan", "design_with_model", "design_only"];

    if (stored && available[stored]) {
      if (stored !== tab) setTab(stored);
      return;
    }
    if (available[tab]) return;
    for (const key of order) {
      if (available[key]) {
        setTab(key);
        window.localStorage.setItem(STORAGE_KEY, key);
        return;
      }
    }
  }, [hasScanViewer, hasDesignViewer, hasDesignOnlyViewer, tab]);

  function selectTab(key: TabKey) {
    setTab(key);
    if (typeof window !== "undefined") {
      window.localStorage.setItem("lumera.caseViewerTab", key);
    }
  }

  // FIX: Inject Midnight Blue into the Iframe
  const handleIframeLoad = (e: React.SyntheticEvent<HTMLIFrameElement, Event>) => {
    try {
      const iframe = e.target as HTMLIFrameElement;
      const doc = iframe.contentDocument;
      if (doc) {
        // 1. Force Body
        doc.body.style.backgroundColor = "#0a1020";
        
        // 2. Inject Style Override (Stronger)
        const style = doc.createElement("style");
        style.textContent = `
          body, html { background-color: #0a1020 !important; }
          #background { background-color: #0a1020 !important; }
          .webviewer-canvas-container { background-color: #0a1020 !important; }
        `;
        doc.head.appendChild(style);
      }
    } catch (err) {
      console.warn("Could not inject styles into viewer (Cross-Origin blocking?)", err);
    }
  };

  const tabBtn = (key: TabKey, label: string, active: boolean, disabled: boolean) => (
    <button
      type="button"
      onClick={() => !disabled && selectTab(key)}
      disabled={disabled}
      className={`
        px-4 h-full text-sm font-medium border-b-2 transition-colors flex items-center
        ${
          active
            ? "border-accent text-accent" // FIX: Use Accent (Purple) instead of White
            : disabled
            ? "border-transparent text-white/20 cursor-not-allowed"
            : "border-transparent text-white/60 hover:text-white"
        }
      `}
    >
      {label}
    </button>
  );

  const renderContent = () => {
    if (tab === "scan") {
      if (scanHtmlUrl) {
        return (
          <div className="w-full h-full bg-[#0a1020] rounded-lg overflow-hidden">
             <iframe 
               src={scanHtmlUrl} 
               className="w-full h-full border-0 block" 
               title="Exocad Scan Viewer"
               onLoad={handleIframeLoad} // Trigger color fix
             />
          </div>
        );
      }
      return <Case3DPanel url={scan3DUrl} />;
    }

    if (tab === "design_with_model") {
      if (designHtmlUrl) {
        return (
          <div className="w-full h-full bg-[#0a1020] rounded-lg overflow-hidden">
             <iframe 
               src={designHtmlUrl} 
               className="w-full h-full border-0 block" 
               title="Exocad Design Viewer"
               onLoad={handleIframeLoad} // Trigger color fix
             />
          </div>
        );
      }
      return <Case3DPanel url={designWithModel3DUrl} />;
    }

    return <Case3DPanel url={designOnly3DUrl} />;
  };

  return (
    <div className="rounded-xl border border-white/10 bg-[#0a1020] flex flex-col h-full overflow-hidden shadow-2xl">
      <div className="flex items-center border-b border-white/10 px-2 bg-white/5 h-14 shrink-0">
        {tabBtn("scan", "Scan", tab === "scan", !hasScanViewer)}
        {tabBtn("design_with_model", "Design + Model", tab === "design_with_model", !hasDesignViewer)}
        {tabBtn("design_only", "Design Only", tab === "design_only", !hasDesignOnlyViewer)}
        
        <div className="ml-auto pr-2">
          <CaseActions 
            caseId={caseId} 
            role={role} 
            currentStatus={status as CaseStatus} 
          />
        </div>
      </div>

      <div className="flex-1 p-2 relative min-h-0 bg-[#0a1020]">
        {renderContent()}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/FileUploader.tsx
// portal/components/FileUploader.tsx
"use client";

import { useState } from "react";

type Role = "customer" | "lab" | "admin" | "milling";

export default function FileUploader({
  caseId,
  role,
  label,
  slot,
  accept, // We will default this smarter now
  description,
}: {
  caseId: string;
  role: Role;
  label?: string;
  slot?: string;
  accept?: string;
  description?: string;
}) {
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | undefined>();
  const [ok, setOk] = useState<string | undefined>();
  const [file, setFile] = useState<File | null>(null);

  if (role === "customer") return null;

  const activeLabel = label || slot || "file";
  const labelText = description || activeLabel.replace(/_/g, " ");

  // ✅ FIX: Smarter defaults if 'accept' isn't passed
  // If label is construction_info, explicitly allow weird extensions
  const finalAccept = accept || (activeLabel === "construction_info" 
    ? ".pdf,.xml,.txt,.constructionInfo" 
    : ".stl,.ply,.obj");

  function onFileChange(e: React.ChangeEvent<HTMLInputElement>) {
    const f = e.target.files?.[0] || null;
    setFile(f);
    setErr(undefined);
    setOk(undefined);
  }

  async function send() {
    if (!file) return setErr("Please choose a file first.");

    setBusy(true);
    setErr(undefined);
    setOk(undefined);

    try {
      const fd = new FormData();
      fd.append("label", activeLabel);
      fd.append("files", file); // Using 'files' to match route logic

      const r = await fetch(`/api/cases/${caseId}/files`, {
        method: "POST",
        body: fd,
      });
      const j = await r.json().catch(() => ({}));
      
      if (!r.ok) throw new Error(j.error || "Upload failed");

      setOk("Uploaded successfully.");
      setTimeout(() => window.location.reload(), 600);
    } catch (e: any) {
      setErr(e?.message || "Upload failed");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="space-y-2">
      <div className="text-xs text-white/60 capitalize">{labelText}</div>

      <label className="flex items-center justify-between gap-3 rounded-lg p-2 bg-black/40 border border-white/10 cursor-pointer hover:border-white/20 transition-colors">
        <div className="flex-1 min-w-0 text-white/80">
          {file ? (
            <>
              <div className="font-medium text-xs truncate" title={file.name}>
                {file.name}
              </div>
              <div className="text-[10px] text-white/60">
                {(file.size / (1024 * 1024)).toFixed(2)} MB
              </div>
            </>
          ) : (
            <div className="text-xs text-white/60 truncate">
              Choose file…
            </div>
          )}
        </div>
        <div className="shrink-0 rounded-md bg-white text-black px-3 py-1.5 text-xs font-medium">
          Browse
        </div>
        <input
          type="file"
          accept={finalAccept}
          onChange={onFileChange}
          className="hidden"
        />
      </label>

      <div className="flex items-center gap-2">
        <button
          onClick={send}
          disabled={busy || !file}
          className="rounded-lg px-3 py-1.5 bg-white text-black text-xs font-bold disabled:opacity-50 hover:bg-gray-200 transition-colors"
        >
          {busy ? "Uploading…" : "Upload"}
        </button>
        {ok && <span className="text-emerald-400 text-xs animate-pulse">{ok}</span>}
        {err && <span className="text-red-400 text-xs">{err}</span>}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/Case3DPanel.tsx
// portal/components/Case3DPanel.tsx
"use client";

import { useEffect, useState } from "react";
import STLViewer from "./STLViewer";

// Removed unused 'title' prop
export default function Case3DPanel({ url }: { url: string | null }) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) return <div className="w-full h-full bg-black/20 animate-pulse" />;

  if (!url) {
    return (
      <div className="w-full h-full flex items-center justify-center text-white/30 text-sm">
        No 3D model available
      </div>
    );
  }

  return (
    <div className="w-full h-full bg-[#1e1e1e] relative">
      <STLViewer url={url} />
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/ActionsBar.tsx
// components/ActionsBar.tsx
"use client";

import { useState } from "react";

type Role = "customer" | "lab" | "admin";
type Status =
  | "NEW"
  | "IN_DESIGN"
  | "READY_FOR_REVIEW"
  | "CHANGES_REQUESTED"
  | "APPROVED"
  | "IN_MILLING"
  | "SHIPPED";

export default function ActionsBar({
  caseId,
  role,
  status,
}: {
  caseId: string;
  role: Role;
  status: Status;
}) {
  const [note, setNote] = useState("");
  const [busy, setBusy] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  const canDoctor = role === "customer";
  const canLab = role === "lab" || role === "admin";

  async function send(to: Status) {
    setBusy(true);
    setMsg(null);
    setErr(null);
    try {
      const res = await fetch(`/api/cases/${caseId}/transition`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ to, note: note || undefined }),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j.error || "Action failed");
      setMsg("Saved.");
      setNote("");
      location.reload();
    } catch (e: any) {
      setErr(e?.message || "Action failed");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="rounded-xl border border-white/10 p-4">
      <div className="flex flex-wrap items-center gap-3">
        <input
          type="text"
          value={note}
          onChange={(e) => setNote(e.target.value)}
          placeholder="Optional note…"
          className="px-3 py-1.5 rounded-md bg-white/10 border border-white/10 text-sm flex-1 min-w-[200px]"
        />

        {/* Doctor actions */}
        {canDoctor && (
          <>
            <button
              disabled={busy}
              onClick={() => send("APPROVED")}
              className="px-3 py-1.5 rounded-md bg-emerald-400 text-black text-sm"
            >
              Approve
            </button>
            <button
              disabled={busy}
              onClick={() => send("CHANGES_REQUESTED")}
              className="px-3 py-1.5 rounded-md bg-amber-300 text-black text-sm"
            >
              Request Changes
            </button>
          </>
        )}

        {/* Lab can mark ready for review, or move back to design */}
        {canLab && (
          <>
            <button
              disabled={busy}
              onClick={() => send("READY_FOR_REVIEW")}
              className="px-3 py-1.5 rounded-md bg-white text-black text-sm"
            >
              Ready for Review
            </button>
            <button
              disabled={busy}
              onClick={() => send("IN_DESIGN")}
              className="px-3 py-1.5 rounded-md bg-white/80 text-black text-sm"
            >
              Back to Design
            </button>
          </>
        )}
      </div>

      {msg && <p className="text-emerald-400 text-sm mt-2">{msg}</p>}
      {err && <p className="text-red-400 text-sm mt-2">{err}</p>}

      <p className="text-white/50 text-xs mt-2">
        Status now: <b>{status}</b>
      </p>
    </div>
  );
}

--- END OF FILE ---

FILE: ./components/HtmlViewerUploader.tsx
// components/HtmlViewerUploader.tsx
"use client";

import { useState } from "react";

// FIX: Added "milling" to Role type
type Role = "customer" | "lab" | "admin" | "milling";

export default function HtmlViewerUploader({
  caseId,
  role,
  label,
  description,
}: {
  caseId: string;
  role: Role;
  label: "scan_html" | "design_with_model_html";
  description: string;
}) {
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | undefined>();
  const [ok, setOk] = useState<string | undefined>();
  const [file, setFile] = useState<File | null>(null);

  // Customers cannot upload viewers
  if (role === "customer") return null;

  function onFileChange(e: React.ChangeEvent<HTMLInputElement>) {
    const f = e.target.files?.[0] || null;
    setFile(f);
    setErr(undefined);
    setOk(undefined);
  }

  async function send() {
    if (!file) {
      return setErr("Please choose a file first.");
    }

    setBusy(true);
    setErr(undefined);
    setOk(undefined);

    try {
      const fd = new FormData();
      fd.append("label", label);
      fd.append("file", file);

      const r = await fetch(`/api/cases/${caseId}/files`, {
        method: "POST",
        body: fd,
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) {
        throw new Error(j.error || "Upload failed");
      }

      setOk("Viewer uploaded.");
      setTimeout(() => window.location.reload(), 600);
    } catch (e: any) {
      setErr(e?.message || "Upload failed");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="space-y-2">
      <div className="text-xs text-white/60">{description}</div>

      <label className="flex items-center justify-between gap-3 rounded-lg p-2 bg-black/40 border border-white/10 cursor-pointer">
        <div className="flex-1 min-w-0 text-white/80">
          {file ? (
            <>
              <div className="font-medium text-xs truncate" title={file.name}>
                {file.name}
              </div>
              <div className="text-[10px] text-white/60">
                {(file.size / (1024 * 1024)).toFixed(2)} MB
              </div>
            </>
          ) : (
            <div className="text-xs text-white/60 truncate">
              Choose Exocad HTML…
            </div>
          )}
        </div>
        <div className="shrink-0 rounded-md bg-white text-black px-3 py-1.5 text-xs">
          Browse
        </div>
        <input
          type="file"
          accept=".html,text/html"
          onChange={onFileChange}
          className="hidden"
        />
      </label>

      <div className="flex items-center gap-2">
        <button
          onClick={send}
          disabled={busy || !file}
          className="rounded-lg px-3 py-1.5 bg-white text-black text-xs disabled:opacity-50"
        >
          {busy ? "Uploading…" : "Upload viewer"}
        </button>
        {ok && <span className="text-emerald-400 text-xs">{ok}</span>}
        {err && <span className="text-red-400 text-xs">{err}</span>}
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/CommentsPanel.tsx
// portal/components/CommentsPanel.tsx
"use client";

import { useState, useRef, useEffect } from "react";
import ImageAnnotator from "./ImageAnnotator";

type Attachment = {
  id: string;
  url: string;
  kind: string;
};

type Comment = {
  id: string;
  body: string;
  at: Date | string;
  author: string;
  role: string;
  attachments?: Attachment[];
};

function fixUrl(url: string) {
  if (!url) return "";
  let clean = url.replace(/^public\//, "");
  if (!clean.startsWith("/")) clean = "/" + clean;
  return clean;
}

export default function CommentsPanel({
  caseId,
  comments: initialComments,
  canPost,
  currentUserName,
  currentUserRole,
}: {
  caseId: string;
  comments: Comment[];
  canPost: boolean;
  currentUserName: string;
  currentUserRole: string;
}) {
  const [comments, setComments] = useState<Comment[]>(initialComments);
  const [body, setBody] = useState("");
  const [posting, setPosting] = useState(false);
  const [annotatingFile, setAnnotatingFile] = useState<File | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [zoomImg, setZoomImg] = useState<string | null>(null);

  useEffect(() => {
    setComments(initialComments);
  }, [initialComments]);

  async function handlePost(attachmentId?: string) {
    if (!body.trim() && !attachmentId) return;

    setPosting(true);
    try {
      const res = await fetch(`/api/cases/${caseId}/comments`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          body: body || (attachmentId ? "Attached image" : ""),
          attachmentFileId: attachmentId 
        }),
      });
      if (!res.ok) throw new Error("Failed to post");

      const newComment = await res.json();
      const mapped: Comment = {
        id: newComment.id,
        body: newComment.body,
        at: new Date(newComment.createdAt),
        author: currentUserName,
        role: currentUserRole,
        attachments: newComment.attachments?.map((a: any) => ({
          id: a.id,
          url: a.url,
          kind: a.kind
        })) || []
      };

      setComments((prev) => [mapped, ...prev]);
      setBody("");
    } catch (e) {
      console.error(e);
      alert("Failed to post comment");
    } finally {
      setPosting(false);
    }
  }

  function onFileSelect(e: React.ChangeEvent<HTMLInputElement>) {
    const file = e.target.files?.[0];
    if (!file) return;
    setAnnotatingFile(file);
    e.target.value = "";
  }

  async function onAnnotationSave(blob: Blob) {
    setAnnotatingFile(null); 
    setPosting(true);
    try {
      const file = new File([blob], "annotation.png", { type: "image/png" });
      const fd = new FormData();
      fd.append("file", file);
      fd.append("label", "Photo"); 

      const upRes = await fetch(`/api/cases/${caseId}/files`, {
        method: "POST",
        body: fd,
      });
      if (!upRes.ok) throw new Error("Failed to upload annotation");
      const upData = await upRes.json();
      
      await handlePost(upData.id);
    } catch (e) {
      console.error(e);
      alert("Failed to upload annotation");
      setPosting(false);
    }
  }

  // --- NEW: Spacing & Inline Image Fix ---
  function renderBody(text: string) {
    const regex = /((?:https?:\/\/[^\s]+|(?:\/uploads\/)[^\s]+)\.(?:png|jpg|jpeg|gif|webp))/gi;
    const parts = text.split(regex);

    return parts.map((part, i) => {
      if (part.match(regex)) {
        const safeSrc = fixUrl(part);
        return (
          // FIX: Standardized spacing (my-3)
          <div key={i} className="my-3">
             {/* eslint-disable-next-line @next/next/no-img-element */}
            <img
              src={safeSrc}
              alt="Inline Content"
              className="block max-w-full rounded-lg border border-white/10 cursor-zoom-in"
              onClick={() => setZoomImg(safeSrc)}
            />
          </div>
        );
      }
      if (!part) return null;
      return <span key={i}>{part}</span>;
    });
  }

  return (
    <div className="flex flex-col h-full min-h-0">
      <h3 className="text-xs font-semibold text-white/50 uppercase tracking-wider mb-4 flex-shrink-0">
        Discussion
      </h3>

      {/* FIX: Added space-y-reverse to handle bottom-up stacking correctly */}
      <div className="flex-1 overflow-y-auto min-h-0 space-y-4 space-y-reverse pr-2 custom-scrollbar flex flex-col-reverse">
        {comments.length === 0 ? (
          <p className="text-white/40 text-sm text-center py-4">No comments yet.</p>
        ) : (
          comments.map((c) => {
            const isInternal = c.role === "admin" || c.role === "lab" || c.role === "milling";
            const maskAsLumera = currentUserRole === "customer" && isInternal;
            
            const displayAuthor = maskAsLumera ? "Lumera" : c.author;
            const displayInitials = maskAsLumera ? "L" : displayAuthor.substring(0, 2).toUpperCase();
            
            const bubbleStyle = isInternal 
                ? "bg-blue-500/20 text-blue-300 border border-blue-500/30" 
                : "bg-emerald-500/20 text-emerald-300 border border-emerald-500/30";

            return (
              <div key={c.id} className="group flex gap-3">
                <div 
                  className={`
                    w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shrink-0
                    ${bubbleStyle}
                  `}
                >
                  {displayInitials}
                </div>

                <div className="flex-1 min-w-0">
                  <div className="flex items-baseline justify-between">
                    <span className="text-sm font-medium text-white/90">
                      {displayAuthor}
                      {!maskAsLumera && c.role !== "customer" && (
                        <span className="ml-2 text-[10px] opacity-50 uppercase border border-white/20 px-1 rounded">{c.role}</span>
                      )}
                    </span>
                    <span className="text-[10px] text-white/40">
                      {new Date(c.at).toLocaleString()}
                    </span>
                  </div>
                  
                  <div className="mt-1 text-sm text-white/80 whitespace-pre-wrap leading-relaxed">
                    {renderBody(c.body)}
                  </div>

                  {c.attachments && c.attachments.length > 0 && (
                    <div className="mt-3 flex flex-wrap gap-2">
                      {c.attachments.map((att) => {
                        const safeSrc = fixUrl(att.url);
                        return (
                          <div 
                            key={att.id}
                            onClick={() => setZoomImg(safeSrc)} 
                            className="relative w-24 h-24 rounded-lg overflow-hidden border border-white/10 cursor-zoom-in hover:border-white/30 transition-colors bg-black/50"
                          >
                            {/* eslint-disable-next-line @next/next/no-img-element */}
                            <img 
                              src={safeSrc} 
                              alt="Attachment" 
                              className="w-full h-full object-cover" 
                              onError={(e) => {
                                (e.target as HTMLImageElement).style.display = 'none';
                                (e.target as HTMLImageElement).parentElement!.innerText = "⚠️ Error";
                              }}
                            />
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            );
          })
        )}
      </div>

      {canPost && (
        <div className="mt-4 pt-4 border-t border-white/10 flex-shrink-0">
          <div className="relative flex items-center gap-2">
            <input 
              type="file" 
              ref={fileInputRef}
              accept="image/*"
              className="hidden"
              onChange={onFileSelect}
            />
            
            <button
              onClick={() => fileInputRef.current?.click()}
              className="p-2 rounded-lg bg-white/5 text-white/60 hover:text-white hover:bg-white/10 transition-colors"
              title="Attach Image & Draw"
            >
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
              </svg>
            </button>

            <input
              value={body}
              onChange={(e) => setBody(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                  e.preventDefault();
                  handlePost();
                }
              }}
              placeholder="Type a message..."
              className="flex-1 bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-white/30 focus:outline-none focus:border-white/30 transition-colors"
            />
            
            <button
              onClick={() => handlePost()}
              disabled={posting || (!body.trim())}
              className="p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {posting ? (
                <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
              ) : (
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
              )}
            </button>
          </div>
        </div>
      )}

      {annotatingFile && (
        <ImageAnnotator
          file={annotatingFile}
          onSave={onAnnotationSave}
          onCancel={() => setAnnotatingFile(null)}
        />
      )}

      {zoomImg && (
        <div 
          className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4"
          onClick={() => setZoomImg(null)}
        >
          <img 
            src={zoomImg} 
            alt="Zoomed" 
            className="max-w-full max-h-full rounded-lg shadow-2xl" 
          />
          <button className="absolute top-4 right-4 text-white/50 hover:text-white">
            <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/Logo.tsx
// portal/components/Logo.tsx
import React from "react";
import Image from "next/image";

interface LogoProps {
  className?: string;
  showText?: boolean;
}

export default function Logo({ className = "", showText = true }: LogoProps) {
  return (
    <div className={`relative flex items-center justify-center select-none ${className}`}>
      {showText ? (
        // FULL WHITE LOGO (Expanded)
        // 'w-full h-auto' allows it to scale up to the container's width (w-52 in sidebar)
        <Image 
          src="/Images/Lumera-Lab-White-.png" 
          alt="Lumera Dental" 
          width={240} 
          height={64} 
          className="w-full h-auto object-contain"
          priority
        />
      ) : (
        // PURPLE ICON (Collapsed)
        // Fixed dimensions ensure it stays sharp in the narrow sidebar
        <Image 
          src="/Images/ONLY-ICON-Purple-.png" 
          alt="Lumera Icon" 
          width={32} 
          height={32} 
          className="w-8 h-8 object-contain"
        />
      )}
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/ClinicForm.tsx
//components/ClinicForm.tsx
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";
import AddressPicker, { AddressData } from "@/components/AddressPicker";

export default function ClinicForm({ initialData, onClose }: { initialData?: any, onClose: () => void }) {
  const router = useRouter();
  const [form, setForm] = useState(initialData || {
    name: "", phone: "",
    taxId: "", bankName: "", routingNumber: "", bankLast4: "",
    billingCycleDay: 1, paymentTerms: 30, priceTier: "STANDARD"
  });
  const [address, setAddress] = useState<AddressData>({
    id: initialData?.address?.id || null,
    street: initialData?.address?.street || "",
    city: initialData?.address?.city || "",
    state: initialData?.address?.state || "",
    zipCode: initialData?.address?.zipCode || ""
  });
  const [busy, setBusy] = useState(false);

  async function save(e: React.FormEvent) {
    e.preventDefault();
    setBusy(true);
    const url = initialData ? `/api/clinics/${initialData.id}` : "/api/clinics";
    const method = initialData ? "PUT" : "POST";
    
    const payload = { ...form, address };
    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      router.refresh();
      onClose();
    } else {
      alert("Failed to save");
      setBusy(false);
    }
  }

  // Helper to update form fields
  const set = (field: string, val: any) => setForm((prev: any) => ({ ...prev, [field]: val }));

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
      {/* FIX: Changed bg-[#1e1e1e] to bg-[#111b2d] (Midnight Surface) */}
      <div className="w-full max-w-2xl bg-[#111b2d] border border-white/10 rounded-xl p-6 max-h-[90vh] overflow-y-auto custom-scrollbar shadow-2xl">
        <h2 className="text-xl font-semibold mb-6 text-white">{initialData ? "Edit Clinic" : "New Clinic"}</h2>
        <form onSubmit={save} className="space-y-6">
          
          {/* 1. Details */}
          <div className="space-y-4">
            <h3 className="text-xs font-bold text-accent uppercase tracking-wider">Details</h3>
            <div className="grid grid-cols-2 gap-4">
              <input placeholder="Clinic Name *" required className="p-2 bg-black/30 border border-white/10 rounded text-white focus:border-accent/50 outline-none" 
                value={form.name} onChange={e => set("name", e.target.value)} />
              <input placeholder="Phone" className="p-2 bg-black/30 border border-white/10 rounded text-white focus:border-accent/50 outline-none" 
                value={form.phone || ""} onChange={e => set("phone", e.target.value)} />
            </div>
          </div>

          {/* 2. Address (New Picker) */}
          <AddressPicker value={address} onChange={setAddress} />

          {/* 3. Financials */}
          <div className="space-y-4 pt-2 border-t border-white/5">
            <h3 className="text-xs font-bold text-accent uppercase tracking-wider">Billing & Financials</h3>
            <div className="grid grid-cols-3 gap-4">
               <select className="p-2 bg-black/30 border border-white/10 rounded text-white focus:border-accent/50 outline-none"
                  value={form.priceTier} onChange={e => set("priceTier", e.target.value)}>
                  <option value="STANDARD">Standard</option>
                  <option value="IN_HOUSE">In-House</option>
               </select>
               <input type="number" placeholder="Cycle Day (1-28)" className="p-2 bg-black/30 border border-white/10 rounded text-white focus:border-accent/50 outline-none" 
                 value={form.billingCycleDay} onChange={e => set("billingCycleDay", e.target.value)} />
               <input type="number" placeholder="Net Terms (e.g. 30)" className="p-2 bg-black/30 border border-white/10 rounded text-white focus:border-accent/50 outline-none" 
                 value={form.paymentTerms} onChange={e => set("paymentTerms", e.target.value)} />
            </div>
            
            {/* Banking */}
            <div className="grid grid-cols-2 gap-4">
               <input placeholder="Bank Name" className="p-2 bg-black/30 border border-white/10 rounded text-white focus:border-accent/50 outline-none" 
                 value={form.bankName || ""} onChange={e => set("bankName", e.target.value)} />
               <input placeholder="Tax ID" className="p-2 bg-black/30 border border-white/10 rounded text-white focus:border-accent/50 outline-none" 
                 value={form.taxId || ""} onChange={e => set("taxId", e.target.value)} />
            </div>
          
            <div className="grid grid-cols-2 gap-4">
               <input placeholder="Routing Number" className="p-2 bg-black/30 border border-white/10 rounded text-white focus:border-accent/50 outline-none" 
                 value={form.routingNumber || ""} onChange={e => set("routingNumber", e.target.value)} />
               <input placeholder="Account Last 4" className="p-2 bg-black/30 border border-white/10 rounded text-white focus:border-accent/50 outline-none" 
                 value={form.bankLast4 || ""} onChange={e => set("bankLast4", e.target.value)} />
            </div>
          </div>

          <div className="flex justify-end gap-3 pt-4 border-t border-white/10">
            <button type="button" onClick={onClose} className="px-4 py-2 text-white/60 hover:text-white">Cancel</button>
            <button type="submit" disabled={busy} className="px-6 py-2 bg-accent text-background font-bold rounded hover:bg-white transition">
              {busy ? "Saving..." : "Save Clinic"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/PublicNavbar.tsx
// portal/components/PublicNavbar.tsx
"use client";

import Link from "next/link";
import Image from "next/image";
import { usePathname } from "next/navigation";

export default function PublicNavbar() {
  const pathname = usePathname();

  const navLink = (path: string, label: string) => {
    const isActive = pathname === path;
    return (
      <Link
        href={path}
        className={`text-sm font-medium transition-colors hover:text-white ${
          isActive ? "text-white" : "text-white/60"
        }`}
      >
        {label}
      </Link>
    );
  };

  return (
    <header className="sticky top-0 z-50 w-full border-b border-white/5 bg-background/80 backdrop-blur-md">
      <div className="container mx-auto px-6 h-16 flex items-center justify-between">
        {/* Brand */}
        <Link href="/" className="flex items-center gap-2 group">
          <Image 
            src="/Images/Lumera-Lab-White-.png" 
            alt="Lumera" 
            width={320} 
            height={64} 
            className="h-16 w-auto"
          />
        </Link>

        {/* Desktop Nav */}
        <nav className="hidden md:flex items-center gap-8">
          {navLink("/", "Home")}
          {navLink("/work", "Our Work")}
          {navLink("/about", "About")}
          {navLink("/contact", "Contact")}
        </nav>

        {/* CTA / Login */}
        <div className="flex items-center gap-4">
          {/* FIX: Corrected route from /auth/login to /login */}
          <Link 
            href="/login" 
            className="text-sm font-medium text-white/60 hover:text-white transition-colors"
          >
            Log In
          </Link>
          <Link
            href="/contact"
            className="hidden sm:inline-flex items-center justify-center px-4 py-2 text-sm font-semibold text-background bg-white rounded-full hover:bg-gray-100 transition shadow-[0_0_20px_rgba(255,255,255,0.2)]"
          >
            Send a Case
          </Link>
        </div>
      </div>
    </header>
  );
}
--- END OF FILE ---

FILE: ./components/BillingList.tsx
// portal/components/BillingList.tsx
"use client";

import { formatCurrency, BillingType } from "@/lib/pricing";

// Define a loose shape for the data passed from the server
type BillingCase = {
  id: string;
  orderDate: Date | string;
  patientAlias: string;
  doctorName: string | null;
  product: string;
  units: number;
  cost: number | string; // Prisma Decimal comes as string or number depending on config
  billingType: string;
  clinic: { name: string };
};

type Props = {
  cases: BillingCase[];
  isAdminOrLab: boolean;
};

export default function BillingList({ cases, isAdminOrLab }: Props) {
  return (
    <div className="flex-1 min-h-0 rounded-xl border border-white/10 bg-black/20 overflow-hidden flex flex-col shadow-2xl">
      <div className="flex-1 overflow-y-auto custom-scrollbar">
        <table className="w-full text-sm text-left border-collapse">
          <thead className="bg-black/60 text-white/70 sticky top-0 backdrop-blur-md z-10 border-b border-white/10">
            <tr>
              <th className="p-4 font-medium">Date</th>
              {isAdminOrLab && <th className="p-4 font-medium">Clinic</th>}
              <th className="p-4 font-medium">Patient</th>
              <th className="p-4 font-medium">Doctor</th>
              <th className="p-4 font-medium">Product</th>
              <th className="p-4 font-medium text-center">Units</th>
              <th className="p-4 font-medium text-right">Cost</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-white/5">
            {cases.length === 0 ? (
              <tr>
                <td
                  colSpan={isAdminOrLab ? 7 : 6}
                  className="p-12 text-center text-white/40"
                >
                  No records found matching your filters.
                </td>
              </tr>
            ) : (
              cases.map((c) => {
                const isWarranty = c.billingType === BillingType.WARRANTY;
                return (
                  <tr key={c.id} className="hover:bg-white/5 transition-colors">
                    <td className="p-4 text-white/70">
                      {new Date(c.orderDate).toLocaleDateString()}
                    </td>
                    {isAdminOrLab && (
                      <td className="p-4 text-white/70">{c.clinic.name}</td>
                    )}
                    <td className="p-4 font-medium text-white">
                      {c.patientAlias}
                    </td>
                    <td className="p-4 text-white/60">
                      {c.doctorName || "—"}
                    </td>
                    <td className="p-4 text-white/60">
                      {c.product.replace(/_/g, " ")}
                      {isWarranty && (
                        <span className="ml-2 px-2 py-0.5 rounded text-[10px] bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 uppercase tracking-wide">
                          Warranty
                        </span>
                      )}
                    </td>
                    <td className="p-4 text-center text-white/60">{c.units}</td>
                    <td
                      className={`p-4 text-right font-mono ${
                        isWarranty
                          ? "text-white/30 decoration-line-through"
                          : "text-emerald-400"
                      }`}
                    >
                      {formatCurrency(Number(c.cost))}
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/BillingStats.tsx
// portal/components/BillingStats.tsx
"use client";

import { formatCurrency } from "@/lib/pricing";

type Props = {
  totalCost: number;
  caseCount: number;
  totalUnits: number;
};

export default function BillingStats({ totalCost, caseCount, totalUnits }: Props) {
  return (
    <div className="flex-none grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div className="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur-sm">
        <div className="text-sm text-white/50 mb-1">Total Cost (Filtered)</div>
        <div className="text-4xl font-light text-accent">
          {formatCurrency(totalCost)}
        </div>
      </div>
      <div className="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur-sm">
        <div className="text-sm text-white/50 mb-1">Cases Processed</div>
        <div className="text-4xl font-light text-white">{caseCount}</div>
      </div>
      <div className="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur-sm">
        <div className="text-sm text-white/50 mb-1">Total Units</div>
        <div className="text-4xl font-light text-blue-300">{totalUnits}</div>
      </div>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/AdminTabs.tsx
// portal/components/AdminTabs.tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";

export function AdminTabs() {
  const pathname = usePathname();
  
  const Tab = ({ href, label }: { href: string; label: string }) => {
    const active = pathname.startsWith(href);
    return (
      <Link
        href={href}
        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
          active ? "bg-white text-black" : "text-white/60 hover:bg-white/10 hover:text-white"
        }`}
      >
        {label}
      </Link>
    );
  };

  return (
    <div className="flex items-center gap-2">
      <Tab href="/portal/admin/users" label="Users" />
      <Tab href="/portal/admin/clinics" label="Clinics" />
      <Tab href="/portal/admin/addresses" label="Addresses" />
      <Tab href="/portal/admin/requests" label="Requests" />
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/ImageAnnotator.tsx
// portal/components/ImageAnnotator.tsx
"use client";

import { useEffect, useRef, useState } from "react";

interface ImageAnnotatorProps {
  file: File;
  onSave: (annotatedFile: File) => void;
  onCancel: () => void;
}

export default function ImageAnnotator({ file, onSave, onCancel }: ImageAnnotatorProps) {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [imageLoaded, setImageLoaded] = useState(false);

  // Load image onto canvas
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = () => {
      // Fit canvas to image aspect ratio within a max container
      const maxWidth = Math.min(800, window.innerWidth - 64);
      const scale = maxWidth / img.width;
      
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      
      // Draw initial image
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      setImageLoaded(true);
    };
  }, [file]);

  const startDrawing = (e: React.MouseEvent | React.TouchEvent) => {
    setIsDrawing(true);
    draw(e);
  };

  const stopDrawing = () => {
    setIsDrawing(false);
    const canvas = canvasRef.current;
    if (canvas) {
      const ctx = canvas.getContext("2d");
      ctx?.beginPath(); // Reset path so lines don't connect
    }
  };

  const draw = (e: React.MouseEvent | React.TouchEvent) => {
    if (!isDrawing) return;
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    // Calculate coordinates
    const rect = canvas.getBoundingClientRect();
    let clientX, clientY;

    if ('touches' in e) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = (e as React.MouseEvent).clientX;
      clientY = (e as React.MouseEvent).clientY;
    }

    const x = clientX - rect.left;
    const y = clientY - rect.top;

    ctx.lineWidth = 4;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#ef4444"; // Tailwind red-500

    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  };

  const handleSave = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    canvas.toBlob((blob) => {
      if (blob) {
        const newFile = new File([blob], `annotated-${file.name}`, { type: "image/png" });
        onSave(newFile);
      }
    }, "image/png");
  };

  return (
    <div className="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center p-4">
      {/* Toolbar */}
      <div className="w-full max-w-4xl flex justify-between items-center mb-4 text-white">
        <h3 className="text-lg font-medium">Draw on Image</h3>
        <div className="flex gap-3">
          <button 
            onClick={onCancel}
            className="px-4 py-2 rounded-lg hover:bg-white/10"
          >
            Cancel
          </button>
          <button 
            onClick={handleSave}
            disabled={!imageLoaded}
            className="px-6 py-2 bg-red-500 hover:bg-red-600 rounded-lg font-bold"
          >
            Save Annotation
          </button>
        </div>
      </div>

      {/* Canvas Container */}
      <div 
        ref={containerRef}
        className="relative bg-[#1a1a1a] rounded-lg overflow-hidden shadow-2xl border border-white/10"
      >
        <canvas
          ref={canvasRef}
          onMouseDown={startDrawing}
          onMouseUp={stopDrawing}
          onMouseOut={stopDrawing}
          onMouseMove={draw}
          onTouchStart={startDrawing}
          onTouchEnd={stopDrawing}
          onTouchMove={draw}
          className="cursor-crosshair block"
        />
        {!imageLoaded && (
          <div className="absolute inset-0 flex items-center justify-center text-white/50">
            Loading image...
          </div>
        )}
      </div>
      
      <p className="mt-4 text-white/40 text-sm">
        Click and drag to draw. Ideal for marking margins or contacts.
      </p>
    </div>
  );
}
--- END OF FILE ---

FILE: ./components/BillingToolbar.tsx
// portal/components/BillingToolbar.tsx
"use client";

import Link from "next/link";

const MONTHS = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];

type Props = {
  selYear: number;
  selMonth: number;
  qFilter: string;
  doctorFilter: string;
  clinicFilter: string;
  isAdminOrLab: boolean;
  isFiltered: boolean;
};

export default function BillingToolbar({
  selYear,
  selMonth,
  qFilter,
  doctorFilter,
  clinicFilter,
  isAdminOrLab,
  isFiltered,
}: Props) {
  // Logic: Start at 2024, end at Current Year (e.g., 2026).
  const currentYear = new Date().getFullYear();
  const startYear = 2024;
  const years = Array.from(
    { length: currentYear - startYear + 1 },
    (_, i) => startYear + i
  );

  return (
    <div className="flex-none space-y-4 mb-6">
      <header>
        <h1 className="text-2xl font-semibold text-white">Billing & Invoices</h1>
        <p className="text-white/50 text-sm mt-1">
          Manage costs, view history, and track monthly usage.
        </p>
      </header>

      <form className="flex flex-wrap gap-2 items-center bg-black/20 p-2 rounded-xl border border-white/5">
        {/* Year Select */}
        <select
          name="year"
          defaultValue={selYear}
          className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-blue-500/50 outline-none transition appearance-none cursor-pointer hover:bg-white/5"
        >
          {years.map((y) => (
            <option key={y} value={y} className="bg-[#1a1a1a]">
              {y}
            </option>
          ))}
        </select>

        {/* Month Select */}
        <select
          name="month"
          defaultValue={selMonth}
          className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-blue-500/50 outline-none transition appearance-none cursor-pointer hover:bg-white/5"
        >
          {MONTHS.map((m, i) => (
            <option key={m} value={i + 1} className="bg-[#1a1a1a]">
              {m}
            </option>
          ))}
        </select>

        {/* Search */}
        <input
          name="q"
          placeholder="Search Patient or Case ID..."
          defaultValue={qFilter}
          className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-blue-500/50 outline-none w-48 transition"
        />

        {/* Admin Filters */}
        {isAdminOrLab && (
          <>
            <input
              name="doctor"
              placeholder="Filter by Doctor..."
              defaultValue={doctorFilter}
              className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-blue-500/50 outline-none w-40 transition"
            />
            <input
              name="clinic"
              placeholder="Filter by Clinic..."
              defaultValue={clinicFilter}
              className="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white focus:border-blue-500/50 outline-none w-40 transition"
            />
          </>
        )}

        <button
          type="submit"
          className="bg-white text-black rounded-lg px-4 py-1.5 text-sm font-medium hover:bg-gray-200 transition"
        >
          Filter
        </button>

        {isFiltered && (
          <Link
            href="/portal/billing"
            className="px-3 py-1.5 text-sm text-white/60 hover:text-white hover:bg-white/10 rounded-lg transition"
          >
            Reset
          </Link>
        )}
      </form>
    </div>
  );
}
--- END OF FILE ---

FILE: ./package.json
{
  "name": "portal",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build --turbopack",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@prisma/client": "5.22.0",
    "archiver": "^7.0.1",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "lucide-react": "^0.563.0",
    "next": "^15.1.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "resend": "^6.6.0",
    "three": "^0.171.0",
    "zod": "^4.3.5"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@tailwindcss/postcss": "^4",
    "@types/archiver": "^7.0.0",
    "@types/bcryptjs": "^2.4.6",
    "@types/estree": "^1.0.8",
    "@types/json-schema": "^7.0.15",
    "@types/jsonwebtoken": "^9.0.10",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@types/stats.js": "^0.17.4",
    "@types/three": "^0.180.0",
    "@types/webxr": "^0.5.24",
    "eslint": "^9",
    "eslint-config-next": "15.5.4",
    "prisma": "5.22.0",
    "tailwindcss": "^4",
    "ts-node": "^10.9.2",
    "typescript": "^5"
  },
  "prisma": {
    "seed": "node prisma/seed.mjs"
  },
  "engines": {
    "node": "22.x",
    "npm": ">=10"
  }
}

--- END OF FILE ---

FILE: ./lib/prisma.ts
// portal/lib/prisma.ts
import { PrismaClient } from "@prisma/client";

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    log: ["query", "error", "warn"], // Helpful logs for dev
  });

if (process.env.NODE_ENV !== "production") {
  globalForPrisma.prisma = prisma;
}
--- END OF FILE ---

FILE: ./lib/pricing.ts
// portal/lib/pricing.ts

// Define constants to replace the missing Prisma Enums
export const PriceTier = {
  STANDARD: "STANDARD",
  IN_HOUSE: "IN_HOUSE",
} as const;

export const ProductKind = {
  ZIRCONIA: "ZIRCONIA",
  MULTILAYER_ZIRCONIA: "MULTILAYER_ZIRCONIA",
  EMAX: "EMAX",
  INLAY_ONLAY: "INLAY_ONLAY",
} as const;

export const BillingType = {
  BILLABLE: "BILLABLE",
  WARRANTY: "WARRANTY",
} as const;

// Types for TypeScript safety
export type PriceTierType = typeof PriceTier[keyof typeof PriceTier];
export type ProductKindType = typeof ProductKind[keyof typeof ProductKind];
export type BillingTypeType = typeof BillingType[keyof typeof BillingType];

const PRICING_MATRIX = {
  [PriceTier.STANDARD]: {
    [ProductKind.ZIRCONIA]: 65.00,
    [ProductKind.MULTILAYER_ZIRCONIA]: 72.00,
    [ProductKind.EMAX]: 109.00,
    [ProductKind.INLAY_ONLAY]: 109.00,
  },
  [PriceTier.IN_HOUSE]: {
    [ProductKind.ZIRCONIA]: 55.00,
    [ProductKind.MULTILAYER_ZIRCONIA]: 62.00,
    [ProductKind.EMAX]: 99.00,
    [ProductKind.INLAY_ONLAY]: 99.00,
  },
};

export function countUnits(toothCodes: string | null): number {
  if (!toothCodes) return 0;
  const units = toothCodes.split(",").map(s => s.trim()).filter(s => s !== "");
  return units.length;
}

export function calculateCaseCost(
  tier: string,       // changed from Enum to string
  product: string,    // changed from Enum to string
  units: number,
  billingType: string // changed from Enum to string
): number {
  if (billingType === BillingType.WARRANTY) {
    return 0.00;
  }

  // Safe Casts / Defaults
  const t = (PRICING_MATRIX as any)[tier] ? tier : PriceTier.STANDARD;
  const p = product || ProductKind.ZIRCONIA;

  const tierPrices = (PRICING_MATRIX as any)[t];
  const basePrice = tierPrices[p] || 0;

  return basePrice * units;
}

export function formatCurrency(amount: number | string) {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
  }).format(Number(amount));
}
--- END OF FILE ---

FILE: ./lib/schemas.ts
// portal/lib/schemas.ts
import { z } from "zod";
import { ProductKind, BillingType } from "@/lib/pricing";

// --- EXISTING CASE SCHEMAS (Keep these) ---
const ProductEnum = z.nativeEnum(ProductKind);
const BillingEnum = z.nativeEnum(BillingType);

const FileSchema = z.custom<File>((v) => v instanceof File, {
  message: "Must be a valid file upload",
});

export const CreateCaseSchema = z.object({
  patientAlias: z.string().min(1, "Patient Alias is required"),
  doctorUserId: z.string().min(1, "Doctor ID is required"),
  toothCodes: z.string().min(1, "Tooth Codes are required"),
  orderDate: z.string().refine((val) => !isNaN(Date.parse(val)), {
    message: "Invalid Order Date",
  }).transform((val) => new Date(val)),
  product: ProductEnum.default(ProductKind.ZIRCONIA),
  billingType: BillingEnum.default(BillingType.BILLABLE),
  shade: z.string().optional(),
  material: z.string().optional(),
  designPreferences: z.string().optional(),
  scanHtml: FileSchema.refine((f) => f.size > 0, "Scan HTML file is empty"),
  rxPdf: FileSchema.refine((f) => f.size > 0, "Rx PDF file is empty"),
  constructionInfo: FileSchema.optional().nullable(),
  modelTop: FileSchema.optional().nullable(),
  modelBottom: FileSchema.optional().nullable(),
});

export type CreateCaseInput = z.infer<typeof CreateCaseSchema>;

// --- ✅ NEW: USER SCHEMA ---
export const CreateUserSchema = z.object({
  email: z.string().email("Invalid email address"),
  name: z.string().min(1, "Name is required"),
  role: z.enum(["customer", "lab", "admin", "milling"]).default("customer"),
  phoneNumber: z.string().optional(),
  
  // Logic: Either clinicId OR newClinicName must be present for doctors
  clinicId: z.string().optional(),
  newClinicName: z.string().optional(),
  
  preferenceNote: z.string().optional(),
  
  address: z.object({
    id: z.string().optional().nullable(),
    street: z.string().optional(),
    city: z.string().optional(),
    state: z.string().optional(),
    zipCode: z.string().optional(),
  }).optional(),
}).refine(data => {
  if (data.role === 'customer') {
    return !!data.clinicId || !!data.newClinicName;
  }
  return true;
}, {
  message: "Doctors must be assigned to an existing Clinic or a New Clinic.",
  path: ["clinicId"], // Error will appear on this field
});

export type CreateUserInput = z.infer<typeof CreateUserSchema>;
--- END OF FILE ---

FILE: ./lib/types.ts
// portal/lib/types.ts
// Shared type definitions for the Dental Portal

/**
 * User roles in the system
 */
export type Role = "customer" | "lab" | "admin" | "milling";

/**
 * Case status values representing the workflow state
 */
export type CaseStatus = 
  | "IN_DESIGN" 
  | "READY_FOR_REVIEW" 
  | "CHANGES_REQUESTED" 
  | "APPROVED" 
  | "IN_MILLING" 
  | "SHIPPED" 
  | "COMPLETED";

/**
 * Production stage values representing physical manufacturing stages
 */
export type ProductionStage = "DESIGN" | "MILLING_GLAZING" | "SHIPPING" | "COMPLETED";

--- END OF FILE ---

FILE: ./lib/auth.ts
// portal/lib/auth.ts
import { cookies } from "next/headers";
import jwt from "jsonwebtoken";

export type Session = {
  userId: string;
  role: "customer" | "lab" | "admin" | "milling";
  clinicId?: string;
};

const COOKIE = "lumera_session";

// ✅ SECURITY FIX: Fail fast in production if secret is missing
if (process.env.NODE_ENV === "production" && !process.env.JWT_SECRET) {
  throw new Error("FATAL: JWT_SECRET is not defined in production environment.");
}

const SECRET = process.env.JWT_SECRET || "dev-secret";

/**
 * Read & verify the session JWT from the request cookies.
 * Next.js 15: cookies() can be async, so we await it.
 */
export async function getSession(): Promise<Session | null> {
  const jar = await cookies(); // async in Next 15
  const token = jar.get(COOKIE)?.value;
  if (!token) return null;
  try {
    return jwt.verify(token, SECRET) as Session;
  } catch {
    return null;
  }
}
--- END OF FILE ---

FILE: ./next.config.ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  experimental: {
    // Increase body size limit for middleware buffering (Fixes 10MB limit error)
    middlewareClientMaxBodySize: '500mb', 
    
    // Increase limit for Server Actions (just in case)
    serverActions: {
      bodySizeLimit: '500mb',
    },
  },
};

export default nextConfig;
--- END OF FILE ---

