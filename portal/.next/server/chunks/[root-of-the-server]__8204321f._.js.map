{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst g = global as unknown as { prisma?: PrismaClient };\nexport const prisma = g.prisma ?? new PrismaClient();\nif (process.env.NODE_ENV !== \"production\") g.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACC,MAAM,SAAS,EAAE,MAAM,IAAI,IAAI,6IAAY;AAClD,wCAA2C,EAAE,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport jwt from \"jsonwebtoken\";\n\nexport type Session = {\n  userId: string;\n  role: \"customer\" | \"lab\" | \"admin\";\n  clinicId?: string;\n};\n\nconst COOKIE = \"lumera_session\";\nconst SECRET = process.env.JWT_SECRET!;\n\n/**\n * Read & verify the session JWT from the request cookies.\n * Next.js 15: cookies() can be async, so we await it.\n */\nexport async function getSession(): Promise<Session | null> {\n  const jar = await cookies(); // async in Next 15\n  const token = jar.get(COOKIE)?.value;\n  if (!token) return null;\n  try {\n    return jwt.verify(token, SECRET) as Session;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQA,MAAM,SAAS;AACf,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;AAM9B,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO,KAAI,mBAAmB;IAChD,MAAM,QAAQ,IAAI,GAAG,CAAC,SAAS;IAC/B,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 134, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/app/api/cases/%5Bid%5D/files/route.ts"],"sourcesContent":["// app/api/cases/[id]/files/route.ts\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { getSession } from \"@/lib/auth\";\nimport path from \"path\";\nimport fs from \"fs/promises\";\nimport crypto from \"crypto\";\n\nconst MAX_SIZE = 200 * 1024 * 1024; // 200MB\nconst ACCEPT_SCAN = new Set([\"stl\", \"ply\", \"obj\"]);\nconst ACCEPT_STL  = new Set([\"stl\"]);\nconst LABELS = new Set([\"scan\", \"design_with_model\", \"design_only\"]);\n\nexport async function POST(req: Request, { params }: { params: { id: string } }) {\n  const session = await getSession();\n  if (!session) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n  if (session.role === \"customer\") return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n\n  const form = await req.formData();\n  const files = form.getAll(\"files\") as File[];\n  const label = String(form.get(\"label\") || \"\");\n\n  if (!LABELS.has(label)) return NextResponse.json({ error: \"Invalid or missing label\" }, { status: 400 });\n  if (!files || files.length === 0) return NextResponse.json({ error: \"No files\" }, { status: 400 });\n\n  const item = await prisma.dentalCase.findUnique({ where: { id: params.id } });\n  if (!item) return NextResponse.json({ error: \"Not found\" }, { status: 404 });\n\n  // Business rule: scan can only be replaced while in DESIGN stage\n  if (label === \"scan\" && item.stage !== \"DESIGN\") {\n    return NextResponse.json({ error: \"Scan cannot be replaced after Milling & Glazing starts\" }, { status: 400 });\n  }\n\n  const root = path.join(process.cwd(), \"public\", \"uploads\", params.id);\n  await fs.mkdir(root, { recursive: true });\n\n  const created = [];\n  for (const f of files) {\n    if (!(f instanceof File)) continue;\n    if (f.size > MAX_SIZE) return NextResponse.json({ error: \"File too large\" }, { status: 413 });\n\n    const ext = (f.name.split(\".\").pop() || \"\").toLowerCase();\n\n    // Per-slot format enforcement\n    if (label === \"scan\" && !ACCEPT_SCAN.has(ext)) {\n      return NextResponse.json({ error: \"Scan must be STL/PLY/OBJ\" }, { status: 400 });\n    }\n    if ((label === \"design_with_model\" || label === \"design_only\") && !ACCEPT_STL.has(ext)) {\n      return NextResponse.json({ error: \"Design files must be STL\" }, { status: 400 });\n    }\n\n    const extUpper = ext.toUpperCase();\n    const kindAny = ([\"STL\", \"PLY\", \"OBJ\"].includes(extUpper) ? extUpper : \"OTHER\") as any;\n\n    const name = `${Date.now()}-${crypto.randomUUID()}.${ext}`;\n    const fullpath = path.join(root, name);\n    const buf = Buffer.from(await f.arrayBuffer());\n    await fs.writeFile(fullpath, buf);\n\n    const publicUrl = `/uploads/${params.id}/${name}`;\n\n    // Replace existing file(s) for this label: delete DB rows (we keep old files on disk in dev)\n    await prisma.caseFile.deleteMany({ where: { caseId: params.id, label } });\n\n    const rec = await prisma.caseFile.create({\n      data: {\n        caseId: params.id,\n        label,\n        kind: kindAny,\n        url: publicUrl,\n        sizeBytes: buf.length,\n      } as any,\n    });\n    created.push(rec);\n  }\n\n  return NextResponse.json({ ok: true, files: created });\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}