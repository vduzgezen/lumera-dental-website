{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/prisma.ts"],"sourcesContent":["// portal/lib/prisma.ts\nimport { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"query\", \"error\", \"warn\"], // Helpful logs for dev\n  });\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalForPrisma.prisma = prisma;\n}"],"names":[],"mappings":"AAAA,uBAAuB;;;;;AACvB;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;QAAS;KAAO;AACjC;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B","debugId":null}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport jwt from \"jsonwebtoken\";\n\nexport type Session = {\n  userId: string;\n  role: \"customer\" | \"lab\" | \"admin\";\n  clinicId?: string;\n};\n\nconst COOKIE = \"lumera_session\";\nconst SECRET = process.env.JWT_SECRET!;\n\n/**\n * Read & verify the session JWT from the request cookies.\n * Next.js 15: cookies() can be async, so we await it.\n */\nexport async function getSession(): Promise<Session | null> {\n  const jar = await cookies(); // async in Next 15\n  const token = jar.get(COOKIE)?.value;\n  if (!token) return null;\n  try {\n    return jwt.verify(token, SECRET) as Session;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQA,MAAM,SAAS;AACf,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;AAM9B,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO,KAAI,mBAAmB;IAChD,MAAM,QAAQ,IAAI,GAAG,CAAC,SAAS;IAC/B,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 143, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/app/api/cases/%5Bid%5D/files/route.ts"],"sourcesContent":["// app/api/cases/[id]/files/route.ts\nimport { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { getSession } from \"@/lib/auth\";\nimport path from \"node:path\";\nimport fs from \"node:fs/promises\";\nimport { FileKind, ProductionStage } from \"@prisma/client\";\n\ntype Params = {\n  params: Promise<{ id: string }>;\n};\n\n/**\n * Normalizes the slot label coming from the client (\"scan\",\n * \"design_with_model\", \"design_only\") into what we store in\n * CaseFile.label.\n */\nfunction normalizeSlotLabel(raw: FormDataEntryValue | null): string {\n  const lower = (raw ?? \"\").toString().trim().toLowerCase();\n\n  if (!lower) return \"other\";\n  if (lower === \"scan\") return \"scan\";\n  if (lower === \"design_with_model\" || lower === \"model_plus_design\") {\n    return \"design_with_model\";\n  }\n  if (lower === \"design_only\") return \"design_only\";\n\n  return lower;\n}\n\n/**\n * Choose a file extension & FileKind enum based on the incoming\n * filename and slot.\n */\nfunction chooseExtAndKind(\n  originalName: string,\n  slot: string,\n): { ext: string; kind: FileKind } {\n  const lower = originalName.toLowerCase();\n\n  // Treat Exocad HTML exports as HTML, not STL\n  if (lower.endsWith(\".html\")) {\n    return { ext: \".html\", kind: FileKind.OTHER };\n  }\n  if (lower.endsWith(\".htm\")) {\n    return { ext: \".htm\", kind: FileKind.OTHER };\n  }\n\n  // 3D formats\n  if (lower.endsWith(\".stl\")) return { ext: \".stl\", kind: FileKind.STL };\n  if (lower.endsWith(\".ply\")) return { ext: \".ply\", kind: FileKind.PLY };\n  if (lower.endsWith(\".obj\")) return { ext: \".obj\", kind: FileKind.OBJ };\n\n  // No extension: assume STL for 3D slots\n  if (\n    slot === \"scan\" ||\n    slot === \"design_with_model\" ||\n    slot === \"design_only\"\n  ) {\n    return { ext: \".stl\", kind: FileKind.STL };\n  }\n\n  // Everything else\n  return { ext: \".bin\", kind: FileKind.OTHER };\n}\n\n/**\n * Inject a tiny DOM-level translator for Exocad HTML viewers.\n */\nfunction injectExocadTranslationScript(html: string): string {\n  if (html.includes(\"window.__LUMERA_EXOCAD_TRANSLATE__\")) {\n    return html;\n  }\n\n  const script = `\n<script>\n(function() {\n  if (window.__LUMERA_EXOCAD_TRANSLATE__) return;\n  window.__LUMERA_EXOCAD_TRANSLATE__ = true;\n\n  var MAP = {\n    \"Antagonistler\": \"Antagonists\",\n    \"Çene taramaları\": \"Jaw scans\",\n    \"C\\u0327ene taramaları\": \"Jaw scans\",\n    \"Cene taramalari\": \"Jaw scans\",\n    \"Tam anatomik\": \"Full contour\",\n    \"Alt tasarım\": \"Reduced design\",\n    \"Alt tasarim\": \"Reduced design\",\n    \"Minimum kalınlık\": \"Minimum thickness\",\n    \"Minimum kalinlik\": \"Minimum thickness\",\n    \"Bütün çene\": \"Full arch\",\n    \"Butun cene\": \"Full arch\",\n    \"Dolgu boslugu\": \"Cement gap\",\n    \"Dolgu boşluğu\": \"Cement gap\"\n  };\n\n  function translateNode(node) {\n    if (!node || !node.childNodes) return;\n    for (var i = 0; i < node.childNodes.length; i++) {\n      var child = node.childNodes[i];\n      if (!child) continue;\n\n      if (child.nodeType === 3) { // text node\n        var text = child.nodeValue || \"\";\n        if (!text) continue;\n        var replaced = text;\n        for (var key in MAP) {\n          if (!Object.prototype.hasOwnProperty.call(MAP, key)) continue;\n          if (replaced.indexOf(key) !== -1) {\n            replaced = replaced.split(key).join(MAP[key]);\n          }\n        }\n        if (replaced !== text) {\n          child.nodeValue = replaced;\n        }\n      } else {\n        translateNode(child);\n      }\n    }\n  }\n\n  function run() {\n    try {\n      translateNode(document.body);\n    } catch (e) {\n      console.error(\"Exocad translation failed\", e);\n    }\n  }\n\n  if (document.readyState === \"loading\") {\n    document.addEventListener(\"DOMContentLoaded\", run);\n  } else {\n    run();\n  }\n\n  window.addEventListener(\"load\", function() {\n    setTimeout(run, 1000);\n  });\n})();\n</script>\n`;\n\n  if (html.includes(\"</body>\")) {\n    return html.replace(\"</body>\", script + \"</body>\");\n  }\n  return html + script;\n}\n\nexport async function POST(req: Request, { params }: Params) {\n  const session = await getSession();\n  if (!session) {\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n\n  // Only lab/admin can upload files\n  if (session.role === \"customer\") {\n    return NextResponse.json(\n      { error: \"Only lab/admin may upload files.\" },\n      { status: 403 },\n    );\n  }\n\n  const { id } = await params;\n\n  const form = await req.formData();\n  const slotLabel = normalizeSlotLabel(form.get(\"label\"));\n\n  // Support both \"file\" and \"files\" keys\n  const incomingFiles: File[] = [\n    ...(form.getAll(\"file\") as File[]),\n    ...(form.getAll(\"files\") as File[]),\n  ].filter((f): f is File => f instanceof File);\n\n  if (!incomingFiles.length) {\n    return NextResponse.json({ error: \"No files uploaded.\" }, { status: 400 });\n  }\n\n  const dentalCase = await prisma.dentalCase.findUnique({\n    where: { id },\n    select: { id: true, stage: true },\n  });\n\n  if (!dentalCase) {\n    return NextResponse.json({ error: \"Case not found.\" }, { status: 404 });\n  }\n\n  // Business rule: scan HTML can only be replaced while in DESIGN stage\n  if (\n    slotLabel === \"scan\" &&\n    dentalCase.stage !== ProductionStage.DESIGN\n  ) {\n    return NextResponse.json(\n      {\n        error:\n          \"Scan files can only be uploaded while the case is in the DESIGN stage.\",\n      },\n      { status: 400 },\n    );\n  }\n\n  const uploadsRoot = path.join(process.cwd(), \"public\", \"uploads\", id);\n  await fs.mkdir(uploadsRoot, { recursive: true });\n\n  const created: any[] = [];\n\n  // One file per slot: remove existing records for this slot on this case\n  await prisma.caseFile.deleteMany({\n    where: { caseId: id, label: slotLabel },\n  });\n\n  for (const file of incomingFiles) {\n    const arrayBuffer = await file.arrayBuffer();\n    let buf = Buffer.from(arrayBuffer);\n\n    const originalName = (file.name || \"file\").replace(/\\s+/g, \"_\");\n\n    // This respects .html / .htm and keeps them as HTML\n    const { ext, kind } = chooseExtAndKind(originalName, slotLabel);\n\n    const hasExt = originalName.toLowerCase().endsWith(ext);\n    const base = hasExt\n      ? originalName.slice(0, originalName.length - ext.length)\n      : originalName;\n\n    const safeName = `${base}${ext}`;\n    const fullPath = path.join(uploadsRoot, safeName);\n\n    // If this is an HTML viewer, inject the translation helper\n    if (ext === \".html\" || ext === \".htm\") {\n      const text = buf.toString(\"utf8\");\n      const normalized = injectExocadTranslationScript(text);\n      buf = Buffer.from(normalized, \"utf8\");\n    }\n\n    await fs.writeFile(fullPath, buf);\n\n    const publicUrl = `/uploads/${id}/${safeName}`;\n\n    const rec = await prisma.caseFile.create({\n      data: {\n        caseId: id,\n        label: slotLabel,\n        kind: kind,\n        url: publicUrl,\n        sizeBytes: buf.length,\n      },\n      select: {\n        id: true,\n        url: true,\n        label: true,\n        kind: true,\n      },\n    });\n\n    created.push(rec);\n  }\n\n  return NextResponse.json({ ok: true, files: created });\n}"],"names":[],"mappings":"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","debugId":null}}]
}