{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst g = global as unknown as { prisma?: PrismaClient };\nexport const prisma = g.prisma ?? new PrismaClient();\nif (process.env.NODE_ENV !== \"production\") g.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACC,MAAM,SAAS,EAAE,MAAM,IAAI,IAAI,6IAAY;AAClD,wCAA2C,EAAE,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport jwt from \"jsonwebtoken\";\n\nexport type Session = {\n  userId: string;\n  role: \"customer\" | \"lab\" | \"admin\";\n  clinicId?: string;\n};\n\nconst COOKIE = \"lumera_session\";\nconst SECRET = process.env.JWT_SECRET!;\n\n/**\n * Read & verify the session JWT from the request cookies.\n * Next.js 15: cookies() can be async, so we await it.\n */\nexport async function getSession(): Promise<Session | null> {\n  const jar = await cookies(); // async in Next 15\n  const token = jar.get(COOKIE)?.value;\n  if (!token) return null;\n  try {\n    return jwt.verify(token, SECRET) as Session;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQA,MAAM,SAAS;AACf,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;AAM9B,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO,KAAI,mBAAmB;IAChD,MAAM,QAAQ,IAAI,GAAG,CAAC,SAAS;IAC/B,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/app/api/cases/%5Bid%5D/stage/route.ts"],"sourcesContent":["// app/api/cases/[id]/stage/route.ts\nimport { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { getSession } from \"@/lib/auth\";\n\ntype Params = {\n  params: Promise<{ id: string }>;\n};\n\nfunction getCaseModel(p: any) {\n  return p.dentalCase ?? p.case ?? p.case_;\n}\n\ntype Stage = \"DESIGN\" | \"MILLING_GLAZING\" | \"SHIPPING\";\n\nconst STAGE_ORDER: Stage[] = [\"DESIGN\", \"MILLING_GLAZING\", \"SHIPPING\"];\n\nexport async function PATCH(req: Request, { params }: Params) {\n  const session = await getSession();\n  if (!session) {\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n  if (session.role !== \"admin\" && session.role !== \"lab\") {\n    return NextResponse.json(\n      { error: \"Only lab/admin can update the process.\" },\n      { status: 403 },\n    );\n  }\n\n  const { id } = await params;\n\n  let body: any;\n  try {\n    body = await req.json();\n  } catch {\n    return NextResponse.json(\n      { error: \"Invalid request body.\" },\n      { status: 400 },\n    );\n  }\n\n  const targetStage = body?.stage as Stage | undefined;\n  if (!targetStage || !STAGE_ORDER.includes(targetStage)) {\n    return NextResponse.json(\n      { error: \"Invalid target stage.\" },\n      { status: 400 },\n    );\n  }\n\n  const model = getCaseModel(prisma as any);\n\n  const existing = await model.findUnique({\n    where: { id },\n    select: {\n      id: true,\n      stage: true,\n      status: true,\n    },\n  });\n\n  if (!existing) {\n    return NextResponse.json({ error: \"Case not found.\" }, { status: 404 });\n  }\n\n  const currentStage = existing.stage as Stage;\n  const currentStatus = existing.status as string;\n\n  const currentIndex = STAGE_ORDER.indexOf(currentStage);\n  const targetIndex = STAGE_ORDER.indexOf(targetStage);\n\n  if (targetIndex === -1) {\n    return NextResponse.json(\n      { error: \"Unsupported stage.\" },\n      { status: 400 },\n    );\n  }\n\n  if (targetIndex === currentIndex) {\n    return NextResponse.json({ ok: true, stage: currentStage });\n  }\n\n  if (targetIndex < currentIndex) {\n    return NextResponse.json(\n      { error: \"Process cannot move backwards.\" },\n      { status: 400 },\n    );\n  }\n\n  // Enforce business rules on transitions\n  let nextStatus = currentStatus;\n\n  if (currentStage === \"DESIGN\" && targetStage === \"MILLING_GLAZING\") {\n    if (currentStatus !== \"APPROVED\") {\n      return NextResponse.json(\n        {\n          error:\n            \"Case must be APPROVED before moving to Milling & Glazing.\",\n        },\n        { status: 400 },\n      );\n    }\n    nextStatus = \"IN_MILLING\";\n  } else if (\n    currentStage === \"MILLING_GLAZING\" &&\n    targetStage === \"SHIPPING\"\n  ) {\n    // When shipping, mark as shipped\n    nextStatus = \"SHIPPED\";\n  } else if (currentStage === \"DESIGN\" && targetStage === \"SHIPPING\") {\n    return NextResponse.json(\n      {\n        error:\n          \"Case must go through Milling & Glazing before Shipping.\",\n      },\n      { status: 400 },\n    );\n  }\n\n  const updated = await model.update({\n    where: { id },\n    data: {\n      stage: targetStage,\n      status: nextStatus as any,\n    } as any,\n    select: { id: true, stage: true, status: true },\n  });\n\n  return NextResponse.json({ ok: true, stage: updated.stage, status: updated.status });\n}\n"],"names":[],"mappings":"AAAA,oCAAoC;;;;;AACpC;AACA;AACA;;;;AAMA,SAAS,aAAa,CAAM;IAC1B,OAAO,EAAE,UAAU,IAAI,EAAE,IAAI,IAAI,EAAE,KAAK;AAC1C;AAIA,MAAM,cAAuB;IAAC;IAAU;IAAmB;CAAW;AAE/D,eAAe,MAAM,GAAY,EAAE,EAAE,MAAM,EAAU;IAC1D,MAAM,UAAU,MAAM,IAAA,2HAAU;IAChC,IAAI,CAAC,SAAS;QACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;IACA,IAAI,QAAQ,IAAI,KAAK,WAAW,QAAQ,IAAI,KAAK,OAAO;QACtD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAyC,GAClD;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;IAErB,IAAI;IACJ,IAAI;QACF,OAAO,MAAM,IAAI,IAAI;IACvB,EAAE,OAAM;QACN,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,cAAc,MAAM;IAC1B,IAAI,CAAC,eAAe,CAAC,YAAY,QAAQ,CAAC,cAAc;QACtD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,QAAQ,aAAa,yHAAM;IAEjC,MAAM,WAAW,MAAM,MAAM,UAAU,CAAC;QACtC,OAAO;YAAE;QAAG;QACZ,QAAQ;YACN,IAAI;YACJ,OAAO;YACP,QAAQ;QACV;IACF;IAEA,IAAI,CAAC,UAAU;QACb,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkB,GAAG;YAAE,QAAQ;QAAI;IACvE;IAEA,MAAM,eAAe,SAAS,KAAK;IACnC,MAAM,gBAAgB,SAAS,MAAM;IAErC,MAAM,eAAe,YAAY,OAAO,CAAC;IACzC,MAAM,cAAc,YAAY,OAAO,CAAC;IAExC,IAAI,gBAAgB,CAAC,GAAG;QACtB,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAqB,GAC9B;YAAE,QAAQ;QAAI;IAElB;IAEA,IAAI,gBAAgB,cAAc;QAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM,OAAO;QAAa;IAC3D;IAEA,IAAI,cAAc,cAAc;QAC9B,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAiC,GAC1C;YAAE,QAAQ;QAAI;IAElB;IAEA,wCAAwC;IACxC,IAAI,aAAa;IAEjB,IAAI,iBAAiB,YAAY,gBAAgB,mBAAmB;QAClE,IAAI,kBAAkB,YAAY;YAChC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,OACE;YACJ,GACA;gBAAE,QAAQ;YAAI;QAElB;QACA,aAAa;IACf,OAAO,IACL,iBAAiB,qBACjB,gBAAgB,YAChB;QACA,iCAAiC;QACjC,aAAa;IACf,OAAO,IAAI,iBAAiB,YAAY,gBAAgB,YAAY;QAClE,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OACE;QACJ,GACA;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,UAAU,MAAM,MAAM,MAAM,CAAC;QACjC,OAAO;YAAE;QAAG;QACZ,MAAM;YACJ,OAAO;YACP,QAAQ;QACV;QACA,QAAQ;YAAE,IAAI;YAAM,OAAO;YAAM,QAAQ;QAAK;IAChD;IAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,IAAI;QAAM,OAAO,QAAQ,KAAK;QAAE,QAAQ,QAAQ,MAAM;IAAC;AACpF","debugId":null}}]
}