{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/prisma.ts"],"sourcesContent":["// portal/lib/prisma.ts\nimport { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"query\", \"error\", \"warn\"], // Helpful logs for dev\n  });\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalForPrisma.prisma = prisma;\n}"],"names":[],"mappings":"AAAA,uBAAuB;;;;;AACvB;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;QAAS;KAAO;AACjC;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B","debugId":null}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport jwt from \"jsonwebtoken\";\n\nexport type Session = {\n  userId: string;\n  role: \"customer\" | \"lab\" | \"admin\";\n  clinicId?: string;\n};\n\nconst COOKIE = \"lumera_session\";\nconst SECRET = process.env.JWT_SECRET!;\n\n/**\n * Read & verify the session JWT from the request cookies.\n * Next.js 15: cookies() can be async, so we await it.\n */\nexport async function getSession(): Promise<Session | null> {\n  const jar = await cookies(); // async in Next 15\n  const token = jar.get(COOKIE)?.value;\n  if (!token) return null;\n  try {\n    return jwt.verify(token, SECRET) as Session;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQA,MAAM,SAAS;AACf,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;AAM9B,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO,KAAI,mBAAmB;IAChD,MAAM,QAAQ,IAAI,GAAG,CAAC,SAAS;IAC/B,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 143, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/app/api/cases/new/route.ts"],"sourcesContent":["// app/api/cases/new/route.ts\nimport { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { getSession } from \"@/lib/auth\";\nimport path from \"node:path\";\nimport fs from \"node:fs/promises\";\nimport { ProductKind, FileKind, CaseStatus, ProductionStage } from \"@prisma/client\";\n\nconst MAX_SCAN_VIEWER_BYTES = 200 * 1024 * 1024; // 200MB\n\nfunction addDays(d: Date, n: number) {\n  const x = new Date(d);\n  x.setDate(x.getDate() + n);\n  x.setHours(0, 0, 0, 0);\n  return x;\n}\n\n/**\n * Sanitize an HTML filename\n */\nfunction sanitizeHtmlFileName(original: string, fallbackBase: string): string {\n  const baseName = (original || fallbackBase).replace(/\\s+/g, \"_\");\n  const lower = baseName.toLowerCase();\n\n  let ext = \".html\";\n  if (lower.endsWith(\".html\")) {\n    ext = \".html\";\n  } else if (lower.endsWith(\".htm\")) {\n    ext = \".htm\";\n  }\n\n  let nameWithoutExt = baseName;\n  if (lower.endsWith(\".html\") || lower.endsWith(\".htm\")) {\n    const idx = baseName.lastIndexOf(\".\");\n    if (idx >= 0) {\n      nameWithoutExt = baseName.slice(0, idx);\n    }\n  }\n\n  const cleanedBase = nameWithoutExt.replace(/[?#]/g, \"\");\n  return cleanedBase + ext;\n}\n\n/**\n * Normalize Exocad HTML text\n */\nfunction normalizeExocadHtml(html: string): string {\n  const script = `\n<script>\n(function() {\n  var MAP = {\n    \"Antagonistler\": \"Antagonists\",\n    \"Çene taramaları\": \"Jaw scans\",\n    \"Çene taramaları\": \"Jaw scans\",\n    \"Cene taramalari\": \"Jaw scans\",\n    \"Çene taraması\": \"Jaw scan\",\n    \"Tam anatomik\": \"Full anatomy\",\n    \"Alt tasarım\": \"Lower design\",\n    \"Alt tasarim\": \"Lower design\",\n    \"Minimum kalınlık\": \"Minimum thickness\",\n    \"Minimum kalinlik\": \"Minimum thickness\",\n    \"Bütün çene\": \"Whole jaw\",\n    \"Butun cene\": \"Whole jaw\",\n    \"Dolgu boslugu\": \"Filling gap\"\n  };\n\n  function translateNode(node) {\n    if (!node) return;\n    if (node.nodeType === 3) { // text\n      var text = node.nodeValue || \"\";\n      var changed = false;\n      for (var key in MAP) {\n        if (!Object.prototype.hasOwnProperty.call(MAP, key)) continue;\n        if (text.indexOf(key) !== -1) {\n          text = text.split(key).join(MAP[key]);\n          changed = true;\n        }\n      }\n      if (changed) {\n        node.nodeValue = text;\n      }\n      return;\n    }\n    if (node.nodeType === 1 && node.childNodes && node.childNodes.length) {\n      for (var i = 0; i < node.childNodes.length; i++) {\n        translateNode(node.childNodes[i]);\n      }\n    }\n  }\n\n  function run() {\n    try {\n      translateNode(document.body);\n    } catch (e) {\n      console.error(\"Exocad translation script error:\", e);\n    }\n  }\n\n  window.addEventListener(\"load\", function() {\n    setTimeout(run, 500);\n  });\n})();\n</script>\n`;\n\n  if (html.includes(\"</body>\")) {\n    return html.replace(\"</body>\", script + \"\\n</body>\");\n  }\n  return html + script;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const session = await getSession();\n    if (!session) {\n      return NextResponse.json({ error: \"Please sign in.\" }, { status: 401 });\n    }\n    if (session.role === \"customer\") {\n      return NextResponse.json(\n        { error: \"Only lab/admin can create cases.\" },\n        { status: 403 },\n      );\n    }\n\n    const form = await req.formData();\n\n    const alias = form.get(\"patientAlias\");\n    const doctorUserId = form.get(\"doctorUserId\");\n    const toothCodes = form.get(\"toothCodes\");\n    const orderDateRaw = form.get(\"orderDate\");\n    const product = form.get(\"product\");\n    const material = form.get(\"material\");\n    const shade = form.get(\"shade\");\n\n    // Scan viewer HTML: prefer explicit field, fall back to \"scan\" for compatibility\n    const scanViewerRaw = form.get(\"scanHtml\") ?? form.get(\"scan\");\n\n    if (typeof alias !== \"string\" || !alias.trim()) {\n      return NextResponse.json(\n        { error: \"Patient alias is required.\" },\n        { status: 400 },\n      );\n    }\n    if (typeof doctorUserId !== \"string\" || !doctorUserId) {\n      return NextResponse.json(\n        { error: \"Doctor user id is required.\" },\n        { status: 400 },\n      );\n    }\n    if (typeof toothCodes !== \"string\" || !toothCodes.trim()) {\n      return NextResponse.json(\n        { error: \"Tooth codes are required.\" },\n        { status: 400 },\n      );\n    }\n    if (typeof orderDateRaw !== \"string\") {\n      return NextResponse.json(\n        { error: \"Order date missing or invalid.\" },\n        { status: 400 },\n      );\n    }\n    if (typeof product !== \"string\" || !product) {\n      return NextResponse.json(\n        { error: \"Product is required.\" },\n        { status: 400 },\n      );\n    }\n\n    if (!(scanViewerRaw instanceof File)) {\n      return NextResponse.json(\n        { error: \"Scan viewer HTML is required.\" },\n        { status: 400 },\n      );\n    }\n\n    const orderDate = new Date(orderDateRaw);\n    if (Number.isNaN(orderDate.getTime())) {\n      return NextResponse.json(\n        { error: \"Order date invalid.\" },\n        { status: 400 },\n      );\n    }\n    const dueDate = addDays(orderDate, 8);\n\n    const doctor = await prisma.user.findUnique({\n      where: { id: doctorUserId },\n      select: {\n        id: true,\n        name: true,\n        role: true,\n        email: true,\n        clinicId: true,\n        clinic: { select: { id: true, name: true } },\n      },\n    });\n\n    if (!doctor || doctor.role !== \"customer\") {\n      return NextResponse.json(\n        { error: \"Doctor account not found.\" },\n        { status: 400 },\n      );\n    }\n    if (!doctor.clinicId || !doctor.clinic) {\n      return NextResponse.json(\n        { error: \"Doctor has no clinic linked.\" },\n        { status: 400 },\n      );\n    }\n\n    // Validate scan viewer type and size\n    const scanViewer = scanViewerRaw as File;\n    const originalName = scanViewer.name || \"scan_viewer.html\";\n    const lower = originalName.toLowerCase();\n    if (!lower.endsWith(\".html\") && !lower.endsWith(\".htm\")) {\n      return NextResponse.json(\n        { error: \"Scan viewer must be an HTML file.\" },\n        { status: 400 },\n      );\n    }\n\n    const scanBuf = Buffer.from(await scanViewer.arrayBuffer());\n    if (scanBuf.length > MAX_SCAN_VIEWER_BYTES) {\n      return NextResponse.json(\n        { error: \"Scan viewer file is too large.\" },\n        { status: 400 },\n      );\n    }\n\n    // DIRECT FIX: Use prisma.dentalCase.create and proper Enum casting\n    const created = await prisma.dentalCase.create({\n      data: {\n        clinicId: doctor.clinic.id,\n        doctorUserId: doctor.id,\n        patientAlias: alias.trim(),\n        doctorName: doctor.name ?? null,\n        toothCodes: toothCodes.trim(),\n        orderDate,\n        dueDate,\n        product: product as ProductKind, // Enforce Enum\n        material:\n          typeof material === \"string\" && material.trim()\n            ? material.trim()\n            : null,\n        shade:\n          typeof shade === \"string\" && shade.trim() ? shade.trim() : null,\n        status: CaseStatus.IN_DESIGN,\n        stage: ProductionStage.DESIGN,\n      },\n      select: { id: true },\n    });\n\n    // Save scan viewer HTML under /public/uploads/<caseId>/<filename>\n    const uploadsRoot = path.join(\n      process.cwd(),\n      \"public\",\n      \"uploads\",\n      created.id,\n    );\n    await fs.mkdir(uploadsRoot, { recursive: true });\n\n    const safeName = sanitizeHtmlFileName(\n      originalName,\n      \"scan_viewer.html\",\n    );\n\n    const htmlText = scanBuf.toString(\"utf8\");\n    const normalized = normalizeExocadHtml(htmlText);\n    const finalBuf = Buffer.from(normalized, \"utf8\");\n\n    const fullPath = path.join(uploadsRoot, safeName);\n    await fs.writeFile(fullPath, finalBuf);\n\n    const publicUrl = `/uploads/${created.id}/${safeName}`;\n\n    await prisma.caseFile.create({\n      data: {\n        caseId: created.id,\n        label: \"scan_html\",\n        kind: FileKind.OTHER,\n        url: publicUrl,\n        sizeBytes: finalBuf.length,\n      },\n    });\n\n    return NextResponse.json({ ok: true, id: created.id });\n  } catch (err) {\n    console.error(\"Create case error:\", err);\n    return NextResponse.json(\n      { error: \"Something went wrong creating the case.\" },\n      { status: 500 },\n    );\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}