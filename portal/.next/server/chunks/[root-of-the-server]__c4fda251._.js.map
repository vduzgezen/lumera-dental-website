{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst g = global as unknown as { prisma?: PrismaClient };\nexport const prisma = g.prisma ?? new PrismaClient();\nif (process.env.NODE_ENV !== \"production\") g.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACC,MAAM,SAAS,EAAE,MAAM,IAAI,IAAI,6IAAY;AAClD,wCAA2C,EAAE,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport jwt from \"jsonwebtoken\";\n\nexport type Session = {\n  userId: string;\n  role: \"customer\" | \"lab\" | \"admin\";\n  clinicId?: string;\n};\n\nconst COOKIE = \"lumera_session\";\nconst SECRET = process.env.JWT_SECRET!;\n\n/**\n * Read & verify the session JWT from the request cookies.\n * Next.js 15: cookies() can be async, so we await it.\n */\nexport async function getSession(): Promise<Session | null> {\n  const jar = await cookies(); // async in Next 15\n  const token = jar.get(COOKIE)?.value;\n  if (!token) return null;\n  try {\n    return jwt.verify(token, SECRET) as Session;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQA,MAAM,SAAS;AACf,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;AAM9B,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO,KAAI,mBAAmB;IAChD,MAAM,QAAQ,IAAI,GAAG,CAAC,SAAS;IAC/B,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 140, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/app/api/cases/new/route.ts"],"sourcesContent":["// app/api/cases/new/route.ts\nimport { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { getSession } from \"@/lib/auth\";\nimport path from \"node:path\";\nimport fs from \"node:fs/promises\";\nimport crypto from \"node:crypto\";\n\nconst ACCEPT_SCAN_EXT = new Set([\".stl\", \".ply\", \".obj\"]);\nconst MAX_SCAN_BYTES = 200 * 1024 * 1024; // 200MB\n\n/** DentalCase may be named differently in Prisma client */\nfunction getCaseModel(p: any) {\n  return p.dentalCase ?? p.case ?? p.case_;\n}\n\nfunction addDays(d: Date, n: number) {\n  const x = new Date(d);\n  x.setDate(x.getDate() + n);\n  x.setHours(0, 0, 0, 0);\n  return x;\n}\n\nfunction chooseExtAndKind(\n  originalName: string,\n): { ext: string; kind: \"STL\" | \"PLY\" | \"OBJ\" } {\n  const lower = originalName.toLowerCase();\n  if (lower.endsWith(\".stl\")) return { ext: \".stl\", kind: \"STL\" };\n  if (lower.endsWith(\".ply\")) return { ext: \".ply\", kind: \"PLY\" };\n  if (lower.endsWith(\".obj\")) return { ext: \".obj\", kind: \"OBJ\" };\n\n  // Default to STL if extension missing but we accepted it as a scan\n  return { ext: \".stl\", kind: \"STL\" };\n}\n\nexport async function POST(req: Request) {\n  try {\n    const session = await getSession();\n    if (!session) {\n      return NextResponse.json({ error: \"Please sign in.\" }, { status: 401 });\n    }\n    if (session.role === \"customer\") {\n      return NextResponse.json(\n        { error: \"Only lab/admin can create cases.\" },\n        { status: 403 },\n      );\n    }\n\n    const form = await req.formData();\n\n    const alias = form.get(\"patientAlias\");\n    const doctorUserId = form.get(\"doctorUserId\");\n    const toothCodes = form.get(\"toothCodes\");\n    const orderDateRaw = form.get(\"orderDate\");\n    const product = form.get(\"product\");\n    const material = form.get(\"material\");\n    const shade = form.get(\"shade\");\n    const scan = form.get(\"scan\");\n\n    if (typeof alias !== \"string\" || !alias.trim()) {\n      return NextResponse.json(\n        { error: \"Patient alias is required.\" },\n        { status: 400 },\n      );\n    }\n    if (typeof doctorUserId !== \"string\" || !doctorUserId) {\n      return NextResponse.json(\n        { error: \"Doctor user id is required.\" },\n        { status: 400 },\n      );\n    }\n    if (typeof toothCodes !== \"string\" || !toothCodes.trim()) {\n      return NextResponse.json(\n        { error: \"Tooth codes are required.\" },\n        { status: 400 },\n      );\n    }\n    if (typeof orderDateRaw !== \"string\") {\n      return NextResponse.json(\n        { error: \"Order date missing or invalid.\" },\n        { status: 400 },\n      );\n    }\n    if (typeof product !== \"string\" || !product) {\n      return NextResponse.json(\n        { error: \"Product is required.\" },\n        { status: 400 },\n      );\n    }\n    if (!(scan instanceof File)) {\n      return NextResponse.json(\n        { error: \"Scan file is required.\" },\n        { status: 400 },\n      );\n    }\n\n    const orderDate = new Date(orderDateRaw);\n    if (Number.isNaN(orderDate.getTime())) {\n      return NextResponse.json(\n        { error: \"Order date invalid.\" },\n        { status: 400 },\n      );\n    }\n    const dueDate = addDays(orderDate, 8);\n\n    const doctor = await prisma.user.findUnique({\n      where: { id: doctorUserId },\n      select: {\n        id: true,\n        name: true,\n        role: true,\n        email: true,\n        clinicId: true,\n        clinic: { select: { id: true, name: true } },\n      },\n    });\n\n    if (!doctor || doctor.role !== \"customer\") {\n      return NextResponse.json(\n        { error: \"Doctor account not found.\" },\n        { status: 400 },\n      );\n    }\n    if (!doctor.clinicId || !doctor.clinic) {\n      return NextResponse.json(\n        { error: \"Doctor has no clinic linked.\" },\n        { status: 400 },\n      );\n    }\n\n    // Validate scan extension and size\n    const originalName = scan.name || \"scan\";\n    const lower = originalName.toLowerCase();\n    const ext =\n      lower.lastIndexOf(\".\") !== -1 ? lower.slice(lower.lastIndexOf(\".\")) : \"\";\n    if (!ACCEPT_SCAN_EXT.has(ext as any)) {\n      return NextResponse.json(\n        { error: \"Scan must be STL, PLY, or OBJ.\" },\n        { status: 400 },\n      );\n    }\n\n    const scanBuf = Buffer.from(await scan.arrayBuffer());\n    if (scanBuf.length > MAX_SCAN_BYTES) {\n      return NextResponse.json(\n        { error: \"Scan file is too large.\" },\n        { status: 400 },\n      );\n    }\n\n    const caseModel = getCaseModel(prisma as any);\n\n    const created = await caseModel.create({\n      data: {\n        clinicId: doctor.clinic.id,\n        doctorUserId: doctor.id,\n        patientAlias: alias.trim(),\n        doctorName: doctor.name ?? null,\n        toothCodes: toothCodes.trim(),\n        orderDate,\n        dueDate,\n        product: product as any,\n        material:\n          typeof material === \"string\" && material.trim()\n            ? material.trim()\n            : null,\n        shade:\n          typeof shade === \"string\" && shade.trim() ? shade.trim() : null,\n        status: \"IN_DESIGN\",\n        stage: \"DESIGN\",\n      } as any,\n      select: { id: true },\n    });\n\n    // Save scan under /public/uploads/<caseId>/<filename>\n    const uploadsRoot = path.join(\n      process.cwd(),\n      \"public\",\n      \"uploads\",\n      created.id,\n    );\n    await fs.mkdir(uploadsRoot, { recursive: true });\n\n    const { ext: chosenExt, kind } = chooseExtAndKind(originalName);\n    const fileName = `${Date.now()}-${crypto.randomUUID()}${chosenExt}`;\n    const fullPath = path.join(uploadsRoot, fileName);\n    await fs.writeFile(fullPath, scanBuf);\n\n    const publicUrl = `/uploads/${created.id}/${fileName}`;\n\n    await prisma.caseFile.create({\n      data: {\n        caseId: created.id,\n        label: \"scan\",\n        kind: kind as any,\n        url: publicUrl,\n        sizeBytes: scanBuf.length,\n      } as any,\n    });\n\n    return NextResponse.json({ ok: true, id: created.id });\n  } catch (err) {\n    console.error(\"Create case error:\", err);\n    return NextResponse.json(\n      { error: \"Something went wrong creating the case.\" },\n      { status: 500 },\n    );\n  }\n}\n"],"names":[],"mappings":"AAAA,6BAA6B;;;;;AAC7B;AACA;AACA;AACA;AACA;AACA;;;;;;;AAEA,MAAM,kBAAkB,IAAI,IAAI;IAAC;IAAQ;IAAQ;CAAO;AACxD,MAAM,iBAAiB,MAAM,OAAO,MAAM,QAAQ;AAElD,yDAAyD,GACzD,SAAS,aAAa,CAAM;IAC1B,OAAO,EAAE,UAAU,IAAI,EAAE,IAAI,IAAI,EAAE,KAAK;AAC1C;AAEA,SAAS,QAAQ,CAAO,EAAE,CAAS;IACjC,MAAM,IAAI,IAAI,KAAK;IACnB,EAAE,OAAO,CAAC,EAAE,OAAO,KAAK;IACxB,EAAE,QAAQ,CAAC,GAAG,GAAG,GAAG;IACpB,OAAO;AACT;AAEA,SAAS,iBACP,YAAoB;IAEpB,MAAM,QAAQ,aAAa,WAAW;IACtC,IAAI,MAAM,QAAQ,CAAC,SAAS,OAAO;QAAE,KAAK;QAAQ,MAAM;IAAM;IAC9D,IAAI,MAAM,QAAQ,CAAC,SAAS,OAAO;QAAE,KAAK;QAAQ,MAAM;IAAM;IAC9D,IAAI,MAAM,QAAQ,CAAC,SAAS,OAAO;QAAE,KAAK;QAAQ,MAAM;IAAM;IAE9D,mEAAmE;IACnE,OAAO;QAAE,KAAK;QAAQ,MAAM;IAAM;AACpC;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,2HAAU;QAChC,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QACA,IAAI,QAAQ,IAAI,KAAK,YAAY;YAC/B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAmC,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,IAAI,QAAQ;QAE/B,MAAM,QAAQ,KAAK,GAAG,CAAC;QACvB,MAAM,eAAe,KAAK,GAAG,CAAC;QAC9B,MAAM,aAAa,KAAK,GAAG,CAAC;QAC5B,MAAM,eAAe,KAAK,GAAG,CAAC;QAC9B,MAAM,UAAU,KAAK,GAAG,CAAC;QACzB,MAAM,WAAW,KAAK,GAAG,CAAC;QAC1B,MAAM,QAAQ,KAAK,GAAG,CAAC;QACvB,MAAM,OAAO,KAAK,GAAG,CAAC;QAEtB,IAAI,OAAO,UAAU,YAAY,CAAC,MAAM,IAAI,IAAI;YAC9C,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA6B,GACtC;gBAAE,QAAQ;YAAI;QAElB;QACA,IAAI,OAAO,iBAAiB,YAAY,CAAC,cAAc;YACrD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA8B,GACvC;gBAAE,QAAQ;YAAI;QAElB;QACA,IAAI,OAAO,eAAe,YAAY,CAAC,WAAW,IAAI,IAAI;YACxD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4B,GACrC;gBAAE,QAAQ;YAAI;QAElB;QACA,IAAI,OAAO,iBAAiB,UAAU;YACpC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiC,GAC1C;gBAAE,QAAQ;YAAI;QAElB;QACA,IAAI,OAAO,YAAY,YAAY,CAAC,SAAS;YAC3C,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAuB,GAChC;gBAAE,QAAQ;YAAI;QAElB;QACA,IAAI,CAAC,CAAC,gBAAgB,IAAI,GAAG;YAC3B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAyB,GAClC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,YAAY,IAAI,KAAK;QAC3B,IAAI,OAAO,KAAK,CAAC,UAAU,OAAO,KAAK;YACrC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsB,GAC/B;gBAAE,QAAQ;YAAI;QAElB;QACA,MAAM,UAAU,QAAQ,WAAW;QAEnC,MAAM,SAAS,MAAM,yHAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YAC1C,OAAO;gBAAE,IAAI;YAAa;YAC1B,QAAQ;gBACN,IAAI;gBACJ,MAAM;gBACN,MAAM;gBACN,OAAO;gBACP,UAAU;gBACV,QAAQ;oBAAE,QAAQ;wBAAE,IAAI;wBAAM,MAAM;oBAAK;gBAAE;YAC7C;QACF;QAEA,IAAI,CAAC,UAAU,OAAO,IAAI,KAAK,YAAY;YACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4B,GACrC;gBAAE,QAAQ;YAAI;QAElB;QACA,IAAI,CAAC,OAAO,QAAQ,IAAI,CAAC,OAAO,MAAM,EAAE;YACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA+B,GACxC;gBAAE,QAAQ;YAAI;QAElB;QAEA,mCAAmC;QACnC,MAAM,eAAe,KAAK,IAAI,IAAI;QAClC,MAAM,QAAQ,aAAa,WAAW;QACtC,MAAM,MACJ,MAAM,WAAW,CAAC,SAAS,CAAC,IAAI,MAAM,KAAK,CAAC,MAAM,WAAW,CAAC,QAAQ;QACxE,IAAI,CAAC,gBAAgB,GAAG,CAAC,MAAa;YACpC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiC,GAC1C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,UAAU,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;QAClD,IAAI,QAAQ,MAAM,GAAG,gBAAgB;YACnC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,YAAY,aAAa,yHAAM;QAErC,MAAM,UAAU,MAAM,UAAU,MAAM,CAAC;YACrC,MAAM;gBACJ,UAAU,OAAO,MAAM,CAAC,EAAE;gBAC1B,cAAc,OAAO,EAAE;gBACvB,cAAc,MAAM,IAAI;gBACxB,YAAY,OAAO,IAAI,IAAI;gBAC3B,YAAY,WAAW,IAAI;gBAC3B;gBACA;gBACA,SAAS;gBACT,UACE,OAAO,aAAa,YAAY,SAAS,IAAI,KACzC,SAAS,IAAI,KACb;gBACN,OACE,OAAO,UAAU,YAAY,MAAM,IAAI,KAAK,MAAM,IAAI,KAAK;gBAC7D,QAAQ;gBACR,OAAO;YACT;YACA,QAAQ;gBAAE,IAAI;YAAK;QACrB;QAEA,sDAAsD;QACtD,MAAM,cAAc,4HAAI,CAAC,IAAI,CAC3B,QAAQ,GAAG,IACX,UACA,WACA,QAAQ,EAAE;QAEZ,MAAM,gJAAE,CAAC,KAAK,CAAC,aAAa;YAAE,WAAW;QAAK;QAE9C,MAAM,EAAE,KAAK,SAAS,EAAE,IAAI,EAAE,GAAG,iBAAiB;QAClD,MAAM,WAAW,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,gIAAM,CAAC,UAAU,KAAK,WAAW;QACnE,MAAM,WAAW,4HAAI,CAAC,IAAI,CAAC,aAAa;QACxC,MAAM,gJAAE,CAAC,SAAS,CAAC,UAAU;QAE7B,MAAM,YAAY,CAAC,SAAS,EAAE,QAAQ,EAAE,CAAC,CAAC,EAAE,UAAU;QAEtD,MAAM,yHAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;YAC3B,MAAM;gBACJ,QAAQ,QAAQ,EAAE;gBAClB,OAAO;gBACP,MAAM;gBACN,KAAK;gBACL,WAAW,QAAQ,MAAM;YAC3B;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM,IAAI,QAAQ,EAAE;QAAC;IACtD,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA0C,GACnD;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}