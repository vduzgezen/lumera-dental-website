{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst g = global as unknown as { prisma?: PrismaClient };\nexport const prisma = g.prisma ?? new PrismaClient();\nif (process.env.NODE_ENV !== \"production\") g.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACC,MAAM,SAAS,EAAE,MAAM,IAAI,IAAI,6IAAY;AAClD,wCAA2C,EAAE,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport jwt from \"jsonwebtoken\";\n\nexport type Session = {\n  userId: string;\n  role: \"customer\" | \"lab\" | \"admin\";\n  clinicId?: string;\n};\n\nconst COOKIE = \"lumera_session\";\nconst SECRET = process.env.JWT_SECRET!;\n\n/**\n * Read & verify the session JWT from the request cookies.\n * Next.js 15: cookies() can be async, so we await it.\n */\nexport async function getSession(): Promise<Session | null> {\n  const jar = await cookies(); // async in Next 15\n  const token = jar.get(COOKIE)?.value;\n  if (!token) return null;\n  try {\n    return jwt.verify(token, SECRET) as Session;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQA,MAAM,SAAS;AACf,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;AAM9B,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO,KAAI,mBAAmB;IAChD,MAAM,QAAQ,IAAI,GAAG,CAAC,SAAS;IAC/B,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 134, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/app/api/cases/new/route.ts"],"sourcesContent":["// app/api/cases/new/route.ts\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { getSession } from \"@/lib/auth\";\nimport path from \"path\";\nimport fs from \"fs/promises\";\nimport crypto from \"crypto\";\n\nconst ACCEPT_SCAN = new Set([\"stl\", \"ply\", \"obj\"]);\nconst MAX_SIZE = 200 * 1024 * 1024; // 200MB\n\nfunction addDays(d: Date, n: number) {\n  const x = new Date(d);\n  x.setDate(x.getDate() + n);\n  x.setHours(0, 0, 0, 0);\n  return x;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const session = await getSession();\n    if (!session) return NextResponse.json({ error: \"Please sign in.\" }, { status: 401 });\n    if (session.role === \"customer\") return NextResponse.json({ error: \"Only lab/admin can create cases.\" }, { status: 403 });\n\n    const form = await req.formData();\n    const alias        = String(form.get(\"patientAlias\") || \"\").trim();\n    const toothCodes   = String(form.get(\"toothCodes\") || \"\").trim();\n    const doctorUserId = String(form.get(\"doctorUserId\") || \"\").trim();\n    const product      = String(form.get(\"product\") || \"\").trim();\n    const material     = (form.get(\"material\") || \"\") as string;\n    const shade        = (form.get(\"shade\") || \"\") as string;\n    const orderDateIn  = (form.get(\"orderDate\") || \"\") as string;\n    const scanFile     = form.get(\"scan\");\n\n    if (!alias || !toothCodes || !doctorUserId || !(scanFile instanceof File)) {\n      return NextResponse.json(\n        { error: \"Missing info. Required: Doctor, Alias, Tooth codes, and a Scan file.\" },\n        { status: 400 }\n      );\n    }\n\n    const doctor = await prisma.user.findUnique({ where: { id: doctorUserId }, include: { clinic: true } });\n    if (!doctor || doctor.role !== \"customer\" || !doctor.clinic) {\n      return NextResponse.json({ error: \"Selected doctor is not valid or not linked to a clinic.\" }, { status: 400 });\n    }\n\n    const orderDate = orderDateIn ? new Date(orderDateIn) : new Date();\n    if (isNaN(orderDate.getTime())) {\n      return NextResponse.json({ error: \"Invalid order date. Use the date picker (YYYY-MM-DD).\" }, { status: 400 });\n    }\n    const dueDate = addDays(orderDate, 8);\n\n    if (scanFile.size > MAX_SIZE) return NextResponse.json({ error: \"Scan file is too large (max ~200MB).\" }, { status: 413 });\n\n    const ext = (scanFile.name.split(\".\").pop() || \"\").toLowerCase();\n    if (!ACCEPT_SCAN.has(ext)) {\n      return NextResponse.json({ error: \"Scan must be STL, PLY, or OBJ.\" }, { status: 400 });\n    }\n\n    const okProducts = new Set([\"ZIRCONIA\", \"MULTILAYER_ZIRCONIA\", \"EMAX\", \"INLAY_ONLAY\"]);\n    if (!okProducts.has(product)) {\n      return NextResponse.json({ error: \"Please choose a valid product.\" }, { status: 400 });\n    }\n\n    const created = await prisma.dentalCase.create({\n      data: {\n        clinicId: doctor.clinic.id,\n        doctorUserId: doctor.id,\n        patientAlias: alias,\n        doctorName: doctor.name || null, // auto-snapshot name\n        toothCodes,\n        product: product as any,\n        material: material || null,\n        shade: shade || null,\n        orderDate,\n        dueDate,\n        status: \"IN_DESIGN\",\n        stage: \"DESIGN\",\n        designedAt: new Date(),\n      } as any,\n      select: { id: true },\n    });\n\n    const root = path.join(process.cwd(), \"public\", \"uploads\", created.id);\n    await fs.mkdir(root, { recursive: true });\n    const name = `${Date.now()}-${crypto.randomUUID()}.${ext}`;\n    const fullpath = path.join(root, name);\n    const buf = Buffer.from(await (scanFile as File).arrayBuffer());\n    await fs.writeFile(fullpath, buf);\n\n    const extUpper = ext.toUpperCase();\n    const kindAny = ([\"STL\", \"PLY\", \"OBJ\"].includes(extUpper) ? extUpper : \"OTHER\") as any;\n    const publicUrl = `/uploads/${created.id}/${name}`;\n\n    await prisma.caseFile.create({\n      data: { caseId: created.id, label: \"scan\", kind: kindAny, url: publicUrl, sizeBytes: buf.length } as any,\n    });\n\n    return NextResponse.json({ ok: true, id: created.id });\n  } catch (e: any) {\n    console.error(\"Create case error:\", e);\n    return NextResponse.json({ error: \"Something went wrong creating the case. Please try again.\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}