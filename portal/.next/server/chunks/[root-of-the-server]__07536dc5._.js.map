{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/prisma.ts"],"sourcesContent":["// portal/lib/prisma.ts\nimport { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"query\", \"error\", \"warn\"], // Helpful logs for dev\n  });\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalForPrisma.prisma = prisma;\n}"],"names":[],"mappings":"AAAA,uBAAuB;;;;;AACvB;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;QAAS;KAAO;AACjC;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B","debugId":null}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport jwt from \"jsonwebtoken\";\n\nexport type Session = {\n  userId: string;\n  role: \"customer\" | \"lab\" | \"admin\";\n  clinicId?: string;\n};\n\nconst COOKIE = \"lumera_session\";\nconst SECRET = process.env.JWT_SECRET!;\n\n/**\n * Read & verify the session JWT from the request cookies.\n * Next.js 15: cookies() can be async, so we await it.\n */\nexport async function getSession(): Promise<Session | null> {\n  const jar = await cookies(); // async in Next 15\n  const token = jar.get(COOKIE)?.value;\n  if (!token) return null;\n  try {\n    return jwt.verify(token, SECRET) as Session;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQA,MAAM,SAAS;AACf,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;AAM9B,eAAe;IACpB,MAAM,MAAM,MAAM,IAAA,4IAAO,KAAI,mBAAmB;IAChD,MAAM,QAAQ,IAAI,GAAG,CAAC,SAAS;IAC/B,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///Users/vedatcanduzgezen/Desktop/lumera-dental-website/portal/app/api/cases/%5Bid%5D/transition/route.ts"],"sourcesContent":["// app/api/cases/[id]/transition/route.ts\nimport { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { getSession } from \"@/lib/auth\";\nimport { CaseStatus, ProductionStage, Prisma } from \"@prisma/client\";\n\nfunction stageForStatus(to: CaseStatus): ProductionStage {\n  switch (to) {\n    case CaseStatus.IN_MILLING:\n    case CaseStatus.APPROVED:\n      return ProductionStage.MILLING_GLAZING;\n    case CaseStatus.SHIPPED:\n      return ProductionStage.SHIPPING;\n    default:\n      return ProductionStage.DESIGN;\n  }\n}\n\nexport async function POST(\n  req: Request,\n  ctx: { params: Promise<{ id: string }> }\n) {\n  const session = await getSession();\n  if (!session) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n\n  const { id } = await ctx.params;\n  const body = await req.json().catch(() => ({}));\n  const to = body?.to as CaseStatus | undefined;\n  const note: string | undefined = body?.note;\n\n  if (!to) return NextResponse.json({ error: \"Missing 'to' status\" }, { status: 400 });\n\n  const item = await prisma.dentalCase.findUnique({ where: { id } });\n  if (!item) return NextResponse.json({ error: \"Not found\" }, { status: 404 });\n\n  // Doctors: only APPROVED or CHANGES_REQUESTED on their own case\n  if (session.role === \"customer\") {\n    // FIX: Cast the array to CaseStatus[] to allow checking any status against it\n    const allowedForDoctor = [CaseStatus.APPROVED, CaseStatus.CHANGES_REQUESTED] as CaseStatus[];\n    \n    if (!allowedForDoctor.includes(to)) {\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n    }\n    if (!session.userId || item.doctorUserId !== session.userId) {\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n    }\n  }\n\n  const newStage = stageForStatus(to);\n  const at = new Date();\n\n  // Explicit type for transaction client\n  await prisma.$transaction(async (tx: Prisma.TransactionClient) => {\n    await tx.dentalCase.update({\n      where: { id },\n      data: {\n        status: to,\n        stage: newStage,\n        designedAt: to === CaseStatus.READY_FOR_REVIEW ? at : item.designedAt,\n        milledAt:\n          to === CaseStatus.IN_MILLING || to === CaseStatus.APPROVED ? at : item.milledAt,\n        shippedAt: to === CaseStatus.SHIPPED ? at : item.shippedAt,\n      },\n    });\n\n    await tx.statusEvent.create({\n      data: {\n        caseId: id,\n        from: item.status, \n        to,\n        note: note ?? null,\n        actorId: session.userId ?? undefined,\n      },\n    });\n  });\n\n  return NextResponse.json({ ok: true, status: to, stage: newStage, at });\n}"],"names":[],"mappings":"AAAA,yCAAyC;;;;;AACzC;AACA;AACA;AACA;;;;;AAEA,SAAS,eAAe,EAAc;IACpC,OAAQ;QACN,KAAK,2IAAU,CAAC,UAAU;QAC1B,KAAK,2IAAU,CAAC,QAAQ;YACtB,OAAO,gJAAe,CAAC,eAAe;QACxC,KAAK,2IAAU,CAAC,OAAO;YACrB,OAAO,gJAAe,CAAC,QAAQ;QACjC;YACE,OAAO,gJAAe,CAAC,MAAM;IACjC;AACF;AAEO,eAAe,KACpB,GAAY,EACZ,GAAwC;IAExC,MAAM,UAAU,MAAM,IAAA,2HAAU;IAChC,IAAI,CAAC,SAAS,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAe,GAAG;QAAE,QAAQ;IAAI;IAEhF,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,IAAI,MAAM;IAC/B,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;IAC7C,MAAM,KAAK,MAAM;IACjB,MAAM,OAA2B,MAAM;IAEvC,IAAI,CAAC,IAAI,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAsB,GAAG;QAAE,QAAQ;IAAI;IAElF,MAAM,OAAO,MAAM,yHAAM,CAAC,UAAU,CAAC,UAAU,CAAC;QAAE,OAAO;YAAE;QAAG;IAAE;IAChE,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAY,GAAG;QAAE,QAAQ;IAAI;IAE1E,gEAAgE;IAChE,IAAI,QAAQ,IAAI,KAAK,YAAY;QAC/B,8EAA8E;QAC9E,MAAM,mBAAmB;YAAC,2IAAU,CAAC,QAAQ;YAAE,2IAAU,CAAC,iBAAiB;SAAC;QAE5E,IAAI,CAAC,iBAAiB,QAAQ,CAAC,KAAK;YAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAY,GAAG;gBAAE,QAAQ;YAAI;QACjE;QACA,IAAI,CAAC,QAAQ,MAAM,IAAI,KAAK,YAAY,KAAK,QAAQ,MAAM,EAAE;YAC3D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAY,GAAG;gBAAE,QAAQ;YAAI;QACjE;IACF;IAEA,MAAM,WAAW,eAAe;IAChC,MAAM,KAAK,IAAI;IAEf,uCAAuC;IACvC,MAAM,yHAAM,CAAC,YAAY,CAAC,OAAO;QAC/B,MAAM,GAAG,UAAU,CAAC,MAAM,CAAC;YACzB,OAAO;gBAAE;YAAG;YACZ,MAAM;gBACJ,QAAQ;gBACR,OAAO;gBACP,YAAY,OAAO,2IAAU,CAAC,gBAAgB,GAAG,KAAK,KAAK,UAAU;gBACrE,UACE,OAAO,2IAAU,CAAC,UAAU,IAAI,OAAO,2IAAU,CAAC,QAAQ,GAAG,KAAK,KAAK,QAAQ;gBACjF,WAAW,OAAO,2IAAU,CAAC,OAAO,GAAG,KAAK,KAAK,SAAS;YAC5D;QACF;QAEA,MAAM,GAAG,WAAW,CAAC,MAAM,CAAC;YAC1B,MAAM;gBACJ,QAAQ;gBACR,MAAM,KAAK,MAAM;gBACjB;gBACA,MAAM,QAAQ;gBACd,SAAS,QAAQ,MAAM,IAAI;YAC7B;QACF;IACF;IAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,IAAI;QAAM,QAAQ;QAAI,OAAO;QAAU;IAAG;AACvE","debugId":null}}]
}